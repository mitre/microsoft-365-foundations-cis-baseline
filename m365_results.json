{"platform":{"name":"mac_os_x","release":"23.6.0","target_id":"60a86ec9-7b82-538a-bed6-7b7ab29a827f"},"profiles":[{"name":"cis-m365-foundations-baseline","version":"3.1.0","sha256":"70c32233c047dfd41c1d076365aa3cf605dc0dbd1ec7878e8bf3b12f9b01d36d","title":"CIS Microsoft 365 Foundations Benchmark","maintainer":"MITRE SAF Team","summary":"InSpec Validation Profile for the CIS Microsoft 365 Foundations Benchmark","license":"Apache-2.0","copyright":"MITRE, 2024","copyright_email":"saf@groups.mitre.org","supports":[],"attributes":[{"name":"disable_slow_controls","options":{"type":"Boolean","required":false,"value":false}},{"name":"client_id","options":{"type":"String","required":true,"value":"***","sensitive":true}},{"name":"tenant_id","options":{"type":"String","required":true,"value":"***","sensitive":true}},{"name":"client_secret","options":{"type":"String","required":true,"value":"***","sensitive":true}},{"name":"certificate_path","options":{"type":"String","required":true,"value":"***","sensitive":true}},{"name":"certificate_password","options":{"type":"String","required":true,"value":"***","sensitive":true}},{"name":"organization","options":{"type":"String","required":true,"value":"***","sensitive":true}},{"name":"notify_outbound_spam_recipients","options":{"type":"String","required":true,"value":"***","sensitive":true}},{"name":"bcc_suspicious_outbound_additional_recipients","options":{"type":"String","required":true,"value":"***","sensitive":true}},{"name":"spf_domains","options":{"type":"Array","required":true,"value":"***","sensitive":true}},{"name":"dmarc_domains","options":{"type":"Array","required":true,"value":"***","sensitive":true}},{"name":"reporting_mail_address","options":{"type":"String","required":true,"value":"***","sensitive":true}},{"name":"moera_domains","options":{"type":"Array","required":true,"value":"***","sensitive":true}},{"name":"permitted_exceptions_teams_locations","options":{"type":"Array","required":true,"value":"***","sensitive":true}},{"name":"internal_domains_transport_rule","options":{"type":"Array","required":true,"value":"***","sensitive":true}},{"name":"email_addresses_bypass_external_tagging","options":{"type":"Array","required":true,"value":"***","sensitive":true}},{"name":"mailtipslargeaudiencethreshold_value","options":{"required":true,"value":"***","sensitive":true}},{"name":"authorized_domains_teams_admin_center","options":{"type":"Array","required":true,"value":"***","sensitive":true}},{"name":"reporting_email_addresses_for_malicious_messages","options":{"type":"Array","required":true,"value":"***","sensitive":true}},{"name":"sharepoint_admin_url","options":{"type":"String","required":true,"value":"***","sensitive":true}},{"name":"domains_trusted_by_organization","options":{"type":"Array","required":true,"value":"***","sensitive":true}},{"name":"trusted_domains_guids","options":{"type":"Array","required":true,"value":"***","sensitive":true}}],"groups":[{"id":"controls/microsoft-365-foundations-1.1.1.rb","controls":["microsoft-365-foundations-1.1.1"]},{"id":"controls/microsoft-365-foundations-1.1.2.rb","controls":["microsoft-365-foundations-1.1.2"]},{"id":"controls/microsoft-365-foundations-1.1.3.rb","controls":["microsoft-365-foundations-1.1.3"]},{"id":"controls/microsoft-365-foundations-1.1.4.rb","controls":["microsoft-365-foundations-1.1.4"]},{"id":"controls/microsoft-365-foundations-1.2.1.rb","controls":["microsoft-365-foundations-1.2.1"]},{"id":"controls/microsoft-365-foundations-1.2.2.rb","controls":["microsoft-365-foundations-1.2.2"]},{"id":"controls/microsoft-365-foundations-1.3.1.rb","controls":["microsoft-365-foundations-1.3.1"]},{"id":"controls/microsoft-365-foundations-1.3.2.rb","controls":["microsoft-365-foundations-1.3.2"]},{"id":"controls/microsoft-365-foundations-1.3.3.rb","controls":["microsoft-365-foundations-1.3.3"]},{"id":"controls/microsoft-365-foundations-1.3.4.rb","controls":["microsoft-365-foundations-1.3.4"]},{"id":"controls/microsoft-365-foundations-1.3.5.rb","controls":["microsoft-365-foundations-1.3.5"]},{"id":"controls/microsoft-365-foundations-1.3.6.rb","controls":["microsoft-365-foundations-1.3.6"]},{"id":"controls/microsoft-365-foundations-1.3.7.rb","controls":["microsoft-365-foundations-1.3.7"]},{"id":"controls/microsoft-365-foundations-1.3.8.rb","controls":["microsoft-365-foundations-1.3.8"]},{"id":"controls/microsoft-365-foundations-2.1.1.rb","controls":["microsoft-365-foundations-2.1.1"]},{"id":"controls/microsoft-365-foundations-2.1.10.rb","controls":["microsoft-365-foundations-2.1.10"]},{"id":"controls/microsoft-365-foundations-2.1.11.rb","controls":["microsoft-365-foundations-2.1.11"]},{"id":"controls/microsoft-365-foundations-2.1.12.rb","controls":["microsoft-365-foundations-2.1.12"]},{"id":"controls/microsoft-365-foundations-2.1.13.rb","controls":["microsoft-365-foundations-2.1.13"]},{"id":"controls/microsoft-365-foundations-2.1.14.rb","controls":["microsoft-365-foundations-2.1.14"]},{"id":"controls/microsoft-365-foundations-2.1.2.rb","controls":["microsoft-365-foundations-2.1.2"]},{"id":"controls/microsoft-365-foundations-2.1.3.rb","controls":["microsoft-365-foundations-2.1.3"]},{"id":"controls/microsoft-365-foundations-2.1.4.rb","controls":["microsoft-365-foundations-2.1.4"]},{"id":"controls/microsoft-365-foundations-2.1.5.rb","controls":["microsoft-365-foundations-2.1.5"]},{"id":"controls/microsoft-365-foundations-2.1.6.rb","controls":["microsoft-365-foundations-2.1.6"]},{"id":"controls/microsoft-365-foundations-2.1.7.rb","controls":["microsoft-365-foundations-2.1.7"]},{"id":"controls/microsoft-365-foundations-2.1.8.rb","controls":["microsoft-365-foundations-2.1.8"]},{"id":"controls/microsoft-365-foundations-2.1.9.rb","controls":["microsoft-365-foundations-2.1.9"]},{"id":"controls/microsoft-365-foundations-2.3.1.rb","controls":["microsoft-365-foundations-2.3.1"]},{"id":"controls/microsoft-365-foundations-2.3.2.rb","controls":["microsoft-365-foundations-2.3.2"]},{"id":"controls/microsoft-365-foundations-2.4.1.rb","controls":["microsoft-365-foundations-2.4.1"]},{"id":"controls/microsoft-365-foundations-2.4.2.rb","controls":["microsoft-365-foundations-2.4.2"]},{"id":"controls/microsoft-365-foundations-2.4.3.rb","controls":["microsoft-365-foundations-2.4.3"]},{"id":"controls/microsoft-365-foundations-2.4.4.rb","controls":["microsoft-365-foundations-2.4.4"]},{"id":"controls/microsoft-365-foundations-3.1.1.rb","controls":["microsoft-365-foundations-3.1.1"]},{"id":"controls/microsoft-365-foundations-3.1.2.rb","controls":["microsoft-365-foundations-3.1.2"]},{"id":"controls/microsoft-365-foundations-3.2.1.rb","controls":["microsoft-365-foundations-3.2.1"]},{"id":"controls/microsoft-365-foundations-3.2.2.rb","controls":["microsoft-365-foundations-3.2.2"]},{"id":"controls/microsoft-365-foundations-3.3.1.rb","controls":["microsoft-365-foundations-3.3.1"]},{"id":"controls/microsoft-365-foundations-5.1.1.1.rb","controls":["microsoft-365-foundations-5.1.1.1"]},{"id":"controls/microsoft-365-foundations-5.1.2.1.rb","controls":["microsoft-365-foundations-5.1.2.1"]},{"id":"controls/microsoft-365-foundations-5.1.2.2.rb","controls":["microsoft-365-foundations-5.1.2.2"]},{"id":"controls/microsoft-365-foundations-5.1.2.3.rb","controls":["microsoft-365-foundations-5.1.2.3"]},{"id":"controls/microsoft-365-foundations-5.1.2.4.rb","controls":["microsoft-365-foundations-5.1.2.4"]},{"id":"controls/microsoft-365-foundations-5.1.2.5.rb","controls":["microsoft-365-foundations-5.1.2.5"]},{"id":"controls/microsoft-365-foundations-5.1.2.6.rb","controls":["microsoft-365-foundations-5.1.2.6"]},{"id":"controls/microsoft-365-foundations-5.1.3.1.rb","controls":["microsoft-365-foundations-5.1.3.1"]},{"id":"controls/microsoft-365-foundations-5.1.5.1.rb","controls":["microsoft-365-foundations-5.1.5.1"]},{"id":"controls/microsoft-365-foundations-5.1.5.2.rb","controls":["microsoft-365-foundations-5.1.5.2"]},{"id":"controls/microsoft-365-foundations-5.1.5.3.rb","controls":["microsoft-365-foundations-5.1.5.3"]},{"id":"controls/microsoft-365-foundations-5.1.6.1.rb","controls":["microsoft-365-foundations-5.1.6.1"]},{"id":"controls/microsoft-365-foundations-5.1.8.1.rb","controls":["microsoft-365-foundations-5.1.8.1"]},{"id":"controls/microsoft-365-foundations-5.2.2.1.rb","controls":["microsoft-365-foundations-5.2.2.1"]},{"id":"controls/microsoft-365-foundations-5.2.2.2.rb","controls":["microsoft-365-foundations-5.2.2.2"]},{"id":"controls/microsoft-365-foundations-5.2.2.3.rb","controls":["microsoft-365-foundations-5.2.2.3"]},{"id":"controls/microsoft-365-foundations-5.2.2.4.rb","controls":["microsoft-365-foundations-5.2.2.4"]},{"id":"controls/microsoft-365-foundations-5.2.2.5.rb","controls":["microsoft-365-foundations-5.2.2.5"]},{"id":"controls/microsoft-365-foundations-5.2.2.6.rb","controls":["microsoft-365-foundations-5.2.2.6"]},{"id":"controls/microsoft-365-foundations-5.2.2.7.rb","controls":["microsoft-365-foundations-5.2.2.7"]},{"id":"controls/microsoft-365-foundations-5.2.2.8.rb","controls":["microsoft-365-foundations-5.2.2.8"]},{"id":"controls/microsoft-365-foundations-5.2.3.1.rb","controls":["microsoft-365-foundations-5.2.3.1"]},{"id":"controls/microsoft-365-foundations-5.2.3.2.rb","controls":["microsoft-365-foundations-5.2.3.2"]},{"id":"controls/microsoft-365-foundations-5.2.3.3.rb","controls":["microsoft-365-foundations-5.2.3.3"]},{"id":"controls/microsoft-365-foundations-5.2.3.4.rb","controls":["microsoft-365-foundations-5.2.3.4"]},{"id":"controls/microsoft-365-foundations-5.2.4.1.rb","controls":["microsoft-365-foundations-5.2.4.1"]},{"id":"controls/microsoft-365-foundations-5.2.4.2.rb","controls":["microsoft-365-foundations-5.2.4.2"]},{"id":"controls/microsoft-365-foundations-5.2.6.1.rb","controls":["microsoft-365-foundations-5.2.6.1"]},{"id":"controls/microsoft-365-foundations-5.3.1.rb","controls":["microsoft-365-foundations-5.3.1"]},{"id":"controls/microsoft-365-foundations-5.3.2.rb","controls":["microsoft-365-foundations-5.3.2"]},{"id":"controls/microsoft-365-foundations-5.3.3.rb","controls":["microsoft-365-foundations-5.3.3"]},{"id":"controls/microsoft-365-foundations-6.1.1.rb","controls":["microsoft-365-foundations-6.1.1"]},{"id":"controls/microsoft-365-foundations-6.1.2.rb","controls":["microsoft-365-foundations-6.1.2"]},{"id":"controls/microsoft-365-foundations-6.1.3.rb","controls":["microsoft-365-foundations-6.1.3"]},{"id":"controls/microsoft-365-foundations-6.1.4.rb","controls":["microsoft-365-foundations-6.1.4"]},{"id":"controls/microsoft-365-foundations-6.2.1.rb","controls":["microsoft-365-foundations-6.2.1"]},{"id":"controls/microsoft-365-foundations-6.2.2.rb","controls":["microsoft-365-foundations-6.2.2"]},{"id":"controls/microsoft-365-foundations-6.2.3.rb","controls":["microsoft-365-foundations-6.2.3"]},{"id":"controls/microsoft-365-foundations-6.3.1.rb","controls":["microsoft-365-foundations-6.3.1"]},{"id":"controls/microsoft-365-foundations-6.4.1.rb","controls":["microsoft-365-foundations-6.4.1"]},{"id":"controls/microsoft-365-foundations-6.5.1.rb","controls":["microsoft-365-foundations-6.5.1"]},{"id":"controls/microsoft-365-foundations-6.5.2.rb","controls":["microsoft-365-foundations-6.5.2"]},{"id":"controls/microsoft-365-foundations-6.5.3.rb","controls":["microsoft-365-foundations-6.5.3"]},{"id":"controls/microsoft-365-foundations-7.2.1.rb","controls":["microsoft-365-foundations-7.2.1"]},{"id":"controls/microsoft-365-foundations-7.2.10.rb","controls":["microsoft-365-foundations-7.2.10"]},{"id":"controls/microsoft-365-foundations-7.2.2.rb","controls":["microsoft-365-foundations-7.2.2"]},{"id":"controls/microsoft-365-foundations-7.2.3.rb","controls":["microsoft-365-foundations-7.2.3"]},{"id":"controls/microsoft-365-foundations-7.2.4.rb","controls":["microsoft-365-foundations-7.2.4"]},{"id":"controls/microsoft-365-foundations-7.2.5.rb","controls":["microsoft-365-foundations-7.2.5"]},{"id":"controls/microsoft-365-foundations-7.2.6.rb","controls":["microsoft-365-foundations-7.2.6"]},{"id":"controls/microsoft-365-foundations-7.2.7.rb","controls":["microsoft-365-foundations-7.2.7"]},{"id":"controls/microsoft-365-foundations-7.2.8.rb","controls":["microsoft-365-foundations-7.2.8"]},{"id":"controls/microsoft-365-foundations-7.2.9.rb","controls":["microsoft-365-foundations-7.2.9"]},{"id":"controls/microsoft-365-foundations-7.3.1.rb","controls":["microsoft-365-foundations-7.3.1"]},{"id":"controls/microsoft-365-foundations-7.3.2.rb","controls":["microsoft-365-foundations-7.3.2"]},{"id":"controls/microsoft-365-foundations-7.3.3.rb","controls":["microsoft-365-foundations-7.3.3"]},{"id":"controls/microsoft-365-foundations-7.3.4.rb","controls":["microsoft-365-foundations-7.3.4"]},{"id":"controls/microsoft-365-foundations-8.1.1.rb","controls":["microsoft-365-foundations-8.1.1"]},{"id":"controls/microsoft-365-foundations-8.1.2.rb","controls":["microsoft-365-foundations-8.1.2"]},{"id":"controls/microsoft-365-foundations-8.2.1.rb","controls":["microsoft-365-foundations-8.2.1"]},{"id":"controls/microsoft-365-foundations-8.4.1.rb","controls":["microsoft-365-foundations-8.4.1"]},{"id":"controls/microsoft-365-foundations-8.5.1.rb","controls":["microsoft-365-foundations-8.5.1"]},{"id":"controls/microsoft-365-foundations-8.5.2.rb","controls":["microsoft-365-foundations-8.5.2"]},{"id":"controls/microsoft-365-foundations-8.5.3.rb","controls":["microsoft-365-foundations-8.5.3"]},{"id":"controls/microsoft-365-foundations-8.5.4.rb","controls":["microsoft-365-foundations-8.5.4"]},{"id":"controls/microsoft-365-foundations-8.5.5.rb","controls":["microsoft-365-foundations-8.5.5"]},{"id":"controls/microsoft-365-foundations-8.5.6.rb","controls":["microsoft-365-foundations-8.5.6"]},{"id":"controls/microsoft-365-foundations-8.5.7.rb","controls":["microsoft-365-foundations-8.5.7"]},{"id":"controls/microsoft-365-foundations-8.5.8.rb","controls":["microsoft-365-foundations-8.5.8"]},{"id":"controls/microsoft-365-foundations-8.6.1.rb","controls":["microsoft-365-foundations-8.6.1"]},{"id":"controls/microsoft-365-foundations-9.1.1.rb","controls":["microsoft-365-foundations-9.1.1"]},{"id":"controls/microsoft-365-foundations-9.1.2.rb","controls":["microsoft-365-foundations-9.1.2"]},{"id":"controls/microsoft-365-foundations-9.1.3.rb","controls":["microsoft-365-foundations-9.1.3"]},{"id":"controls/microsoft-365-foundations-9.1.4.rb","controls":["microsoft-365-foundations-9.1.4"]},{"id":"controls/microsoft-365-foundations-9.1.5.rb","controls":["microsoft-365-foundations-9.1.5"]},{"id":"controls/microsoft-365-foundations-9.1.6.rb","controls":["microsoft-365-foundations-9.1.6"]},{"id":"controls/microsoft-365-foundations-9.1.7.rb","controls":["microsoft-365-foundations-9.1.7"]},{"id":"controls/microsoft-365-foundations-9.1.8.rb","controls":["microsoft-365-foundations-9.1.8"]},{"id":"controls/microsoft-365-foundations-9.1.9.rb","controls":["microsoft-365-foundations-9.1.9"]}],"controls":[{"id":"microsoft-365-foundations-1.1.1","title":"Ensure Administrative accounts are separate and cloud-only","desc":"Administrative accounts are special privileged accounts that could have varying levels of access to data, users, and settings. Regular user accounts should never be utilized for administrative tasks and care should be taken, in the case of a hybrid environment, to keep Administrative accounts separated from on-prem accounts. Administrative accounts should not have applications assigned so that they have no access to potentially vulnerable services (EX. email, Teams, SharePoint, etc.) and only access to perform tasks as needed for administrative purposes.\n          Ensure administrative accounts are licensed without attached applications and cloud-only.","descriptions":[{"label":"default","data":"Administrative accounts are special privileged accounts that could have varying levels of access to data, users, and settings. Regular user accounts should never be utilized for administrative tasks and care should be taken, in the case of a hybrid environment, to keep Administrative accounts separated from on-prem accounts. Administrative accounts should not have applications assigned so that they have no access to potentially vulnerable services (EX. email, Teams, SharePoint, etc.) and only access to perform tasks as needed for administrative purposes.\n          Ensure administrative accounts are licensed without attached applications and cloud-only."},{"label":"check","data":"Ensure Administrative accounts are separate and cloud-only:\n        1.Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2.Click to expand Users select Active users.\n        3.Sort by the Licenses column.\n        4.For each user account in an administrative role verify the following:\n          - The account is Cloud only (not synced)\n          - The account is assigned a license that is not associated with applications i.e. (Microsoft Entra ID P1, Microsoft Entra ID P2)"},{"label":"fix","data":"To created licensed, separate Administrative accounts for Administrative users:\n        1.Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2.Click to expand Users select Active users\n        3.Click Add a user.\n        4.Fill out the appropriate fields for Name, user, etc.\n        5.When prompted to assign licenses select as needed Microsoft Entra ID P1 or Microsoft Entra ID P2, then click Next.\n        6.Under the Option settings screen you may choose from several types of Administrative access roles. Choose Admin center access followed by the appropriate role then click"},{"label":"rationale","data":"Security defaults provide secure default settings that we manage on behalf of organizations to keep customers safe until they are ready to manage their own identity security settings.\n        For example, doing the following:\n          • Requiring all users and admins to register for MFA.\n          • Challenging users with MFA - when necessary, based on factors such as location, device, role, and task.\n          • Disabling authentication from legacy authentication clients, which can’t do MFA."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/admin/add-users/add-users?view=o365-worldwide"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/enterprise/protect-your-global-administrator-accounts?view=o365-worldwide"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/roles/best-practices#9-use-cloud-native-accounts-for-azure-ad-roles"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/whatis"}],"tags":{"severity":"medium","cis_controls":[{"8":["5.4"]},{"7":["4.1"]}],"default_value":"N/A","nist":["AC-6(2)","CM-1","CM-2","CM-6","CM-7","CM-7(1)","CM-9","SA-3","SA-8","SA-10"]},"code":"control 'microsoft-365-foundations-1.1.1' do\n  title 'Ensure Administrative accounts are separate and cloud-only'\n  desc \"Administrative accounts are special privileged accounts that could have varying levels of access to data, users, and settings. Regular user accounts should never be utilized for administrative tasks and care should be taken, in the case of a hybrid environment, to keep Administrative accounts separated from on-prem accounts. Administrative accounts should not have applications assigned so that they have no access to potentially vulnerable services (EX. email, Teams, SharePoint, etc.) and only access to perform tasks as needed for administrative purposes.\n          Ensure administrative accounts are licensed without attached applications and cloud-only.\"\n\n  desc 'check',\n       \"Ensure Administrative accounts are separate and cloud-only:\n        1.Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2.Click to expand Users select Active users.\n        3.Sort by the Licenses column.\n        4.For each user account in an administrative role verify the following:\n          - The account is Cloud only (not synced)\n          - The account is assigned a license that is not associated with applications i.e. (Microsoft Entra ID P1, Microsoft Entra ID P2)\"\n\n  desc 'fix',\n       \"To created licensed, separate Administrative accounts for Administrative users:\n        1.Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2.Click to expand Users select Active users\n        3.Click Add a user.\n        4.Fill out the appropriate fields for Name, user, etc.\n        5.When prompted to assign licenses select as needed Microsoft Entra ID P1 or Microsoft Entra ID P2, then click Next.\n        6.Under the Option settings screen you may choose from several types of Administrative access roles. Choose Admin center access followed by the appropriate role then click\"\n\n  desc 'rationale',\n       \"Security defaults provide secure default settings that we manage on behalf of organizations to keep customers safe until they are ready to manage their own identity security settings.\n        For example, doing the following:\n          • Requiring all users and admins to register for MFA.\n          • Challenging users with MFA - when necessary, based on factors such as location, device, role, and task.\n          • Disabling authentication from legacy authentication clients, which can’t do MFA.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['5.4'] }, { '7' => ['4.1'] }]\n  tag default_value: 'N/A'\n  tag nist: ['AC-6(2)', 'CM-1', 'CM-2', 'CM-6', 'CM-7', 'CM-7(1)', 'CM-9', 'SA-3', 'SA-8', 'SA-10']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/admin/add-users/add-users?view=o365-worldwide'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/enterprise/protect-your-global-administrator-accounts?view=o365-worldwide'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/roles/best-practices#9-use-cloud-native-accounts-for-azure-ad-roles'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/whatis'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-1.1.1.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":7.0e-06,"start_time":"2024-09-24T15:28:16-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-1.1.2","title":"Ensure two emergency access accounts have been defined","desc":"Emergency access or \"break glass\" accounts are limited for emergency scenarios where normal administrative accounts are unavailable. They are not assigned to a specific user and will have a combination of physical and technical controls to prevent them from being accessed outside a true emergency. These emergencies could be due to several things, including:\n        - Technical failures of a cellular provider or Microsoft related service such as MFA.\n        - The last remaining Global Administrator account is inaccessible.\n        - Ensure two Emergency Access accounts have been defined.\n        - Note: Microsoft provides several recommendations for these accounts and how to configure them. For more information on this, please refer to the references section. The CIS Benchmark outlines the more critical things to consider.","descriptions":[{"label":"default","data":"Emergency access or \"break glass\" accounts are limited for emergency scenarios where normal administrative accounts are unavailable. They are not assigned to a specific user and will have a combination of physical and technical controls to prevent them from being accessed outside a true emergency. These emergencies could be due to several things, including:\n        - Technical failures of a cellular provider or Microsoft related service such as MFA.\n        - The last remaining Global Administrator account is inaccessible.\n        - Ensure two Emergency Access accounts have been defined.\n        - Note: Microsoft provides several recommendations for these accounts and how to configure them. For more information on this, please refer to the references section. The CIS Benchmark outlines the more critical things to consider."},{"label":"check","data":"Step 1 - Ensure a policy and procedure is in place at the organization:\n          - In order for accounts to be effectively used in a break-glass situation the proper policies and procedures must be authorized and distributed by senior management.\n          - FIDO2 Security Keys, if used, should be locked in a secure separate fireproof location.\n          - Passwords should be at least 16 characters, randomly generated and MAY be separated in multiple pieces to be joined on emergency.\n        Step 2 - Ensure two emergency access accounts are defined:\n            1. Navigate to Microsoft 365 admin center https://admin.microsoft.com\n            2. Expand Users > Active Users\n            3. Inspect the designated emergency access accounts and ensure the following:\n              - The accounts are named correctly, and do NOT identify with a particular person.\n              - The accounts use the default .onmicrosoft.com domain and not the organization's.\n              - The accounts are cloud-only.\n              - The accounts are unlicensed.\n              - The accounts are assigned the Global Administrator directory role.\n        Step 3 - Ensure at least one account is excluded from all conditional access rules:\n        1. Navigate Microsoft Entra admin center https://entra.microsoft.com/\n        2. Expand Protection > Conditional Access.\n        3. Inspect the conditional access rules.\n        4. Ensure one of the emergency access accounts is excluded from all rules."},{"label":"fix","data":"Step 1 - Create two emergency access accounts:\n            1. Navigate to Microsoft 365 admin center https://admin.microsoft.com\n            2. Expand Users > Active Users\n            3. Click Add user and create a new user with this criteria:\n              - Name the account in a way that does NOT identify it with a particular person.\n              - Assign the account to the default .onmicrosoft.com domain and not the organization's.\n              - The password must be at least 16 characters and generated randomly.\n              - Do not assign a license.\n              - Assign the user the Global Administrator role.\n            4. Repeat the above steps for the second account.\n        Step 2 - Exclude at least one account from conditional access policies:\n            1. Navigate Microsoft Entra admin center https://entra.microsoft.com/\n            2. Expand Protection > Conditional Access.\n            3. Inspect the conditional access policies.\n            4. For each rule add an exclusion for at least one of the emergency access accounts.\n            5. Users > Exclude > Users and groups and select one emergency access account.\n        Step 3 - Ensure the necessary procedures and policies are in place:\n            * In order for accounts to be effectively used in a break glass situation the proper policies and procedures must be authorized and distributed by senior management.\n            * FIDO2 Security Keys, if used, should be locked in a secure separate fireproof location.\n            * Passwords should be at least 16 characters, randomly generated and MAY be separated in multiple pieces to be joined on emergency.\n        Note: Additional suggestions for emergency account management:\n            * Create access reviews for these users.\n            * Exclude users from conditional access rules.\n        Warning: If CA (conditional access) exclusion is managed by a group, this group should be added to PIM for groups (licensing required) or be created as a role-assignable group. If it is a regular security group, then users with the Group Administrators role are able to bypass CA entirely."},{"label":"rationale","data":"Multi-factor authentication requires an individual to present a minimum of two separate forms of authentication before access is granted. Multi-factor authentication provides additional assurance that the individual attempting to gain access is who they claim to be. With multi-factor authentication, an attacker would need to compromise at least two different authentication mechanisms, increasing the difficulty of compromise and thus reducing the risk."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/roles/security-planning#stage-1-critical-items-to-do-right-now"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/roles/security-emergency-access"}],"tags":{"severity":"medium","cis_controls":[{"8":["5.1"]}],"default_value":"Not defined.","nist":["AC-2"]},"code":"control 'microsoft-365-foundations-1.1.2' do\n  title 'Ensure two emergency access accounts have been defined'\n  desc 'Emergency access or \"break glass\" accounts are limited for emergency scenarios where normal administrative accounts are unavailable. They are not assigned to a specific user and will have a combination of physical and technical controls to prevent them from being accessed outside a true emergency. These emergencies could be due to several things, including:\n        - Technical failures of a cellular provider or Microsoft related service such as MFA.\n        - The last remaining Global Administrator account is inaccessible.\n        - Ensure two Emergency Access accounts have been defined.\n        - Note: Microsoft provides several recommendations for these accounts and how to configure them. For more information on this, please refer to the references section. The CIS Benchmark outlines the more critical things to consider.'\n  desc 'check',\n       \"Step 1 - Ensure a policy and procedure is in place at the organization:\n          - In order for accounts to be effectively used in a break-glass situation the proper policies and procedures must be authorized and distributed by senior management.\n          - FIDO2 Security Keys, if used, should be locked in a secure separate fireproof location.\n          - Passwords should be at least 16 characters, randomly generated and MAY be separated in multiple pieces to be joined on emergency.\n        Step 2 - Ensure two emergency access accounts are defined:\n            1. Navigate to Microsoft 365 admin center https://admin.microsoft.com\n            2. Expand Users > Active Users\n            3. Inspect the designated emergency access accounts and ensure the following:\n              - The accounts are named correctly, and do NOT identify with a particular person.\n              - The accounts use the default .onmicrosoft.com domain and not the organization's.\n              - The accounts are cloud-only.\n              - The accounts are unlicensed.\n              - The accounts are assigned the Global Administrator directory role.\n        Step 3 - Ensure at least one account is excluded from all conditional access rules:\n        1. Navigate Microsoft Entra admin center https://entra.microsoft.com/\n        2. Expand Protection > Conditional Access.\n        3. Inspect the conditional access rules.\n        4. Ensure one of the emergency access accounts is excluded from all rules.\"\n  desc 'fix',\n       \"Step 1 - Create two emergency access accounts:\n            1. Navigate to Microsoft 365 admin center https://admin.microsoft.com\n            2. Expand Users > Active Users\n            3. Click Add user and create a new user with this criteria:\n              - Name the account in a way that does NOT identify it with a particular person.\n              - Assign the account to the default .onmicrosoft.com domain and not the organization's.\n              - The password must be at least 16 characters and generated randomly.\n              - Do not assign a license.\n              - Assign the user the Global Administrator role.\n            4. Repeat the above steps for the second account.\n        Step 2 - Exclude at least one account from conditional access policies:\n            1. Navigate Microsoft Entra admin center https://entra.microsoft.com/\n            2. Expand Protection > Conditional Access.\n            3. Inspect the conditional access policies.\n            4. For each rule add an exclusion for at least one of the emergency access accounts.\n            5. Users > Exclude > Users and groups and select one emergency access account.\n        Step 3 - Ensure the necessary procedures and policies are in place:\n            * In order for accounts to be effectively used in a break glass situation the proper policies and procedures must be authorized and distributed by senior management.\n            * FIDO2 Security Keys, if used, should be locked in a secure separate fireproof location.\n            * Passwords should be at least 16 characters, randomly generated and MAY be separated in multiple pieces to be joined on emergency.\n        Note: Additional suggestions for emergency account management:\n            * Create access reviews for these users.\n            * Exclude users from conditional access rules.\n        Warning: If CA (conditional access) exclusion is managed by a group, this group should be added to PIM for groups (licensing required) or be created as a role-assignable group. If it is a regular security group, then users with the Group Administrators role are able to bypass CA entirely.\"\n\n  desc 'rationale',\n       'Multi-factor authentication requires an individual to present a minimum of two separate forms of authentication before access is granted. Multi-factor authentication provides additional assurance that the individual attempting to gain access is who they claim to be. With multi-factor authentication, an attacker would need to compromise at least two different authentication mechanisms, increasing the difficulty of compromise and thus reducing the risk.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['5.1'] }]\n  tag default_value: 'Not defined.'\n  tag nist: ['AC-2']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/roles/security-planning#stage-1-critical-items-to-do-right-now'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/roles/security-emergency-access'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-1.1.2.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":2.0e-06,"start_time":"2024-09-24T15:28:16-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-1.1.3","title":"Ensure that between two and four global admins are designated","desc":"More than one global administrator should be designated so a single admin can be monitored and to provide redundancy should a single admin leave an organization. Additionally, there should be no more than four global admins set for any tenant. Ideally global administrators will have no licenses assigned to them.","descriptions":[{"label":"default","data":"More than one global administrator should be designated so a single admin can be monitored and to provide redundancy should a single admin leave an organization. Additionally, there should be no more than four global admins set for any tenant. Ideally global administrators will have no licenses assigned to them."},{"label":"check","data":"Ensure that between two and four global admins are designated:\n        1. Navigate to the Microsoft 365 admin center https://admin.microsoft.com\n        2. Select Users > Active Users.\n        3. Select Filter then select Global Admins.\n        4. Review the list of Global Admins to confirm there are from two to four such accounts.\n    To verify the number of global tenant administrators using PowerShell:\n        1.Connect to Microsoft Graph using Connect-MgGraph -Scopes Directory.Read.All\n        2.Run the following PowerShell script:\n            # Determine Id of role using the immutable RoleTemplateId value.\n            $globalAdminRole = Get-MgDirectoryRole -Filter \"RoleTemplateId eq '62e90394-69f5-4237-9190-012177145e10'\"\n            $globalAdmins = Get-MgDirectoryRoleMember -DirectoryRoleId $globalAdminRole.Id Write-Host \"*** There are\"\n            $globalAdmins.AdditionalProperties.Count \"Global Administrators assigned.\"\n    This information is also available via the Microsoft Graph Security API: GET https://graph.microsoft.com/beta/security/secureScores\n    Note: When tallying the number of Global Administrators the above does not account for Partner relationships. Those are located under Settings > Partner Relationships and should be reviewed on a reoccurring basis."},{"label":"fix","data":"To correct the number of global tenant administrators:\n        1. Navigate to the Microsoft 365 admin center https://admin.microsoft.com\n        2. Select Users > Active Users.\n        3. In the Search field enter the name of the user to be made a Global Administrator.\n        4. To create a new Global Admin:\n            1. Select the user's name.\n            2. A window will appear to the right.\n            3. Select Manage roles.\n            4. Select Admin center access.\n            5. Check Global Administrator.\n            6. Click Save changes.\n        5. To remove Global Admins:\n            1. Select User.\n            2. Under Roles select Manage roles\n            3. De-Select the appropriate role.\n            4. Click Save changes."},{"label":"rationale","data":"Multi-factor authentication requires an individual to present a minimum of two separate forms of authentication before access is granted. Multi-factor authentication provides additional assurance that the individual attempting to gain access is who they claim to be. With multi-factor authentication, an attacker would need to compromise at least two different authentication mechanisms, increasing the difficulty of compromise and thus reducing the risk."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/powershell/module/microsoft.graph.identity.directorymanagement/get-mgdirectoryrole?view=graph-powershell-1.0"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#role-template-ids"}],"tags":{"severity":"medium","cis_controls":[{"8":["5.1"]},{"7":["4.1"]}],"nist":["AC-2","CM-1","CM-2","CM-6","CM-7","CM-7(1)","CM-9","SA-3","SA-8","SA-10"]},"code":"control 'microsoft-365-foundations-1.1.3' do\n  title 'Ensure that between two and four global admins are designated'\n  desc 'More than one global administrator should be designated so a single admin can be monitored and to provide redundancy should a single admin leave an organization. Additionally, there should be no more than four global admins set for any tenant. Ideally global administrators will have no licenses assigned to them.'\n\n  desc 'check',\n       'Ensure that between two and four global admins are designated:\n        1. Navigate to the Microsoft 365 admin center https://admin.microsoft.com\n        2. Select Users > Active Users.\n        3. Select Filter then select Global Admins.\n        4. Review the list of Global Admins to confirm there are from two to four such accounts.\n    To verify the number of global tenant administrators using PowerShell:\n        1.Connect to Microsoft Graph using Connect-MgGraph -Scopes Directory.Read.All\n        2.Run the following PowerShell script:\n            # Determine Id of role using the immutable RoleTemplateId value.\n            $globalAdminRole = Get-MgDirectoryRole -Filter \"RoleTemplateId eq \\'62e90394-69f5-4237-9190-012177145e10\\'\"\n            $globalAdmins = Get-MgDirectoryRoleMember -DirectoryRoleId $globalAdminRole.Id Write-Host \"*** There are\"\n            $globalAdmins.AdditionalProperties.Count \"Global Administrators assigned.\"\n    This information is also available via the Microsoft Graph Security API: GET https://graph.microsoft.com/beta/security/secureScores\n    Note: When tallying the number of Global Administrators the above does not account for Partner relationships. Those are located under Settings > Partner Relationships and should be reviewed on a reoccurring basis.'\n\n  desc 'fix',\n       \"To correct the number of global tenant administrators:\n        1. Navigate to the Microsoft 365 admin center https://admin.microsoft.com\n        2. Select Users > Active Users.\n        3. In the Search field enter the name of the user to be made a Global Administrator.\n        4. To create a new Global Admin:\n            1. Select the user's name.\n            2. A window will appear to the right.\n            3. Select Manage roles.\n            4. Select Admin center access.\n            5. Check Global Administrator.\n            6. Click Save changes.\n        5. To remove Global Admins:\n            1. Select User.\n            2. Under Roles select Manage roles\n            3. De-Select the appropriate role.\n            4. Click Save changes.\"\n\n  desc 'rationale',\n       'Multi-factor authentication requires an individual to present a minimum of two separate forms of authentication before access is granted. Multi-factor authentication provides additional assurance that the individual attempting to gain access is who they claim to be. With multi-factor authentication, an attacker would need to compromise at least two different authentication mechanisms, increasing the difficulty of compromise and thus reducing the risk.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['5.1'] }, { '7' => ['4.1'] }]\n  tag nist: ['AC-2', 'CM-1', 'CM-2', 'CM-6', 'CM-7', 'CM-7(1)', 'CM-9', 'SA-3', 'SA-8', 'SA-10']\n\n  ref 'https://learn.microsoft.com/en-us/powershell/module/microsoft.graph.identity.directorymanagement/get-mgdirectoryrole?view=graph-powershell-1.0'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#role-template-ids'\n\n  get_admin_user_count_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $appObjectID = '136a849a-74bc-47ed-9bec-dde306688a6a' #hardly ever used\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}' #This should not be stored inside of any script; supplied to transmit detail\n    import-module microsoft.graph\n    $password = ConvertTo-SecureString -String $clientSecret -AsPlainText -Force\n    $ClientSecretCredential = New-Object -TypeName System.Management.Automation.PSCredential($client_id,$password)\n    Connect-MgGraph -TenantId $tenantid -ClientSecretCredential $ClientSecretCredential -NoWelcome\n    $globalAdminRole = Get-MgDirectoryRole -Filter \"RoleTemplateId eq '62e90394-69f5-4237-9190-012177145e10'\"\n    $globalAdmins = Get-MgDirectoryRoleMember -DirectoryRoleId $globalAdminRole.Id\n    Write-Host $globalAdmins.AdditionalProperties.Count\n    }\n\n  powershell_output = powershell(get_admin_user_count_script)\n  describe 'Ensure global tenant administrator count' do\n    subject { powershell_output.stdout.strip }\n    it 'should be between two to four' do\n      expect(subject).to cmp(2..4)\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-1.1.3.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure global tenant administrator count should be between two to four","run_time":137.625302,"start_time":"2024-09-24T15:28:16-04:00","message":"\nexpected: 2..4\n     got: 0\n\n(compared using `cmp` matcher)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure global tenant administrator count"}]},{"id":"microsoft-365-foundations-1.1.4","title":"Ensure Guest Users are reviewed at least biweekly","desc":"Guest users can be set up for those users not in the organization to still be granted access to resources. It is important to maintain visibility for what guest users are established in the tenant.\n        Ensure Guest Users are reviewed no less frequently than biweekly.\n        Note: With the E5 license an access review can be configured to review guest accounts automatically on a reoccurring basis. This is the preferred method if the licensing is available.","descriptions":[{"label":"default","data":"Guest users can be set up for those users not in the organization to still be granted access to resources. It is important to maintain visibility for what guest users are established in the tenant.\n        Ensure Guest Users are reviewed no less frequently than biweekly.\n        Note: With the E5 license an access review can be configured to review guest accounts automatically on a reoccurring basis. This is the preferred method if the licensing is available."},{"label":"check","data":"To verify the report is being reviewed at least biweekly, confirm that the necessary procedures are in place and being followed."},{"label":"fix","data":"To review guest users in the UI:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com/.\n        2. Click to expand Users and select Guest Users.\n        3. Review the list of users.\n    To verify Microsoft 365 audit log search is enabled using Microsoft Graph PowerShell:\n        1. Connect using Connect-MgGraph -Scopes \"User.Read.All\"\n        2. Run the following PowerShell command:\n            Get-MgUser -All -Property UserType,UserPrincipalName | Where {$_.UserType -ne \"Member\"} | Format-Table UserPrincipalName, UserType\n        3. Review the list of users. If nothing is returned then there are no guest users."},{"label":"rationale","data":"Remembering Multi-Factor Authentication (MFA) for devices and browsers allows users to have the option to bypass MFA for a set number of days after performing a successful sign-in using MFA. This can enhance usability by minimizing the number of times a user may need to perform two-step verification on the same device. However, if an account or device is compromised, remembering MFA for trusted devices may affect security. Hence, it is recommended that users not be allowed to bypass MFA."}],"impact":0.5,"refs":[],"tags":{"severity":"medium","cis_controls":[{"8":["5.1"]},{"8":["5.3"]},{"7":["6.2"]},{"7":["16.6"]}],"default_value":"By default, Allow users to remember multi-factor authentication on devices they trust is disabled.","nist":["AC-2","AC-2(3)","AC-1","AC-2","AC-2(1)"]},"code":"control 'microsoft-365-foundations-1.1.4' do\n  title 'Ensure Guest Users are reviewed at least biweekly'\n  desc \"Guest users can be set up for those users not in the organization to still be granted access to resources. It is important to maintain visibility for what guest users are established in the tenant.\n        Ensure Guest Users are reviewed no less frequently than biweekly.\n        Note: With the E5 license an access review can be configured to review guest accounts automatically on a reoccurring basis. This is the preferred method if the licensing is available.\"\n\n  desc 'check',\n       'To verify the report is being reviewed at least biweekly, confirm that the necessary procedures are in place and being followed.'\n\n  desc 'fix',\n       'To review guest users in the UI:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com/.\n        2. Click to expand Users and select Guest Users.\n        3. Review the list of users.\n    To verify Microsoft 365 audit log search is enabled using Microsoft Graph PowerShell:\n        1. Connect using Connect-MgGraph -Scopes \"User.Read.All\"\n        2. Run the following PowerShell command:\n            Get-MgUser -All -Property UserType,UserPrincipalName | Where {$_.UserType -ne \"Member\"} | Format-Table UserPrincipalName, UserType\n        3. Review the list of users. If nothing is returned then there are no guest users.'\n\n  desc 'rationale',\n       'Remembering Multi-Factor Authentication (MFA) for devices and browsers allows users to have the option to bypass MFA for a set number of days after performing a successful sign-in using MFA. This can enhance usability by minimizing the number of times a user may need to perform two-step verification on the same device. However, if an account or device is compromised, remembering MFA for trusted devices may affect security. Hence, it is recommended that users not be allowed to bypass MFA.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [\n    { '8' => ['5.1'] },\n    { '8' => ['5.3'] },\n    { '7' => ['6.2'] },\n    { '7' => ['16.6'] }\n  ]\n  tag default_value: 'By default, Allow users to remember multi-factor authentication on devices they trust is disabled.'\n  tag nist: ['AC-2', 'AC-2(3)', 'AC-1', 'AC-2', 'AC-2(1)']\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-1.1.4.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":1.4e-05,"start_time":"2024-09-24T15:30:33-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-1.2.1","title":"Ensure that only organizationally managed/approved public groups exist","desc":"Microsoft 365 Groups is the foundational membership service that drives all teamwork across Microsoft 365. With Microsoft 365 Groups, you can give a group of people access to a collection of shared resources. While there are several different group types this recommendation concerns Microsoft 365 Groups.\n        In the Administration panel, when a group is created, the default privacy value is \"Public\".","descriptions":[{"label":"default","data":"Microsoft 365 Groups is the foundational membership service that drives all teamwork across Microsoft 365. With Microsoft 365 Groups, you can give a group of people access to a collection of shared resources. While there are several different group types this recommendation concerns Microsoft 365 Groups.\n        In the Administration panel, when a group is created, the default privacy value is \"Public\"."},{"label":"check","data":"Ensure only organizationally managed/approved public groups exist:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Teams & groups select Active teams & groups.\n        3. On the Active teams and groups page, check that no groups have the status 'Public' in the privacy column.\n    Using the Microsoft Graph PowerShell module:\n        1. Connect to the Microsoft Graph service using Connect-MgGraph -Scopes \"Group.Read.All\".\n        2. Run the following Microsoft Graph PowerShell command:\n            Get-MgGroup | where {$_.Visibility -eq \"Public\"} | select DisplayName,Visibility\n        3. Ensure Visibility is Private for each group."},{"label":"fix","data":"To enable only organizationally managed/approved public groups exist:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Teams & groups select Active teams & groups..\n        3. On the Active teams and groups page, select the group's name that is public.\n        4. On the popup groups name page, Select Settings.\n        5. Under Privacy, select Private."},{"label":"rationale","data":"Defining trusted source IP addresses or ranges helps organizations create and enforce Conditional Access policies around those trusted or untrusted IP addresses and ranges. Users authenticating from trusted IP addresses and/or ranges may have less access restrictions or access requirements when compared to users that try to authenticate to Microsoft Entra ID from untrusted locations or untrusted source IP addresses/ranges."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/enterprise-users/groups-self-service-management"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/admin/create-groups/compare-groups?view=o365-worldwide"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.3"]},{"7":["13.1"]}],"default_value":"Public when created from the Administration portal; private otherwise.","nist":["AC-3","AC-5","AC-6","MP-2","AU-6(1)","AU-7","IR-4(1)","SI-4(2)","SI-4(5)"]},"code":"control 'microsoft-365-foundations-1.2.1' do\n  title 'Ensure that only organizationally managed/approved public groups exist'\n  desc 'Microsoft 365 Groups is the foundational membership service that drives all teamwork across Microsoft 365. With Microsoft 365 Groups, you can give a group of people access to a collection of shared resources. While there are several different group types this recommendation concerns Microsoft 365 Groups.\n        In the Administration panel, when a group is created, the default privacy value is \"Public\".'\n\n  desc 'check',\n       'Ensure only organizationally managed/approved public groups exist:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Teams & groups select Active teams & groups.\n        3. On the Active teams and groups page, check that no groups have the status \\'Public\\' in the privacy column.\n    Using the Microsoft Graph PowerShell module:\n        1. Connect to the Microsoft Graph service using Connect-MgGraph -Scopes \"Group.Read.All\".\n        2. Run the following Microsoft Graph PowerShell command:\n            Get-MgGroup | where {$_.Visibility -eq \"Public\"} | select DisplayName,Visibility\n        3. Ensure Visibility is Private for each group.'\n\n  desc 'fix',\n       \"To enable only organizationally managed/approved public groups exist:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Teams & groups select Active teams & groups..\n        3. On the Active teams and groups page, select the group's name that is public.\n        4. On the popup groups name page, Select Settings.\n        5. Under Privacy, select Private.\"\n\n  desc 'rationale',\n       'Defining trusted source IP addresses or ranges helps organizations create and enforce Conditional Access policies around those trusted or untrusted IP addresses and ranges. Users authenticating from trusted IP addresses and/or ranges may have less access restrictions or access requirements when compared to users that try to authenticate to Microsoft Entra ID from untrusted locations or untrusted source IP addresses/ranges.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['3.3'] }, { '7' => ['13.1'] }]\n  tag default_value: 'Public when created from the Administration portal; private otherwise.'\n  tag nist: ['AC-3', 'AC-5', 'AC-6', 'MP-2', 'AU-6(1)', 'AU-7', 'IR-4(1)', 'SI-4(2)', 'SI-4(5)']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/enterprise-users/groups-self-service-management'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/admin/create-groups/compare-groups?view=o365-worldwide'\n\n  all_groups_private_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}' # SAME AS APPLICATION ID.   TERMS often interchangeable\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}' #This should not be stored inside of any script; supplied to transmit detail\n    import-module microsoft.graph\n    $password = ConvertTo-SecureString -String $clientSecret -AsPlainText -Force\n    $ClientSecretCredential = New-Object -TypeName System.Management.Automation.PSCredential($client_id,$password)\n    Connect-MgGraph -TenantId \"$tenantid\" -ClientSecretCredential $ClientSecretCredential -NoWelcome\n    # Determine Id of role using the immutable RoleTemplateId value.\n    Write-Host (Get-MgGroup | where {$_.Visibility -eq \"Public\"} | select DisplayName,Visibility).Count\n  }\n\n  powershell_output = powershell(all_groups_private_script)\n  describe 'Public groups count' do\n    subject { powershell_output.stdout.to_i }\n    it 'should be 0' do\n      expect(subject).to cmp(0)\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-1.2.1.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Public groups count should be 0","run_time":134.724701,"start_time":"2024-09-24T15:30:33-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Public groups count"}]},{"id":"microsoft-365-foundations-1.2.2","title":"Ensure sign-in to shared mailboxes is blocked","desc":"Shared mailboxes are used when multiple people need access to the same mailbox, such as a company information or support email address, reception desk, or other function that might be shared by multiple people.\n        Users with permissions to the group mailbox can send as or send on behalf of the mailbox email address if the administrator has given that user permissions to do that. This is particularly useful for help and support mailboxes because users can send emails from \"Contoso Support\" or \"Building A Reception Desk.\"\n        Shared mailboxes are created with a corresponding user account using a system generated password that is unknown at the time of creation.\n        The recommended state is Sign in blocked for Shared mailboxes.","descriptions":[{"label":"default","data":"Shared mailboxes are used when multiple people need access to the same mailbox, such as a company information or support email address, reception desk, or other function that might be shared by multiple people.\n        Users with permissions to the group mailbox can send as or send on behalf of the mailbox email address if the administrator has given that user permissions to do that. This is particularly useful for help and support mailboxes because users can send emails from \"Contoso Support\" or \"Building A Reception Desk.\"\n        Shared mailboxes are created with a corresponding user account using a system generated password that is unknown at the time of creation.\n        The recommended state is Sign in blocked for Shared mailboxes."},{"label":"check","data":"Review Shared mailboxes in the UI:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com/\n        2. Click to expand Teams & groups and select Shared mailboxes.\n        3. Take note of all shared mailboxes.\n        4. Click to expand Users and select Active users.\n        5. Select a shared mailbox account to open its properties pane, and review.\n        6. Ensure the option reads Unblock sign-in.\n        7. Repeat for any additional shared mailboxes.\n    Note: If sign-in is not blocked it will read Block sign-in.\n    Audit in PowerShell using 2 modules:\n        1. Connect to Exchange Online using Connect-ExchangeOnline\n        2. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"Policy.Read.All\"\n        3. Run the following PowerShell commands:\n            $MBX = Get-EXOMailbox -RecipientTypeDetails SharedMailbox\n            $MBX | ForEach-Object { Get-MgUser -UserId $_.ExternalDirectoryObjectId ` -Property DisplayName, UserPrincipalName, AccountEnabled } | Format-Table DisplayName, UserPrincipalName, AccountEnabled\n        4. Ensure AccountEnabled is set to False for all Shared Mailboxes."},{"label":"fix","data":"Block sign-in to shared mailboxes in the UI:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com/\n        2. Click to expand Teams & groups and select Shared mailboxes.\n        3. Take note of all shared mailboxes.\n        4. Click to expand Users and select Active users.\n        5. Select a shared mailbox account to open it's properties pane and then select Block sign-in.\n        6. Check the box for Block this user from signing in.\n        7. Repeat for any additional shared mailboxes.\"\n  'Remediate in PowerShell using 2 modules:\n        1. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"User.ReadWrite.All\"\n        2. Connect to Exchange Online using Connect-ExchangeOnline.\n        3. To disable sign-in for a single account: $MBX = Get-EXOMailbox -Identity TestUser@example.com Update-MgUser -UserId $MBX.ExternalDirectoryObjectId -AccountEnabled:$false\n        3. The following will block sign-in to all Shared Mailboxes. $MBX = Get-EXOMailbox -RecipientTypeDetails SharedMailbox $MBX | ForEach-Object { Update-MgUser -UserId $_.ExternalDirectoryObjectId -AccountEnabled:$false }"},{"label":"rationale","data":"Conditional Access, when used as a deny list for the tenant or subscription, is able to prevent ingress or egress of traffic to countries that are outside of the scope of interest (e.g.: customers, suppliers) or jurisdiction of an organization. This is an effective way to prevent unnecessary and long-lasting exposure to international threats such as APTs."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/admin/email/about-shared-mailboxes?view=o365-worldwide"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/admin/email/create-a-shared-mailbox?view=o365-worldwide#block-sign-in-for-the-shared-mailbox-account"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/enterprise/block-user-accounts-with-microsoft-365-powershell?view=o365-worldwide#block-individual-user-accounts"}],"tags":{"severity":"medium","cis_controls":[{"8":["untracked"]},{"7":["untracked"]}],"default_value":"AccountEnabled: True","nist":["CM-6"]},"code":"control 'microsoft-365-foundations-1.2.2' do\n  title 'Ensure sign-in to shared mailboxes is blocked'\n  desc 'Shared mailboxes are used when multiple people need access to the same mailbox, such as a company information or support email address, reception desk, or other function that might be shared by multiple people.\n        Users with permissions to the group mailbox can send as or send on behalf of the mailbox email address if the administrator has given that user permissions to do that. This is particularly useful for help and support mailboxes because users can send emails from \"Contoso Support\" or \"Building A Reception Desk.\"\n        Shared mailboxes are created with a corresponding user account using a system generated password that is unknown at the time of creation.\n        The recommended state is Sign in blocked for Shared mailboxes.'\n\n  desc 'check',\n       'Review Shared mailboxes in the UI:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com/\n        2. Click to expand Teams & groups and select Shared mailboxes.\n        3. Take note of all shared mailboxes.\n        4. Click to expand Users and select Active users.\n        5. Select a shared mailbox account to open its properties pane, and review.\n        6. Ensure the option reads Unblock sign-in.\n        7. Repeat for any additional shared mailboxes.\n    Note: If sign-in is not blocked it will read Block sign-in.\n    Audit in PowerShell using 2 modules:\n        1. Connect to Exchange Online using Connect-ExchangeOnline\n        2. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"Policy.Read.All\"\n        3. Run the following PowerShell commands:\n            $MBX = Get-EXOMailbox -RecipientTypeDetails SharedMailbox\n            $MBX | ForEach-Object { Get-MgUser -UserId $_.ExternalDirectoryObjectId ` -Property DisplayName, UserPrincipalName, AccountEnabled } | Format-Table DisplayName, UserPrincipalName, AccountEnabled\n        4. Ensure AccountEnabled is set to False for all Shared Mailboxes.'\n\n  desc 'fix',\n       %q(Block sign-in to shared mailboxes in the UI:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com/\n        2. Click to expand Teams & groups and select Shared mailboxes.\n        3. Take note of all shared mailboxes.\n        4. Click to expand Users and select Active users.\n        5. Select a shared mailbox account to open it's properties pane and then select Block sign-in.\n        6. Check the box for Block this user from signing in.\n        7. Repeat for any additional shared mailboxes.\"\n  'Remediate in PowerShell using 2 modules:\n        1. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"User.ReadWrite.All\"\n        2. Connect to Exchange Online using Connect-ExchangeOnline.\n        3. To disable sign-in for a single account: $MBX = Get-EXOMailbox -Identity TestUser@example.com Update-MgUser -UserId $MBX.ExternalDirectoryObjectId -AccountEnabled:$false\n        3. The following will block sign-in to all Shared Mailboxes. $MBX = Get-EXOMailbox -RecipientTypeDetails SharedMailbox $MBX | ForEach-Object { Update-MgUser -UserId $_.ExternalDirectoryObjectId -AccountEnabled:$false })\n\n  desc 'rationale',\n       'Conditional Access, when used as a deny list for the tenant or subscription, is able to prevent ingress or egress of traffic to countries that are outside of the scope of interest (e.g.: customers, suppliers) or jurisdiction of an organization. This is an effective way to prevent unnecessary and long-lasting exposure to international threats such as APTs.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['untracked'] }, { '7' => ['untracked'] }]\n  tag default_value: 'AccountEnabled: True'\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/admin/email/about-shared-mailboxes?view=o365-worldwide'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/admin/email/create-a-shared-mailbox?view=o365-worldwide#block-sign-in-for-the-shared-mailbox-account'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/enterprise/block-user-accounts-with-microsoft-365-powershell?view=o365-worldwide#block-individual-user-accounts'\n\n  ensure_signin_mailboxes_blocked_script = %{\n      $client_id = '#{input('client_id')}'\n      $tenantid = '#{input('tenant_id')}'\n      $certificate_password = '#{input('certificate_password')}'\n      $certificate_path = '#{input('certificate_path')}'\n      $organization = '#{input('organization')}'\n      $clientSecret = '#{input('client_secret')}'\n      import-module microsoft.graph\n      import-module exchangeonlinemanagement\n      $password = ConvertTo-SecureString -String $clientSecret -AsPlainText -Force\n      $ClientSecretCredential = New-Object -TypeName System.Management.Automation.PSCredential($client_id,$password)\n      Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n      Connect-MgGraph -TenantId \"$tenantid\" -ClientSecretCredential $ClientSecretCredential -NoWelcome\n      Connect-MgGraph -Scopes \"Policy.Read.All\" -NoWelcome\n      $MBX = Get-EXOMailbox -RecipientTypeDetails SharedMailbox\n      $disabled_account_count = $MBX | ForEach-Object { Get-MgUser -UserId $_.ExternalDirectoryObjectId ` -Property DisplayName, UserPrincipalName, AccountEnabled } | Where-Object { $_.AccountEnabled -eq $true } | Measure-Object | Select-Object -ExpandProperty Count\n      Write-Output $disabled_account_count\n   }\n\n  powershell_output = powershell(ensure_signin_mailboxes_blocked_script)\n  describe 'Ensure the number of shared mailboxes with AccountEnabled as true' do\n    subject { powershell_output.stdout.strip }\n    it 'is equal to 0' do\n      expect(subject).to cmp(0)\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-1.2.2.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure the number of shared mailboxes with AccountEnabled as true is equal to 0","run_time":188.139832,"start_time":"2024-09-24T15:32:48-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the number of shared mailboxes with AccountEnabled as true"}]},{"id":"microsoft-365-foundations-1.3.1","title":"Ensure the 'Password expiration policy' is set to 'Set passwords to never expire (recommended)","desc":"Microsoft cloud-only accounts have a pre-defined password policy that cannot be changed. The only items that can change are the number of days until a password expires and whether or whether passwords expire at all.","descriptions":[{"label":"default","data":"Microsoft cloud-only accounts have a pre-defined password policy that cannot be changed. The only items that can change are the number of days until a password expires and whether or whether passwords expire at all."},{"label":"check","data":"Ensure that Office 365 passwords are set to never expire:\n            1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n            2. Click to expand Settings select Org Settings.\n            3. Click on Security & privacy.\n            4. Select Password expiration policy ensure that Set passwords to never expire (recommended) has been checked.\n        To verify Office 365 Passwords Are Not Set to Expire, use the Microsoft Graph PowerShell module:\n            1. Connect to the Microsoft Graph service using Connect-MgGraph -Scopes \"Domain.Read.All\".\n            2. Run the following Microsoft Online PowerShell command:\n                Get-MgDomain -DomainId <Domain Name> | ft PasswordValidityPeriodInDays"},{"label":"fix","data":"To set Office 365 passwords are set to never expire:\n            1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n            2. Click to expand Settings select Org Settings.\n            3. Click on Security & privacy.\n            4. Check the Set passwords to never expire (recommended) box.\n            5. Click Save.\n        To set Office 365 Passwords Are Not Set to Expire, use the Microsoft Graph PowerShell module:\n            1. Connect to the Microsoft Graph service using Connect-MgGraph -Scopes \"Domain.ReadWrite.All\".\n            2. Run the following Microsoft Graph PowerShell command: Update-MgDomain -DomainId <Domain> -PasswordValidityPeriodInDays 2147483647 -PasswordNotificationWindowInDays 30"},{"label":"rationale","data":"Organizations such as NIST and Microsoft have updated their password policy recommendations to not arbitrarily require users to change their passwords after a specific amount of time, unless there is evidence that the password is compromised, or the user forgot it. They suggest this even for single factor (Password Only) use cases, with a reasoning that forcing arbitrary password changes on users actually make the passwords less secure. Other recommendations within this Benchmark suggest the use of MFA authentication for at least critical accounts (at minimum), which makes password expiration even less useful as well as password protection for Entra ID."}],"impact":0.5,"refs":[{"ref":"https://pages.nist.gov/800-63-3/sp800-63b.html"},{"ref":"https://www.cisecurity.org/insights/white-papers/cis-password-policy-guide"},{"ref":"https://learn.microsoft.com/en-US/microsoft-365/admin/misc/password-policy-recommendations?view=o365-worldwide"}],"tags":{"severity":"medium","cis_controls":[{"8":["5.2"]},{"7":["4.4"]}],"default_value":"If the property is not set, a default value of 90 days will be used","nist":["IA-5(1)","CA-9","SC-7","SC-7(5)"]},"code":"control 'microsoft-365-foundations-1.3.1' do\n  title \"Ensure the 'Password expiration policy' is set to 'Set passwords to never expire (recommended)\"\n  desc 'Microsoft cloud-only accounts have a pre-defined password policy that cannot be changed. The only items that can change are the number of days until a password expires and whether or whether passwords expire at all.'\n\n  desc 'check',\n       'Ensure that Office 365 passwords are set to never expire:\n            1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n            2. Click to expand Settings select Org Settings.\n            3. Click on Security & privacy.\n            4. Select Password expiration policy ensure that Set passwords to never expire (recommended) has been checked.\n        To verify Office 365 Passwords Are Not Set to Expire, use the Microsoft Graph PowerShell module:\n            1. Connect to the Microsoft Graph service using Connect-MgGraph -Scopes \"Domain.Read.All\".\n            2. Run the following Microsoft Online PowerShell command:\n                Get-MgDomain -DomainId <Domain Name> | ft PasswordValidityPeriodInDays'\n  desc 'fix',\n       'To set Office 365 passwords are set to never expire:\n            1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n            2. Click to expand Settings select Org Settings.\n            3. Click on Security & privacy.\n            4. Check the Set passwords to never expire (recommended) box.\n            5. Click Save.\n        To set Office 365 Passwords Are Not Set to Expire, use the Microsoft Graph PowerShell module:\n            1. Connect to the Microsoft Graph service using Connect-MgGraph -Scopes \"Domain.ReadWrite.All\".\n            2. Run the following Microsoft Graph PowerShell command: Update-MgDomain -DomainId <Domain> -PasswordValidityPeriodInDays 2147483647 -PasswordNotificationWindowInDays 30'\n\n  desc 'rationale',\n       'Organizations such as NIST and Microsoft have updated their password policy recommendations to not arbitrarily require users to change their passwords after a specific amount of time, unless there is evidence that the password is compromised, or the user forgot it. They suggest this even for single factor (Password Only) use cases, with a reasoning that forcing arbitrary password changes on users actually make the passwords less secure. Other recommendations within this Benchmark suggest the use of MFA authentication for at least critical accounts (at minimum), which makes password expiration even less useful as well as password protection for Entra ID.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['5.2'] }, { '7' => ['4.4'] }]\n  tag default_value: 'If the property is not set, a default value of 90 days will be used'\n  tag nist: ['IA-5(1)', 'CA-9', 'SC-7', 'SC-7(5)']\n\n  ref 'https://pages.nist.gov/800-63-3/sp800-63b.html'\n  ref 'https://www.cisecurity.org/insights/white-papers/cis-password-policy-guide'\n  ref 'https://learn.microsoft.com/en-US/microsoft-365/admin/misc/password-policy-recommendations?view=o365-worldwide'\n\n  password_expiration_days_script = %{\n     $appName = 'cisBenchmarkL512'\n     $client_id = '#{input('client_id')}'\n     $tenantid = '#{input('tenant_id')}'\n     $clientSecret = '#{input('client_secret')}' #This should not be stored inside of any script; supplied to transmit detail\n     import-module microsoft.graph\n     $password = ConvertTo-SecureString -String $clientSecret -AsPlainText -Force\n     $ClientSecretCredential = New-Object -TypeName System.Management.Automation.PSCredential($client_id,$password)\n     Connect-MgGraph -TenantId \"$tenantid\" -ClientSecretCredential $ClientSecretCredential -NoWelcome\n     $passwordValidityPeriod = (Get-MgDomain -DomainId 'mitredev.onmicrosoft.com').PasswordValidityPeriodInDays\n     Write-Output $passwordValidityPeriod\n  }\n\n  powershell_output = powershell(password_expiration_days_script)\n  describe 'The password validity period' do\n    subject { powershell_output.stdout.to_i }\n    it 'should be at integer max value' do\n      expect(subject).to cmp(2_147_483_647)\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-1.3.1.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"The password validity period should be at integer max value","run_time":134.941648,"start_time":"2024-09-24T15:35:56-04:00","message":"\nexpected: 2147483647\n     got: 0\n\n(compared using `cmp` matcher)\n","resource_class":"Object","resource_params":"[]","resource_id":"The password validity period"}]},{"id":"microsoft-365-foundations-1.3.2","title":"Ensure 'Idle session timeout' is set to '3 hours (or less)' for unmanaged devices","desc":"Idle session timeout allows the configuration of a setting which will timeout inactive users after a pre-determined amount of time. When a user reaches the set idle timeout session, they'll get a notification that they're about to be signed out. They have to select to stay signed in or they'll be automatically signed out of all Microsoft 365 web apps. Combined with a Conditional Access rule this will only impact unmanaged devices. A managed device is considered a device managed by Intune MDM.\n        The following Microsoft 365 web apps are supported.\n            • Outlook Web App\n            • OneDrive for Business\n            • SharePoint Online (SPO)\n            • Office.com and other start pages\n            • Office (Word, Excel, PowerPoint) on the web\n            • Microsoft 365 Admin Center\n        NOTE: Idle session timeout doesn't affect Microsoft 365 desktop and mobile apps.\n        The recommended setting is 3 hours (or less) for unmanaged devices.","descriptions":[{"label":"default","data":"Idle session timeout allows the configuration of a setting which will timeout inactive users after a pre-determined amount of time. When a user reaches the set idle timeout session, they'll get a notification that they're about to be signed out. They have to select to stay signed in or they'll be automatically signed out of all Microsoft 365 web apps. Combined with a Conditional Access rule this will only impact unmanaged devices. A managed device is considered a device managed by Intune MDM.\n        The following Microsoft 365 web apps are supported.\n            • Outlook Web App\n            • OneDrive for Business\n            • SharePoint Online (SPO)\n            • Office.com and other start pages\n            • Office (Word, Excel, PowerPoint) on the web\n            • Microsoft 365 Admin Center\n        NOTE: Idle session timeout doesn't affect Microsoft 365 desktop and mobile apps.\n        The recommended setting is 3 hours (or less) for unmanaged devices."},{"label":"check","data":"Step 1 - Ensure Idle session timeout is configured:\n            1. Navigate to the Microsoft 365 admin center https://admin.microsoft.com/.\n            2. Click to expand Settings Select Org settings.\n            3. Click Security & Privacy tab.\n            4. Select Idle session timeout.\n            5. Verify Turn on to set the period of inactivity for users to be signed off of Microsoft 365 web apps is set to 3 hours (or less).\n        Step 2 - Ensure the Conditional Access policy is in place:\n            1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n            2. Expand Protect > Conditional Access.\n            3. Inspect existing conditional access rules for one that meets the below conditions:\n                • Users is set to All users\n                • Cloud apps or actions > Select apps is set to Office 365.\n                • Conditions > Client apps is Browser and nothing else.\n                • Session is set to Use app enforced restrictions.\n                • Enable Policy is set to On\n        NOTE: To ensure that idle timeouts affect only unmanaged devices, both steps must be completed."},{"label":"fix","data":"To configure Idle session timeout:\n        1. Navigate to the Microsoft 365 admin center https://admin.microsoft.com/.\n        2. Click to expand Settings Select Org settings.\n        3. Click Security & Privacy tab.\n        4. Select Idle session timeout.\n        5. Check the box Turn on to set the period of inactivity for users to be signed off of Microsoft 365 web apps\n        6. Set a maximum value of 3 hours.\n        7. Click save.\n    Step 2 - Ensure the Conditional Access policy is in place:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Expand Protect > Conditional Access\n        3. Click New policy and give the policy a name.\n        4. Select Users > All users.\n        5. Select Cloud apps or actions > Select apps and select Office 365\n        6. Select Conditions > Client apps > Yes check only Browser unchecking all other boxes.\n        7. Select Sessions and check Use app enforced restrictions.\n        8. Set Enable policy to On and click Create.\n    NOTE: To ensure that idle timeouts affect only unmanaged devices, both steps must be completed."},{"label":"rationale","data":"Ending idle sessions through an automatic process can help protect sensitive company data and will add another layer of security for end users who work on unmanaged devices that can potentially be accessed by the public. Unauthorized individuals onsite or remotely can take advantage of systems left unattended over time. Automatic timing out of sessions makes this more difficult."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/admin/manage/idle-session-timeout-web-apps?view=o365-worldwide"}],"tags":{"severity":"medium","cis_controls":[{"8":["4.3"]}],"default_value":"Not configured. (Idle sessions will not timeout.)","nist":["AC-2(5)","AC-11","AC-11(1)","AC-12"]},"code":"control 'microsoft-365-foundations-1.3.2' do\n  title \"Ensure 'Idle session timeout' is set to '3 hours (or less)' for unmanaged devices\"\n  desc \"Idle session timeout allows the configuration of a setting which will timeout inactive users after a pre-determined amount of time. When a user reaches the set idle timeout session, they'll get a notification that they're about to be signed out. They have to select to stay signed in or they'll be automatically signed out of all Microsoft 365 web apps. Combined with a Conditional Access rule this will only impact unmanaged devices. A managed device is considered a device managed by Intune MDM.\n        The following Microsoft 365 web apps are supported.\n            • Outlook Web App\n            • OneDrive for Business\n            • SharePoint Online (SPO)\n            • Office.com and other start pages\n            • Office (Word, Excel, PowerPoint) on the web\n            • Microsoft 365 Admin Center\n        NOTE: Idle session timeout doesn't affect Microsoft 365 desktop and mobile apps.\n        The recommended setting is 3 hours (or less) for unmanaged devices.\"\n  desc 'check',\n       \"Step 1 - Ensure Idle session timeout is configured:\n            1. Navigate to the Microsoft 365 admin center https://admin.microsoft.com/.\n            2. Click to expand Settings Select Org settings.\n            3. Click Security & Privacy tab.\n            4. Select Idle session timeout.\n            5. Verify Turn on to set the period of inactivity for users to be signed off of Microsoft 365 web apps is set to 3 hours (or less).\n        Step 2 - Ensure the Conditional Access policy is in place:\n            1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n            2. Expand Protect > Conditional Access.\n            3. Inspect existing conditional access rules for one that meets the below conditions:\n                • Users is set to All users\n                • Cloud apps or actions > Select apps is set to Office 365.\n                • Conditions > Client apps is Browser and nothing else.\n                • Session is set to Use app enforced restrictions.\n                • Enable Policy is set to On\n        NOTE: To ensure that idle timeouts affect only unmanaged devices, both steps must be completed.\"\n  desc 'fix',\n       \"To configure Idle session timeout:\n        1. Navigate to the Microsoft 365 admin center https://admin.microsoft.com/.\n        2. Click to expand Settings Select Org settings.\n        3. Click Security & Privacy tab.\n        4. Select Idle session timeout.\n        5. Check the box Turn on to set the period of inactivity for users to be signed off of Microsoft 365 web apps\n        6. Set a maximum value of 3 hours.\n        7. Click save.\n    Step 2 - Ensure the Conditional Access policy is in place:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Expand Protect > Conditional Access\n        3. Click New policy and give the policy a name.\n        4. Select Users > All users.\n        5. Select Cloud apps or actions > Select apps and select Office 365\n        6. Select Conditions > Client apps > Yes check only Browser unchecking all other boxes.\n        7. Select Sessions and check Use app enforced restrictions.\n        8. Set Enable policy to On and click Create.\n    NOTE: To ensure that idle timeouts affect only unmanaged devices, both steps must be completed.\"\n\n  desc 'rationale',\n       'Ending idle sessions through an automatic process can help protect sensitive company data and will add another layer of security for end users who work on unmanaged devices that can potentially be accessed by the public. Unauthorized individuals onsite or remotely can take advantage of systems left unattended over time. Automatic timing out of sessions makes this more difficult.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['4.3'] }]\n  tag default_value: 'Not configured. (Idle sessions will not timeout.)'\n  tag nist: ['AC-2(5)', 'AC-11', 'AC-11(1)', 'AC-12']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/admin/manage/idle-session-timeout-web-apps?view=o365-worldwide'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-1.3.2.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":9.0e-06,"start_time":"2024-09-24T15:38:11-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-1.3.3","title":"Ensure 'External sharing' of calendars is not available","desc":"External calendar sharing allows an administrator to enable the ability for users to share calendars with anyone outside of the organization. Outside users will be sent a URL that can be used to view the calendar.","descriptions":[{"label":"default","data":"External calendar sharing allows an administrator to enable the ability for users to share calendars with anyone outside of the organization. Outside users will be sent a URL that can be used to view the calendar."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings select Org settings.\n        3. In the Services section click Calendar.\n        4. Verify Let your users share their calendars with people outside of your organization who have Office 365 or Exchange is unchecked.\n    To audit using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following Exchange Online PowerShell command:\n            Get-SharingPolicy -Identity \"Default Sharing Policy\"\n        3. Verify Enabled is set to False"},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings select Org settings.\n        3. In the Services section click Calendar.\n        4. Uncheck Let your users share their calendars with people outside of your organization who have Office 365 or Exchange.\n        5. Click Save.\n    To remediate using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following Exchange Online PowerShell command:\n            Set-SharingPolicy -Identity \"Default Sharing Policy\" -Enabled $False"},{"label":"rationale","data":"Attackers often spend time learning about organizations before launching an attack. Publicly available calendars can help attackers understand organizational relationships and determine when specific users may be more vulnerable to an attack, such as when they are traveling."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/admin/manage/share-calendars-with-external-users?view=o365-worldwide"}],"tags":{"severity":"medium","cis_controls":[{"8":["4.8"]},{"7":["14.6"]}],"default_value":"Enabled (True)","nist":["CM-6","CM-7","AT-2"]},"code":"control 'microsoft-365-foundations-1.3.3' do\n  title \"Ensure 'External sharing' of calendars is not available\"\n  desc 'External calendar sharing allows an administrator to enable the ability for users to share calendars with anyone outside of the organization. Outside users will be sent a URL that can be used to view the calendar.'\n\n  desc 'check',\n       'To audit using the UI:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings select Org settings.\n        3. In the Services section click Calendar.\n        4. Verify Let your users share their calendars with people outside of your organization who have Office 365 or Exchange is unchecked.\n    To audit using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following Exchange Online PowerShell command:\n            Get-SharingPolicy -Identity \"Default Sharing Policy\"\n        3. Verify Enabled is set to False'\n\n  desc 'fix',\n       'To remediate using the UI:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings select Org settings.\n        3. In the Services section click Calendar.\n        4. Uncheck Let your users share their calendars with people outside of your organization who have Office 365 or Exchange.\n        5. Click Save.\n    To remediate using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following Exchange Online PowerShell command:\n            Set-SharingPolicy -Identity \"Default Sharing Policy\" -Enabled $False'\n\n  desc 'rationale',\n       'Attackers often spend time learning about organizations before launching an attack. Publicly available calendars can help attackers understand organizational relationships and determine when specific users may be more vulnerable to an attack, such as when they are traveling.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['4.8'] }, { '7' => ['14.6'] }]\n  tag default_value: 'Enabled (True)'\n  tag nist: ['CM-6', 'CM-7', 'AT-2']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/admin/manage/share-calendars-with-external-users?view=o365-worldwide'\n\n  ensure_external_calendar_sharing_blocked_script = %{\n      $client_id = '#{input('client_id')}'\n      $certificate_password = '#{input('certificate_password')}'\n      $certificate_path = '#{input('certificate_path')}'\n      $organization = '#{input('organization')}'\n      import-module exchangeonlinemanagement\n      Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n      $enabledStatus = Get-SharingPolicy -Identity \"Default Sharing Policy\" | Select-Object -ExpandProperty Enabled\n      Write-Output $enabledStatus\n   }\n\n  powershell_output = powershell(ensure_external_calendar_sharing_blocked_script)\n  describe 'Ensure the Enabled option for Default Sharing Policy' do\n    subject { powershell_output.stdout.strip }\n    it 'is set to False' do\n      expect(subject).to eq('False')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-1.3.3.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the Enabled option for Default Sharing Policy is set to False","run_time":8.495388,"start_time":"2024-09-24T15:38:11-04:00","message":"\nexpected: \"False\"\n     got: \"True\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the Enabled option for Default Sharing Policy"}]},{"id":"microsoft-365-foundations-1.3.4","title":"Ensure 'User owned apps and services' is restricted","desc":"By default, users can install add-ins in their Microsoft Word, Excel, and PowerPoint applications, allowing data access within the application.\n        Do not allow users to install add-ins in Word, Excel, or PowerPoint.","descriptions":[{"label":"default","data":"By default, users can install add-ins in their Microsoft Word, Excel, and PowerPoint applications, allowing data access within the application.\n        Do not allow users to install add-ins in Word, Excel, or PowerPoint."},{"label":"check","data":"Ensure users installing Office Store add-ins, and enabling 365 trials is not allowed:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings Select Org settings.\n        3. Under Services select User owned apps and services.\n        4. Verify Let users access the Office Store and Let users start trials on behalf of your organization are Not Checked."},{"label":"fix","data":"To prohibit users installing Office Store add-ins and starting 365 trials:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings Select `Org settings'.\n        3. Under Services select User owned apps and services.\n        4. Uncheck Let users access the Office Store and Let users start trials on behalf of your organization.\n        5. Click Save."},{"label":"rationale","data":"Attackers commonly use vulnerable and custom-built add-ins to access data in user applications.\n      While allowing users to install add-ins by themselves does allow them to easily acquire useful add-ins that integrate with Microsoft applications, it can represent a risk if not used and monitored carefully.\n      Disable future user's ability to install add-ins in Microsoft Word, Excel, or PowerPoint helps reduce your threat-surface and mitigate this risk."}],"impact":0.5,"refs":[],"tags":{"severity":"medium","cis_controls":[{"8":["4.8"]},{"7":["5.1"]}],"default_value":"Let users access the Office Store is Checked\n                      Let users start trials on behalf of your organization is Checked","nist":["CM-6","CM-7","AC-2"]},"code":"control 'microsoft-365-foundations-1.3.4' do\n  title \"Ensure 'User owned apps and services' is restricted\"\n  desc \"By default, users can install add-ins in their Microsoft Word, Excel, and PowerPoint applications, allowing data access within the application.\n        Do not allow users to install add-ins in Word, Excel, or PowerPoint.\"\n\n  desc 'check',\n       \"Ensure users installing Office Store add-ins, and enabling 365 trials is not allowed:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings Select Org settings.\n        3. Under Services select User owned apps and services.\n        4. Verify Let users access the Office Store and Let users start trials on behalf of your organization are Not Checked.\"\n\n  desc 'fix',\n       \"To prohibit users installing Office Store add-ins and starting 365 trials:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings Select `Org settings'.\n        3. Under Services select User owned apps and services.\n        4. Uncheck Let users access the Office Store and Let users start trials on behalf of your organization.\n        5. Click Save.\"\n\n  desc 'rationale',\n       \"Attackers commonly use vulnerable and custom-built add-ins to access data in user applications.\n      While allowing users to install add-ins by themselves does allow them to easily acquire useful add-ins that integrate with Microsoft applications, it can represent a risk if not used and monitored carefully.\n      Disable future user's ability to install add-ins in Microsoft Word, Excel, or PowerPoint helps reduce your threat-surface and mitigate this risk.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['4.8'] }, { '7' => ['5.1'] }]\n  tag default_value: \"Let users access the Office Store is Checked\n                      Let users start trials on behalf of your organization is Checked\"\n  tag nist: ['CM-6', 'CM-7', 'AC-2']\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-1.3.4.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":1.2e-05,"start_time":"2024-09-24T15:38:20-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-1.3.5","title":"Ensure internal phishing protection for Forms is enabled","desc":"Microsoft Forms can be used for phishing attacks by asking personal or sensitive information and collecting the results. Microsoft 365 has built-in protection that will proactively scan for phishing attempt in forms such personal information request.","descriptions":[{"label":"default","data":"Microsoft Forms can be used for phishing attacks by asking personal or sensitive information and collecting the results. Microsoft 365 has built-in protection that will proactively scan for phishing attempt in forms such personal information request."},{"label":"check","data":"Ensure internal phishing protection for Forms is enabled:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings then select Org settings.\n        3. Under Services select Microsoft Forms.\n        4. Ensure the checkbox labeled Add internal phishing protection is checked under Phishing protection."},{"label":"fix","data":"To enable internal phishing protection for Forms:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings then select Org settings.\n        3. Under Services select Microsoft Forms.\n        4. Click the checkbox labeled Add internal phishing protection under Phishing protection.\n        5. Click Save."},{"label":"rationale","data":"Enabling internal phishing protection for Microsoft Forms will prevent attackers using forms for phishing attacks by asking personal or other sensitive information and URLs."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-US/microsoft-forms/administrator-settings-microsoft-forms"},{"ref":"https://learn.microsoft.com/en-US/microsoft-forms/review-unblock-forms-users-detected-blocked-potential-phishing"}],"tags":{"severity":"medium","cis_controls":[{"8":["10.1"]},{"8":["14.2"]}],"default_value":"Internal Phishing Protection is enabled.","nist":["SI-3","AT-2(3)"]},"code":"control 'microsoft-365-foundations-1.3.5' do\n  title 'Ensure internal phishing protection for Forms is enabled'\n  desc 'Microsoft Forms can be used for phishing attacks by asking personal or sensitive information and collecting the results. Microsoft 365 has built-in protection that will proactively scan for phishing attempt in forms such personal information request.'\n\n  desc 'check',\n       \"Ensure internal phishing protection for Forms is enabled:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings then select Org settings.\n        3. Under Services select Microsoft Forms.\n        4. Ensure the checkbox labeled Add internal phishing protection is checked under Phishing protection.\"\n\n  desc 'fix',\n       \"To enable internal phishing protection for Forms:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings then select Org settings.\n        3. Under Services select Microsoft Forms.\n        4. Click the checkbox labeled Add internal phishing protection under Phishing protection.\n        5. Click Save.\"\n\n  desc 'rationale',\n       'Enabling internal phishing protection for Microsoft Forms will prevent attackers using forms for phishing attacks by asking personal or other sensitive information and URLs.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['10.1'] }, { '8' => ['14.2'] }]\n  tag default_value: 'Internal Phishing Protection is enabled.'\n  tag nist: ['SI-3', 'AT-2(3)']\n\n  ref 'https://learn.microsoft.com/en-US/microsoft-forms/administrator-settings-microsoft-forms'\n  ref 'https://learn.microsoft.com/en-US/microsoft-forms/review-unblock-forms-users-detected-blocked-potential-phishing'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-1.3.5.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":6.0e-06,"start_time":"2024-09-24T15:38:20-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-1.3.6","title":"Ensure the customer lockbox feature is enabled","desc":"Customer Lockbox is a security feature that provides an additional layer of control and transparency to customer data in Microsoft 365. It offers an approval process for Microsoft support personnel to access organization data and creates an audited trail to meet compliance requirements.","descriptions":[{"label":"default","data":"Customer Lockbox is a security feature that provides an additional layer of control and transparency to customer data in Microsoft 365. It offers an approval process for Microsoft support personnel to access organization data and creates an audited trail to meet compliance requirements."},{"label":"check","data":"Ensure the customer lockbox feature is enabled:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings then select Org settings.\n        3. Select Security & privacy tab.\n        4. Click Customer lockbox.\n        5. Ensure the box labeled Require approval for all data access requests is checked.\n    To verify the Customer Lockbox feature is enabled using the SecureScore Portal:\n        1. Navigate to the Microsoft 365 SecureScore portal. https://securescore.microsoft.com\n        2. Search for Turn on customer lockbox feature under Improvement actions\n    To verify the Customer Lockbox feature is enabled using the REST API:\n        GET https://graph.microsoft.com/beta/security/secureScores\n    To verify the Customer Lockbox feature is enabled using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command: Get-OrganizationConfig | Select-Object CustomerLockBoxEnabled\n        3. Verify the value is set to True"},{"label":"fix","data":"To enable the Customer Lockbox feature:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings then select Org settings.\n        3. Select Security & privacy tab.\n        4. Click Customer lockbox.\n        5. Check the box Require approval for all data access requests.\n        6. Click Save.\n    To set the Customer Lockbox feature to enabled using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Set-OrganizationConfig -CustomerLockBoxEnabled $true"},{"label":"rationale","data":"Enabling this feature protects organizational data against data spillage and exfiltration."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/security/fundamentals/customer-lockbox-overview"}],"tags":{"severity":"medium","cis_controls":[{"8":["untracked"]}],"default_value":"Require approval for all data access requests - Unchecked\n                    CustomerLockboxEnabled - False","nist":["CM-6"]},"code":"control 'microsoft-365-foundations-1.3.6' do\n  title 'Ensure the customer lockbox feature is enabled'\n  desc 'Customer Lockbox is a security feature that provides an additional layer of control and transparency to customer data in Microsoft 365. It offers an approval process for Microsoft support personnel to access organization data and creates an audited trail to meet compliance requirements.'\n\n  desc 'check',\n       \"Ensure the customer lockbox feature is enabled:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings then select Org settings.\n        3. Select Security & privacy tab.\n        4. Click Customer lockbox.\n        5. Ensure the box labeled Require approval for all data access requests is checked.\n    To verify the Customer Lockbox feature is enabled using the SecureScore Portal:\n        1. Navigate to the Microsoft 365 SecureScore portal. https://securescore.microsoft.com\n        2. Search for Turn on customer lockbox feature under Improvement actions\n    To verify the Customer Lockbox feature is enabled using the REST API:\n        GET https://graph.microsoft.com/beta/security/secureScores\n    To verify the Customer Lockbox feature is enabled using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command: Get-OrganizationConfig | Select-Object CustomerLockBoxEnabled\n        3. Verify the value is set to True\"\n\n  desc 'fix',\n       \"To enable the Customer Lockbox feature:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings then select Org settings.\n        3. Select Security & privacy tab.\n        4. Click Customer lockbox.\n        5. Check the box Require approval for all data access requests.\n        6. Click Save.\n    To set the Customer Lockbox feature to enabled using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Set-OrganizationConfig -CustomerLockBoxEnabled $true\"\n\n  desc 'rationale',\n       'Enabling this feature protects organizational data against data spillage and exfiltration.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['untracked'] }]\n  tag default_value: \"Require approval for all data access requests - Unchecked\n                    CustomerLockboxEnabled - False\"\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-us/azure/security/fundamentals/customer-lockbox-overview'\n\n  ensure_customer_lockbox_is_enabled_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    $lock_box_status = Get-OrganizationConfig | Select-Object -ExpandProperty CustomerLockBoxEnabled\n    Write-Output $lock_box_status\n }\n\n  powershell_output = powershell(ensure_customer_lockbox_is_enabled_script)\n  describe 'Ensure the CustomerLockBoxEnabled option from Get-OrganizationConfig' do\n    subject { powershell_output.stdout.strip }\n    it 'is set to True' do\n      expect(subject).to eq('True')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-1.3.6.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the CustomerLockBoxEnabled option from Get-OrganizationConfig is set to True","run_time":8.375193,"start_time":"2024-09-24T15:38:20-04:00","message":"\nexpected: \"True\"\n     got: \"False\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the CustomerLockBoxEnabled option from Get-OrganizationConfig"}]},{"id":"microsoft-365-foundations-1.3.7","title":"Ensure 'third-party storage services' are restricted in 'Microsoft 365 on the web'","desc":"Third-party storage can be enabled for users in Microsoft 365, allowing them to store and share documents using services such as Dropbox, alongside OneDrive and team sites.\n        Ensure Microsoft 365 on the web third-party storage services are restricted.","descriptions":[{"label":"default","data":"Third-party storage can be enabled for users in Microsoft 365, allowing them to store and share documents using services such as Dropbox, alongside OneDrive and team sites.\n        Ensure Microsoft 365 on the web third-party storage services are restricted."},{"label":"check","data":"Ensure Microsoft 365 on the web is restricted:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com\n        2. Go to Settings > Org Settings > Services > Microsoft 365 on the web\n        3. Ensure Let users open files stored in third-party storage services in Microsoft 365 on the web is not checked."},{"label":"fix","data":"To restrict Microsoft 365 on the web:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com\n        2. Go to Settings > Org Settings > Services > Microsoft 365 on the web\n        3. Uncheck Let users open files stored in third-party storage services in Microsoft 365 on the web"},{"label":"rationale","data":"By using external storage services an organization may increase the risk of data breaches and unauthorized access to confidential information. Additionally, third-party services may not adhere to the same security standards as the organization, making it difficult to maintain data privacy and security."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/admin/setup/set-up-file-storage-and-sharing?view=o365-worldwide#enable-or-disable-third-party-storage-services"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.3"]},{"7":["13.1"]},{"7":["13.4"]}],"default_value":"Enabled - Users are able to open files stored in third-party storage services","nist":["AC-3","AC-5","AC-6","MP-2","AU-6(1)","AU-7","IR-4(1)","SI-4(2)","SI-4(5)","CA-9","SC-7"]},"code":"control 'microsoft-365-foundations-1.3.7' do\n  title \"Ensure 'third-party storage services' are restricted in 'Microsoft 365 on the web'\"\n  desc \"Third-party storage can be enabled for users in Microsoft 365, allowing them to store and share documents using services such as Dropbox, alongside OneDrive and team sites.\n        Ensure Microsoft 365 on the web third-party storage services are restricted.\"\n\n  desc 'check',\n       \"Ensure Microsoft 365 on the web is restricted:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com\n        2. Go to Settings > Org Settings > Services > Microsoft 365 on the web\n        3. Ensure Let users open files stored in third-party storage services in Microsoft 365 on the web is not checked.\"\n\n  desc 'fix',\n       \"To restrict Microsoft 365 on the web:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com\n        2. Go to Settings > Org Settings > Services > Microsoft 365 on the web\n        3. Uncheck Let users open files stored in third-party storage services in Microsoft 365 on the web\"\n\n  desc 'rationale',\n       'By using external storage services an organization may increase the risk of data breaches and unauthorized access to confidential information. Additionally, third-party services may not adhere to the same security standards as the organization, making it difficult to maintain data privacy and security.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [\n    { '8' => ['3.3'] },\n    { '7' => ['13.1'] },\n    { '7' => ['13.4'] }\n  ]\n  tag default_value: 'Enabled - Users are able to open files stored in third-party storage services'\n  tag nist: ['AC-3', 'AC-5', 'AC-6', 'MP-2', 'AU-6(1)', 'AU-7', 'IR-4(1)', 'SI-4(2)', 'SI-4(5)', 'CA-9', 'SC-7']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/admin/setup/set-up-file-storage-and-sharing?view=o365-worldwide#enable-or-disable-third-party-storage-services'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-1.3.7.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":1.3e-05,"start_time":"2024-09-24T15:38:28-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-1.3.8","title":"Ensure that Sways cannot be shared with people outside of your organization","desc":"Third-party storage can be enabled for users in Microsoft 365, allowing them to store and share documents using services such as Dropbox, alongside OneDrive and team sites.\n        Ensure Microsoft 365 on the web third-party storage services are restricted.","descriptions":[{"label":"default","data":"Third-party storage can be enabled for users in Microsoft 365, allowing them to store and share documents using services such as Dropbox, alongside OneDrive and team sites.\n        Ensure Microsoft 365 on the web third-party storage services are restricted."},{"label":"check","data":"Ensure that Sways cannot be shared with people outside of your organization:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings then select Org settings.\n        3. Under Services select Sway.\n        4. Confirm that under Sharing the following is not checked\n            o Option: Let people in your organization share their sways with people outside your organization."},{"label":"fix","data":"To ensure Sways cannot be viewed outside of your organization:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings then select Org settings.\n        3. Under Services select Sway\n            o Uncheck: Let people in your organization share their sways with people outside your organization.\n        4. Click Save."},{"label":"rationale","data":"Disable external sharing of Sway documents that can contain sensitive information to prevent accidental or arbitrary data leaks."}],"impact":0.5,"refs":[{"ref":"https://support.microsoft.com/en-us/office/administrator-settings-for-sway-d298e79b-b6ab-44c6-9239-aa312f5784d4"}],"tags":{"severity":"medium","cis_controls":[{"8":["4.8"]},{"7":["13.1"]}],"default_value":"Let people in your organization share their sways with people outside your organization - Enabled","nist":["CM-6","CM-7"]},"code":"control 'microsoft-365-foundations-1.3.8' do\n  title 'Ensure that Sways cannot be shared with people outside of your organization'\n  desc \"Third-party storage can be enabled for users in Microsoft 365, allowing them to store and share documents using services such as Dropbox, alongside OneDrive and team sites.\n        Ensure Microsoft 365 on the web third-party storage services are restricted.\"\n\n  desc 'check',\n       \"Ensure that Sways cannot be shared with people outside of your organization:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings then select Org settings.\n        3. Under Services select Sway.\n        4. Confirm that under Sharing the following is not checked\n            o Option: Let people in your organization share their sways with people outside your organization.\"\n\n  desc 'fix',\n       \"To ensure Sways cannot be viewed outside of your organization:\n        1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n        2. Click to expand Settings then select Org settings.\n        3. Under Services select Sway\n            o Uncheck: Let people in your organization share their sways with people outside your organization.\n        4. Click Save.\"\n\n  desc 'rationale',\n       'Disable external sharing of Sway documents that can contain sensitive information to prevent accidental or arbitrary data leaks.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['4.8'] }, { '7' => ['13.1'] }]\n  tag default_value: 'Let people in your organization share their sways with people outside your organization - Enabled'\n  tag nist: ['CM-6', 'CM-7']\n\n  ref 'https://support.microsoft.com/en-us/office/administrator-settings-for-sway-d298e79b-b6ab-44c6-9239-aa312f5784d4'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-1.3.8.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":9.0e-06,"start_time":"2024-09-24T15:38:28-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-2.1.1","title":"Ensure Safe Links for Office Applications is Enabled","desc":"Enabling Safe Links policy for Office applications allows URL's that exist inside of Office documents and email applications opened by Office, Office Online and Office mobile to be processed against Defender for Office time-of-click verification and rewritten if required.\n        Note: E5 Licensing includes a number of Built-in Protection policies. When auditing policies note which policy you are viewing, and keep in mind CIS recommendations often extend the Default or Build-in Policies provided by MS. In order to Pass the highest priority policy must match all settings recommended.","descriptions":[{"label":"default","data":"Enabling Safe Links policy for Office applications allows URL's that exist inside of Office documents and email applications opened by Office, Office Online and Office mobile to be processed against Defender for Office time-of-click verification and rewritten if required.\n        Note: E5 Licensing includes a number of Built-in Protection policies. When auditing policies note which policy you are viewing, and keep in mind CIS recommendations often extend the Default or Build-in Policies provided by MS. In order to Pass the highest priority policy must match all settings recommended."},{"label":"check","data":"Ensure Safe Links for Office Applications is Enabled:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com\n        2. Under Email & collaboration select Policies & rules\n        3. Select Threat policies then Safe Links\n        4. Inspect each policy and attempt to identify one that matches the parameters outlined below.\n        5. Scroll down the pane and click on Edit Protection settings (Global Readers will look for on or off values)\n        6. Ensure the following protection settings are set as outlined: Email\n                o Checked On: Safe Links checks a list of known, malicious links when users click links in email. URLs are rewritten by default\n                o Checked Apply Safe Links to email messages sent within the organization\n                o Checked Apply real-time URL scanning for suspicious links and links that point to files\n                o Checked Wait for URL scanning to complete before delivering the message\n                o Unchecked Do not rewrite URLs, do checks via Safe Links API only.\n            Teams\n                o Checked On: Safe Links checks a list of known, malicious links when users click links in Microsoft Teams. URLs are not rewritten\n            Office 365 Apps\n                o Checked On: Safe Links checks a list of known, malicious links when users click links in Microsoft Office apps. URLs are not rewritten\n            Click protection settings\n                o Checked Track user clicks\n                o Unchecked Let users click through the original URL\n        7. There is no recommendation for organization branding.\n        8. Click close\n\n    To verify the Safe Links policy is enabled, use the Exchange Online PowerShell Module:\n        1. Connect using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Get-SafeLinksPolicy | Format-Table Name\n        3. Once this returns the list of policies run the following command to view the policies.\n            Get-SafeLinksPolicy -Identity \"Policy Name\"\n        4. Verify the value for the following.\n            o EnableSafeLinksForEmail: True\n            o EnableSafeLinksForTeams: True\n            o EnableSafeLinksForOffice: True\n            o TrackClicks: True\n            o AllowClickThrough: False\n            o ScanUrls: True\n            o EnableForInternalSenders: True\n            o DeliverMessageAfterScan: True\n            o DisableUrlRewrite: False"},{"label":"fix","data":"To create a Safe Links policy:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com\n        2. Under Email & collaboration select Policies & rules\n        3. Select Threat policies then Safe Links\n        4. Click on +Create\n        5. Name the policy then click Next\n        6. In Domains select all valid domains for the organization and Next\n        7. Ensure the following URL & click protection settings are defined: Email\n                o Checked On: Safe Links checks a list of known, malicious links when users click links in email. URLs are rewritten by default\n                o Checked Apply Safe Links to email messages sent within the organization\n                o Checked Apply real-time URL scanning for suspicious links and links that point to files\n                o Checked Wait for URL scanning to complete before delivering the message\n                o Unchecked Do not rewrite URLs, do checks via Safe Links API only.\n            Teams\n                o Checked On: Safe Links checks a list of known, malicious links when users click links in Microsoft Teams. URLs are not rewritten\n            Office 365 Apps\n                o Checked On: Safe Links checks a list of known, malicious links when users click links in Microsoft Office apps. URLs are not rewritten\n            Click protection settings\n                o Checked Track user clicks\n                o Unchecked Let users click through the original URL\n                o There is no recommendation for organization branding.\n        8. Click Next twice and finally Submit\n\n    To create a Safe Links policy using the Exchange Online PowerShell Module:\n        1. Connect using Connect-ExchangeOnline.\n        2. Run the following PowerShell script to create a policy at highest priority that will apply to all valid domains on the tenant:\n            # Create the Policy\n            $params = @{ Name = \"CIS SafeLinks Policy\" EnableSafeLinksForEmail = $true EnableSafeLinksForTeams = $true EnableSafeLinksForOffice = $true TrackClicks = $true AllowClickThrough = $false ScanUrls = $true EnableForInternalSenders = $true DeliverMessageAfterScan = $true DisableUrlRewrite = $false }\n            New-SafeLinksPolicy @params\n            # Create the rule for all users in all valid domains and associate with Policy\n            New-SafeLinksRule -Name \"CIS SafeLinks\" -SafeLinksPolicy \"CIS SafeLinks Policy\" -RecipientDomainIs (Get-AcceptedDomain).Name -Priority 0"},{"label":"rationale","data":"Safe Links for Office applications extends phishing protection to documents and emails that contain hyperlinks, even after they have been delivered to a user."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/safe-links-policies-configure?view=o365-worldwide"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/exchange/set-safelinkspolicy?view=exchange-ps"},{"ref":"https://learn.microsoft.com/en-us/defender-office-365/preset-security-policies?view=o365-worldwide"}],"tags":{"severity":"medium","cis_controls":[{"8":["10.1"]},{"7":["7.4"]}],"nist":["SI-3","RA-5","RA-7","SI-2","SI-2(2)"]},"code":"control 'microsoft-365-foundations-2.1.1' do\n  title 'Ensure Safe Links for Office Applications is Enabled'\n  desc \"Enabling Safe Links policy for Office applications allows URL's that exist inside of Office documents and email applications opened by Office, Office Online and Office mobile to be processed against Defender for Office time-of-click verification and rewritten if required.\n        Note: E5 Licensing includes a number of Built-in Protection policies. When auditing policies note which policy you are viewing, and keep in mind CIS recommendations often extend the Default or Build-in Policies provided by MS. In order to Pass the highest priority policy must match all settings recommended.\"\n\n  desc 'check',\n       'Ensure Safe Links for Office Applications is Enabled:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com\n        2. Under Email & collaboration select Policies & rules\n        3. Select Threat policies then Safe Links\n        4. Inspect each policy and attempt to identify one that matches the parameters outlined below.\n        5. Scroll down the pane and click on Edit Protection settings (Global Readers will look for on or off values)\n        6. Ensure the following protection settings are set as outlined: Email\n                o Checked On: Safe Links checks a list of known, malicious links when users click links in email. URLs are rewritten by default\n                o Checked Apply Safe Links to email messages sent within the organization\n                o Checked Apply real-time URL scanning for suspicious links and links that point to files\n                o Checked Wait for URL scanning to complete before delivering the message\n                o Unchecked Do not rewrite URLs, do checks via Safe Links API only.\n            Teams\n                o Checked On: Safe Links checks a list of known, malicious links when users click links in Microsoft Teams. URLs are not rewritten\n            Office 365 Apps\n                o Checked On: Safe Links checks a list of known, malicious links when users click links in Microsoft Office apps. URLs are not rewritten\n            Click protection settings\n                o Checked Track user clicks\n                o Unchecked Let users click through the original URL\n        7. There is no recommendation for organization branding.\n        8. Click close\n\n    To verify the Safe Links policy is enabled, use the Exchange Online PowerShell Module:\n        1. Connect using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Get-SafeLinksPolicy | Format-Table Name\n        3. Once this returns the list of policies run the following command to view the policies.\n            Get-SafeLinksPolicy -Identity \"Policy Name\"\n        4. Verify the value for the following.\n            o EnableSafeLinksForEmail: True\n            o EnableSafeLinksForTeams: True\n            o EnableSafeLinksForOffice: True\n            o TrackClicks: True\n            o AllowClickThrough: False\n            o ScanUrls: True\n            o EnableForInternalSenders: True\n            o DeliverMessageAfterScan: True\n            o DisableUrlRewrite: False'\n\n  desc 'fix',\n       'To create a Safe Links policy:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com\n        2. Under Email & collaboration select Policies & rules\n        3. Select Threat policies then Safe Links\n        4. Click on +Create\n        5. Name the policy then click Next\n        6. In Domains select all valid domains for the organization and Next\n        7. Ensure the following URL & click protection settings are defined: Email\n                o Checked On: Safe Links checks a list of known, malicious links when users click links in email. URLs are rewritten by default\n                o Checked Apply Safe Links to email messages sent within the organization\n                o Checked Apply real-time URL scanning for suspicious links and links that point to files\n                o Checked Wait for URL scanning to complete before delivering the message\n                o Unchecked Do not rewrite URLs, do checks via Safe Links API only.\n            Teams\n                o Checked On: Safe Links checks a list of known, malicious links when users click links in Microsoft Teams. URLs are not rewritten\n            Office 365 Apps\n                o Checked On: Safe Links checks a list of known, malicious links when users click links in Microsoft Office apps. URLs are not rewritten\n            Click protection settings\n                o Checked Track user clicks\n                o Unchecked Let users click through the original URL\n                o There is no recommendation for organization branding.\n        8. Click Next twice and finally Submit\n\n    To create a Safe Links policy using the Exchange Online PowerShell Module:\n        1. Connect using Connect-ExchangeOnline.\n        2. Run the following PowerShell script to create a policy at highest priority that will apply to all valid domains on the tenant:\n            # Create the Policy\n            $params = @{ Name = \"CIS SafeLinks Policy\" EnableSafeLinksForEmail = $true EnableSafeLinksForTeams = $true EnableSafeLinksForOffice = $true TrackClicks = $true AllowClickThrough = $false ScanUrls = $true EnableForInternalSenders = $true DeliverMessageAfterScan = $true DisableUrlRewrite = $false }\n            New-SafeLinksPolicy @params\n            # Create the rule for all users in all valid domains and associate with Policy\n            New-SafeLinksRule -Name \"CIS SafeLinks\" -SafeLinksPolicy \"CIS SafeLinks Policy\" -RecipientDomainIs (Get-AcceptedDomain).Name -Priority 0'\n\n  desc 'rationale',\n       'Safe Links for Office applications extends phishing protection to documents and emails that contain hyperlinks, even after they have been delivered to a user.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['10.1'] }, { '7' => ['7.4'] }]\n  tag nist: ['SI-3', 'RA-5', 'RA-7', 'SI-2', 'SI-2(2)']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/safe-links-policies-configure?view=o365-worldwide'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/exchange/set-safelinkspolicy?view=exchange-ps'\n  ref 'https://learn.microsoft.com/en-us/defender-office-365/preset-security-policies?view=o365-worldwide'\n\n  get_policy_names_line = %{\n        $client_id = '#{input('client_id')}'\n        $certificate_password = '#{input('certificate_password')}'\n        $certificate_path = '#{input('certificate_path')}'\n        $organization = '#{input('organization')}'\n        import-module exchangeonlinemanagement\n        Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n        $policy_names = Get-SafeLinksPolicy | Select-Object -ExpandProperty Name\n        Write-Output $policy_names\n  }\n  policy_links_script = powershell(get_policy_names_line)\n\n  describe 'Ensure the number of Safe Links policies' do\n    subject { powershell(get_policy_names_line).stdout.strip }\n    it 'is not 0' do\n      expect(subject).to_not be_empty\n    end\n  end\n\n  policy_names = policy_links_script.stdout.strip.split(\"\\n\")\n  policy_names.each do |policy_name|\n    get_state_script = %{\n        $client_id = '#{input('client_id')}'\n        $certificate_password = '#{input('certificate_password')}'\n        $certificate_path = '#{input('certificate_path')}'\n        $organization = '#{input('organization')}'\n        import-module exchangeonlinemanagement\n        Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n        Get-SafeLinksPolicy -Identity \"#{policy_name.strip}\" | Select-Object -Property EnableSafeLinksForEmail, EnableSafeLinksForTeams, EnableSafeLinksForOffice, TrackClicks, AllowClickThrough, ScanUrls, EnableForInternalSenders, DeliverMessageAfterScan, DisableUrlRewrite | ConvertTo-Json\n      }\n    describe \"Safe Links Policy: #{policy_name}\" do\n      subject { JSON.parse(powershell(get_state_script).stdout.strip) }\n      it 'should have EnableSafeLinksForEmail set to True' do\n        expect(subject['EnableSafeLinksForEmail']).to eq(true)\n      end\n      it 'should have EnableSafeLinksForTeams set to True' do\n        expect(subject['EnableSafeLinksForTeams']).to eq(true)\n      end\n      it 'should have EnableSafeLinksForOffice set to True' do\n        expect(subject['EnableSafeLinksForOffice']).to eq(true)\n      end\n      it 'should have TrackClicks set to True' do\n        expect(subject['TrackClicks']).to eq(true)\n      end\n      it 'should have AllowClickThrough set to False' do\n        expect(subject['AllowClickThrough']).to eq(false)\n      end\n      it 'should have ScanUrls set to True' do\n        expect(subject['ScanUrls']).to eq(true)\n      end\n      it 'should have EnableForInternalSenders set to True' do\n        expect(subject['EnableForInternalSenders']).to eq(true)\n      end\n      it 'should have DeliverMessageAfterScan set to True' do\n        expect(subject['DeliverMessageAfterScan']).to eq(true)\n      end\n      it 'should have DisableUrlRewrite set to False' do\n        expect(subject['DisableUrlRewrite']).to eq(false)\n      end\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.1.1.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure the number of Safe Links policies is not 0","run_time":0.00503,"start_time":"2024-09-24T15:38:28-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the number of Safe Links policies"},{"status":"passed","code_desc":"Safe Links Policy: Built-In Protection Policy should have EnableSafeLinksForEmail set to True","run_time":7.49279,"start_time":"2024-09-24T15:38:28-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Safe Links Policy: Built-In Protection Policy"},{"status":"passed","code_desc":"Safe Links Policy: Built-In Protection Policy should have EnableSafeLinksForTeams set to True","run_time":0.000667,"start_time":"2024-09-24T15:38:36-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Safe Links Policy: Built-In Protection Policy"},{"status":"passed","code_desc":"Safe Links Policy: Built-In Protection Policy should have EnableSafeLinksForOffice set to True","run_time":0.000189,"start_time":"2024-09-24T15:38:36-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Safe Links Policy: Built-In Protection Policy"},{"status":"passed","code_desc":"Safe Links Policy: Built-In Protection Policy should have TrackClicks set to True","run_time":0.000144,"start_time":"2024-09-24T15:38:36-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Safe Links Policy: Built-In Protection Policy"},{"status":"failed","code_desc":"Safe Links Policy: Built-In Protection Policy should have AllowClickThrough set to False","run_time":0.028601,"start_time":"2024-09-24T15:38:36-04:00","message":"\nexpected: false\n     got: true\n\n(compared using ==)\n\nDiff:\n@@ -1 +1 @@\n-false\n+true\n","resource_class":"Object","resource_params":"[]","resource_id":"Safe Links Policy: Built-In Protection Policy"},{"status":"passed","code_desc":"Safe Links Policy: Built-In Protection Policy should have ScanUrls set to True","run_time":0.000229,"start_time":"2024-09-24T15:38:36-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Safe Links Policy: Built-In Protection Policy"},{"status":"failed","code_desc":"Safe Links Policy: Built-In Protection Policy should have EnableForInternalSenders set to True","run_time":0.001282,"start_time":"2024-09-24T15:38:36-04:00","message":"\nexpected: true\n     got: false\n\n(compared using ==)\n\nDiff:\n@@ -1 +1 @@\n-true\n+false\n","resource_class":"Object","resource_params":"[]","resource_id":"Safe Links Policy: Built-In Protection Policy"},{"status":"passed","code_desc":"Safe Links Policy: Built-In Protection Policy should have DeliverMessageAfterScan set to True","run_time":0.000121,"start_time":"2024-09-24T15:38:36-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Safe Links Policy: Built-In Protection Policy"},{"status":"failed","code_desc":"Safe Links Policy: Built-In Protection Policy should have DisableUrlRewrite set to False","run_time":0.001147,"start_time":"2024-09-24T15:38:36-04:00","message":"\nexpected: false\n     got: true\n\n(compared using ==)\n\nDiff:\n@@ -1 +1 @@\n-false\n+true\n","resource_class":"Object","resource_params":"[]","resource_id":"Safe Links Policy: Built-In Protection Policy"}]},{"id":"microsoft-365-foundations-2.1.10","title":"Ensure DMARC Records for all Exchange Online domains are published","desc":"DMARC, or Domain-based Message Authentication, Reporting, and Conformance, assists recipient mail systems in determining the appropriate action to take when messages from a domain fail to meet SPF or DKIM authentication criteria.","descriptions":[{"label":"default","data":"DMARC, or Domain-based Message Authentication, Reporting, and Conformance, assists recipient mail systems in determining the appropriate action to take when messages from a domain fail to meet SPF or DKIM authentication criteria."},{"label":"check","data":"Ensure DMARC Records for all Exchange Online domains are published:\n        1.Open a command prompt.\n        2.For each of the Accepted Domains in Exchange Online run the following in PowerShell:\n            Resolve-DnsName _dmarc.[domain1.com] txt\n        3.Ensure that the record exists and has at minimum the following flags defined as follows: v=DMARC1; (p=quarantine OR p=reject), pct=100, rua=mailto:<reporting email address> and ruf=mailto:<reporting email address>\n    The below example records would pass as they contain a policy that would either quarantine or reject messages failing DMARC, the policy affects 100% of mail pct=100 as well as containing valid reporting addresses:\n            v=DMARC1; p=reject; pct=100; rua=mailto:rua@contoso.com;\n            ruf=mailto:ruf@contoso.com; fo=1\n            v=DMARC1; p=reject; pct=100; fo=1; ri=3600; rua=mailto:rua@contoso.com;\n            ruf=mailto:ruf@contoso.com\n            v=DMARC1; p=quarantine; pct=100; sp=none; fo=1; ri=3600; rua=mailto:rua@contoso.com;\n            ruf=ruf@contoso.com;\n        4.Ensure the Microsoft MOERA domain is also configured.\n            Resolve-DnsName _dmarc.[tenant].onmicrosoft.com txt\n        5.Ensure the record meets the same criteria listed in step #3."},{"label":"fix","data":"To add DMARC records, use the following steps:\n        1.For each Exchange Online Accepted Domain, add the following record to DNS: Record: _dmarc.domain1.com Type: TXT Value: v=DMARC1; p=none; rua=mailto:<rua-report@example.com>; ruf=mailto:<ruf-report@example.com>\n        2.This will create a basic DMARC policy that will allow the organization to start monitoring message statistics.\n        3.The next steps will involve first implementing quarantine and next a reject policy with 100 percent of email is affected. Microsoft has a list of best practices for implementing DMARC that cover these steps in detail.\n    To establish a DMARC record for the MOERA domain:\n        1.Navigate to the Microsoft 365 admin center https://admin.microsoft.com/\n        2.Expand Settings and select Domains.\n        3.Select your tenant domain (for example, contoso.onmicrosoft.com).\n        4.Select DNS records and click + Add record.\n        5.Add a new record with the TXT name of _dmarc with the appropriate values outlined above.\n    Note: The remediation portion involves a multi-staged approach over a period of time. First, a baseline of the current state of email will be established with p=none and rua and ruf. Once the environment is better understood and reports have been analyzed an organization will move to the final state with dmarc record values as outlined in the audit section."},{"label":"rationale","data":"DMARC strengthens the trustworthiness of messages sent from an organization's\n        domain to destination email systems. By integrating DMARC with SPF (Sender Policy\n        Framework) and DKIM (DomainKeys Identified Mail), organizations can significantly\n        enhance their defenses against email spoofing and phishing attempts."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/email-authentication-dmarc-configure?view=o365-worldwide"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/step-by-step-guides/how-to-enable-dmarc-reporting-for-microsoft-online-email-routing-address-moera-and-parked-domains?view=o365-worldwide"}],"tags":{"severity":"medium","cis_controls":[{"8":["9.5"]},{"7":["7.8"]}],"nist":["SC-7"]},"code":"control 'microsoft-365-foundations-2.1.10' do\n  title 'Ensure DMARC Records for all Exchange Online domains are published'\n  desc 'DMARC, or Domain-based Message Authentication, Reporting, and Conformance, assists recipient mail systems in determining the appropriate action to take when messages from a domain fail to meet SPF or DKIM authentication criteria.'\n\n  desc 'check',\n       \"Ensure DMARC Records for all Exchange Online domains are published:\n        1.Open a command prompt.\n        2.For each of the Accepted Domains in Exchange Online run the following in PowerShell:\n            Resolve-DnsName _dmarc.[domain1.com] txt\n        3.Ensure that the record exists and has at minimum the following flags defined as follows: v=DMARC1; (p=quarantine OR p=reject), pct=100, rua=mailto:<reporting email address> and ruf=mailto:<reporting email address>\n    The below example records would pass as they contain a policy that would either quarantine or reject messages failing DMARC, the policy affects 100% of mail pct=100 as well as containing valid reporting addresses:\n            v=DMARC1; p=reject; pct=100; rua=mailto:rua@contoso.com;\n            ruf=mailto:ruf@contoso.com; fo=1\n            v=DMARC1; p=reject; pct=100; fo=1; ri=3600; rua=mailto:rua@contoso.com;\n            ruf=mailto:ruf@contoso.com\n            v=DMARC1; p=quarantine; pct=100; sp=none; fo=1; ri=3600; rua=mailto:rua@contoso.com;\n            ruf=ruf@contoso.com;\n        4.Ensure the Microsoft MOERA domain is also configured.\n            Resolve-DnsName _dmarc.[tenant].onmicrosoft.com txt\n        5.Ensure the record meets the same criteria listed in step #3.\"\n\n  desc 'fix',\n       \"To add DMARC records, use the following steps:\n        1.For each Exchange Online Accepted Domain, add the following record to DNS: Record: _dmarc.domain1.com Type: TXT Value: v=DMARC1; p=none; rua=mailto:<rua-report@example.com>; ruf=mailto:<ruf-report@example.com>\n        2.This will create a basic DMARC policy that will allow the organization to start monitoring message statistics.\n        3.The next steps will involve first implementing quarantine and next a reject policy with 100 percent of email is affected. Microsoft has a list of best practices for implementing DMARC that cover these steps in detail.\n    To establish a DMARC record for the MOERA domain:\n        1.Navigate to the Microsoft 365 admin center https://admin.microsoft.com/\n        2.Expand Settings and select Domains.\n        3.Select your tenant domain (for example, contoso.onmicrosoft.com).\n        4.Select DNS records and click + Add record.\n        5.Add a new record with the TXT name of _dmarc with the appropriate values outlined above.\n    Note: The remediation portion involves a multi-staged approach over a period of time. First, a baseline of the current state of email will be established with p=none and rua and ruf. Once the environment is better understood and reports have been analyzed an organization will move to the final state with dmarc record values as outlined in the audit section.\"\n\n  desc 'rationale',\n       \"DMARC strengthens the trustworthiness of messages sent from an organization's\n        domain to destination email systems. By integrating DMARC with SPF (Sender Policy\n        Framework) and DKIM (DomainKeys Identified Mail), organizations can significantly\n        enhance their defenses against email spoofing and phishing attempts.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['9.5'] }, { '7' => ['7.8'] }]\n  tag nist: ['SC-7']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/email-authentication-dmarc-configure?view=o365-worldwide'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/step-by-step-guides/how-to-enable-dmarc-reporting-for-microsoft-online-email-routing-address-moera-and-parked-domains?view=o365-worldwide'\n\n  # This does not work on Mac - need to find a different way to test. Additionally, CIS Benchmark says manual\n  domain_list = input('dmarc_domains')\n  domain_list.each do |domain|\n    check_dmarc_domain_script = %{\n      $client_id = '#{input('client_id')}'\n      $certificate_password = '#{input('certificate_password')}'\n      $certificate_path = '#{input('certificate_path')}'\n      $organization = '#{input('organization')}'\n      import-module exchangeonlinemanagement\n      Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n      Import-Module DNSClient\n      Resolve-DnsName _dmarc.#{domain} txt\n    }\n    describe \"Ensure the following DMARC domain (#{domain})\" do\n      subject { powershell(check_dmarc_domain_script).stdout.strip }\n      it %{should contain all parts following string: v=DMARC1; (p=quarantine OR p=reject), pct=100, rua=mailto:#{input('reporting_mail_address')} and ruf=mailto:#{input('reporting_mail_address')}} do\n        expect(subject).should match %{v=DMARC1;.*p=(quarantine|reject);.*pct=100;.*rua=mailto:.*ruf=mailto:#{input('reporting_mail_address')}}\n      end\n    end\n  end\n  domain_list_moera = input('moera_domains')\n  domain_list_moera.each do |domain|\n    check_moera_domain_script = %{\n      $client_id = '#{input('client_id')}'\n      $certificate_password = '#{input('certificate_password')}'\n      $certificate_path = '#{input('certificate_path')}'\n      $organization = '#{input('organization')}'\n      import-module exchangeonlinemanagement\n      Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n      Import-Module DNSClient\n      Resolve-DnsName _dmarc.#{domain}.onmicrosoft.com txt\n    }\n    describe \"Ensure the following MOERA domain (#{domain})\" do\n      subject { powershell(check_moera_domain_script).stdout.strip }\n      it %{should contain all parts following string: v=DMARC1; (p=quarantine OR p=reject), pct=100, rua=mailto:#{input('reporting_mail_address')} and ruf=mailto:#{input('reporting_mail_address')}} do\n        expect(subject).should match %{v=DMARC1;.*p=(quarantine|reject);.*pct=100;.*rua=mailto:.*ruf=mailto:#{input('reporting_mail_address')}}\n      end\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.1.10.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"Ensure the following DMARC domain (google.com)","run_time":9.0e-06,"start_time":"2024-09-24T15:38:36-04:00","resource":"","skip_message":"reporting_mail_address","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following DMARC domain (google.com)"},{"status":"skipped","code_desc":"Ensure the following DMARC domain (google.com)","run_time":1.0e-05,"start_time":"2024-09-24T15:38:36-04:00","resource":"","skip_message":"reporting_mail_address","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following DMARC domain (google.com)"},{"status":"failed","code_desc":"Ensure the following DMARC domain (google.com) should contain all parts following string: v=DMARC1; (p=quarantine OR p=reject), pct=100, rua=mailto:#<RSpec::Core::Example \"reporting_mail_address\"> and ruf=mailto:#<RSpec::Core::Example \"reporting_mail_address\">","run_time":7.025802,"start_time":"2024-09-24T15:38:36-04:00","message":"expected #<RSpec::Expectations::ValueExpectationTarget:0x000000011c67e950 @target=\"\"> to match \"v=DMARC1;.*p=(quarantine|reject);.*pct=100;.*rua=mailto:.*ruf=mailto:test@gmail.com\"\nDiff:\n@@ -1 +1 @@\n-\"v=DMARC1;.*p=(quarantine|reject);.*pct=100;.*rua=mailto:.*ruf=mailto:test@gmail.com\"\n+#<RSpec::Expectations::ValueExpectationTarget:0x000000011c67e950 @target=\"\">\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following DMARC domain (google.com)"},{"status":"skipped","code_desc":"Ensure the following MOERA domain (google.com)","run_time":1.2e-05,"start_time":"2024-09-24T15:38:43-04:00","resource":"","skip_message":"reporting_mail_address","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following MOERA domain (google.com)"},{"status":"skipped","code_desc":"Ensure the following MOERA domain (google.com)","run_time":5.0e-06,"start_time":"2024-09-24T15:38:43-04:00","resource":"","skip_message":"reporting_mail_address","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following MOERA domain (google.com)"},{"status":"failed","code_desc":"Ensure the following MOERA domain (google.com) should contain all parts following string: v=DMARC1; (p=quarantine OR p=reject), pct=100, rua=mailto:#<RSpec::Core::Example \"reporting_mail_address\"> and ruf=mailto:#<RSpec::Core::Example \"reporting_mail_address\">","run_time":7.691234,"start_time":"2024-09-24T15:38:43-04:00","message":"expected #<RSpec::Expectations::ValueExpectationTarget:0x000000011cc25de0 @target=\"\"> to match \"v=DMARC1;.*p=(quarantine|reject);.*pct=100;.*rua=mailto:.*ruf=mailto:test@gmail.com\"\nDiff:\n@@ -1 +1 @@\n-\"v=DMARC1;.*p=(quarantine|reject);.*pct=100;.*rua=mailto:.*ruf=mailto:test@gmail.com\"\n+#<RSpec::Expectations::ValueExpectationTarget:0x000000011cc25de0 @target=\"\">\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following MOERA domain (google.com)"}]},{"id":"microsoft-365-foundations-2.1.11","title":"Ensure the spoofed domains report is reviewed weekly","desc":"Use spoof intelligence in the Security Center on the Anti-spam settings page to review all senders who are spoofing either domains that are part of the organization or spoofing external domains. Spoof intelligence is available as part of Office 365 Enterprise E5 or separately as part of Defender for Office 365 and as of October 2018 Exchange Online Protection (EOP).","descriptions":[{"label":"default","data":"Use spoof intelligence in the Security Center on the Anti-spam settings page to review all senders who are spoofing either domains that are part of the organization or spoofing external domains. Spoof intelligence is available as part of Office 365 Enterprise E5 or separately as part of Defender for Office 365 and as of October 2018 Exchange Online Protection (EOP)."},{"label":"check","data":"To verify the report is being reviewed at least weekly, confirm that the necessary procedures are in place and being followed."},{"label":"fix","data":"To review the spoofed domains report:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2.Under Email & collaboration click on Policies & rules then select Threat policies.\n        3.Under Rules click on Tenant Allow / Block Lists then select Spoofed senders.\n        4.Review.\n    To view spoofed senders that were allowed or blocked by spoof intelligence in the last 7 days:\n        1.Connect to Exchange Online using Connect-ExchangeOnline.\n        2.Run the following PowerShell command:\n            Get-SpoofIntelligenceInsight\n        3.Review."},{"label":"rationale","data":"Bad actors spoof domains to trick users into conducting actions they normally would not\n        or should not via phishing emails. Running this report will inform the message\n        administrators of current activities, and the phishing techniques used by bad actors.\n        This information can be used to inform end users and plan against future campaigns."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/anti-spoofing-spoof-intelligence?view=o365-worldwide"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/exchange/get-spoofintelligenceinsight?view=exchange-ps"}],"tags":{"severity":"medium","cis_controls":[{"8":["8.11"]},{"7":["6.2"]}],"nist":["AU-6","AU-6(1)","AU-7(1)","AC-1","AC-2","AC-2(1)"]},"code":"control 'microsoft-365-foundations-2.1.11' do\n  title 'Ensure the spoofed domains report is reviewed weekly'\n  desc 'Use spoof intelligence in the Security Center on the Anti-spam settings page to review all senders who are spoofing either domains that are part of the organization or spoofing external domains. Spoof intelligence is available as part of Office 365 Enterprise E5 or separately as part of Defender for Office 365 and as of October 2018 Exchange Online Protection (EOP).'\n\n  desc 'check',\n       'To verify the report is being reviewed at least weekly, confirm that the necessary procedures are in place and being followed.'\n\n  desc 'fix',\n       \"To review the spoofed domains report:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2.Under Email & collaboration click on Policies & rules then select Threat policies.\n        3.Under Rules click on Tenant Allow / Block Lists then select Spoofed senders.\n        4.Review.\n    To view spoofed senders that were allowed or blocked by spoof intelligence in the last 7 days:\n        1.Connect to Exchange Online using Connect-ExchangeOnline.\n        2.Run the following PowerShell command:\n            Get-SpoofIntelligenceInsight\n        3.Review.\"\n\n  desc 'rationale',\n       \"Bad actors spoof domains to trick users into conducting actions they normally would not\n        or should not via phishing emails. Running this report will inform the message\n        administrators of current activities, and the phishing techniques used by bad actors.\n        This information can be used to inform end users and plan against future campaigns.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['8.11'] }, { '7' => ['6.2'] }]\n  tag nist: ['AU-6', 'AU-6(1)', 'AU-7(1)', 'AC-1', 'AC-2', 'AC-2(1)']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/anti-spoofing-spoof-intelligence?view=o365-worldwide'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/exchange/get-spoofintelligenceinsight?view=exchange-ps'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.1.11.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":1.4e-05,"start_time":"2024-09-24T15:38:50-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-2.1.12","title":"Ensure the Restricted entities' report is reviewed weekly","desc":"Microsoft 365 Defender reviews of Restricted Entities will provide a list of user accounts restricted from sending e-mail. If a user exceeds one of the outbound sending limits as specified in the service limits or in outbound spam policies, the user is restricted from sending email, but they can still receive email.","descriptions":[{"label":"default","data":"Microsoft 365 Defender reviews of Restricted Entities will provide a list of user accounts restricted from sending e-mail. If a user exceeds one of the outbound sending limits as specified in the service limits or in outbound spam policies, the user is restricted from sending email, but they can still receive email."},{"label":"check","data":"To verify the report is being reviewed at least weekly, confirm that the necessary procedures are in place and being followed."},{"label":"fix","data":"To review the report of users who have had their email privileges restricted due to spamming:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2.Under Email & collaboration navigate to Review.\n        3.Click Restricted Entities.\n        4.Review alerts and take appropriate action (unblocking) after account has been remediated.\n    Review a list of users blocked from sending messages using PowerShell:\n        1.Connect to Exchange Online using Connect-ExchangeOnline\n        2.Run the following PowerShell command:\n            Get-BlockedSenderAddress\n        3.Review."},{"label":"rationale","data":"Users who are found on the restricted users list have a high probability of having been\n        compromised. Review of this list will allow an organization to remediate these user\n        accounts, and then unblock them."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/responding-to-a-compromised-email-account?view=o365-worldwide"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/removing-user-from-restricted-users-portal-after-spam?view=o365-worldwide"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/exchange/get-blockedsenderaddress?view=exchange-ps"}],"tags":{"severity":"medium","cis_controls":[{"8":["8.11"]},{"7":["6.2"]}],"nist":["AU-6","AU-6(1)","AU-7(1)","AC-1","AC-2","AC-2(1)"]},"code":"control 'microsoft-365-foundations-2.1.12' do\n  title \"Ensure the Restricted entities' report is reviewed weekly\"\n  desc 'Microsoft 365 Defender reviews of Restricted Entities will provide a list of user accounts restricted from sending e-mail. If a user exceeds one of the outbound sending limits as specified in the service limits or in outbound spam policies, the user is restricted from sending email, but they can still receive email.'\n\n  desc 'check',\n       'To verify the report is being reviewed at least weekly, confirm that the necessary procedures are in place and being followed.'\n\n  desc 'fix',\n       \"To review the report of users who have had their email privileges restricted due to spamming:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2.Under Email & collaboration navigate to Review.\n        3.Click Restricted Entities.\n        4.Review alerts and take appropriate action (unblocking) after account has been remediated.\n    Review a list of users blocked from sending messages using PowerShell:\n        1.Connect to Exchange Online using Connect-ExchangeOnline\n        2.Run the following PowerShell command:\n            Get-BlockedSenderAddress\n        3.Review.\"\n\n  desc 'rationale',\n       \"Users who are found on the restricted users list have a high probability of having been\n        compromised. Review of this list will allow an organization to remediate these user\n        accounts, and then unblock them.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['8.11'] }, { '7' => ['6.2'] }]\n  tag nist: ['AU-6', 'AU-6(1)', 'AU-7(1)', 'AC-1', 'AC-2', 'AC-2(1)']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/responding-to-a-compromised-email-account?view=o365-worldwide'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/removing-user-from-restricted-users-portal-after-spam?view=o365-worldwide'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/exchange/get-blockedsenderaddress?view=exchange-ps'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.1.12.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":9.0e-06,"start_time":"2024-09-24T15:38:50-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-2.1.13","title":"Ensure malware trends are reviewed at least weekly","desc":"Threat explorer shows specific instances of Microsoft blocking a malware attachment from reaching users, phishing being blocked, impersonation attempts, etc. The report should be reviewed at least weekly.","descriptions":[{"label":"default","data":"Threat explorer shows specific instances of Microsoft blocking a malware attachment from reaching users, phishing being blocked, impersonation attempts, etc. The report should be reviewed at least weekly."},{"label":"check","data":"To verify the report is being reviewed at least weekly, confirm that the necessary procedures are in place and being followed."},{"label":"fix","data":"To remediate using the UI:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2.Click to expand Email & collaboration select Review.\n        3.Select Malware trends.\n        4.On the Threat Explorer page, select each tab to review statistics"},{"label":"rationale","data":"While this report isn't strictly actionable, reviewing it will give a sense of the overall\n        volume of various security threats targeting users, which may prompt adoption of more\n        aggressive threat mitigations."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/reports-email-security?view=o365-worldwide"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/threat-explorer-real-time-detections-about?view=o365-worldwide"}],"tags":{"severity":"medium","cis_controls":[{"8":["8.11"]},{"7":["6.2"]}],"nist":["AU-6","AU-6(1)","AU-7(1)","AC-1","AC-2","AC-2(1)"]},"code":"control 'microsoft-365-foundations-2.1.13' do\n  title 'Ensure malware trends are reviewed at least weekly'\n  desc 'Threat explorer shows specific instances of Microsoft blocking a malware attachment from reaching users, phishing being blocked, impersonation attempts, etc. The report should be reviewed at least weekly.'\n\n  desc 'check',\n       'To verify the report is being reviewed at least weekly, confirm that the necessary procedures are in place and being followed.'\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2.Click to expand Email & collaboration select Review.\n        3.Select Malware trends.\n        4.On the Threat Explorer page, select each tab to review statistics\"\n\n  desc 'rationale',\n       \"While this report isn't strictly actionable, reviewing it will give a sense of the overall\n        volume of various security threats targeting users, which may prompt adoption of more\n        aggressive threat mitigations.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['8.11'] }, { '7' => ['6.2'] }]\n  tag nist: ['AU-6', 'AU-6(1)', 'AU-7(1)', 'AC-1', 'AC-2', 'AC-2(1)']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/reports-email-security?view=o365-worldwide'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/threat-explorer-real-time-detections-about?view=o365-worldwide'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.1.13.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":9.0e-06,"start_time":"2024-09-24T15:38:50-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-2.1.14","title":"Ensure comprehensive attachment filtering is applied","desc":"The Common Attachment Types Filter lets a user block known and custom malicious file types from being attached to emails. The policy provided by Microsoft covers 53 extensions, and an additional custom list of extensions can be defined.\n        The list of 187 extensions provided in this recommendation is comprehensive but not exhaustive.","descriptions":[{"label":"default","data":"The Common Attachment Types Filter lets a user block known and custom malicious file types from being attached to emails. The policy provided by Microsoft covers 53 extensions, and an additional custom list of extensions can be defined.\n        The list of 187 extensions provided in this recommendation is comprehensive but not exhaustive."},{"label":"check","data":"Note: Utilizing the UI for auditing Anti-malware policies can be very time consuming so it is recommended to use a script like the one supplied below. To Audit using PowerShell:\n            1.Connect to Exchange Online using Connect-ExchangeOnline.\n            2.Run the following script:\n                # Evaluate each Malware policy containing over 120 extensions\n                # Output a report showing a list of missing extensions and other params.\n                $L2Extensions = @( \"7z\", \"a3x\", \"ace\", \"ade\", \"adp\", \"ani\", \"app\", \"appinstaller\", \"applescript\", \"application\", \"appref-ms\", \"appx\", \"appxbundle\", \"arj\", \"asd\", \"asx\", \"bas\", \"bat\", \"bgi\", \"bz2\", \"cab\", \"chm\", \"cmd\", \"com\", \"cpl\", \"crt\", \"cs\", \"csh\", \"daa\", \"dbf\", \"dcr\", \"deb\", \"desktopthemepackfile\", \"dex\", \"diagcab\", \"dif\", \"dir\", \"dll\", \"dmg\", \"doc\", \"docm\", \"dot\", \"dotm\", \"elf\", \"eml\", \"exe\", \"fxp\", \"gadget\", \"gz\", \"hlp\", \"hta\", \"htc\", \"htm\", \"htm\", \"html\", \"html\", \"hwpx\", \"ics\", \"img\", \"inf\", \"ins\", \"iqy\", \"iso\", \"isp\", \"jar\", \"jnlp\", \"js\", \"jse\", \"kext\", \"ksh\", \"lha\", \"lib\", \"library-ms\", \"lnk\", \"lzh\", \"macho\", \"mam\", \"mda\", \"mdb\", \"mde\", \"mdt\", \"mdw\", \"mdz\", \"mht\", \"mhtml\", \"mof\", \"msc\", \"msi\", \"msix\", \"msp\", \"msrcincident\", \"mst\", \"ocx\", \"odt\", \"ops\", \"oxps\", \"pcd\", \"pif\", \"plg\", \"pot\", \"potm\", \"ppa\", \"ppam\", \"ppkg\", \"pps\", \"ppsm\", \"ppt\", \"pptm\", \"prf\", \"prg\", \"ps1\", \"ps11\", \"ps11xml\", \"ps1xml\", \"ps2\", \"ps2xml\", \"psc1\", \"psc2\", \"pub\", \"py\", \"pyc\", \"pyo\", \"pyw\", \"pyz\", \"pyzw\", \"rar\", \"reg\", \"rev\", \"rtf\", \"scf\", \"scpt\", \"scr\", \"sct\", \"searchConnector-ms\", \"service\", \"settingcontent-ms\", \"sh\", \"shb\", \"shs\", \"shtm\", \"shtml\", \"sldm\", \"slk\", \"so\", \"spl\", \"stm\", \"svg\", \"swf\", \"sys\", \"tar\", \"theme\", \"themepack\", \"timer\", \"uif\", \"url\", \"uue\", \"vb\", \"vbe\", \"vbs\", \"vhd\", \"vhdx\", \"vxd\", \"wbk\", \"website\", \"wim\", \"wiz\", \"ws\", \"wsc\", \"wsf\", \"wsh\", \"xla\", \"xlam\", \"xlc\", \"xll\", \"xlm\", \"xls\", \"xlsb\", \"xlsm\", \"xlt\", \"xltm\", \"xlw\", \"xml\", \"xnk\", \"xps\", \"xsl\", \"xz\", \"z\" )\n                $MissingCount = 0\n                $ExtensionPolicies = $null\n                $RLine = $ExtensionReport = @()\n                $FilterRules = Get-MalwareFilterRule\n                $DateTime = $(((Get-Date).ToUniversalTime()).ToString(\"yyyyMMddTHHmmssZ\"))\n                $OutputFilePath = \"$PWD\\CIS-Report_$($DateTime).txt\"\n\n                $RLine += \"$(Get-Date)`n\"\n                function Test-MalwarePolicy {\n                    param (\n                        $PolicyId\n                    )\n                    # Find the matching rule for custom policies\n                    $FoundRule = $null\n                    $FoundRule = $FilterRules |\n                        Where-Object { $_.MalwareFilterPolicy -eq $PolicyId }\n                    if ($PolicyId.EnableFileFilter -eq $false) {\n                            $script:RLine += \"WARNING: Common attachments filter is disabled.\"\n                    }\n                    if ($FoundRule.State -eq 'Disabled') {\n                        $script:RLine += \"WARNING: The Anti-malware rule is disabled.\"\n                    }\n                    $script:RLine += \"`nManual review needed - Domains, inclusions and exclusions must be valid:\"\n                    $script:RLine += $FoundRule |\n                        Format-List Name, RecipientDomainIs, Sent*, Except*\n                    }\n                # Match any policy that has over 120 extensions defined\n                $ExtensionPolicies = Get-MalwareFilterPolicy |\n                    Where-Object {$_.FileTypes.Count -gt 120 }\n                if (!$ExtensionPolicies) {\n                    Write-Host \"`nFAIL: A policy containing the minimum number of extensions was not found.\" -ForegroundColor Red\n                    Write-Host \"Only policies with over 120 extensions defined will be evaluated.\" -ForegroundColor Red Exit\n                    }\n                # Check each policy for missing extensions\n                foreach ($policy in $ExtensionPolicies){\n                    $MissingExtensions = $L2Extensions |\n                    Where-Object {\n                        $extension = $_; -not $policy.FileTypes.Contains($extension)\n                        }\n                    if ($MissingExtensions.Count -eq 0) {\n                        $RLine += \"-\" * 60\n                        $RLine += \"[FOUND]\n                        $($policy.Identity)\"\n                        $RLine += \"-\" * 60\n                        $RLine += \"PASS: Policy contains all extensions\"\n                        Test-MalwarePolicy -PolicyId $policy\n                    } else {\n                        $MissingCount++\n                        $ExtensionReport += @{\n                            Identity = $policy.Identity\n                            MissingExtensions = $MissingExtensions -join\n                        }\n                    }\n                }\n                if ($MissingCount -gt 0) {\n                    foreach ($fpolicy in $ExtensionReport) {\n                        $RLine += \"-\" * 60\n                        $RLine += \"[PARTIAL]\n                        $($fpolicy.Identity)\"\n                        $RLine += \"-\" * 60\n                        $RLine += \"NOTICE - The following extensions were not found:`n\"\n                        $RLine += \"$($fpolicy.MissingExtensions)`n\" Test-MalwarePolicy -PolicyId $fpolicy.Identity\n                    }\n                }\n                # Output the report to a text file\n                Out-File -FilePath $OutputFilePath -InputObject $RLine\n                Get-Content $OutputFilePath\n                Write-Host \"`nLog file exported to\" $OutputFilePath\n            3.Review the exported results which are stored in the present working directory.\n            4.A pass for this recommendation is made when an active policy is in place that covers all extensions except for those explicitly defined as an exception by the organization. A passing policy must also be enabled and have the EnableFileFilter parameter enabled.\n            5.Review any manual steps listed in the output, exceptions and inclusions are organizational specific.\n        Note: Weighting by individual extension risk is beyond the scope of this document. Organizations should evaluate these both independently and based on business need."},{"label":"fix","data":"To Remediate using PowerShell:\n        1.Connect to Exchange Online using Connect-ExchangeOnline.\n        2.Run the following script:\n            # Create an attachment policy and associated rule. The rule is\n            # intentionally disabled allowing the org to enable it when ready\n            $Policy = @{\n                Name = \"CIS L2 Attachment Policy\"\n                EnableFileFilter = $true\n                ZapEnabled = $true\n                EnableInternalSenderAdminNotifications = $true\n                InternalSenderAdminAddress = 'admin@contoso.com' # Change this.\n            }\n            $L2Extensions = @(\n             \"7z\", \"a3x\", \"ace\", \"ade\", \"adp\", \"ani\", \"app\", \"appinstaller\", \"applescript\", \"application\", \"appref-ms\", \"appx\", \"appxbundle\", \"arj\", \"asd\", \"asx\", \"bas\", \"bat\", \"bgi\", \"bz2\", \"cab\", \"chm\", \"cmd\", \"com\", \"cpl\", \"crt\", \"cs\", \"csh\", \"daa\", \"dbf\", \"dcr\", \"deb\", \"desktopthemepackfile\", \"dex\", \"diagcab\", \"dif\", \"dir\", \"dll\", \"dmg\", \"doc\", \"docm\", \"dot\", \"dotm\", \"elf\", \"eml\", \"exe\", \"fxp\", \"gadget\", \"gz\", \"hlp\", \"hta\", \"htc\", \"htm\", \"htm\", \"html\", \"html\", \"hwpx\", \"ics\", \"img\", \"inf\", \"ins\", \"iqy\", \"iso\", \"isp\", \"jar\", \"jnlp\", \"js\", \"jse\", \"kext\", \"ksh\", \"lha\", \"lib\", \"library-ms\", \"lnk\", \"lzh\", \"macho\", \"mam\", \"mda\", \"mdb\", \"mde\", \"mdt\", \"mdw\", \"mdz\", \"mht\", \"mhtml\", \"mof\", \"msc\", \"msi\", \"msix\", \"msp\", \"msrcincident\", \"mst\", \"ocx\", \"odt\", \"ops\", \"oxps\", \"pcd\", \"pif\", \"plg\", \"pot\", \"potm\", \"ppa\", \"ppam\", \"ppkg\", \"pps\", \"ppsm\", \"ppt\", \"pptm\", \"prf\", \"prg\", \"ps1\", \"ps11\", \"ps11xml\", \"ps1xml\", \"ps2\", \"ps2xml\", \"psc1\", \"psc2\", \"pub\", \"py\", \"pyc\", \"pyo\", \"pyw\", \"pyz\", \"pyzw\", \"rar\", \"reg\", \"rev\", \"rtf\", \"scf\", \"scpt\", \"scr\", \"sct\", \"searchConnector-ms\", \"service\", \"settingcontent-ms\", \"sh\", \"shb\", \"shs\", \"shtm\", \"shtml\", \"sldm\", \"slk\", \"so\", \"spl\", \"stm\", \"svg\", \"swf\", \"sys\", \"tar\", \"theme\", \"themepack\", \"timer\", \"uif\", \"url\", \"uue\", \"vb\", \"vbe\", \"vbs\", \"vhd\", \"vhdx\", \"vxd\", \"wbk\", \"website\", \"wim\", \"wiz\", \"ws\", \"wsc\", \"wsf\", \"wsh\", \"xla\", \"xlam\", \"xlc\", \"xll\", \"xlm\", \"xls\", \"xlsb\", \"xlsm\", \"xlt\", \"xltm\", \"xlw\", \"xml\", \"xnk\", \"xps\", \"xsl\", \"xz\", \"z\"\n            )\n            # Create the policy\n            New-MalwareFilterPolicy @Policy -FileTypes $L2Extensions\n            # Create the rule for all accepted domains\n            $Rule = @{\n                Name = $Policy.Name\n                Enabled = $false\n                MalwareFilterPolicy = $Policy.Name\n                RecipientDomainIs = (Get-AcceptedDomain).Name\n                Priority = 0\n            }\n            New-MalwareFilterRule @Rule\n        3.When prepared enable the rule either through the UI or PowerShell.\n\n        Note: Due to the number of extensions the UI method is not covered. The objects can however be edited in the UI or manually added using the list from the script.\n            1.Navigate to Microsoft Defender at https://security.microsoft.com/\n            2.Browse to Policies & rules > Threat policies > Anti-malware."},{"label":"rationale","data":"Blocking known malicious file types can help prevent malware-infested files from\n        infecting a host or performing other malicious attacks such as phishing and data\n        extraction.\n        Defining a comprehensive list of attachments can help protect against additional\n        unknown and known threats. Many legacy file formats, binary files and compressed files\n        have been used as delivery mechanisms for malicious software. Organizations can\n        protect themselves from Business E-mail Compromise (BEC) by allow-listing only the\n        file types relevant to their line of business and blocking all others."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/powershell/module/exchange/get-malwarefilterpolicy?view=exchange-ps"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/anti-malware-policies-configure?view=o365-worldwide"},{"ref":"https://learn.microsoft.com/en-us/deployoffice/compat/office-file-format-reference"}],"tags":{"severity":"medium","cis_controls":[{"8":["9.6"]},{"7":["7.9"]},{"7":["8.1"]}],"default_value":"The following extensions are blocked by default:\n                    ace, ani, apk, app, appx, arj, bat, cab, cmd, com, deb, dex, dll, docm, elf, exe, hta, img,\n                    iso, jar, jnlp, kext, lha, lib, library, lnk, lzh, macho, msc, msi, msix, msp, mst, pif, ppa,\n                    ppam, reg, rev, scf, scr, sct, sys, uif, vb, vbe, vbs, vxd, wsc, wsf, wsh, xll, xz, z","nist":["SI-3","SI-8","AU-1","AU-2"]},"code":"control 'microsoft-365-foundations-2.1.14' do\n  title 'Ensure comprehensive attachment filtering is applied'\n  desc \"The Common Attachment Types Filter lets a user block known and custom malicious file types from being attached to emails. The policy provided by Microsoft covers 53 extensions, and an additional custom list of extensions can be defined.\n        The list of 187 extensions provided in this recommendation is comprehensive but not exhaustive.\"\n\n  desc 'check',\n       'Note: Utilizing the UI for auditing Anti-malware policies can be very time consuming so it is recommended to use a script like the one supplied below. To Audit using PowerShell:\n            1.Connect to Exchange Online using Connect-ExchangeOnline.\n            2.Run the following script:\n                # Evaluate each Malware policy containing over 120 extensions\n                # Output a report showing a list of missing extensions and other params.\n                $L2Extensions = @( \"7z\", \"a3x\", \"ace\", \"ade\", \"adp\", \"ani\", \"app\", \"appinstaller\", \"applescript\", \"application\", \"appref-ms\", \"appx\", \"appxbundle\", \"arj\", \"asd\", \"asx\", \"bas\", \"bat\", \"bgi\", \"bz2\", \"cab\", \"chm\", \"cmd\", \"com\", \"cpl\", \"crt\", \"cs\", \"csh\", \"daa\", \"dbf\", \"dcr\", \"deb\", \"desktopthemepackfile\", \"dex\", \"diagcab\", \"dif\", \"dir\", \"dll\", \"dmg\", \"doc\", \"docm\", \"dot\", \"dotm\", \"elf\", \"eml\", \"exe\", \"fxp\", \"gadget\", \"gz\", \"hlp\", \"hta\", \"htc\", \"htm\", \"htm\", \"html\", \"html\", \"hwpx\", \"ics\", \"img\", \"inf\", \"ins\", \"iqy\", \"iso\", \"isp\", \"jar\", \"jnlp\", \"js\", \"jse\", \"kext\", \"ksh\", \"lha\", \"lib\", \"library-ms\", \"lnk\", \"lzh\", \"macho\", \"mam\", \"mda\", \"mdb\", \"mde\", \"mdt\", \"mdw\", \"mdz\", \"mht\", \"mhtml\", \"mof\", \"msc\", \"msi\", \"msix\", \"msp\", \"msrcincident\", \"mst\", \"ocx\", \"odt\", \"ops\", \"oxps\", \"pcd\", \"pif\", \"plg\", \"pot\", \"potm\", \"ppa\", \"ppam\", \"ppkg\", \"pps\", \"ppsm\", \"ppt\", \"pptm\", \"prf\", \"prg\", \"ps1\", \"ps11\", \"ps11xml\", \"ps1xml\", \"ps2\", \"ps2xml\", \"psc1\", \"psc2\", \"pub\", \"py\", \"pyc\", \"pyo\", \"pyw\", \"pyz\", \"pyzw\", \"rar\", \"reg\", \"rev\", \"rtf\", \"scf\", \"scpt\", \"scr\", \"sct\", \"searchConnector-ms\", \"service\", \"settingcontent-ms\", \"sh\", \"shb\", \"shs\", \"shtm\", \"shtml\", \"sldm\", \"slk\", \"so\", \"spl\", \"stm\", \"svg\", \"swf\", \"sys\", \"tar\", \"theme\", \"themepack\", \"timer\", \"uif\", \"url\", \"uue\", \"vb\", \"vbe\", \"vbs\", \"vhd\", \"vhdx\", \"vxd\", \"wbk\", \"website\", \"wim\", \"wiz\", \"ws\", \"wsc\", \"wsf\", \"wsh\", \"xla\", \"xlam\", \"xlc\", \"xll\", \"xlm\", \"xls\", \"xlsb\", \"xlsm\", \"xlt\", \"xltm\", \"xlw\", \"xml\", \"xnk\", \"xps\", \"xsl\", \"xz\", \"z\" )\n                $MissingCount = 0\n                $ExtensionPolicies = $null\n                $RLine = $ExtensionReport = @()\n                $FilterRules = Get-MalwareFilterRule\n                $DateTime = $(((Get-Date).ToUniversalTime()).ToString(\"yyyyMMddTHHmmssZ\"))\n                $OutputFilePath = \"$PWD\\CIS-Report_$($DateTime).txt\"\n\n                $RLine += \"$(Get-Date)`n\"\n                function Test-MalwarePolicy {\n                    param (\n                        $PolicyId\n                    )\n                    # Find the matching rule for custom policies\n                    $FoundRule = $null\n                    $FoundRule = $FilterRules |\n                        Where-Object { $_.MalwareFilterPolicy -eq $PolicyId }\n                    if ($PolicyId.EnableFileFilter -eq $false) {\n                            $script:RLine += \"WARNING: Common attachments filter is disabled.\"\n                    }\n                    if ($FoundRule.State -eq \\'Disabled\\') {\n                        $script:RLine += \"WARNING: The Anti-malware rule is disabled.\"\n                    }\n                    $script:RLine += \"`nManual review needed - Domains, inclusions and exclusions must be valid:\"\n                    $script:RLine += $FoundRule |\n                        Format-List Name, RecipientDomainIs, Sent*, Except*\n                    }\n                # Match any policy that has over 120 extensions defined\n                $ExtensionPolicies = Get-MalwareFilterPolicy |\n                    Where-Object {$_.FileTypes.Count -gt 120 }\n                if (!$ExtensionPolicies) {\n                    Write-Host \"`nFAIL: A policy containing the minimum number of extensions was not found.\" -ForegroundColor Red\n                    Write-Host \"Only policies with over 120 extensions defined will be evaluated.\" -ForegroundColor Red Exit\n                    }\n                # Check each policy for missing extensions\n                foreach ($policy in $ExtensionPolicies){\n                    $MissingExtensions = $L2Extensions |\n                    Where-Object {\n                        $extension = $_; -not $policy.FileTypes.Contains($extension)\n                        }\n                    if ($MissingExtensions.Count -eq 0) {\n                        $RLine += \"-\" * 60\n                        $RLine += \"[FOUND]\n                        $($policy.Identity)\"\n                        $RLine += \"-\" * 60\n                        $RLine += \"PASS: Policy contains all extensions\"\n                        Test-MalwarePolicy -PolicyId $policy\n                    } else {\n                        $MissingCount++\n                        $ExtensionReport += @{\n                            Identity = $policy.Identity\n                            MissingExtensions = $MissingExtensions -join\n                        }\n                    }\n                }\n                if ($MissingCount -gt 0) {\n                    foreach ($fpolicy in $ExtensionReport) {\n                        $RLine += \"-\" * 60\n                        $RLine += \"[PARTIAL]\n                        $($fpolicy.Identity)\"\n                        $RLine += \"-\" * 60\n                        $RLine += \"NOTICE - The following extensions were not found:`n\"\n                        $RLine += \"$($fpolicy.MissingExtensions)`n\" Test-MalwarePolicy -PolicyId $fpolicy.Identity\n                    }\n                }\n                # Output the report to a text file\n                Out-File -FilePath $OutputFilePath -InputObject $RLine\n                Get-Content $OutputFilePath\n                Write-Host \"`nLog file exported to\" $OutputFilePath\n            3.Review the exported results which are stored in the present working directory.\n            4.A pass for this recommendation is made when an active policy is in place that covers all extensions except for those explicitly defined as an exception by the organization. A passing policy must also be enabled and have the EnableFileFilter parameter enabled.\n            5.Review any manual steps listed in the output, exceptions and inclusions are organizational specific.\n        Note: Weighting by individual extension risk is beyond the scope of this document. Organizations should evaluate these both independently and based on business need.'\n\n  desc 'fix',\n       'To Remediate using PowerShell:\n        1.Connect to Exchange Online using Connect-ExchangeOnline.\n        2.Run the following script:\n            # Create an attachment policy and associated rule. The rule is\n            # intentionally disabled allowing the org to enable it when ready\n            $Policy = @{\n                Name = \"CIS L2 Attachment Policy\"\n                EnableFileFilter = $true\n                ZapEnabled = $true\n                EnableInternalSenderAdminNotifications = $true\n                InternalSenderAdminAddress = \\'admin@contoso.com\\' # Change this.\n            }\n            $L2Extensions = @(\n             \"7z\", \"a3x\", \"ace\", \"ade\", \"adp\", \"ani\", \"app\", \"appinstaller\", \"applescript\", \"application\", \"appref-ms\", \"appx\", \"appxbundle\", \"arj\", \"asd\", \"asx\", \"bas\", \"bat\", \"bgi\", \"bz2\", \"cab\", \"chm\", \"cmd\", \"com\", \"cpl\", \"crt\", \"cs\", \"csh\", \"daa\", \"dbf\", \"dcr\", \"deb\", \"desktopthemepackfile\", \"dex\", \"diagcab\", \"dif\", \"dir\", \"dll\", \"dmg\", \"doc\", \"docm\", \"dot\", \"dotm\", \"elf\", \"eml\", \"exe\", \"fxp\", \"gadget\", \"gz\", \"hlp\", \"hta\", \"htc\", \"htm\", \"htm\", \"html\", \"html\", \"hwpx\", \"ics\", \"img\", \"inf\", \"ins\", \"iqy\", \"iso\", \"isp\", \"jar\", \"jnlp\", \"js\", \"jse\", \"kext\", \"ksh\", \"lha\", \"lib\", \"library-ms\", \"lnk\", \"lzh\", \"macho\", \"mam\", \"mda\", \"mdb\", \"mde\", \"mdt\", \"mdw\", \"mdz\", \"mht\", \"mhtml\", \"mof\", \"msc\", \"msi\", \"msix\", \"msp\", \"msrcincident\", \"mst\", \"ocx\", \"odt\", \"ops\", \"oxps\", \"pcd\", \"pif\", \"plg\", \"pot\", \"potm\", \"ppa\", \"ppam\", \"ppkg\", \"pps\", \"ppsm\", \"ppt\", \"pptm\", \"prf\", \"prg\", \"ps1\", \"ps11\", \"ps11xml\", \"ps1xml\", \"ps2\", \"ps2xml\", \"psc1\", \"psc2\", \"pub\", \"py\", \"pyc\", \"pyo\", \"pyw\", \"pyz\", \"pyzw\", \"rar\", \"reg\", \"rev\", \"rtf\", \"scf\", \"scpt\", \"scr\", \"sct\", \"searchConnector-ms\", \"service\", \"settingcontent-ms\", \"sh\", \"shb\", \"shs\", \"shtm\", \"shtml\", \"sldm\", \"slk\", \"so\", \"spl\", \"stm\", \"svg\", \"swf\", \"sys\", \"tar\", \"theme\", \"themepack\", \"timer\", \"uif\", \"url\", \"uue\", \"vb\", \"vbe\", \"vbs\", \"vhd\", \"vhdx\", \"vxd\", \"wbk\", \"website\", \"wim\", \"wiz\", \"ws\", \"wsc\", \"wsf\", \"wsh\", \"xla\", \"xlam\", \"xlc\", \"xll\", \"xlm\", \"xls\", \"xlsb\", \"xlsm\", \"xlt\", \"xltm\", \"xlw\", \"xml\", \"xnk\", \"xps\", \"xsl\", \"xz\", \"z\"\n            )\n            # Create the policy\n            New-MalwareFilterPolicy @Policy -FileTypes $L2Extensions\n            # Create the rule for all accepted domains\n            $Rule = @{\n                Name = $Policy.Name\n                Enabled = $false\n                MalwareFilterPolicy = $Policy.Name\n                RecipientDomainIs = (Get-AcceptedDomain).Name\n                Priority = 0\n            }\n            New-MalwareFilterRule @Rule\n        3.When prepared enable the rule either through the UI or PowerShell.\n\n        Note: Due to the number of extensions the UI method is not covered. The objects can however be edited in the UI or manually added using the list from the script.\n            1.Navigate to Microsoft Defender at https://security.microsoft.com/\n            2.Browse to Policies & rules > Threat policies > Anti-malware.'\n\n  desc 'rationale',\n       \"Blocking known malicious file types can help prevent malware-infested files from\n        infecting a host or performing other malicious attacks such as phishing and data\n        extraction.\n        Defining a comprehensive list of attachments can help protect against additional\n        unknown and known threats. Many legacy file formats, binary files and compressed files\n        have been used as delivery mechanisms for malicious software. Organizations can\n        protect themselves from Business E-mail Compromise (BEC) by allow-listing only the\n        file types relevant to their line of business and blocking all others.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['9.6'] }, { '7' => ['7.9'] }, { '7' => ['8.1'] }]\n  tag default_value: \"The following extensions are blocked by default:\n                    ace, ani, apk, app, appx, arj, bat, cab, cmd, com, deb, dex, dll, docm, elf, exe, hta, img,\n                    iso, jar, jnlp, kext, lha, lib, library, lnk, lzh, macho, msc, msi, msix, msp, mst, pif, ppa,\n                    ppam, reg, rev, scf, scr, sct, sys, uif, vb, vbe, vbs, vxd, wsc, wsf, wsh, xll, xz, z\"\n  tag nist: ['SI-3', 'SI-8', 'AU-1', 'AU-2']\n\n  ref 'https://learn.microsoft.com/en-us/powershell/module/exchange/get-malwarefilterpolicy?view=exchange-ps'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/anti-malware-policies-configure?view=o365-worldwide'\n  ref 'https://learn.microsoft.com/en-us/deployoffice/compat/office-file-format-reference'\n\n  def ruby_to_powershell(dictionary)\n    powershell_script = \"@{\\n\"\n    dictionary.each do |key, value|\n      if value.is_a?(Array)\n        powershell_script += \"    '#{key}' = @(\\n\"\n        value.each do |item|\n          powershell_script += \"        '#{item}',\\n\"\n        end\n        powershell_script.chomp!(\",\\n\")\n        powershell_script += \"\\n    )\\n\"\n      else\n        powershell_script += \"    '#{key}' = #{value.inspect}\\n\"\n      end\n    end\n    powershell_script += '}'\n    powershell_script\n  end\n\n  get_policies_script = %{\n   $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    $ExtensionPolicies = Get-MalwareFilterPolicy | Where-Object {$_.FileTypes.Count -gt 120 }\n    $ExtensionPolicies | ConvertTo-Json\n    }\n\n  get_polices_output = powershell(get_policies_script).stdout.strip\n  policy_list = JSON.parse(get_polices_output) unless get_polices_output.empty?\n  describe 'Ensure there is at least one policy that' do\n    subject { policy_list }\n    it 'covers at least 120 malware extensions' do\n      expect(subject).not_to be_nil\n    end\n  end\n  policy_list&.each do |_policy|\n    file_ext_list = _policy.map { |file_ext| \"'#{file_ext}'\" }.join(', ')\n    ensure_comprehensive_attachment_filtering_applied_script = %{\n        $client_id = '#{input('client_id')}'\n        $certificate_password = '#{input('certificate_password')}'\n        $certificate_path = '#{input('certificate_path')}'\n        $organization = '#{input('organization')}'\n        import-module exchangeonlinemanagement\n        Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n        $L2Extensions = @( \"7z\", \"a3x\", \"ace\", \"ade\", \"adp\", \"ani\", \"app\", \"appinstaller\", \"applescript\", \"application\", \"appref-ms\", \"appx\", \"appxbundle\", \"arj\", \"asd\", \"asx\", \"bas\", \"bat\", \"bgi\", \"bz2\", \"cab\", \"chm\", \"cmd\", \"com\", \"cpl\", \"crt\", \"cs\", \"csh\", \"daa\", \"dbf\", \"dcr\", \"deb\", \"desktopthemepackfile\", \"dex\", \"diagcab\", \"dif\", \"dir\", \"dll\", \"dmg\", \"doc\", \"docm\", \"dot\", \"dotm\", \"elf\", \"eml\", \"exe\", \"fxp\", \"gadget\", \"gz\", \"hlp\", \"hta\", \"htc\", \"htm\", \"htm\", \"html\", \"html\", \"hwpx\", \"ics\", \"img\", \"inf\", \"ins\", \"iqy\", \"iso\", \"isp\", \"jar\", \"jnlp\", \"js\", \"jse\", \"kext\", \"ksh\", \"lha\", \"lib\", \"library-ms\", \"lnk\", \"lzh\", \"macho\", \"mam\", \"mda\", \"mdb\", \"mde\", \"mdt\", \"mdw\", \"mdz\", \"mht\", \"mhtml\", \"mof\", \"msc\", \"msi\", \"msix\", \"msp\", \"msrcincident\", \"mst\", \"ocx\", \"odt\", \"ops\", \"oxps\", \"pcd\", \"pif\", \"plg\", \"pot\", \"potm\", \"ppa\", \"ppam\", \"ppkg\", \"pps\", \"ppsm\", \"ppt\", \"pptm\", \"prf\", \"prg\", \"ps1\", \"ps11\", \"ps11xml\", \"ps1xml\", \"ps2\", \"ps2xml\", \"psc1\", \"psc2\", \"pub\", \"py\", \"pyc\", \"pyo\", \"pyw\", \"pyz\", \"pyzw\", \"rar\", \"reg\", \"rev\", \"rtf\", \"scf\", \"scpt\", \"scr\", \"sct\", \"searchConnector-ms\", \"service\", \"settingcontent-ms\", \"sh\", \"shb\", \"shs\", \"shtm\", \"shtml\", \"sldm\", \"slk\", \"so\", \"spl\", \"stm\", \"svg\", \"swf\", \"sys\", \"tar\", \"theme\", \"themepack\", \"timer\", \"uif\", \"url\", \"uue\", \"vb\", \"vbe\", \"vbs\", \"vhd\", \"vhdx\", \"vxd\", \"wbk\", \"website\", \"wim\", \"wiz\", \"ws\", \"wsc\", \"wsf\", \"wsh\", \"xla\", \"xlam\", \"xlc\", \"xll\", \"xlm\", \"xls\", \"xlsb\", \"xlsm\", \"xlt\", \"xltm\", \"xlw\", \"xml\", \"xnk\", \"xps\", \"xsl\", \"xz\", \"z\" )\n        $MissingCount = 0\n        $ExtensionPolicies = $null\n        $RLine = $ExtensionReport = @()\n        $FilterRules = Get-MalwareFilterRule\n        $DateTime = $(((Get-Date).ToUniversalTime()).ToString(\"yyyyMMddTHHmmssZ\"))\n        $OutputFilePath = \"$PWD\\\\CIS-Report_$($DateTime).txt\"\n        function Test-MalwarePolicy {\n          param ( $PolicyId )\n          $FoundRule = $null\n          $FoundRule = $FilterRules | Where-Object { $_.MalwareFilterPolicy -eq $PolicyId }\n          if ($PolicyId.EnableFileFilter -eq $false) { $script:RLine += \"WARNING: Common attachments filter is disabled.\" }\n          if ($FoundRule.State -eq 'Disabled') { $script:RLine += \"WARNING: The Anti-malware rule is disabled.\" }\n          $script:RLine += \"`nManual review needed - Domains, inclusions and exclusions must be valid:\"\n          $script:RLine += $FoundRule | Format-List Name, RecipientDomainIs, Sent*, Except*\n        }\n        $ExtensionPolicies = Get-MalwareFilterPolicy | Where-Object {$_.FileTypes.Count -gt 120 }\n        if (!$ExtensionPolicies) {\n          Write-Host \"`nFAIL: A policy containing the minimum number of extensions was not found.\" -ForegroundColor Red\n          Write-Host \"Only policies with over 120 extensions defined will be evaluated.\" -ForegroundColor Red\n          Exit\n        }\n\n        $MissingExtensions = $L2Extensions | Where-Object { $extension = $_; -not @(#{file_ext_list}).Contains($extension) }\n        if ($MissingExtensions.Count -eq 0) {\n            $RLine += \"[FOUND] $(#{_policy['Identity']})\"\n            $RLine += \"PASS: Policy contains all extensions\"\n            Test-MalwarePolicy -PolicyId #{ruby_to_powershell(_policy)}\n        } else {\n            $MissingCount++\n            $ExtensionReport += @{ Identity = #{_policy['Identity']}; MissingExtensions = $MissingExtensions -join ', ' }\n        }\n\n        if ($MissingCount -gt 0) {\n            $RLine += \"[PARTIAL Extentions Missing] $(#{_policy['Identity']})\"\n            $RLine += \"NOTICE - The following extensions were not found:`n\"\n            $RLine += \"$(#{_policy['MissingExtensions']})`n\"\n            Test-MalwarePolicy -PolicyId #{ruby_to_powershell(_policy)}\n        }\n        Write-Output $RLine\n      }\n\n    describe \"Ensure the following malware policy (#{_policy['Identity']})\" do\n      subject { powershell(ensure_comprehensive_attachment_filtering_applied_script).stdout.strip }\n      it 'should cover and contain all malware extensions' do\n        expect(subject).to include 'PASS: Policy contains all extensions'\n      end\n      it 'should be enabled' do\n        expect(subject).to_not include 'WARNING: The Anti-malware rule is disabled.'\n      end\n      it 'should have its EnableFileFilter state be enabled' do\n        expect(subject).to_not include 'WARNING: Common attachments filter is disabled.'\n      end\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.1.14.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure there is at least one policy that covers at least 120 malware extensions","run_time":0.000156,"start_time":"2024-09-24T15:38:50-04:00","message":"expected: not nil\n     got: nil","resource_class":"Object","resource_params":"[]","resource_id":"Ensure there is at least one policy that"}]},{"id":"microsoft-365-foundations-2.1.2","title":"Ensure the Common Attachment Types Filter is enabled","desc":"The Common Attachment Types Filter lets a user block known and custom malicious file types from being attached to emails.","descriptions":[{"label":"default","data":"The Common Attachment Types Filter lets a user block known and custom malicious file types from being attached to emails."},{"label":"check","data":"Ensure the Common Attachment Types Filter is enabled:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Click to expand Email & collaboration select Policies & rules.\n        3. On the Policies & rules page select Threat policies.\n        4. Under polices select Anti-malware and click on the Default (Default) policy.\n        5. On the policy page that appears on the righthand pane, under Protection settings, verify that the Enable the common attachments filter has the value of On.\n    To verify the Common Attachment Types Filter is enabled using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following Exchange Online PowerShell command:\n            Get-MalwareFilterPolicy -Identity Default | Select-Object EnableFileFilter\n        3. Verify EnableFileFilter is set to True.\n    NOTE: Audit and Remediation guidance may focus on the Default policy however, if a Custom Policy exists in the organization's tenant then ensure the setting is set as outlined in the highest priority policy listed."},{"label":"fix","data":"To enable the Common Attachment Types Filter:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Click to expand Email & collaboration select Policies & rules.\n        3. On the Policies & rules page select Threat policies.\n        4. Under polices select Anti-malware and click on the Default (Default) policy.\n        5. On the Policy page that appears on the right hand pane scroll to the bottom and click on Edit protection settings, check the Enable the common attachments filter.\n        6. Click Save.\n    To enable the Common Attachment Types Filter using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following Exchange Online PowerShell command: Set-MalwareFilterPolicy -Identity Default -EnableFileFilter $true\n    NOTE: Audit and Remediation guidance may focus on the Default policy however, if a Custom Policy exists in the organization's tenant then ensure the setting is set as outlined in the highest priority policy listed."},{"label":"rationale","data":"Blocking known malicious file types can help prevent malware-infested files from infecting a host."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/powershell/module/exchange/get-malwarefilterpolicy?view=exchange-ps"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/anti-malware-policies-configure?view=o365-worldwide"}],"tags":{"severity":"medium","cis_controls":[{"8":["9.6"]},{"7":["7.9"]},{"7":["8.1"]}],"default_value":"Always on","nist":["SI-3","SI-8","AU-1","AU-2",""]},"code":"control 'microsoft-365-foundations-2.1.2' do\n  title 'Ensure the Common Attachment Types Filter is enabled'\n  desc 'The Common Attachment Types Filter lets a user block known and custom malicious file types from being attached to emails.'\n\n  desc 'check',\n       \"Ensure the Common Attachment Types Filter is enabled:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Click to expand Email & collaboration select Policies & rules.\n        3. On the Policies & rules page select Threat policies.\n        4. Under polices select Anti-malware and click on the Default (Default) policy.\n        5. On the policy page that appears on the righthand pane, under Protection settings, verify that the Enable the common attachments filter has the value of On.\n    To verify the Common Attachment Types Filter is enabled using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following Exchange Online PowerShell command:\n            Get-MalwareFilterPolicy -Identity Default | Select-Object EnableFileFilter\n        3. Verify EnableFileFilter is set to True.\n    NOTE: Audit and Remediation guidance may focus on the Default policy however, if a Custom Policy exists in the organization's tenant then ensure the setting is set as outlined in the highest priority policy listed.\"\n\n  desc 'fix',\n       \"To enable the Common Attachment Types Filter:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Click to expand Email & collaboration select Policies & rules.\n        3. On the Policies & rules page select Threat policies.\n        4. Under polices select Anti-malware and click on the Default (Default) policy.\n        5. On the Policy page that appears on the right hand pane scroll to the bottom and click on Edit protection settings, check the Enable the common attachments filter.\n        6. Click Save.\n    To enable the Common Attachment Types Filter using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following Exchange Online PowerShell command: Set-MalwareFilterPolicy -Identity Default -EnableFileFilter $true\n    NOTE: Audit and Remediation guidance may focus on the Default policy however, if a Custom Policy exists in the organization's tenant then ensure the setting is set as outlined in the highest priority policy listed.\"\n\n  desc 'rationale',\n       'Blocking known malicious file types can help prevent malware-infested files from infecting a host.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['9.6'] }, { '7' => ['7.9'] }, { '7' => ['8.1'] }]\n  tag default_value: 'Always on'\n  tag nist: ['SI-3', 'SI-8', 'AU-1', 'AU-2', '']\n\n  ref 'https://learn.microsoft.com/en-us/powershell/module/exchange/get-malwarefilterpolicy?view=exchange-ps'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/anti-malware-policies-configure?view=o365-worldwide'\n\n  ensure_common_attachment_types_filter_enabled_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    Get-MalwareFilterPolicy -Identity Default | Select-Object -ExpandProperty EnableFileFilter\n }\n\n  powershell_output = powershell(ensure_common_attachment_types_filter_enabled_script)\n  describe 'Ensure the EnableFileFilter option from Get-MalwareFilterPolicy' do\n    subject { powershell_output.stdout.strip }\n    it 'is set to True' do\n      expect(subject).to eq('True')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.1.2.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the EnableFileFilter option from Get-MalwareFilterPolicy is set to True","run_time":8.193536,"start_time":"2024-09-24T15:38:50-04:00","message":"\nexpected: \"True\"\n     got: \"False\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the EnableFileFilter option from Get-MalwareFilterPolicy"}]},{"id":"microsoft-365-foundations-2.1.3","title":"Ensure notifications for internal users sending malware is Enabled","desc":"Exchange Online Protection (EOP) is the cloud-based filtering service that protects organizations against spam, malware, and other email threats. EOP is included in all Microsoft 365 organizations with Exchange Online mailboxes.\n        EOP uses flexible anti-malware policies for malware protection settings. These policies can be set to notify Admins of malicious activity.","descriptions":[{"label":"default","data":"Exchange Online Protection (EOP) is the cloud-based filtering service that protects organizations against spam, malware, and other email threats. EOP is included in all Microsoft 365 organizations with Exchange Online mailboxes.\n        EOP uses flexible anti-malware policies for malware protection settings. These policies can be set to notify Admins of malicious activity."},{"label":"check","data":"Ensure notifications for internal users sending malware is Enabled:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Click to expand E-mail & Collaboration select Policies & rules.\n        3. On the Policies & rules page select Threat policies.\n        4. Under Policies select Anti-malware.\n        5. Click on the Default (Default) policy.\n        6. Ensure the setting Notify an admin about undelivered messages from internal senders is set to On and that there is at least one email address under Administrator email address.\n    To audit using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following command:\n            Get-MalwareFilterPolicy | fl Identity, EnableInternalSenderAdminNotifications, InternalSenderAdminAddress\n    NOTE: Audit and Remediation guidance may focus on the Default policy however, if a Custom Policy exists in the organization's tenant then ensure the setting is set as outlined in the highest priority policy listed."},{"label":"fix","data":"To enable notifications for internal users sending malware:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Click to expand E-mail & Collaboration select Policies & rules.\n        3. On the Policies & rules page select Threat policies.\n        4. Under Policies select Anti-malware.\n        5. Click on the Default (Default) policy.\n        6. Click on Edit protection settings and change the settings for Notify an admin about undelivered messages from internal senders to On and enter the email address of the administrator who should be notified under Administrator email address.\n        7. Click Save.\n    To remediate using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following command:\n            Set-MalwareFilterPolicy -Identity '{Identity Name}' -EnableInternalSenderAdminNotifications $True -InternalSenderAdminAddress {admin@domain1.com}\n    NOTE: Audit and Remediation guidance may focus on the Default policy however, if a Custom Policy exists in the organization's tenant then ensure the setting is set as outlined in the highest priority policy listed."},{"label":"rationale","data":"This setting alerts administrators that an internal user sent a message that contained malware. This may indicate an account or machine compromise that would need to be investigated."}],"impact":0.5,"refs":[],"tags":{"severity":"medium","cis_controls":[{"8":["17.5"]},{"7":["7.1"]},{"7":["8.1"]}],"default_value":"EnableInternalSenderAdminNotifications : False\n                      InternalSenderAdminAddress : $null","nist":["IR-1","IR-8","RA-5","AU-1","AU-2"]},"code":"control 'microsoft-365-foundations-2.1.3' do\n  title 'Ensure notifications for internal users sending malware is Enabled'\n  desc \"Exchange Online Protection (EOP) is the cloud-based filtering service that protects organizations against spam, malware, and other email threats. EOP is included in all Microsoft 365 organizations with Exchange Online mailboxes.\n        EOP uses flexible anti-malware policies for malware protection settings. These policies can be set to notify Admins of malicious activity.\"\n\n  desc 'check',\n       \"Ensure notifications for internal users sending malware is Enabled:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Click to expand E-mail & Collaboration select Policies & rules.\n        3. On the Policies & rules page select Threat policies.\n        4. Under Policies select Anti-malware.\n        5. Click on the Default (Default) policy.\n        6. Ensure the setting Notify an admin about undelivered messages from internal senders is set to On and that there is at least one email address under Administrator email address.\n    To audit using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following command:\n            Get-MalwareFilterPolicy | fl Identity, EnableInternalSenderAdminNotifications, InternalSenderAdminAddress\n    NOTE: Audit and Remediation guidance may focus on the Default policy however, if a Custom Policy exists in the organization's tenant then ensure the setting is set as outlined in the highest priority policy listed.\"\n\n  desc 'fix',\n       \"To enable notifications for internal users sending malware:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Click to expand E-mail & Collaboration select Policies & rules.\n        3. On the Policies & rules page select Threat policies.\n        4. Under Policies select Anti-malware.\n        5. Click on the Default (Default) policy.\n        6. Click on Edit protection settings and change the settings for Notify an admin about undelivered messages from internal senders to On and enter the email address of the administrator who should be notified under Administrator email address.\n        7. Click Save.\n    To remediate using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following command:\n            Set-MalwareFilterPolicy -Identity '{Identity Name}' -EnableInternalSenderAdminNotifications $True -InternalSenderAdminAddress {admin@domain1.com}\n    NOTE: Audit and Remediation guidance may focus on the Default policy however, if a Custom Policy exists in the organization's tenant then ensure the setting is set as outlined in the highest priority policy listed.\"\n\n  desc 'rationale',\n       'This setting alerts administrators that an internal user sent a message that contained malware. This may indicate an account or machine compromise that would need to be investigated.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [\n    { '8' => ['17.5'] },\n    { '7' => ['7.1'] },\n    { '7' => ['8.1'] }\n  ]\n  tag default_value: \"EnableInternalSenderAdminNotifications : False\n                      InternalSenderAdminAddress : $null\"\n  tag nist: ['IR-1', 'IR-8', 'RA-5', 'AU-1', 'AU-2']\n\n  ensure_notifications_for_internal_users_sending_malware_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    Get-MalwareFilterPolicy | Select-Object Identity, EnableInternalSenderAdminNotifications, InternalSenderAdminAddress | ConvertTo-Json\n }\n  powershell_output = JSON.parse(powershell(ensure_notifications_for_internal_users_sending_malware_script).stdout.strip)\n  case powershell_output\n  when Hash\n    describe \"Ensure the following policy (#{powershell_output['Identity']})\" do\n      it 'should have EnableInternalSenderAdminNotifications set to true' do\n        expect(powershell_output['EnableInternalSenderAdminNotifications']).to eq(true)\n      end\n\n      it 'should have a non-empty InternalSenderAdminAddress' do\n        expect(powershell_output['InternalSenderAdminAddress']).not_to be_empty\n      end\n    end\n  when Array\n    powershell_output.each do |policy|\n      describe %(Ensure the following policy (#{policy['Identity']})) do\n        it 'should have EnableInternalSenderAdminNotifications set to true' do\n          expect(policy['EnableInternalSenderAdminNotifications']).to eq(true)\n        end\n        it 'should have a non-empty InternalSenderAdminAddress' do\n          expect(policy['InternalSenderAdminAddress']).not_to be_empty\n        end\n      end\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.1.3.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the following policy (Default) should have EnableInternalSenderAdminNotifications set to true","run_time":0.001776,"start_time":"2024-09-24T15:38:58-04:00","message":"\nexpected: true\n     got: false\n\n(compared using ==)\n\nDiff:\n@@ -1 +1 @@\n-true\n+false\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following policy (Default)"},{"status":"failed","code_desc":"Ensure the following policy (Default) should have a non-empty InternalSenderAdminAddress","run_time":0.002877,"start_time":"2024-09-24T15:38:58-04:00","message":"expected `\"\".empty?` to be falsey, got true","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following policy (Default)"}]},{"id":"microsoft-365-foundations-2.1.4","title":"(L2) Ensure Safe Attachments policy is enabled","desc":"The Safe Attachments policy helps protect users from malware in email attachments by scanning attachments for viruses, malware, and other malicious content. When an email attachment is received by a user, Safe Attachments will scan the attachment in a secure environment and provide a verdict on whether the attachment is safe or not.","descriptions":[{"label":"default","data":"The Safe Attachments policy helps protect users from malware in email attachments by scanning attachments for viruses, malware, and other malicious content. When an email attachment is received by a user, Safe Attachments will scan the attachment in a secure environment and provide a verdict on whether the attachment is safe or not."},{"label":"check","data":"Ensure Safe Attachments policy is enabled:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Click to expand E-mail & Collaboration select Policies & rules.\n        3. On the Policies & rules page select Threat policies.\n        4. Under Policies select Safe Attachments.\n        5. Inspect the highest priority policy.\n        6. Ensure Users and domains and Included recipient domains are in scope for the organization.\n        7. Ensure Safe Attachments detection response: is set to Block - Block current and future messages and attachments with detected malware.\n        8. Ensure the Quarantine Policy is set to AdminOnlyAccessPolicy.\n        9. Ensure the policy is not disabled.\n    To verify the Safe Attachments policy is enabled using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Get-SafeAttachmentPolicy | where-object {$_.Enable -eq \"True\"}"},{"label":"fix","data":"To enable the Safe Attachments policy:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Click to expand E-mail & Collaboration select Policies & rules.\n        3. On the Policies & rules page select Threat policies.\n        4. Under Policies select Safe Attachments.\n        5. Click + Create.\n        6. Create a Policy Name and Description, and then click Next.\n        7. Select all valid domains and click Next.\n        8. Select Block.\n        9. Quarantine policy is AdminOnlyAccessPolicy.\n        10. Leave Enable redirect unchecked.\n        11. Click Next and finally Submit."},{"label":"rationale","data":"Enabling Safe Attachments policy helps protect against malware threats in email attachments by analyzing suspicious attachments in a secure, cloud-based environment before they are delivered to the user's inbox. This provides an additional layer of security and can prevent new or unseen types of malware from infiltrating the organization's network."}],"impact":0.5,"refs":[],"tags":{"severity":"medium","cis_controls":[{"8":["9.7"]},{"7":["7.10"]},{"7":["8.1"]}],"default_value":"disabled","nist":["SI-3","SI-8","AU-1","AU-2"]},"code":"control 'microsoft-365-foundations-2.1.4' do\n  title '(L2) Ensure Safe Attachments policy is enabled'\n  desc 'The Safe Attachments policy helps protect users from malware in email attachments by scanning attachments for viruses, malware, and other malicious content. When an email attachment is received by a user, Safe Attachments will scan the attachment in a secure environment and provide a verdict on whether the attachment is safe or not.'\n\n  desc 'check',\n       'Ensure Safe Attachments policy is enabled:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Click to expand E-mail & Collaboration select Policies & rules.\n        3. On the Policies & rules page select Threat policies.\n        4. Under Policies select Safe Attachments.\n        5. Inspect the highest priority policy.\n        6. Ensure Users and domains and Included recipient domains are in scope for the organization.\n        7. Ensure Safe Attachments detection response: is set to Block - Block current and future messages and attachments with detected malware.\n        8. Ensure the Quarantine Policy is set to AdminOnlyAccessPolicy.\n        9. Ensure the policy is not disabled.\n    To verify the Safe Attachments policy is enabled using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Get-SafeAttachmentPolicy | where-object {$_.Enable -eq \"True\"}'\n\n  desc 'fix',\n       \"To enable the Safe Attachments policy:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Click to expand E-mail & Collaboration select Policies & rules.\n        3. On the Policies & rules page select Threat policies.\n        4. Under Policies select Safe Attachments.\n        5. Click + Create.\n        6. Create a Policy Name and Description, and then click Next.\n        7. Select all valid domains and click Next.\n        8. Select Block.\n        9. Quarantine policy is AdminOnlyAccessPolicy.\n        10. Leave Enable redirect unchecked.\n        11. Click Next and finally Submit.\"\n\n  desc 'rationale',\n       \"Enabling Safe Attachments policy helps protect against malware threats in email attachments by analyzing suspicious attachments in a secure, cloud-based environment before they are delivered to the user's inbox. This provides an additional layer of security and can prevent new or unseen types of malware from infiltrating the organization's network.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [\n    { '8' => ['9.7'] },\n    { '7' => ['7.10'] },\n    { '7' => ['8.1'] }\n  ]\n  tag default_value: 'disabled'\n  tag nist: ['SI-3', 'SI-8', 'AU-1', 'AU-2']\n\n  ensure_safe_attachments_policy_enabled_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    Get-SafeAttachmentPolicy | where-object {$_.Enable -eq \"True\"}\n }\n\n  powershell_output = powershell(ensure_safe_attachments_policy_enabled_script)\n  describe 'Ensure that there is at least one Safe Attachment policy with an Enabled state that' do\n    subject { powershell_output.stdout.strip }\n    it 'is set to True' do\n      expect(subject).not_to be_empty\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.1.4.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure that there is at least one Safe Attachment policy with an Enabled state that is set to True","run_time":8.052458,"start_time":"2024-09-24T15:38:58-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that there is at least one Safe Attachment policy with an Enabled state that"}]},{"id":"microsoft-365-foundations-2.1.5","title":"Ensure Safe Attachments for SharePoint, OneDrive, and Microsoft Teams is Enabled","desc":"Safe Attachments for SharePoint, OneDrive, and Microsoft Teams scans these services for malicious files.","descriptions":[{"label":"default","data":"Safe Attachments for SharePoint, OneDrive, and Microsoft Teams scans these services for malicious files."},{"label":"check","data":"Ensure Safe Attachments for SharePoint, OneDrive, and Microsoft Teams is Enabled:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com\n        2. Under Email & collaboration select Policies & rules\n        3. Select Threat policies then Safe Attachments.\n        4. Click on Global settings\n        5. Ensure the toggle is Enabled to Turn on Defender for Office 365 for SharePoint, OneDrive, and Microsoft Teams.\n        6. Ensure the toggle is Enabled to Turn on Safe Documents for Office clients.\n        7. Ensure the toggle is Deselected/Disabled to Allow people to click through Protected View even if Safe Documents identified the file as malicious.\n    To audit using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Get-AtpPolicyForO365 | fl Name,EnableATPForSPOTeamsODB,EnableSafeDocs,AllowSafeDocsOpen\n        Verify the values for each parameter as below:\n            EnableATPForSPOTeamsODB : True\n            EnableSafeDocs : True\n            AllowSafeDocsOpen : False"},{"label":"fix","data":"To enable Safe Attachments for SharePoint, OneDrive, and Microsoft Teams:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com\n        2. Under Email & collaboration select Policies & rules\n        3. Select Threat policies then Safe Attachments.\n        4. Click on Global settings\n        5. Click to Enable Turn on Defender for Office 365 for SharePoint, OneDrive, and Microsoft Teams\n        6. Click to Enable Turn on Safe Documents for Office clients\n        7. Click to Disable Allow people to click through Protected View even if Safe Documents identified the file as malicious.\n        8. Click Save\n    To remediate using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Set-AtpPolicyForO365 -EnableATPForSPOTeamsODB $true -EnableSafeDocs $true -AllowSafeDocsOpen $false"},{"label":"rationale","data":"Safe Attachments for SharePoint, OneDrive, and Microsoft Teams protect organizations from inadvertently sharing malicious files. When a malicious file is detected that file is blocked so that no one can open, copy, move, or share it until further actions are taken by the organization's security team."}],"impact":0.5,"refs":[],"tags":{"severity":"medium","cis_controls":[{"8":["9.7"]},{"8":["10.1"]},{"7":["7.10"]},{"7":["8.1"]}],"nist":["SI-3","SI-8","AU-1","AU-2"]},"code":"control 'microsoft-365-foundations-2.1.5' do\n  title 'Ensure Safe Attachments for SharePoint, OneDrive, and Microsoft Teams is Enabled'\n  desc 'Safe Attachments for SharePoint, OneDrive, and Microsoft Teams scans these services for malicious files.'\n\n  desc 'check',\n       \"Ensure Safe Attachments for SharePoint, OneDrive, and Microsoft Teams is Enabled:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com\n        2. Under Email & collaboration select Policies & rules\n        3. Select Threat policies then Safe Attachments.\n        4. Click on Global settings\n        5. Ensure the toggle is Enabled to Turn on Defender for Office 365 for SharePoint, OneDrive, and Microsoft Teams.\n        6. Ensure the toggle is Enabled to Turn on Safe Documents for Office clients.\n        7. Ensure the toggle is Deselected/Disabled to Allow people to click through Protected View even if Safe Documents identified the file as malicious.\n    To audit using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Get-AtpPolicyForO365 | fl Name,EnableATPForSPOTeamsODB,EnableSafeDocs,AllowSafeDocsOpen\n        Verify the values for each parameter as below:\n            EnableATPForSPOTeamsODB : True\n            EnableSafeDocs : True\n            AllowSafeDocsOpen : False\"\n\n  desc 'fix',\n       \"To enable Safe Attachments for SharePoint, OneDrive, and Microsoft Teams:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com\n        2. Under Email & collaboration select Policies & rules\n        3. Select Threat policies then Safe Attachments.\n        4. Click on Global settings\n        5. Click to Enable Turn on Defender for Office 365 for SharePoint, OneDrive, and Microsoft Teams\n        6. Click to Enable Turn on Safe Documents for Office clients\n        7. Click to Disable Allow people to click through Protected View even if Safe Documents identified the file as malicious.\n        8. Click Save\n    To remediate using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Set-AtpPolicyForO365 -EnableATPForSPOTeamsODB $true -EnableSafeDocs $true -AllowSafeDocsOpen $false\"\n\n  desc 'rationale',\n       \"Safe Attachments for SharePoint, OneDrive, and Microsoft Teams protect organizations from inadvertently sharing malicious files. When a malicious file is detected that file is blocked so that no one can open, copy, move, or share it until further actions are taken by the organization's security team.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [\n    { '8' => ['9.7'] },\n    { '8' => ['10.1'] },\n    { '7' => ['7.10'] },\n    { '7' => ['8.1'] }\n  ]\n  tag nist: ['SI-3', 'SI-8', 'AU-1', 'AU-2']\n\n  ensure_safe_attachments_for_msproducts_enabled_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    Get-AtpPolicyForO365 | Select-Object Name, EnableATPForSPOTeamsODB, EnableSafeDocs, AllowSafeDocsOpen | ConvertTo-Json\n  }\n\n  powershell_output = JSON.parse(powershell(ensure_safe_attachments_for_msproducts_enabled_script).stdout.strip)\n  case powershell_output\n  when Hash\n    describe \"Ensure the following Safe Attachment Policy (#{powershell_output['Name']})\" do\n      it 'should have EnableATPForSPOTeamsODB set to True' do\n        expect(powershell_output['EnableATPForSPOTeamsODB']).to eq(true)\n      end\n      it 'should have EnableSafeDocs set to True' do\n        expect(powershell_output['EnableSafeDocs']).to eq(true)\n      end\n      it 'should have AllowSafeDocsOpen set to False' do\n        expect(powershell_output['AllowSafeDocsOpen']).to eq(false)\n      end\n    end\n  when Array\n    powershell_output.each do |policy|\n      describe %(Ensure the Safe Attachment Policy #{policy['Name']}) do\n        it 'should have EnableATPForSPOTeamsODB set to True' do\n          expect(powershell_output['EnableATPForSPOTeamsODB']).to eq(true)\n        end\n        it 'should have EnableSafeDocs set to True' do\n          expect(powershell_output['EnableSafeDocs']).to eq(true)\n        end\n        it 'should have AllowSafeDocsOpen set to False' do\n          expect(powershell_output['AllowSafeDocsOpen']).to eq(false)\n        end\n      end\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.1.5.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure the following Safe Attachment Policy (Default) should have EnableATPForSPOTeamsODB set to True","run_time":0.0001,"start_time":"2024-09-24T15:39:07-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following Safe Attachment Policy (Default)"},{"status":"passed","code_desc":"Ensure the following Safe Attachment Policy (Default) should have EnableSafeDocs set to True","run_time":3.8e-05,"start_time":"2024-09-24T15:39:07-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following Safe Attachment Policy (Default)"},{"status":"passed","code_desc":"Ensure the following Safe Attachment Policy (Default) should have AllowSafeDocsOpen set to False","run_time":3.0e-05,"start_time":"2024-09-24T15:39:07-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following Safe Attachment Policy (Default)"}]},{"id":"microsoft-365-foundations-2.1.6","title":"Ensure Exchange Online Spam Policies are set to notify administrators","desc":"In Microsoft 365 organizations with mailboxes in Exchange Online or standalone Exchange Online Protection (EOP) organizations without Exchange Online mailboxes, email messages are automatically protected against spam (junk email) by EOP.\n        Configure Exchange Online Spam Policies to copy emails and notify someone when a sender in the organization has been blocked for sending spam emails.","descriptions":[{"label":"default","data":"In Microsoft 365 organizations with mailboxes in Exchange Online or standalone Exchange Online Protection (EOP) organizations without Exchange Online mailboxes, email messages are automatically protected against spam (junk email) by EOP.\n        Configure Exchange Online Spam Policies to copy emails and notify someone when a sender in the organization has been blocked for sending spam emails."},{"label":"check","data":"Ensure Exchange Online Spam Policies are set to notify administrators:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Click to expand Email & collaboration select Policies & rules > Threat policies.\n        3. Under Policies select Anti-spam.\n        4. Click on the Anti-spam outbound policy (default).\n        5. Verify that Send a copy of outbound messages that exceed these limits to these users and groups is set to On, ensure the email address is correct.\n    To verify the Exchange Online Spam Policies are set correctly using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Get-HostedOutboundSpamFilterPolicy | Select-Object Bcc*, Notify*\n        3. Verify both BccSuspiciousOutboundMail and NotifyOutboundSpam are set to True and the email addresses to be notified are correct.\n    Note: Audit and Remediation guidance may focus on the Default policy however, if a Custom Policy exists in the organization's tenant then ensure the setting is set as outlined in the highest priority policy listed."},{"label":"fix","data":"To set the Exchange Online Spam Policies:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Click to expand Email & collaboration select Policies & rules> Threat policies.\n        3. Under Policies select Anti-spam.\n        4. Click on the Anti-spam outbound policy (default).\n        5. Select Edit protection settings then under Notifications\n        6. Check Send a copy of outbound messages that exceed these limits to these users and groups then enter the desired email addresses.\n        7. Check Notify these users and groups if a sender is blocked due to sending outbound spam then enter the desired email addresses.\n        8. Click Save.\n    To set the Exchange Online Spam Policies correctly using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            $BccEmailAddress = @(\"<INSERT-EMAIL>\")\n            $NotifyEmailAddress = @(\"<INSERT-EMAIL>\")\n            Set-HostedOutboundSpamFilterPolicy -Identity Default -\n            BccSuspiciousOutboundAdditionalRecipients $BccEmailAddress -\n            BccSuspiciousOutboundMail $true -NotifyOutboundSpam $true -\n            NotifyOutboundSpamRecipients $NotifyEmailAddress\n    Note: Audit and Remediation guidance may focus on the Default policy however, if a Custom Policy exists in the organization's tenant then ensure the setting is set as outlined in the highest priority policy listed."},{"label":"rationale","data":"A blocked account is a good indication that the account in question has been breached and an attacker is using it to send spam emails to other people."}],"impact":0.5,"refs":[],"tags":{"severity":"medium","cis_controls":[{"8":["17.5"]},{"7":["7.9"]},{"7":["7.10"]}],"default_value":"BccSuspiciousOutboundAdditionalRecipients : {}\n                      BccSuspiciousOutboundMail : False\n                      NotifyOutboundSpamRecipients : {}\n                      NotifyOutboundSpam : False","nist":["IR-1","IR-8"]},"code":"control 'microsoft-365-foundations-2.1.6' do\n  title 'Ensure Exchange Online Spam Policies are set to notify administrators'\n  desc \"In Microsoft 365 organizations with mailboxes in Exchange Online or standalone Exchange Online Protection (EOP) organizations without Exchange Online mailboxes, email messages are automatically protected against spam (junk email) by EOP.\n        Configure Exchange Online Spam Policies to copy emails and notify someone when a sender in the organization has been blocked for sending spam emails.\"\n\n  desc 'check',\n       \"Ensure Exchange Online Spam Policies are set to notify administrators:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Click to expand Email & collaboration select Policies & rules > Threat policies.\n        3. Under Policies select Anti-spam.\n        4. Click on the Anti-spam outbound policy (default).\n        5. Verify that Send a copy of outbound messages that exceed these limits to these users and groups is set to On, ensure the email address is correct.\n    To verify the Exchange Online Spam Policies are set correctly using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Get-HostedOutboundSpamFilterPolicy | Select-Object Bcc*, Notify*\n        3. Verify both BccSuspiciousOutboundMail and NotifyOutboundSpam are set to True and the email addresses to be notified are correct.\n    Note: Audit and Remediation guidance may focus on the Default policy however, if a Custom Policy exists in the organization's tenant then ensure the setting is set as outlined in the highest priority policy listed.\"\n\n  desc 'fix',\n       \"To set the Exchange Online Spam Policies:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Click to expand Email & collaboration select Policies & rules> Threat policies.\n        3. Under Policies select Anti-spam.\n        4. Click on the Anti-spam outbound policy (default).\n        5. Select Edit protection settings then under Notifications\n        6. Check Send a copy of outbound messages that exceed these limits to these users and groups then enter the desired email addresses.\n        7. Check Notify these users and groups if a sender is blocked due to sending outbound spam then enter the desired email addresses.\n        8. Click Save.\n    To set the Exchange Online Spam Policies correctly using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            $BccEmailAddress = @(\\\"<INSERT-EMAIL>\\\")\n            $NotifyEmailAddress = @(\\\"<INSERT-EMAIL>\\\")\n            Set-HostedOutboundSpamFilterPolicy -Identity Default -\n            BccSuspiciousOutboundAdditionalRecipients $BccEmailAddress -\n            BccSuspiciousOutboundMail $true -NotifyOutboundSpam $true -\n            NotifyOutboundSpamRecipients $NotifyEmailAddress\n    Note: Audit and Remediation guidance may focus on the Default policy however, if a Custom Policy exists in the organization's tenant then ensure the setting is set as outlined in the highest priority policy listed.\"\n\n  desc 'rationale',\n       'A blocked account is a good indication that the account in question has been breached and an attacker is using it to send spam emails to other people.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [\n    { '8' => ['17.5'] },\n    { '7' => ['7.9'] },\n    { '7' => ['7.10'] }\n  ]\n  tag default_value: \"BccSuspiciousOutboundAdditionalRecipients : {}\n                      BccSuspiciousOutboundMail : False\n                      NotifyOutboundSpamRecipients : {}\n                      NotifyOutboundSpam : False\"\n  tag nist: ['IR-1', 'IR-8']\n\n  ensure_exchange_online_spam_policies_set_to_notify_admins_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    Get-HostedOutboundSpamFilterPolicy | Select-Object Name, Bcc*, Notify* | ConvertTo-Json\n  }\n  powershell_output = JSON.parse(powershell(ensure_exchange_online_spam_policies_set_to_notify_admins_script).stdout.strip)\n  case powershell_output\n  when Hash\n    describe \"Ensure the following Exchange Online Spam Policy (#{powershell_output['Name']})\" do\n      it 'should have BccSuspiciousOutboundMail set to True' do\n        expect(powershell_output['BccSuspiciousOutboundMail']).to eq(true)\n      end\n      it 'should have NotifyOutboundSpam set to True' do\n        expect(powershell_output['NotifyOutboundSpam']).to eq(true)\n      end\n      it 'should have NotifyOutboundSpamRecipients set to correct email address' do\n        expect(powershell_output['NotifyOutboundSpamRecipients']).to eq(input('notify_outbound_spam_recipients'))\n      end\n      it 'should have BccSuspiciousOutboundAdditionalRecipients set to correct email address' do\n        expect(powershell_output['BccSuspiciousOutboundAdditionalRecipients']).to eq(input('bcc_suspicious_outbound_additional_recipients'))\n      end\n    end\n  when Array\n    powershell_output.each do |policy|\n      describe %(Ensure the following Exchange Online Spam Policy #{policy['Name']}) do\n        it 'should have BccSuspiciousOutboundMail set to True' do\n          expect(powershell_output['BccSuspiciousOutboundMail']).to eq(true)\n        end\n        it 'should have NotifyOutboundSpam set to True' do\n          expect(powershell_output['NotifyOutboundSpam']).to eq(true)\n        end\n        it 'should have NotifyOutboundSpamRecipients set to correct email address' do\n          expect(powershell_output['NotifyOutboundSpamRecipients']).to eq(input('notify_outbound_spam_recipients'))\n        end\n        it 'should have BccSuspiciousOutboundAdditionalRecipients set to correct email address' do\n          expect(powershell_output['BccSuspiciousOutboundAdditionalRecipients']).to eq(input('bcc_suspicious_outbound_additional_recipients'))\n        end\n      end\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.1.6.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the following Exchange Online Spam Policy (Default) should have BccSuspiciousOutboundMail set to True","run_time":0.002013,"start_time":"2024-09-24T15:39:07-04:00","message":"\nexpected: true\n     got: false\n\n(compared using ==)\n\nDiff:\n@@ -1 +1 @@\n-true\n+false\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following Exchange Online Spam Policy (Default)"},{"status":"failed","code_desc":"Ensure the following Exchange Online Spam Policy (Default) should have NotifyOutboundSpam set to True","run_time":0.001253,"start_time":"2024-09-24T15:39:07-04:00","message":"\nexpected: true\n     got: false\n\n(compared using ==)\n\nDiff:\n@@ -1 +1 @@\n-true\n+false\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following Exchange Online Spam Policy (Default)"},{"status":"failed","code_desc":"Ensure the following Exchange Online Spam Policy (Default) should have NotifyOutboundSpamRecipients set to correct email address","run_time":0.000126,"start_time":"2024-09-24T15:39:07-04:00","message":"\nexpected: \"test@msft.com\"\n     got: []\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following Exchange Online Spam Policy (Default)"},{"status":"failed","code_desc":"Ensure the following Exchange Online Spam Policy (Default) should have BccSuspiciousOutboundAdditionalRecipients set to correct email address","run_time":5.5e-05,"start_time":"2024-09-24T15:39:07-04:00","message":"\nexpected: \"test@msft.com\"\n     got: []\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following Exchange Online Spam Policy (Default)"}]},{"id":"microsoft-365-foundations-2.1.7","title":"Ensure that an anti-phishing policy has been created","desc":"By default, Office 365 includes built-in features that help protect users from phishing attacks. Set up anti-phishing polices to increase this protection, for example by refining settings to better detect and prevent impersonation and spoofing attacks. The default policy applies to all users within the organization and is a single view to fine-tune anti-phishing protection. Custom policies can be created and configured for specific users, groups or domains within the organization and will take precedence over the default policy for the scoped users.","descriptions":[{"label":"default","data":"By default, Office 365 includes built-in features that help protect users from phishing attacks. Set up anti-phishing polices to increase this protection, for example by refining settings to better detect and prevent impersonation and spoofing attacks. The default policy applies to all users within the organization and is a single view to fine-tune anti-phishing protection. Custom policies can be created and configured for specific users, groups or domains within the organization and will take precedence over the default policy for the scoped users."},{"label":"check","data":"Note: Audit and Remediation guidance may focus on the Default policy however, if a Custom Policy exists in the organization's tenant then ensure the setting is set as outlined in the highest priority policy listed.\n    Ensure that an anti-phishing policy has been created:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2.Click to expand Email & collaboration select Policies & rules\n        3.Select Threat policies.\n        4.Under Policies select Anti-phishing.\n        5.Verify the Office365 AntiPhish Default (Default) policy exists and is Always on.\n        6.Verify that Phishing email threshold is set to at least 2 - Aggressive\n        7.Verify the following features are enabled: Mailbox intelligence - Mailbox intelligence for impersonations and Spoof intelligence.\n    To verify the anti-phishing policy using PowerShell:\n        1.Connect to Exchange Online service using Connect-ExchangeOnline.\n        2.Run the following Exchange Online PowerShell command: Get-AntiPhishPolicy | Format-Table -AutoSize ` name, enabled, PhishThresholdLevel, ` EnableMailboxIntelligenceProtection, ` EnableMailboxIntelligence, EnableSpoofIntelligence\n        3.Verify values for Office365 AntiPhish Default and custom policies are:\n            •Enabled - True\n            •PhishThresholdLevel - at least 2\n            •EnableMailboxIntelligenceProtection - True\n            •EnableMailboxIntelligence - True\n            •EnableSpoofIntelligence - True"},{"label":"fix","data":"Note: Audit and Remediation guidance may focus on the Default policy however, if a Custom Policy exists in the organization's tenant then ensure the setting is set as outlined in the highest priority policy listed. To set the anti-phishing policy\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Click to expand Email & collaboration select Policies & rules\n        3. Select Threat policies.\n        4. Under Policies select Anti-phishing.\n        5. Select the Office365 AntiPhish Default (Default) policy and click Edit protection settings.\n        6. Set the Phishing email threshold to at least 2 - Aggressive.\n    Under Impersonation\n        • Check Enable mailbox intelligence (Recommended)\n        • Check Enable Intelligence for impersonation protection (Recommended).\n    Under Spoof\n        • Check Enable spoof intelligence (Recommended).\n        7. Click Save.\n    To create an anti-phishing policy using PowerShell:\n        1. Connect to Exchange Online service using Connect-ExchangeOnline.\n        2. Run the following Exchange Online PowerShell command:\n            New-AntiPhishPolicy -Name \"Office365 AntiPhish Policy\""},{"label":"rationale","data":"Protects users from phishing attacks (like impersonation and spoofing), and uses safety tips to warn users about potentially harmful messages."}],"impact":0.5,"refs":[],"tags":{"severity":"medium","cis_controls":[{"8":["9.7"]},{"7":["7"]}],"nist":["SI-3","SI-8"]},"code":"control 'microsoft-365-foundations-2.1.7' do\n  title 'Ensure that an anti-phishing policy has been created'\n  desc 'By default, Office 365 includes built-in features that help protect users from phishing attacks. Set up anti-phishing polices to increase this protection, for example by refining settings to better detect and prevent impersonation and spoofing attacks. The default policy applies to all users within the organization and is a single view to fine-tune anti-phishing protection. Custom policies can be created and configured for specific users, groups or domains within the organization and will take precedence over the default policy for the scoped users.'\n\n  desc 'check',\n       \"Note: Audit and Remediation guidance may focus on the Default policy however, if a Custom Policy exists in the organization's tenant then ensure the setting is set as outlined in the highest priority policy listed.\n    Ensure that an anti-phishing policy has been created:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2.Click to expand Email & collaboration select Policies & rules\n        3.Select Threat policies.\n        4.Under Policies select Anti-phishing.\n        5.Verify the Office365 AntiPhish Default (Default) policy exists and is Always on.\n        6.Verify that Phishing email threshold is set to at least 2 - Aggressive\n        7.Verify the following features are enabled: Mailbox intelligence - Mailbox intelligence for impersonations and Spoof intelligence.\n    To verify the anti-phishing policy using PowerShell:\n        1.Connect to Exchange Online service using Connect-ExchangeOnline.\n        2.Run the following Exchange Online PowerShell command: Get-AntiPhishPolicy | Format-Table -AutoSize ` name, enabled, PhishThresholdLevel, ` EnableMailboxIntelligenceProtection, ` EnableMailboxIntelligence, EnableSpoofIntelligence\n        3.Verify values for Office365 AntiPhish Default and custom policies are:\n            •Enabled - True\n            •PhishThresholdLevel - at least 2\n            •EnableMailboxIntelligenceProtection - True\n            •EnableMailboxIntelligence - True\n            •EnableSpoofIntelligence - True\"\n\n  desc 'fix',\n       \"Note: Audit and Remediation guidance may focus on the Default policy however, if a Custom Policy exists in the organization's tenant then ensure the setting is set as outlined in the highest priority policy listed. To set the anti-phishing policy\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Click to expand Email & collaboration select Policies & rules\n        3. Select Threat policies.\n        4. Under Policies select Anti-phishing.\n        5. Select the Office365 AntiPhish Default (Default) policy and click Edit protection settings.\n        6. Set the Phishing email threshold to at least 2 - Aggressive.\n    Under Impersonation\n        • Check Enable mailbox intelligence (Recommended)\n        • Check Enable Intelligence for impersonation protection (Recommended).\n    Under Spoof\n        • Check Enable spoof intelligence (Recommended).\n        7. Click Save.\n    To create an anti-phishing policy using PowerShell:\n        1. Connect to Exchange Online service using Connect-ExchangeOnline.\n        2. Run the following Exchange Online PowerShell command:\n            New-AntiPhishPolicy -Name \\\"Office365 AntiPhish Policy\\\"\"\n\n  desc 'rationale',\n       'Protects users from phishing attacks (like impersonation and spoofing), and uses safety tips to warn users about potentially harmful messages.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['9.7'] }, { '7' => ['7'] }]\n  tag nist: ['SI-3', 'SI-8']\n\n  ensure_anti_phishing_policy_created_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    Get-AntiPhishPolicy | Select-Object Name, Enabled, PhishThresholdLevel, EnableMailboxIntelligenceProtection, EnableMailboxIntelligence, EnableSpoofIntelligence | ConvertTo-Json\n  }\n  powershell_output = JSON.parse(powershell(ensure_anti_phishing_policy_created_script).stdout.strip)\n  case powershell_output\n  when Hash\n    describe \"Ensure the following Exchange Anti-Fishing Policy (#{powershell_output['Name']})\" do\n      it 'should have Enabled state set to True' do\n        expect(powershell_output['Enabled']).to eq(true)\n      end\n      it 'should have PhishThresholdLevel at least 2' do\n        expect(powershell_output['PhishThresholdLevel']).to be >= 2\n      end\n      it 'should have EnableMailboxIntelligenceProtection state set to True' do\n        expect(powershell_output['EnableMailboxIntelligenceProtection']).to eq(true)\n      end\n      it 'should have EnableMailboxIntelligence state set to True' do\n        expect(powershell_output['EnableMailboxIntelligence']).to eq(true)\n      end\n      it 'should have EnableSpoofIntelligence state set to True' do\n        expect(powershell_output['EnableSpoofIntelligence']).to eq(true)\n      end\n    end\n  when Array\n    powershell_output.each do |policy|\n      describe %(Ensure the following Exchange Anti-Fishing Policy #{policy['Name']}) do\n        it 'should have Enabled state set to True' do\n          expect(powershell_output['Enabled']).to eq(true)\n        end\n        it 'should have PhishThresholdLevel at least 2' do\n          expect(powershell_output['PhishThresholdLevel']).to be >= 2\n        end\n        it 'should have EnableMailboxIntelligenceProtection state set to True' do\n          expect(powershell_output['EnableMailboxIntelligenceProtection']).to eq(true)\n        end\n        it 'should have EnableMailboxIntelligence state set to True' do\n          expect(powershell_output['EnableMailboxIntelligence']).to eq(true)\n        end\n        it 'should have EnableSpoofIntelligence state set to True' do\n          expect(powershell_output['EnableSpoofIntelligence']).to eq(true)\n        end\n      end\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.1.7.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure the following Exchange Anti-Fishing Policy (Office365 AntiPhish Default) should have Enabled state set to True","run_time":4.0e-05,"start_time":"2024-09-24T15:39:07-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following Exchange Anti-Fishing Policy (Office365 AntiPhish Default)"},{"status":"failed","code_desc":"Ensure the following Exchange Anti-Fishing Policy (Office365 AntiPhish Default) should have PhishThresholdLevel at least 2","run_time":0.00013,"start_time":"2024-09-24T15:39:07-04:00","message":"expected: >= 2\n     got:    1","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following Exchange Anti-Fishing Policy (Office365 AntiPhish Default)"},{"status":"failed","code_desc":"Ensure the following Exchange Anti-Fishing Policy (Office365 AntiPhish Default) should have EnableMailboxIntelligenceProtection state set to True","run_time":0.001076,"start_time":"2024-09-24T15:39:07-04:00","message":"\nexpected: true\n     got: false\n\n(compared using ==)\n\nDiff:\n@@ -1 +1 @@\n-true\n+false\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following Exchange Anti-Fishing Policy (Office365 AntiPhish Default)"},{"status":"passed","code_desc":"Ensure the following Exchange Anti-Fishing Policy (Office365 AntiPhish Default) should have EnableMailboxIntelligence state set to True","run_time":2.8e-05,"start_time":"2024-09-24T15:39:07-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following Exchange Anti-Fishing Policy (Office365 AntiPhish Default)"},{"status":"passed","code_desc":"Ensure the following Exchange Anti-Fishing Policy (Office365 AntiPhish Default) should have EnableSpoofIntelligence state set to True","run_time":2.7e-05,"start_time":"2024-09-24T15:39:07-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following Exchange Anti-Fishing Policy (Office365 AntiPhish Default)"}]},{"id":"microsoft-365-foundations-2.1.8","title":"Ensure that SPF records are published for all Exchange Domains","desc":"For each domain that is configured in Exchange, a corresponding Sender Policy Framework (SPF) record should be created.","descriptions":[{"label":"default","data":"For each domain that is configured in Exchange, a corresponding Sender Policy Framework (SPF) record should be created."},{"label":"check","data":"Ensure that SPF records are published for all Exchange Domains:\n        1.Open a command prompt.\n        2.Type the following command in PowerShell:\n            Resolve-DnsName [domain1.com] txt | fl\n        3.Ensure that a value exists and that it includes v=spf1 include:spf.protection.outlook.com. This designates Exchange Online as a designated sender.\n    To verify the SPF records are published, use the REST API for each domain: https://graph.microsoft.com/v1.0/domains/[DOMAIN.COM]/serviceConfigurationRecords\n        1.Ensure that a value exists that includes v=spf1 include:spf.protection.outlook.com. This designates Exchange Online as a designated sender."},{"label":"fix","data":"To setup SPF records for Exchange Online accepted domains, perform the following steps:\n        1.If all email in your domain is sent from and received by Exchange Online, add the following TXT record for each Accepted Domain:\n            v=spf1 include:spf.protection.outlook.com -all\n        2.If there are other systems that send email in the environment, refer to this article for the proper SPF configuration: https://docs.microsoft.com/en-us/office365/SecurityCompliance/set-up-spf-in-office-365-to-help-prevent-spoofing."},{"label":"rationale","data":"SPF records allow Exchange Online Protection and other mail systems to know where\n        messages from domains are allowed to originate. This information can be used by that\n        system to determine how to treat the message based on if it is being spoofed or is valid."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/email-authentication-spf-configure?view=o365-worldwide"}],"tags":{"severity":"medium","cis_controls":[{"8":["9.5"]},{"7":["7.8"]}],"nist":["SC-7"]},"code":"control 'microsoft-365-foundations-2.1.8' do\n  title 'Ensure that SPF records are published for all Exchange Domains'\n  desc 'For each domain that is configured in Exchange, a corresponding Sender Policy Framework (SPF) record should be created.'\n\n  desc 'check',\n       \"Ensure that SPF records are published for all Exchange Domains:\n        1.Open a command prompt.\n        2.Type the following command in PowerShell:\n            Resolve-DnsName [domain1.com] txt | fl\n        3.Ensure that a value exists and that it includes v=spf1 include:spf.protection.outlook.com. This designates Exchange Online as a designated sender.\n    To verify the SPF records are published, use the REST API for each domain: https://graph.microsoft.com/v1.0/domains/[DOMAIN.COM]/serviceConfigurationRecords\n        1.Ensure that a value exists that includes v=spf1 include:spf.protection.outlook.com. This designates Exchange Online as a designated sender.\"\n\n  desc 'fix',\n       \"To setup SPF records for Exchange Online accepted domains, perform the following steps:\n        1.If all email in your domain is sent from and received by Exchange Online, add the following TXT record for each Accepted Domain:\n            v=spf1 include:spf.protection.outlook.com -all\n        2.If there are other systems that send email in the environment, refer to this article for the proper SPF configuration: https://docs.microsoft.com/en-us/office365/SecurityCompliance/set-up-spf-in-office-365-to-help-prevent-spoofing.\"\n\n  desc 'rationale',\n       \"SPF records allow Exchange Online Protection and other mail systems to know where\n        messages from domains are allowed to originate. This information can be used by that\n        system to determine how to treat the message based on if it is being spoofed or is valid.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['9.5'] }, { '7' => ['7.8'] }]\n  tag nist: ['SC-7']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/email-authentication-spf-configure?view=o365-worldwide'\n\n  # This does not work on Mac - need to find a different way to test. Additionally, CIS Benchmark says manual\n  domain_list = input('spf_domains')\n  domain_list.each do |domain|\n    resolve_domain_script = %{\n      $client_id = '#{input('client_id')}'\n      $certificate_password = '#{input('certificate_password')}'\n      $certificate_path = '#{input('certificate_path')}'\n      $organization = '#{input('organization')}'\n      import-module exchangeonlinemanagement\n      Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n      Import-Module DNSClient\n      Resolve-DnsName #{domain} txt | fl\n    }\n    describe \"Ensure the following domain (#{domain})\" do\n      subject { powershell(resolve_domain_script).stdout.strip }\n      it 'should exist' do\n        expect(subject).should_not be_empty\n      end\n      it 'should contain the following string: v=spf1 include:spf.protection.outlook.com' do\n        expect(subject).should include 'v=spf1 include:spf.protection.outlook.com'\n      end\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.1.8.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the following domain (google.com) should exist","run_time":6.520088,"start_time":"2024-09-24T15:39:07-04:00","message":"expected #<RSpec::Expectations::ValueExpectationTarget:0x000000011d5d5020 @target=\"\"> to respond to `empty?`","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following domain (google.com)"},{"status":"failed","code_desc":"Ensure the following domain (google.com) should contain the following string: v=spf1 include:spf.protection.outlook.com","run_time":0.001837,"start_time":"2024-09-24T15:39:13-04:00","message":"expected #<RSpec::Expectations::ValueExpectationTarget:0x000000010ec9ea50 @target=\"\"> to include \"v=spf1 include:spf.protection.outlook.com\", but it does not respond to `include?`\nDiff:\n@@ -1 +1 @@\n-[\"v=spf1 include:spf.protection.outlook.com\"]\n+#<RSpec::Expectations::ValueExpectationTarget:0x000000010ec9ea50 @target=\"\">\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following domain (google.com)"}]},{"id":"microsoft-365-foundations-2.1.9","title":"Ensure that DKIM is enabled for all Exchange Online Domains","desc":"DKIM is one of the trio of Authentication methods (SPF, DKIM and DMARC) that help prevent attackers from sending messages that look like they come from your domain.\n        DKIM lets an organization add a digital signature to outbound email messages in the message header. When DKIM is configured, the organization authorizes it's domain to associate, or sign, its name to an email message using cryptographic authentication. Email systems that get email from this domain can use a digital signature to help verify whether incoming email is legitimate.\n        Use of DKIM in addition to SPF and DMARC to help prevent malicious actors using spoofing techniques from sending messages that look like they are coming from your domain.","descriptions":[{"label":"default","data":"DKIM is one of the trio of Authentication methods (SPF, DKIM and DMARC) that help prevent attackers from sending messages that look like they come from your domain.\n        DKIM lets an organization add a digital signature to outbound email messages in the message header. When DKIM is configured, the organization authorizes it's domain to associate, or sign, its name to an email message using cryptographic authentication. Email systems that get email from this domain can use a digital signature to help verify whether incoming email is legitimate.\n        Use of DKIM in addition to SPF and DMARC to help prevent malicious actors using spoofing techniques from sending messages that look like they are coming from your domain."},{"label":"check","data":"To ensure DKIM is enabled:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com/\n        2.Expand Email & collaboration > Policies & rules > Threat policies.\n        3.Under Rules section click Email authentication settings.\n        4.Select DKIM\n        5.Click on each domain and confirm that Sign messages for this domain with DKIM signatures is Enabled.\n        6.A status of Not signing DKIM signatures for this domain is an audit fail.\n    To verify DKIM is enabled, use the Exchange Online PowerShell Module:\n        1.Connect to Exchange Online service using Connect-ExchangeOnline.\n        2.Run the following Exchange Online PowerShell command: Get-DkimSigningConfig\n        3.Verify Enabled is set to True"},{"label":"fix","data":"To setup DKIM records, first add the following records to your DNS system, for each domain in Exchange Online that you plan to use to send email with:\n        1. For each accepted domain in Exchange Online, two DNS entries are required.\n        Host name: selector1._domainkey\n        Points to address or value: selector1-\n        <domainGUID>._domainkey.<initialDomain>\n        TTL: 3600\n        Host name: selector2._domainkey\n        Points to address or value: selector2-\n        <domainGUID>._domainkey.<initialDomain>\n        TTL: 3600\n    For Office 365, the selectors will always be selector1 or selector2. domainGUID is the same as the domainGUID in the customized MX record for your custom domain that appears before mail.protection.outlook.com. For example, in the following MX record for the domain contoso.com, the domainGUID is contoso-com: contoso.com. 3600 IN MX 5 contoso-com.mail.protection.outlook.com\n    The initial domain is the domain that you used when you signed up for Office 365. Initial domains always end in on microsoft.com.\n        1.After the DNS records are created, enable DKIM signing in Defender.\n        2.Navigate to Microsoft 365 Defender https://security.microsoft.com/\n        3.Expand Email & collaboration > Policies & rules > Threat policies.\n        4.Under Rules section click Email authentication settings.\n        5.Select DKIM\n        6.Click on each domain and click Enable next to Sign messages for this domain with DKIM signature.\n    To set DKIM is enabled, use the Exchange Online PowerShell Module:\n        1.Connect to Exchange Online service using Connect-ExchangeOnline.\n        2.Run the following Exchange Online PowerShell command:\n            Set-DkimSigningConfig -Identity < domainName > -Enabled $True"},{"label":"rationale","data":"By enabling DKIM with Office 365, messages that are sent from Exchange Online will\n        be cryptographically signed. This will allow the receiving email system to validate that\n        the messages were generated by a server that the organization authorized and not\n        being spoofed."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/defender-office-365/email-authentication-dkim-configure?view=o365-worldwide"}],"tags":{"severity":"medium","cis_controls":[{"8":["9.5"]},{"7":["7.8"]}],"nist":["SC-7"]},"code":"control 'microsoft-365-foundations-2.1.9' do\n  title 'Ensure that DKIM is enabled for all Exchange Online Domains'\n  desc \"DKIM is one of the trio of Authentication methods (SPF, DKIM and DMARC) that help prevent attackers from sending messages that look like they come from your domain.\n        DKIM lets an organization add a digital signature to outbound email messages in the message header. When DKIM is configured, the organization authorizes it's domain to associate, or sign, its name to an email message using cryptographic authentication. Email systems that get email from this domain can use a digital signature to help verify whether incoming email is legitimate.\n        Use of DKIM in addition to SPF and DMARC to help prevent malicious actors using spoofing techniques from sending messages that look like they are coming from your domain.\"\n\n  desc 'check',\n       \"To ensure DKIM is enabled:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com/\n        2.Expand Email & collaboration > Policies & rules > Threat policies.\n        3.Under Rules section click Email authentication settings.\n        4.Select DKIM\n        5.Click on each domain and confirm that Sign messages for this domain with DKIM signatures is Enabled.\n        6.A status of Not signing DKIM signatures for this domain is an audit fail.\n    To verify DKIM is enabled, use the Exchange Online PowerShell Module:\n        1.Connect to Exchange Online service using Connect-ExchangeOnline.\n        2.Run the following Exchange Online PowerShell command: Get-DkimSigningConfig\n        3.Verify Enabled is set to True\"\n\n  desc 'fix',\n       \"To setup DKIM records, first add the following records to your DNS system, for each domain in Exchange Online that you plan to use to send email with:\n        1. For each accepted domain in Exchange Online, two DNS entries are required.\n        Host name: selector1._domainkey\n        Points to address or value: selector1-\n        <domainGUID>._domainkey.<initialDomain>\n        TTL: 3600\n        Host name: selector2._domainkey\n        Points to address or value: selector2-\n        <domainGUID>._domainkey.<initialDomain>\n        TTL: 3600\n    For Office 365, the selectors will always be selector1 or selector2. domainGUID is the same as the domainGUID in the customized MX record for your custom domain that appears before mail.protection.outlook.com. For example, in the following MX record for the domain contoso.com, the domainGUID is contoso-com: contoso.com. 3600 IN MX 5 contoso-com.mail.protection.outlook.com\n    The initial domain is the domain that you used when you signed up for Office 365. Initial domains always end in on microsoft.com.\n        1.After the DNS records are created, enable DKIM signing in Defender.\n        2.Navigate to Microsoft 365 Defender https://security.microsoft.com/\n        3.Expand Email & collaboration > Policies & rules > Threat policies.\n        4.Under Rules section click Email authentication settings.\n        5.Select DKIM\n        6.Click on each domain and click Enable next to Sign messages for this domain with DKIM signature.\n    To set DKIM is enabled, use the Exchange Online PowerShell Module:\n        1.Connect to Exchange Online service using Connect-ExchangeOnline.\n        2.Run the following Exchange Online PowerShell command:\n            Set-DkimSigningConfig -Identity < domainName > -Enabled $True\"\n\n  desc 'rationale',\n       \"By enabling DKIM with Office 365, messages that are sent from Exchange Online will\n        be cryptographically signed. This will allow the receiving email system to validate that\n        the messages were generated by a server that the organization authorized and not\n        being spoofed.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['9.5'] }, { '7' => ['7.8'] }]\n  tag nist: ['SC-7']\n\n  ref 'https://learn.microsoft.com/en-us/defender-office-365/email-authentication-dkim-configure?view=o365-worldwide'\n\n  ensure_dkim_enabled_for_exchange_domains_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    Get-DkimSigningConfig | Where-Object { $_.Enabled -eq $false } | Measure-Object | Select-Object -ExpandProperty Count\n }\n  powershell_output = powershell(ensure_dkim_enabled_for_exchange_domains_script)\n  describe 'Ensure the count of Exchange Online Domains with the DKIM Enabled setting set to False' do\n    subject { powershell_output.stdout.strip }\n    it 'is 0' do\n      expect(subject).to cmp(0)\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.1.9.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure the count of Exchange Online Domains with the DKIM Enabled setting set to False is 0","run_time":9.017889,"start_time":"2024-09-24T15:39:13-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the count of Exchange Online Domains with the DKIM Enabled setting set to False"}]},{"id":"microsoft-365-foundations-2.3.1","title":"Ensure the Account Provisioning Activity report is reviewed at least weekly","desc":"The Account Provisioning Activity report details any account provisioning that was attempted by an external application","descriptions":[{"label":"default","data":"The Account Provisioning Activity report details any account provisioning that was attempted by an external application"},{"label":"check","data":"To verify the report is being reviewed at least weekly, confirm that the necessary procedures are in place and being followed."},{"label":"fix","data":"To review the Account Provisioning Activity report:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2.Click on Audit.\n        3.Set Activities to Added user for User administration activities.\n        4.Set Start Date and End Date.\n        5.Click Search.\n        6.Review.\n    To review Account Provisioning Activity report using PowerShell:\n        1.Connect to Exchange Online using Connect-ExchangeOnline.\n        2.Run the following Exchange Online PowerShell command:\n            $startDate = ((Get-date).AddDays(-7)).ToShortDateString()\n            $endDate = (Get-date).ToShortDateString()\n            Search-UnifiedAuditLog -StartDate $startDate -EndDate $endDate | Where-Object\n            { $_.Operations -eq \"add user.\" }\n        3.Review the output."},{"label":"rationale","data":"If the organization doesn't usually use a third-party provider to manage accounts, any\n        entry on the list is likely illicit. Otherwise, it is recommended to monitor transaction\n        volumes and look for new or unusual third party applications that may be managing\n        users. If anything unusual is observed, the provider should be contacted to determine\n        the legitimacy of the action."}],"impact":0.5,"refs":[],"tags":{"severity":"medium","cis_controls":[{"8":["8.11"]},{"7":["6.2"]}],"nist":["AU-6","AU-6(1)","AU-7(1)","AC-1","AC-2","AC-2(1)"]},"code":"control 'microsoft-365-foundations-2.3.1' do\n  title 'Ensure the Account Provisioning Activity report is reviewed at least weekly'\n  desc 'The Account Provisioning Activity report details any account provisioning that was attempted by an external application'\n\n  desc 'check',\n       'To verify the report is being reviewed at least weekly, confirm that the necessary procedures are in place and being followed.'\n\n  desc 'fix',\n       'To review the Account Provisioning Activity report:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2.Click on Audit.\n        3.Set Activities to Added user for User administration activities.\n        4.Set Start Date and End Date.\n        5.Click Search.\n        6.Review.\n    To review Account Provisioning Activity report using PowerShell:\n        1.Connect to Exchange Online using Connect-ExchangeOnline.\n        2.Run the following Exchange Online PowerShell command:\n            $startDate = ((Get-date).AddDays(-7)).ToShortDateString()\n            $endDate = (Get-date).ToShortDateString()\n            Search-UnifiedAuditLog -StartDate $startDate -EndDate $endDate | Where-Object\n            { $_.Operations -eq \"add user.\" }\n        3.Review the output.'\n\n  desc 'rationale',\n       \"If the organization doesn't usually use a third-party provider to manage accounts, any\n        entry on the list is likely illicit. Otherwise, it is recommended to monitor transaction\n        volumes and look for new or unusual third party applications that may be managing\n        users. If anything unusual is observed, the provider should be contacted to determine\n        the legitimacy of the action.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['8.11'] }, { '7' => ['6.2'] }]\n  tag nist: ['AU-6', 'AU-6(1)', 'AU-7(1)', 'AC-1', 'AC-2', 'AC-2(1)']\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.3.1.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":1.0e-05,"start_time":"2024-09-24T15:39:22-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-2.3.2","title":"Ensure non-global administrator role group assignments are reviewed at least weekly","desc":"Non-global administrator role group assignments should be reviewed at least every week.","descriptions":[{"label":"default","data":"Non-global administrator role group assignments should be reviewed at least every week."},{"label":"check","data":"To verify non-global administrator role group assignments are being reviewed at least weekly, confirm that the necessary procedures are in place and being followed."},{"label":"fix","data":"To review non-global administrator role group assignments:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2.Click on Audit.\n        3.Set Added member to Role and Removed a user from a directory role for Activities.\n        4.Set Start Date and End Date.\n        5.Click Search.\n        6.Review."},{"label":"rationale","data":"While these roles are less powerful than a global admin, they do grant special privileges\n        that can be used illicitly. If unusual activity is detected, contact the user to confirm it is a\n        legitimate need."}],"impact":0.5,"refs":[],"tags":{"severity":"medium","cis_controls":[{"8":["8.11"]},{"7":["6.2"]}],"nist":["AU-6","AU-6(1)","AU-7(1)","AC-1","AC-2","AC-2(1)"]},"code":"control 'microsoft-365-foundations-2.3.2' do\n  title 'Ensure non-global administrator role group assignments are reviewed at least weekly'\n  desc 'Non-global administrator role group assignments should be reviewed at least every week.'\n\n  desc 'check',\n       'To verify non-global administrator role group assignments are being reviewed at least weekly, confirm that the necessary procedures are in place and being followed.'\n\n  desc 'fix',\n       \"To review non-global administrator role group assignments:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2.Click on Audit.\n        3.Set Added member to Role and Removed a user from a directory role for Activities.\n        4.Set Start Date and End Date.\n        5.Click Search.\n        6.Review.\"\n\n  desc 'rationale',\n       'While these roles are less powerful than a global admin, they do grant special privileges\n        that can be used illicitly. If unusual activity is detected, contact the user to confirm it is a\n        legitimate need.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['8.11'] }, { '7' => ['6.2'] }]\n  tag nist: ['AU-6', 'AU-6(1)', 'AU-7(1)', 'AC-1', 'AC-2', 'AC-2(1)']\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.3.2.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":1.4e-05,"start_time":"2024-09-24T15:39:22-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-2.4.1","title":"Ensure Priority account protection is enabled and configured","desc":"Identify priority accounts to utilize Microsoft 365's advanced custom security features. This is an essential tool to bolster protection for users who are frequently targeted due to their critical positions, such as executives, leaders, managers, or others who have access to sensitive, confidential, financial, or high-priority information.\n        Once these accounts are identified, several services and features can be enabled, including threat policies, enhanced sign-in protection through conditional access policies, and alert policies, enabling faster response times for incident response teams.","descriptions":[{"label":"default","data":"Identify priority accounts to utilize Microsoft 365's advanced custom security features. This is an essential tool to bolster protection for users who are frequently targeted due to their critical positions, such as executives, leaders, managers, or others who have access to sensitive, confidential, financial, or high-priority information.\n        Once these accounts are identified, several services and features can be enabled, including threat policies, enhanced sign-in protection through conditional access policies, and alert policies, enabling faster response times for incident response teams."},{"label":"check","data":"Audit with a 3-step process\n    Step 1: Verify Priority account protection is enabled:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com/\n        2.Select Settings > E-mail & Collaboration > Priority account protection\n        3.Ensure Priority account protection is set to On\n    Step 2: Verify that priority accounts are identified and tagged accordingly:\n        4.Select User tags\n        5.Select the PRIORITY ACCOUNT tag and click Edit\n        6.Verify the assigned members match the organization's defined priority accounts or groups.\n        7.Repeat the previous 2 steps for any additional tags identified, such as Finance or HR.\n    Step 3: Ensure alerts are configured:\n        8.Expand E-mail & Collaboration on the left column.\n        9.Select Policies & rules > Alert policy\n        10.Ensure alert policies are configured for priority accounts, enabled and have a valid recipient. The tags column can be used to identify policies using a specific tag"},{"label":"fix","data":"Remediate with a 3-step process\n    Step 1: Enable Priority account protection in Microsoft 365 Defender:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com/\n        2.Select Settings > E-mail & Collaboration > Priority account protection\n        3.Ensure Priority account protection is set to On\n    Step 2: Tag priority accounts:\n        4.Select User tags\n        5.Select the PRIORITY ACCOUNT tag and click Edit\n        6.Select Add members to add users, or groups. Groups are recommended.\n        7.Repeat the previous 2 steps for any additional tags needed, such as Finance or HR.\n        8.Next and Submit.\n    Step 3: Configure E-mail alerts for Priority Accounts:\n        9.Expand E-mail & Collaboration on the left column.\n        10.Select New Alert Policy\n        11.Enter a valid policy Name & Description. Set Severity to High and Category to Threat management.\n        12.Set Activity is to Detected malware in an e-mail message\n        13.Mail direction is Inbound\n        14.Select Add Condition and User: recipient tags are\n        15.In the Selection option field add chosen priority tags such as Priority account.\n        16.Select Every time an activity matches the rule.\n        17.Next and Verify valid recipient(s) are selected.\n        18.Next and select Yes, turn it on right away. Click Submit to save the alert.\n        19.Repeat steps 10 - 18 for the Activity field Activity is: Phishing email detected at time of delivery\n    NOTE: Any additional activity types may be added as needed. Above are the minimum recommended."},{"label":"rationale","data":"Enabling priority account protection for users in Microsoft 365 is necessary to enhance\n        security for accounts with access to sensitive data and high privileges, such as CEOs,\n        CISOs, CFOs, and IT admins. These priority accounts are often targeted by spear\n        phishing or whaling attacks and require stronger protection to prevent account\n        compromise.\n        To address this, Microsoft 365 and Microsoft Defender for Office 365 offer several key\n        features that provide extra security, including the identification of incidents and alerts\n        involving priority accounts and the use of built-in custom protections designed\n        specifically for them."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/admin/setup/priority-accounts"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/security-recommendations-for-priority-accounts"}],"tags":{"severity":"medium","cis_controls":[{"8":["9.7"]}],"default_value":"By default, priority accounts are undefined.","nist":["SI-3","SI-8"]},"code":"control 'microsoft-365-foundations-2.4.1' do\n  title 'Ensure Priority account protection is enabled and configured'\n  desc \"Identify priority accounts to utilize Microsoft 365's advanced custom security features. This is an essential tool to bolster protection for users who are frequently targeted due to their critical positions, such as executives, leaders, managers, or others who have access to sensitive, confidential, financial, or high-priority information.\n        Once these accounts are identified, several services and features can be enabled, including threat policies, enhanced sign-in protection through conditional access policies, and alert policies, enabling faster response times for incident response teams.\"\n\n  desc 'check',\n       \"Audit with a 3-step process\n    Step 1: Verify Priority account protection is enabled:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com/\n        2.Select Settings > E-mail & Collaboration > Priority account protection\n        3.Ensure Priority account protection is set to On\n    Step 2: Verify that priority accounts are identified and tagged accordingly:\n        4.Select User tags\n        5.Select the PRIORITY ACCOUNT tag and click Edit\n        6.Verify the assigned members match the organization's defined priority accounts or groups.\n        7.Repeat the previous 2 steps for any additional tags identified, such as Finance or HR.\n    Step 3: Ensure alerts are configured:\n        8.Expand E-mail & Collaboration on the left column.\n        9.Select Policies & rules > Alert policy\n        10.Ensure alert policies are configured for priority accounts, enabled and have a valid recipient. The tags column can be used to identify policies using a specific tag\"\n\n  desc 'fix',\n       \"Remediate with a 3-step process\n    Step 1: Enable Priority account protection in Microsoft 365 Defender:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com/\n        2.Select Settings > E-mail & Collaboration > Priority account protection\n        3.Ensure Priority account protection is set to On\n    Step 2: Tag priority accounts:\n        4.Select User tags\n        5.Select the PRIORITY ACCOUNT tag and click Edit\n        6.Select Add members to add users, or groups. Groups are recommended.\n        7.Repeat the previous 2 steps for any additional tags needed, such as Finance or HR.\n        8.Next and Submit.\n    Step 3: Configure E-mail alerts for Priority Accounts:\n        9.Expand E-mail & Collaboration on the left column.\n        10.Select New Alert Policy\n        11.Enter a valid policy Name & Description. Set Severity to High and Category to Threat management.\n        12.Set Activity is to Detected malware in an e-mail message\n        13.Mail direction is Inbound\n        14.Select Add Condition and User: recipient tags are\n        15.In the Selection option field add chosen priority tags such as Priority account.\n        16.Select Every time an activity matches the rule.\n        17.Next and Verify valid recipient(s) are selected.\n        18.Next and select Yes, turn it on right away. Click Submit to save the alert.\n        19.Repeat steps 10 - 18 for the Activity field Activity is: Phishing email detected at time of delivery\n    NOTE: Any additional activity types may be added as needed. Above are the minimum recommended.\"\n\n  desc 'rationale',\n       'Enabling priority account protection for users in Microsoft 365 is necessary to enhance\n        security for accounts with access to sensitive data and high privileges, such as CEOs,\n        CISOs, CFOs, and IT admins. These priority accounts are often targeted by spear\n        phishing or whaling attacks and require stronger protection to prevent account\n        compromise.\n        To address this, Microsoft 365 and Microsoft Defender for Office 365 offer several key\n        features that provide extra security, including the identification of incidents and alerts\n        involving priority accounts and the use of built-in custom protections designed\n        specifically for them.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['9.7'] }]\n  tag default_value: 'By default, priority accounts are undefined.'\n  tag nist: ['SI-3', 'SI-8']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/admin/setup/priority-accounts'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/security-recommendations-for-priority-accounts'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.4.1.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":1.3e-05,"start_time":"2024-09-24T15:39:22-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-2.4.2","title":"Ensure Priority accounts have 'Strict protection' presets applied","desc":"Preset security policies have been established by Microsoft, utilizing observations and experiences within datacenters to strike a balance between the exclusion of malicious content from users and limiting unwarranted disruptions. These policies can apply to all, or select users and encompass recommendations for addressing spam, malware, and phishing threats. The policy parameters are pre-determined and non-adjustable.\n        Strict protection has the most aggressive protection of the 3 presets.\n            •EOP: Anti-spam, Anti-malware and Anti-phishing\n            •Defender: Spoof protection, Impersonation protection and Advanced phishing\n            •Defender: Safe Links and Safe Attachments\n        NOTE: The preset security polices cannot target Priority account TAGS currently, groups should be used instead.","descriptions":[{"label":"default","data":"Preset security policies have been established by Microsoft, utilizing observations and experiences within datacenters to strike a balance between the exclusion of malicious content from users and limiting unwarranted disruptions. These policies can apply to all, or select users and encompass recommendations for addressing spam, malware, and phishing threats. The policy parameters are pre-determined and non-adjustable.\n        Strict protection has the most aggressive protection of the 3 presets.\n            •EOP: Anti-spam, Anti-malware and Anti-phishing\n            •Defender: Spoof protection, Impersonation protection and Advanced phishing\n            •Defender: Safe Links and Safe Attachments\n        NOTE: The preset security polices cannot target Priority account TAGS currently, groups should be used instead."},{"label":"check","data":"Verify strict preset security policies have been applied to Priority accounts:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com/\n        2.Select to expand E-mail & collaboration.\n        3.Select Policies & rules > Threat policies.\n        4.From here visit each section in turn: Anti-phishing Anti-spam Anti-malware Safe Attachments Safe Links\n        5.Ensure in each there is a policy named Strict Preset Security Policy which includes the organization's priority Accounts/Groups."},{"label":"fix","data":"Enable strict preset security policies for Priority accounts:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com/\n        2.Select to expand E-mail & collaboration.\n        3.Select Policies & rules > Threat policies > Preset security policies.\n        4.Click to Manage protection settings for Strict protection preset.\n        5.For Apply Exchange Online Protection select at minimum Specific recipients and include the Accounts/Groups identified as Priority Accounts.\n        6.For Apply Defender for Office 365 Protection select at minimum Specific recipients and include the Accounts/Groups identified as Priority Accounts.\n        7.For Impersonation protection click Next and add valid e-mails or priority accounts both internal and external that may be subject to impersonation.\n        8.For Protected custom domains add the organization's domain name, along side other key partners.\n        9.Click Next and finally Confirm"},{"label":"rationale","data":"Enabling priority account protection for users in Microsoft 365 is necessary to enhance\n        security for accounts with access to sensitive data and high privileges, such as CEOs,\n        CISOs, CFOs, and IT admins. These priority accounts are often targeted by spear\n        phishing or whaling attacks and require stronger protection to prevent account\n        compromise.\n        The implementation of stringent, pre-defined policies may result in instances of false\n        positive, however, the benefit of requiring the end-user to preview junk email before\n        accessing their inbox outweighs the potential risk of mistakenly perceiving a malicious\n        email as safe due to its placement in the inbox."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/preset-security-policies?view=o365-worldwide"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/security-recommendations-for-priority-accounts"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/recommended-settings-for-eop-and-office365?view=o365-worldwide#impersonation-settings-in-anti-phishing-policies-in-microsoft-defender-for-office-365"}],"tags":{"severity":"medium","cis_controls":[{"8":["9.7"]},{"8":["10.7"]}],"default_value":"By default, presets are not applied to any users or groups.","nist":["SI-3","SI-8","SI-4"]},"code":"control 'microsoft-365-foundations-2.4.2' do\n  title \"Ensure Priority accounts have 'Strict protection' presets applied\"\n  desc \"Preset security policies have been established by Microsoft, utilizing observations and experiences within datacenters to strike a balance between the exclusion of malicious content from users and limiting unwarranted disruptions. These policies can apply to all, or select users and encompass recommendations for addressing spam, malware, and phishing threats. The policy parameters are pre-determined and non-adjustable.\n        Strict protection has the most aggressive protection of the 3 presets.\n            •EOP: Anti-spam, Anti-malware and Anti-phishing\n            •Defender: Spoof protection, Impersonation protection and Advanced phishing\n            •Defender: Safe Links and Safe Attachments\n        NOTE: The preset security polices cannot target Priority account TAGS currently, groups should be used instead.\"\n\n  desc 'check',\n       \"Verify strict preset security policies have been applied to Priority accounts:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com/\n        2.Select to expand E-mail & collaboration.\n        3.Select Policies & rules > Threat policies.\n        4.From here visit each section in turn: Anti-phishing Anti-spam Anti-malware Safe Attachments Safe Links\n        5.Ensure in each there is a policy named Strict Preset Security Policy which includes the organization's priority Accounts/Groups.\"\n\n  desc 'fix',\n       \"Enable strict preset security policies for Priority accounts:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com/\n        2.Select to expand E-mail & collaboration.\n        3.Select Policies & rules > Threat policies > Preset security policies.\n        4.Click to Manage protection settings for Strict protection preset.\n        5.For Apply Exchange Online Protection select at minimum Specific recipients and include the Accounts/Groups identified as Priority Accounts.\n        6.For Apply Defender for Office 365 Protection select at minimum Specific recipients and include the Accounts/Groups identified as Priority Accounts.\n        7.For Impersonation protection click Next and add valid e-mails or priority accounts both internal and external that may be subject to impersonation.\n        8.For Protected custom domains add the organization's domain name, along side other key partners.\n        9.Click Next and finally Confirm\"\n\n  desc 'rationale',\n       'Enabling priority account protection for users in Microsoft 365 is necessary to enhance\n        security for accounts with access to sensitive data and high privileges, such as CEOs,\n        CISOs, CFOs, and IT admins. These priority accounts are often targeted by spear\n        phishing or whaling attacks and require stronger protection to prevent account\n        compromise.\n        The implementation of stringent, pre-defined policies may result in instances of false\n        positive, however, the benefit of requiring the end-user to preview junk email before\n        accessing their inbox outweighs the potential risk of mistakenly perceiving a malicious\n        email as safe due to its placement in the inbox.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['9.7'] }, { '8' => ['10.7'] }]\n  tag default_value: 'By default, presets are not applied to any users or groups.'\n  tag nist: ['SI-3', 'SI-8', 'SI-4']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/preset-security-policies?view=o365-worldwide'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/security-recommendations-for-priority-accounts'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/recommended-settings-for-eop-and-office365?view=o365-worldwide#impersonation-settings-in-anti-phishing-policies-in-microsoft-defender-for-office-365'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.4.2.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":1.1e-05,"start_time":"2024-09-24T15:39:22-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-2.4.3","title":"Ensure Microsoft Defender for Cloud Apps is enabled and configured","desc":"Microsoft Defender for Cloud Apps is a Cloud Access Security Broker (CASB). It provides visibility into suspicious activity in Microsoft 365, enabling investigation into potential security issues and facilitating the implementation of remediation measures if necessary.\n        Some risk detection methods provided by Entra Identity Protection also require Microsoft Defender for Cloud Apps:\n            •Suspicious manipulation of inbox rules\n            •Suspicious inbox forwarding\n            •New country detection\n            •Impossible travel detection\n            •Activity from anonymous IP addresses\n            •Mass access to sensitive files","descriptions":[{"label":"default","data":"Microsoft Defender for Cloud Apps is a Cloud Access Security Broker (CASB). It provides visibility into suspicious activity in Microsoft 365, enabling investigation into potential security issues and facilitating the implementation of remediation measures if necessary.\n        Some risk detection methods provided by Entra Identity Protection also require Microsoft Defender for Cloud Apps:\n            •Suspicious manipulation of inbox rules\n            •Suspicious inbox forwarding\n            •New country detection\n            •Impossible travel detection\n            •Activity from anonymous IP addresses\n            •Mass access to sensitive files"},{"label":"check","data":"Ensure Microsoft Defender for Cloud Apps is enabled and configured:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com/\n        2.Select Settings > Cloud apps.\n        3.Scroll to Connected apps and select App connectors.\n        4.Ensure that Microsoft 365 and Microsoft Azure both show in the list as Connected.\n        5.Go to Cloud Discovery > Microsoft Defender for Endpoint and check if the integration is enabled.\n        6.Go to Information Protection > Files and verify Enable file monitoring is checked."},{"label":"fix","data":"Configure Information Protection and Cloud Discovery:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com/\n        2.Select Settings > Cloud apps.\n        3.Scroll to Information Protection and select Files.\n        4.Check Enable file monitoring.\n        5.Scroll up to Cloud Discovery and select Microsoft Defender for Endpoint.\n        6.Check Enforce app access, configure a Notification URL and Save.\n    Note: Defender for Endpoint requires a Defender for Endpoint license.\n    Configure App Connectors:\n        1.Scroll to Connected apps and select App connectors.\n        2.Click on Connect an app and select Microsoft 365.\n        3.Check all Azure and Office 365 boxes then click Connect Office 365.\n        4.Repeat for the Microsoft Azure application."},{"label":"rationale","data":"Security teams can receive notifications of triggered alerts for atypical or suspicious\n        activities, see how the organization's data in Microsoft 365 is accessed and used,\n        suspend user accounts exhibiting suspicious activity, and require users to log back in to\n        Microsoft 365 apps after an alert has been triggered."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/defender-cloud-apps/connect-office-365"},{"ref":"https://learn.microsoft.com/en-us/defender-cloud-apps/connect-azure"},{"ref":"https://learn.microsoft.com/en-us/defender-cloud-apps/best-practices"},{"ref":"https://learn.microsoft.com/en-us/defender-cloud-apps/get-started"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/concept-identity-protection-risks"}],"tags":{"severity":"medium","cis_controls":[{"8":["10.1"]},{"8":["10.5"]},{"7":["6.2"]},{"7":["16"]}],"default_value":"Disabled","nist":["SI-3","SI-16","AC-1","AC-2","AC-2(1)"]},"code":"control 'microsoft-365-foundations-2.4.3' do\n  title 'Ensure Microsoft Defender for Cloud Apps is enabled and configured'\n  desc \"Microsoft Defender for Cloud Apps is a Cloud Access Security Broker (CASB). It provides visibility into suspicious activity in Microsoft 365, enabling investigation into potential security issues and facilitating the implementation of remediation measures if necessary.\n        Some risk detection methods provided by Entra Identity Protection also require Microsoft Defender for Cloud Apps:\n            •Suspicious manipulation of inbox rules\n            •Suspicious inbox forwarding\n            •New country detection\n            •Impossible travel detection\n            •Activity from anonymous IP addresses\n            •Mass access to sensitive files\"\n\n  desc 'check',\n       \"Ensure Microsoft Defender for Cloud Apps is enabled and configured:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com/\n        2.Select Settings > Cloud apps.\n        3.Scroll to Connected apps and select App connectors.\n        4.Ensure that Microsoft 365 and Microsoft Azure both show in the list as Connected.\n        5.Go to Cloud Discovery > Microsoft Defender for Endpoint and check if the integration is enabled.\n        6.Go to Information Protection > Files and verify Enable file monitoring is checked.\"\n\n  desc 'fix',\n       \"Configure Information Protection and Cloud Discovery:\n        1.Navigate to Microsoft 365 Defender https://security.microsoft.com/\n        2.Select Settings > Cloud apps.\n        3.Scroll to Information Protection and select Files.\n        4.Check Enable file monitoring.\n        5.Scroll up to Cloud Discovery and select Microsoft Defender for Endpoint.\n        6.Check Enforce app access, configure a Notification URL and Save.\n    Note: Defender for Endpoint requires a Defender for Endpoint license.\n    Configure App Connectors:\n        1.Scroll to Connected apps and select App connectors.\n        2.Click on Connect an app and select Microsoft 365.\n        3.Check all Azure and Office 365 boxes then click Connect Office 365.\n        4.Repeat for the Microsoft Azure application.\"\n\n  desc 'rationale',\n       \"Security teams can receive notifications of triggered alerts for atypical or suspicious\n        activities, see how the organization's data in Microsoft 365 is accessed and used,\n        suspend user accounts exhibiting suspicious activity, and require users to log back in to\n        Microsoft 365 apps after an alert has been triggered.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [\n    { '8' => ['10.1'] },\n    { '8' => ['10.5'] },\n    { '7' => ['6.2'] },\n    { '7' => ['16'] }\n  ]\n  tag default_value: 'Disabled'\n  tag nist: ['SI-3', 'SI-16', 'AC-1', 'AC-2', 'AC-2(1)']\n\n  ref 'https://learn.microsoft.com/en-us/defender-cloud-apps/connect-office-365'\n  ref 'https://learn.microsoft.com/en-us/defender-cloud-apps/connect-azure'\n  ref 'https://learn.microsoft.com/en-us/defender-cloud-apps/best-practices'\n  ref 'https://learn.microsoft.com/en-us/defender-cloud-apps/get-started'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/concept-identity-protection-risks'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.4.3.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":1.0e-05,"start_time":"2024-09-24T15:39:22-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-2.4.4","title":"Ensure Zero-hour auto purge for Microsoft Teams is on","desc":"Zero-hour auto purge (ZAP) is a protection feature that retroactively detects and neutralizes malware and high confidence phishing. When ZAP for Teams protection blocks a message, the message is blocked for everyone in the chat. The initial block happens right after delivery, but ZAP occurs up to 48 hours after delivery.","descriptions":[{"label":"default","data":"Zero-hour auto purge (ZAP) is a protection feature that retroactively detects and neutralizes malware and high confidence phishing. When ZAP for Teams protection blocks a message, the message is blocked for everyone in the chat. The initial block happens right after delivery, but ZAP occurs up to 48 hours after delivery."},{"label":"check","data":"To audit using the UI:\n        1.Navigate to Microsoft Defender https://security.microsoft.com/\n        2.Click Settings > Email & collaboration > Microsoft Teams protection.\n        3.Ensure Zero-hour auto purge (ZAP) is set to On (Default)\n        4.Under Exclude these participants review the list of exclusions and ensure they are justified and within tolerance for the organization.\n    To audit using PowerShell:\n        1.Connect to Exchange Online using Connect-ExchangeOnline.\n          2.Run the following cmdlets:\n            Get-TeamsProtectionPolicy | fl ZapEnabled\n            Get-TeamsProtectionPolicyRule | fl ExceptIf*\n        3.Ensure ZapEnabled is True.\n        4.Review the list of exclusions and ensure they are justified and within tolerance for the organization. If nothing returns from the 2nd cmdlet then there are no exclusions defined."},{"label":"fix","data":"To remediate using the UI:\n        1.Navigate to Microsoft Defender https://security.microsoft.com/\n        2.Click Settings > Email & collaboration > Microsoft Teams protection.\n        3.Set Zero-hour auto purge (ZAP) to On (Default)\n    To remediate using PowerShell:\n        1.Connect to Exchange Online using Connect-ExchangeOnline.\n        2.Run the following cmdlet:\n            Set-TeamsProtectionPolicy -Identity \"Teams Protection Policy\" -ZapEnabled $true"},{"label":"rationale","data":"ZAP is intended to protect users that have received zero-day malware messages or\n        content that is weaponized after being delivered to users. It does this by continually\n        monitoring spam and malware signatures taking automated retroactive action on\n        messages that have already been delivered."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/zero-hour-auto-purge?view=o365-worldwide#zero-hour-auto-purge-zap-in-microsoft-teams"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/mdo-support-teams-about?view=o365-worldwide#configure-zap-for-teams-protection-in-defender-for-office-365-plan-2"}],"tags":{"severity":"medium","cis_controls":[{"8":["10.1"]}],"default_value":"On (Default)","nist":["SI-3"]},"code":"control 'microsoft-365-foundations-2.4.4' do\n  title 'Ensure Zero-hour auto purge for Microsoft Teams is on'\n  desc 'Zero-hour auto purge (ZAP) is a protection feature that retroactively detects and neutralizes malware and high confidence phishing. When ZAP for Teams protection blocks a message, the message is blocked for everyone in the chat. The initial block happens right after delivery, but ZAP occurs up to 48 hours after delivery.'\n\n  desc 'check',\n       \"To audit using the UI:\n        1.Navigate to Microsoft Defender https://security.microsoft.com/\n        2.Click Settings > Email & collaboration > Microsoft Teams protection.\n        3.Ensure Zero-hour auto purge (ZAP) is set to On (Default)\n        4.Under Exclude these participants review the list of exclusions and ensure they are justified and within tolerance for the organization.\n    To audit using PowerShell:\n        1.Connect to Exchange Online using Connect-ExchangeOnline.\n          2.Run the following cmdlets:\n            Get-TeamsProtectionPolicy | fl ZapEnabled\n            Get-TeamsProtectionPolicyRule | fl ExceptIf*\n        3.Ensure ZapEnabled is True.\n        4.Review the list of exclusions and ensure they are justified and within tolerance for the organization. If nothing returns from the 2nd cmdlet then there are no exclusions defined.\"\n\n  desc 'fix',\n       'To remediate using the UI:\n        1.Navigate to Microsoft Defender https://security.microsoft.com/\n        2.Click Settings > Email & collaboration > Microsoft Teams protection.\n        3.Set Zero-hour auto purge (ZAP) to On (Default)\n    To remediate using PowerShell:\n        1.Connect to Exchange Online using Connect-ExchangeOnline.\n        2.Run the following cmdlet:\n            Set-TeamsProtectionPolicy -Identity \"Teams Protection Policy\" -ZapEnabled $true'\n\n  desc 'rationale',\n       'ZAP is intended to protect users that have received zero-day malware messages or\n        content that is weaponized after being delivered to users. It does this by continually\n        monitoring spam and malware signatures taking automated retroactive action on\n        messages that have already been delivered.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['10.1'] }]\n  tag default_value: 'On (Default)'\n  tag nist: ['SI-3']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/zero-hour-auto-purge?view=o365-worldwide#zero-hour-auto-purge-zap-in-microsoft-teams'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/mdo-support-teams-about?view=o365-worldwide#configure-zap-for-teams-protection-in-defender-for-office-365-plan-2'\n\n  ensure_zap_enabled_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    $zapEnabledValue = Get-TeamsProtectionPolicy | Select-Object -ExpandProperty ZapEnabled\n    Write-Host $zapEnabledValue\n }\n  check_exclusions_script = %{\n  $client_id = '#{input('client_id')}'\n  $certificate_password = '#{input('certificate_password')}'\n  $certificate_path = '#{input('certificate_path')}'\n  $organization = '#{input('organization')}'\n  import-module exchangeonlinemanagement\n  Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n  $zapEnabledValue = Get-TeamsProtectionPolicy | Select-Object -ExpandProperty ZapEnabled\n  $rules = Get-TeamsProtectionPolicyRule\n  $filteredRules = $rules | ForEach-Object {\n      $exceptIfData = $_ | Select-Object -Property * | Where-Object { $_.PSObject.Properties.Name -like 'ExceptIf*' }\n      $exceptIfDataString = $exceptIfData | Out-String\n      $exceptIfDataString\n  }\n  $filteredRules\n}\n\n  powershell_output_zap = powershell(ensure_zap_enabled_script)\n  describe 'Ensure the ZapEnabled option for Default Sharing Policy' do\n    subject { powershell_output_zap.stdout.strip }\n    it 'is set to True' do\n      expect(subject).to eq('True')\n    end\n  end\n\n  powershell_output_exclusions = powershell(check_exclusions_script)\n  describe 'Ensure that the list of of exclusions' do\n    subject { powershell_output_exclusions.stdout.strip }\n    it 'is empty. In case of failure, a manual review is required to check the justification of each present exclusion.' do\n      expect(subject).to be_empty\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-2.4.4.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure the ZapEnabled option for Default Sharing Policy is set to True","run_time":6.510913,"start_time":"2024-09-24T15:39:22-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the ZapEnabled option for Default Sharing Policy"},{"status":"passed","code_desc":"Ensure that the list of of exclusions is empty. In case of failure, a manual review is required to check the justification of each present exclusion.","run_time":8.607149,"start_time":"2024-09-24T15:39:29-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the list of of exclusions"}]},{"id":"microsoft-365-foundations-3.1.1","title":"Ensure Microsoft 365 audit log search is Enabled","desc":"When audit log search is enabled in the Microsoft Purview compliance portal, user and admin activity within the organization is recorded in the audit log and retained for 90 days. However, some organizations may prefer to use a third-party security information and event management (SIEM) application to access their auditing data. In this scenario, a global admin can choose to turn off audit log search in Microsoft 365.","descriptions":[{"label":"default","data":"When audit log search is enabled in the Microsoft Purview compliance portal, user and admin activity within the organization is recorded in the audit log and retained for 90 days. However, some organizations may prefer to use a third-party security information and event management (SIEM) application to access their auditing data. In this scenario, a global admin can choose to turn off audit log search in Microsoft 365."},{"label":"check","data":"Ensure Microsoft 365 audit log search is Enabled:\n        1.Navigate to Microsoft Purview https://compliance.microsoft.com.\n        2.Select Audit to open the audit search.\n        3.Choose a date and time frame in the past 30 days.\n        4.Verify search capabilities (e.g. try searching for Activities as Accessed file and results should be displayed).\n    To verify audit log search is enabled using PowerShell:\n        1.Connect to Exchange Online using Connect-ExchangeOnline.\n        2.Run the following PowerShell command:\n            Get-AdminAuditLogConfig | Select-Object UnifiedAuditLogIngestionEnabled\n        3.Ensure UnifiedAuditLogIngestionEnabled is set to True."},{"label":"fix","data":"To enable Microsoft 365 audit log search:\n        1.Navigate to Microsoft Purview https://compliance.microsoft.com.\n        2.Select Audit to open the audit search.\n        3.Click Start recording user and admin activity next to the information warning at the top.\n        4.Click Yes on the dialog box to confirm.\n    To enable Microsoft 365 audit log search using PowerShell:\n        1.Connect to Exchange Online using Connect-ExchangeOnline.\n        2.Run the following PowerShell command:\n            Set-AdminAuditLogConfig -UnifiedAuditLogIngestionEnabled $true"},{"label":"rationale","data":"Enabling audit log search in the Microsoft Purview compliance portal can help\n        organizations improve their security posture, meet regulatory compliance requirements,\n        respond to security incidents, and gain valuable operational insights."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/compliance/audit-log-enable-disable?view=o365-worldwide"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/exchange/set-adminauditlogconfig?view=exchange-ps"}],"tags":{"severity":"medium","cis_controls":[{"8":["8.2"]},{"7":["6.2"]}],"nist":["AU-2","AU-7","AU-12","AC-1","AC-2","AC-2(1)"]},"code":"control 'microsoft-365-foundations-3.1.1' do\n  title 'Ensure Microsoft 365 audit log search is Enabled'\n  desc 'When audit log search is enabled in the Microsoft Purview compliance portal, user and admin activity within the organization is recorded in the audit log and retained for 90 days. However, some organizations may prefer to use a third-party security information and event management (SIEM) application to access their auditing data. In this scenario, a global admin can choose to turn off audit log search in Microsoft 365.'\n\n  desc 'check',\n       \"Ensure Microsoft 365 audit log search is Enabled:\n        1.Navigate to Microsoft Purview https://compliance.microsoft.com.\n        2.Select Audit to open the audit search.\n        3.Choose a date and time frame in the past 30 days.\n        4.Verify search capabilities (e.g. try searching for Activities as Accessed file and results should be displayed).\n    To verify audit log search is enabled using PowerShell:\n        1.Connect to Exchange Online using Connect-ExchangeOnline.\n        2.Run the following PowerShell command:\n            Get-AdminAuditLogConfig | Select-Object UnifiedAuditLogIngestionEnabled\n        3.Ensure UnifiedAuditLogIngestionEnabled is set to True.\"\n\n  desc 'fix',\n       \"To enable Microsoft 365 audit log search:\n        1.Navigate to Microsoft Purview https://compliance.microsoft.com.\n        2.Select Audit to open the audit search.\n        3.Click Start recording user and admin activity next to the information warning at the top.\n        4.Click Yes on the dialog box to confirm.\n    To enable Microsoft 365 audit log search using PowerShell:\n        1.Connect to Exchange Online using Connect-ExchangeOnline.\n        2.Run the following PowerShell command:\n            Set-AdminAuditLogConfig -UnifiedAuditLogIngestionEnabled $true\"\n\n  desc 'rationale',\n       'Enabling audit log search in the Microsoft Purview compliance portal can help\n        organizations improve their security posture, meet regulatory compliance requirements,\n        respond to security incidents, and gain valuable operational insights.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['8.2'] }, { '7' => ['6.2'] }]\n  tag nist: ['AU-2', 'AU-7', 'AU-12', 'AC-1', 'AC-2', 'AC-2(1)']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/compliance/audit-log-enable-disable?view=o365-worldwide'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/exchange/set-adminauditlogconfig?view=exchange-ps'\n\n  ensure_m365_audit_log_enabled_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    (Get-AdminAuditLogConfig | Select-Object -ExpandProperty UnifiedAuditLogIngestionEnabled)\n }\n\n  powershell_output = powershell(ensure_m365_audit_log_enabled_script)\n  describe 'Ensure the UnifiedAuditLogIngestionEnabled option for audit logs' do\n    subject { powershell_output.stdout.strip }\n    it 'is set to True' do\n      expect(subject).to eq('True')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-3.1.1.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure the UnifiedAuditLogIngestionEnabled option for audit logs is set to True","run_time":7.810516,"start_time":"2024-09-24T15:39:37-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the UnifiedAuditLogIngestionEnabled option for audit logs"}]},{"id":"microsoft-365-foundations-3.1.2","title":"Ensure user role group changes are reviewed at least weekly","desc":"Role-Based Access Control allows for permissions to be assigned to users based on their roles within an organization. It is a more manageable form of access control that is less prone to errors. These user roles can be audited inside of Microsoft Purview to provide a security auditor insight into user privilege change.","descriptions":[{"label":"default","data":"Role-Based Access Control allows for permissions to be assigned to users based on their roles within an organization. It is a more manageable form of access control that is less prone to errors. These user roles can be audited inside of Microsoft Purview to provide a security auditor insight into user privilege change."},{"label":"check","data":"To verify user role group changes are being reviewed at least weekly, confirm that the necessary procedures are in place and being followed."},{"label":"fix","data":"To review user role group changes:\n        1. Navigate to Microsoft Purview https://compliance.microsoft.com/.\n        2. Under Solutions click on Audit then select New Search.\n        3. In Activities find Added member to Role under the Role administration activities section and select it.\n        4. Set a valid Start Date and End Date within the last week.\n        5. Click Search.\n        6. Review once the search is completed.\n    To review user role group changes using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline\n        2. Run the following Exchange Online PowerShell command:\n            $startDate = ((Get-date).AddDays(-7)).ToShortDateString()\n            $endDate = (Get-date).ToShortDateString()\n            Search-UnifiedAuditLog -StartDate $startDate -EndDate $endDate -RecordType\n            AzureActiveDirectory -Operations \"Add member to role.\"\n        3. Review the output."},{"label":"rationale","data":"Weekly reviews provide an opportunity to identify rights changes in an organization and\n        are a large part of maintaining Least Privilege and preventing Privilege creep. Insider\n        Threats, either intentional or unintentional, can occur when a user has higher than\n        needed privileges. Maintaining accountability of role membership will keep insiders and\n        malicious actors limited in the scope of potential damaging activities."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/powershell/module/exchange/search-unifiedauditlog?view=exchange-ps"}],"tags":{"severity":"medium","cis_controls":[{"8":["8.11"]},{"7":["6.2"]}],"nist":["AU-6","AU-6(1)","AU-7(1)","AC-1","AC-2","AC-2(1)"]},"code":"control 'microsoft-365-foundations-3.1.2' do\n  title 'Ensure user role group changes are reviewed at least weekly'\n  desc 'Role-Based Access Control allows for permissions to be assigned to users based on their roles within an organization. It is a more manageable form of access control that is less prone to errors. These user roles can be audited inside of Microsoft Purview to provide a security auditor insight into user privilege change.'\n\n  desc 'check',\n       'To verify user role group changes are being reviewed at least weekly, confirm that the necessary procedures are in place and being followed.'\n\n  desc 'fix',\n       'To review user role group changes:\n        1. Navigate to Microsoft Purview https://compliance.microsoft.com/.\n        2. Under Solutions click on Audit then select New Search.\n        3. In Activities find Added member to Role under the Role administration activities section and select it.\n        4. Set a valid Start Date and End Date within the last week.\n        5. Click Search.\n        6. Review once the search is completed.\n    To review user role group changes using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline\n        2. Run the following Exchange Online PowerShell command:\n            $startDate = ((Get-date).AddDays(-7)).ToShortDateString()\n            $endDate = (Get-date).ToShortDateString()\n            Search-UnifiedAuditLog -StartDate $startDate -EndDate $endDate -RecordType\n            AzureActiveDirectory -Operations \"Add member to role.\"\n        3. Review the output.'\n\n  desc 'rationale',\n       'Weekly reviews provide an opportunity to identify rights changes in an organization and\n        are a large part of maintaining Least Privilege and preventing Privilege creep. Insider\n        Threats, either intentional or unintentional, can occur when a user has higher than\n        needed privileges. Maintaining accountability of role membership will keep insiders and\n        malicious actors limited in the scope of potential damaging activities.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['8.11'] }, { '7' => ['6.2'] }]\n  tag nist: ['AU-6', 'AU-6(1)', 'AU-7(1)', 'AC-1', 'AC-2', 'AC-2(1)']\n\n  ref 'https://learn.microsoft.com/en-us/powershell/module/exchange/search-unifiedauditlog?view=exchange-ps'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-3.1.2.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":1.7e-05,"start_time":"2024-09-24T15:39:45-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-3.2.1","title":"Ensure DLP policies are enabled","desc":"Data Loss Prevention (DLP) policies allow Exchange Online and SharePoint Online content to be scanned for specific types of data like social security numbers, credit card numbers, or passwords.","descriptions":[{"label":"default","data":"Data Loss Prevention (DLP) policies allow Exchange Online and SharePoint Online content to be scanned for specific types of data like social security numbers, credit card numbers, or passwords."},{"label":"check","data":"Ensure DLP policies are enabled:\n        1. Navigate to Microsoft Purview https://compliance.microsoft.com.\n        2. Under Solutions select Data loss prevention then Policies.\n        3. Verify that policies exist and are enabled."},{"label":"fix","data":"To enable DLP policies:\n        1. Navigate to Microsoft Purview https://compliance.microsoft.com.\n        2. Under Solutions select Data loss prevention then Policies.\n        3. Click Create policy."},{"label":"rationale","data":"Enabling DLP policies alerts users and administrators that specific types of data should\n        not be exposed, helping to protect the data from accidental exposure."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/compliance/dlp-learn-about-dlp?view=o365-worldwide"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.1"]},{"7":["13"]},{"7":["14.7"]}],"nist":["AU-11","CM-12","SI-12","AT-2"]},"code":"control 'microsoft-365-foundations-3.2.1' do\n  title 'Ensure DLP policies are enabled'\n  desc 'Data Loss Prevention (DLP) policies allow Exchange Online and SharePoint Online content to be scanned for specific types of data like social security numbers, credit card numbers, or passwords.'\n\n  desc 'check',\n       \"Ensure DLP policies are enabled:\n        1. Navigate to Microsoft Purview https://compliance.microsoft.com.\n        2. Under Solutions select Data loss prevention then Policies.\n        3. Verify that policies exist and are enabled.\"\n\n  desc 'fix',\n       \"To enable DLP policies:\n        1. Navigate to Microsoft Purview https://compliance.microsoft.com.\n        2. Under Solutions select Data loss prevention then Policies.\n        3. Click Create policy.\"\n\n  desc 'rationale',\n       'Enabling DLP policies alerts users and administrators that specific types of data should\n        not be exposed, helping to protect the data from accidental exposure.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['3.1'] }, { '7' => ['13'] }, { '7' => ['14.7'] }]\n  tag nist: ['AU-11', 'CM-12', 'SI-12', 'AT-2']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/compliance/dlp-learn-about-dlp?view=o365-worldwide'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-3.2.1.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":9.0e-06,"start_time":"2024-09-24T15:39:45-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-3.2.2","title":"Ensure DLP policies are enabled for Microsoft Teams","desc":"The default Teams Data Loss Prevention (DLP) policy rule in Microsoft 365 is a preconfigured rule that is automatically applied to all Teams conversations and channels. The default rule helps prevent accidental sharing of sensitive information by detecting and blocking certain types of content that are deemed sensitive or inappropriate by the organization.\n        By default, the rule includes a check for the sensitive info type Credit Card Number which is pre-defined by Microsoft.","descriptions":[{"label":"default","data":"The default Teams Data Loss Prevention (DLP) policy rule in Microsoft 365 is a preconfigured rule that is automatically applied to all Teams conversations and channels. The default rule helps prevent accidental sharing of sensitive information by detecting and blocking certain types of content that are deemed sensitive or inappropriate by the organization.\n        By default, the rule includes a check for the sensitive info type Credit Card Number which is pre-defined by Microsoft."},{"label":"check","data":"To audit the using the UI:\n        1. Navigate to Microsoft Purview compliance portal https://compliance.microsoft.com.\n        2. Under Solutions select Data loss prevention then Policies.\n        3. Locate the Default policy for Teams.\n        4. Verify the Status is On.\n        5. Verify Locations include Teams chat and channel messages - All accounts.\n        6. Verify Policy settings incudes the Default Teams DLP policy rule or one specific to the organization.\n    Note: If there is not a default policy for teams inspect existing policies starting with step 4. DLP rules are specific to the organization and each organization should take steps to protect the data that matters to them. The default teams DLP rule will only alert on Credit Card matches.\n    To audit using PowerShell:\n        1. Connect to the Security & Compliance PowerShell using Connect-IPPSSession.\n        2. Run the following to return policies that include Teams chat and channel messages:\n            $DlpPolicy = Get-DlpCompliancePolicy\n            $DlpPolicy | Where-Object {$_.Workload -match \"Teams\"} | ft Name,Mode,TeamsLocation*\n        3. If nothing returns then there are no policies that include Teams and remediation is required.\n        4. For any returned policy verify Mode is set to Enable.\n        5. Verify TeamsLocation includes All.\n        6. Verify TeamsLocationException includes only permitted exceptions.\n    Note: Some tenants may not have a default policy for teams as Microsoft started creating these by default at a particular point in time. In this case a new policy will have to be created that includes a rule to protect data important to the organization such as credit cards and PII."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft Purview compliance portal https://compliance.microsoft.com.\n        2. Under Solutions select Data loss prevention then Policies.\n        3. Click Policies tab.\n        4. Check Default policy for Teams then click Edit policy.\n        5. The edit policy window will appear click Next\n        6. At the Choose locations to apply the policy page, turn the status toggle to On for Teams chat and channel messages location and then click Next.\n        7. On Customized advanced DLP rules page, ensure the Default Teams DLP policy rule Status is On and click Next.\n        8. On the Policy mode page, select the radial for Turn it on right away and click Next.\n        9. Review all the settings for the created policy on the Review your policy and create it page, and then click submit.\n        10. Once the policy has been successfully submitted click Done.\n    Note: Some tenants may not have a default policy for teams as Microsoft started creating these by default at a particular point in time. In this case a new policy will have to be created that includes a rule to protect data important to the organization such as credit cards and PII."},{"label":"rationale","data":"Enabling the default Teams DLP policy rule in Microsoft 365 helps protect an\n        organization's sensitive information by preventing accidental sharing or leakage Credit\n        Card information in Teams conversations and channels.\n        DLP rules are not one size fits all, but at a minimum something should be defined. The\n        organization should identify sensitive information important to them and seek to\n        intercept it using DLP."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/powershell/exchange/connect-to-scc-powershell?view=exchange-ps"},{"ref":"https://learn.microsoft.com/en-us/purview/dlp-teams-default-policy?view=o365-worldwide%2F1000"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/exchange/connect-ippssession?view=exchange-ps"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.1"]},{"7":["13"]},{"7":["14.7"]}],"default_value":"Enabled (On)","nist":["AU-11","CM-12","SI-12","AT-2"]},"code":"control 'microsoft-365-foundations-3.2.2' do\n  title 'Ensure DLP policies are enabled for Microsoft Teams'\n  desc \"The default Teams Data Loss Prevention (DLP) policy rule in Microsoft 365 is a preconfigured rule that is automatically applied to all Teams conversations and channels. The default rule helps prevent accidental sharing of sensitive information by detecting and blocking certain types of content that are deemed sensitive or inappropriate by the organization.\n        By default, the rule includes a check for the sensitive info type Credit Card Number which is pre-defined by Microsoft.\"\n\n  desc 'check',\n       'To audit the using the UI:\n        1. Navigate to Microsoft Purview compliance portal https://compliance.microsoft.com.\n        2. Under Solutions select Data loss prevention then Policies.\n        3. Locate the Default policy for Teams.\n        4. Verify the Status is On.\n        5. Verify Locations include Teams chat and channel messages - All accounts.\n        6. Verify Policy settings incudes the Default Teams DLP policy rule or one specific to the organization.\n    Note: If there is not a default policy for teams inspect existing policies starting with step 4. DLP rules are specific to the organization and each organization should take steps to protect the data that matters to them. The default teams DLP rule will only alert on Credit Card matches.\n    To audit using PowerShell:\n        1. Connect to the Security & Compliance PowerShell using Connect-IPPSSession.\n        2. Run the following to return policies that include Teams chat and channel messages:\n            $DlpPolicy = Get-DlpCompliancePolicy\n            $DlpPolicy | Where-Object {$_.Workload -match \"Teams\"} | ft Name,Mode,TeamsLocation*\n        3. If nothing returns then there are no policies that include Teams and remediation is required.\n        4. For any returned policy verify Mode is set to Enable.\n        5. Verify TeamsLocation includes All.\n        6. Verify TeamsLocationException includes only permitted exceptions.\n    Note: Some tenants may not have a default policy for teams as Microsoft started creating these by default at a particular point in time. In this case a new policy will have to be created that includes a rule to protect data important to the organization such as credit cards and PII.'\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to Microsoft Purview compliance portal https://compliance.microsoft.com.\n        2. Under Solutions select Data loss prevention then Policies.\n        3. Click Policies tab.\n        4. Check Default policy for Teams then click Edit policy.\n        5. The edit policy window will appear click Next\n        6. At the Choose locations to apply the policy page, turn the status toggle to On for Teams chat and channel messages location and then click Next.\n        7. On Customized advanced DLP rules page, ensure the Default Teams DLP policy rule Status is On and click Next.\n        8. On the Policy mode page, select the radial for Turn it on right away and click Next.\n        9. Review all the settings for the created policy on the Review your policy and create it page, and then click submit.\n        10. Once the policy has been successfully submitted click Done.\n    Note: Some tenants may not have a default policy for teams as Microsoft started creating these by default at a particular point in time. In this case a new policy will have to be created that includes a rule to protect data important to the organization such as credit cards and PII.\"\n\n  desc 'rationale',\n       \"Enabling the default Teams DLP policy rule in Microsoft 365 helps protect an\n        organization's sensitive information by preventing accidental sharing or leakage Credit\n        Card information in Teams conversations and channels.\n        DLP rules are not one size fits all, but at a minimum something should be defined. The\n        organization should identify sensitive information important to them and seek to\n        intercept it using DLP.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['3.1'] }, { '7' => ['13'] }, { '7' => ['14.7'] }]\n  tag default_value: 'Enabled (On)'\n  tag nist: ['AU-11', 'CM-12', 'SI-12', 'AT-2']\n\n  ref 'https://learn.microsoft.com/en-us/powershell/exchange/connect-to-scc-powershell?view=exchange-ps'\n  ref 'https://learn.microsoft.com/en-us/purview/dlp-teams-default-policy?view=o365-worldwide%2F1000'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/exchange/connect-ippssession?view=exchange-ps'\n\n  ensure_dlp_policies_enabled_teams_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-IPPSSession -AppID $client_id -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force) -Organization $organization -ShowBanner:$false\n    $DlpPolicy = Get-DlpCompliancePolicy\n    $DlpPolicy | Where-Object {$_.Workload -match \"Teams\"} | Select-Object Name, Mode, TeamsLocation, TeamsLocationException | ConvertTo-Json\n }\n\n  powershell_output = JSON.parse(powershell(ensure_dlp_policies_enabled_teams_script).stdout.strip)\n  case powershell_output\n  when Hash\n    describe \"Ensure the following DLP policy (#{powershell_output['Name']})\" do\n      it 'should have its Mode state set to Enable' do\n        expect(powershell_output['Mode']).to eq('Enable')\n      end\n      it %(should have its TeamsLocation state include 'All') do\n        expect(powershell_output['TeamsLocation'][0]['DisplayName']).to include('All')\n      end\n      it 'should have its TeamsLocationException state to be empty or include only permitted exceptions' do\n        permitted_exceptions = input('permitted_exceptions_teams_locations')\n        actual_exceptions = powershell_output['TeamsLocationException']\n        expect(actual_exceptions.empty? ||\n        (actual_exceptions - permitted_exceptions).empty? ||\n        actual_exceptions.sort == permitted_exceptions.sort).to eq(true)\n      end\n    end\n  when Array\n    powershell_output.each do |policy|\n      describe %(Ensure the following DLP policy (#{policy['Identity']})) do\n        it 'should have its Mode state set to Enable' do\n          expect(powershell_output['Mode']).to eq('Enable')\n        end\n        it %(should have its TeamsLocation state include 'All') do\n          expect(powershell_output['TeamsLocation'][0]['DisplayName']).to include('All')\n        end\n        it 'should have its TeamsLocationException state to be empty or include only permitted exceptions' do\n          permitted_exceptions = input('permitted_exceptions_teams_locations')\n          actual_exceptions = powershell_output['TeamsLocationException']\n          expect(actual_exceptions.empty? ||\n          (actual_exceptions - permitted_exceptions).empty? ||\n          actual_exceptions.sort == permitted_exceptions.sort).to eq(true)\n        end\n      end\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-3.2.2.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure the following DLP policy (Default policy for Teams) should have its Mode state set to Enable","run_time":0.000119,"start_time":"2024-09-24T15:39:45-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following DLP policy (Default policy for Teams)"},{"status":"passed","code_desc":"Ensure the following DLP policy (Default policy for Teams) should have its TeamsLocation state include 'All'","run_time":8.5e-05,"start_time":"2024-09-24T15:39:45-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following DLP policy (Default policy for Teams)"},{"status":"passed","code_desc":"Ensure the following DLP policy (Default policy for Teams) should have its TeamsLocationException state to be empty or include only permitted exceptions","run_time":0.000115,"start_time":"2024-09-24T15:39:45-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following DLP policy (Default policy for Teams)"}]},{"id":"microsoft-365-foundations-3.3.1","title":"Ensure SharePoint Online Information Protection policies are set up and used","desc":"SharePoint Online Data Classification Policies enables organizations to classify and label content in SharePoint Online based on its sensitivity and business impact. This setting helps organizations to manage and protect sensitive data by automatically applying labels to content, which can then be used to apply policy-based protection and governance controls.","descriptions":[{"label":"default","data":"SharePoint Online Data Classification Policies enables organizations to classify and label content in SharePoint Online based on its sensitivity and business impact. This setting helps organizations to manage and protect sensitive data by automatically applying labels to content, which can then be used to apply policy-based protection and governance controls."},{"label":"check","data":"Ensure SharePoint Online Information Protection policies are set up and used:\n        1. Navigate to Microsoft Purview compliance portal https://compliance.microsoft.com.\n        2. Under Solutions select Information protection.\n        3. Click on the Label policies tab.\n        4. Ensure that a Label policy exists and is published accordingly."},{"label":"fix","data":"To set up SharePoint Online Information Protection:\n        1. Navigate to Microsoft Purview compliance portal https://compliance.microsoft.com.\n        2. Under Solutions select Information protection.\n        3. Click on the Label policies tab.\n        4. Click Create a label to create a label.\n        5. Select the label and click on the Publish label.\n        6. Fill out the forms to create the policy."},{"label":"rationale","data":"By categorizing and applying policy-based protection, SharePoint Online Data\n        Classification Policies can help reduce the risk of data loss or exposure and enable\n        more effective incident response if a breach does occur."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/compliance/data-classification-overview?view=o365-worldwide#top-sensitivity-labels-applied-to-content"},{"ref":"https://learn.microsoft.com/en-us/purview/sensitivity-labels-sharepoint-onedrive-files"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.7"]},{"7":["13.1"]},{"7":["14.6"]}],"nist":["RA-2","AU-6(1)","AU-7","IR-4(1)","SI-4(2)","SI-4(5)","AT-2"]},"code":"control 'microsoft-365-foundations-3.3.1' do\n  title 'Ensure SharePoint Online Information Protection policies are set up and used'\n  desc 'SharePoint Online Data Classification Policies enables organizations to classify and label content in SharePoint Online based on its sensitivity and business impact. This setting helps organizations to manage and protect sensitive data by automatically applying labels to content, which can then be used to apply policy-based protection and governance controls.'\n\n  desc 'check',\n       \"Ensure SharePoint Online Information Protection policies are set up and used:\n        1. Navigate to Microsoft Purview compliance portal https://compliance.microsoft.com.\n        2. Under Solutions select Information protection.\n        3. Click on the Label policies tab.\n        4. Ensure that a Label policy exists and is published accordingly.\"\n\n  desc 'fix',\n       \"To set up SharePoint Online Information Protection:\n        1. Navigate to Microsoft Purview compliance portal https://compliance.microsoft.com.\n        2. Under Solutions select Information protection.\n        3. Click on the Label policies tab.\n        4. Click Create a label to create a label.\n        5. Select the label and click on the Publish label.\n        6. Fill out the forms to create the policy.\"\n\n  desc 'rationale',\n       'By categorizing and applying policy-based protection, SharePoint Online Data\n        Classification Policies can help reduce the risk of data loss or exposure and enable\n        more effective incident response if a breach does occur.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [\n    { '8' => ['3.7'] },\n    { '7' => ['13.1'] },\n    { '7' => ['14.6'] }\n  ]\n  tag nist: ['RA-2', 'AU-6(1)', 'AU-7', 'IR-4(1)', 'SI-4(2)', 'SI-4(5)', 'AT-2']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/compliance/data-classification-overview?view=o365-worldwide#top-sensitivity-labels-applied-to-content'\n  ref 'https://learn.microsoft.com/en-us/purview/sensitivity-labels-sharepoint-onedrive-files'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-3.3.1.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":5.0e-06,"start_time":"2024-09-24T15:39:45-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.1.1.1","title":"Ensure Security Defaults is disabled on Azure Active Directory","desc":"Security defaults in Microsoft Entra ID make it easier to be secure and help protect the organization. Security defaults contain preconfigured security settings for common attacks.\n        By default, Microsoft enables security defaults. The goal is to ensure that all organizations have a basic level of security enabled. The security default setting is manipulated in the Azure Portal.\n        The use of security defaults, however, will prohibit custom settings which are being set with more advanced settings from this benchmark.","descriptions":[{"label":"default","data":"Security defaults in Microsoft Entra ID make it easier to be secure and help protect the organization. Security defaults contain preconfigured security settings for common attacks.\n        By default, Microsoft enables security defaults. The goal is to ensure that all organizations have a basic level of security enabled. The security default setting is manipulated in the Azure Portal.\n        The use of security defaults, however, will prohibit custom settings which are being set with more advanced settings from this benchmark."},{"label":"check","data":"Ensure security defaults is disabled:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click to expand Identity select Overview\n        3. Click Properties.\n        4. Review the section Security Defaults near the bottom\n        5. If Manage security defaults appears clickable then proceed to the remediation section, otherwise read the note below.\n    NOTE: If Manage Conditional Access appears in blue then Security defaults are already disabled, and CA is in use. The audit can be considered a Pass.\n        To verify security defaults is disabled using Microsoft Graph PowerShell:\n        1. Connect to the Microsoft Graph service using Connect-MgGraph -Scopes \"Policy.Read.All\".\n        2. Run the following Microsoft Graph PowerShell command:\n            Get-MgPolicyIdentitySecurityDefaultEnforcementPolicy | ft IsEnabled\n        3. If the value is false then Security Defaults is disabled."},{"label":"fix","data":"To disable security defaults:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click to expand Identity select Overview\n        3. Click Properties.\n        4. Click Manage security defaults.\n        5. Set the Security defaults dropdown to Disabled.\n        6. Select Save.\n    To configure security defaults using Microsoft Graph PowerShell:\n        1. Connect to the Microsoft Graph service using Connect-MgGraph -Scopes \"Policy.ReadWrite.ConditionalAccess\".\n        2. Run the following Microsoft Graph PowerShell command:\n            $params = @{ IsEnabled = $false }\n            Update-MgPolicyIdentitySecurityDefaultEnforcementPolicy -BodyParameter $params\n    Warning: It is recommended not to disable security defaults until you are ready to implement conditional access rules in the benchmark. Rules such as requiring MFA for all users and blocking legacy protocols are required in CA to make up for the gap created by disabling defaults. Plan accordingly. See the reference section for more details on what coverage Security Defaults provide."},{"label":"rationale","data":"Security defaults provide secure default settings that are managed on behalf of\n        organizations to keep customers safe until they are ready to manage their own identity\n        security settings.\n        For example, doing the following:\n          • Requiring all users and admins to register for MFA.\n          • Challenging users with MFA - mostly when they show up on a new device or app,\n        but more often for critical roles and tasks.\n          • Disabling authentication from legacy authentication clients, which can’t do MFA."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/concept-fundamentals-security-defaults"},{"ref":"https://techcommunity.microsoft.com/t5/azure-active-directory-identity/introducing-security-defaults/ba-p/1061414"}],"tags":{"severity":"medium","cis_controls":[{"8":["untracked"]}],"default_value":"Enabled.","nist":["CM-6"]},"code":"control 'microsoft-365-foundations-5.1.1.1' do\n  title 'Ensure Security Defaults is disabled on Azure Active Directory'\n  desc \"Security defaults in Microsoft Entra ID make it easier to be secure and help protect the organization. Security defaults contain preconfigured security settings for common attacks.\n        By default, Microsoft enables security defaults. The goal is to ensure that all organizations have a basic level of security enabled. The security default setting is manipulated in the Azure Portal.\n        The use of security defaults, however, will prohibit custom settings which are being set with more advanced settings from this benchmark.\"\n\n  desc 'check',\n       'Ensure security defaults is disabled:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click to expand Identity select Overview\n        3. Click Properties.\n        4. Review the section Security Defaults near the bottom\n        5. If Manage security defaults appears clickable then proceed to the remediation section, otherwise read the note below.\n    NOTE: If Manage Conditional Access appears in blue then Security defaults are already disabled, and CA is in use. The audit can be considered a Pass.\n        To verify security defaults is disabled using Microsoft Graph PowerShell:\n        1. Connect to the Microsoft Graph service using Connect-MgGraph -Scopes \"Policy.Read.All\".\n        2. Run the following Microsoft Graph PowerShell command:\n            Get-MgPolicyIdentitySecurityDefaultEnforcementPolicy | ft IsEnabled\n        3. If the value is false then Security Defaults is disabled.'\n\n  desc 'fix',\n       'To disable security defaults:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click to expand Identity select Overview\n        3. Click Properties.\n        4. Click Manage security defaults.\n        5. Set the Security defaults dropdown to Disabled.\n        6. Select Save.\n    To configure security defaults using Microsoft Graph PowerShell:\n        1. Connect to the Microsoft Graph service using Connect-MgGraph -Scopes \"Policy.ReadWrite.ConditionalAccess\".\n        2. Run the following Microsoft Graph PowerShell command:\n            $params = @{ IsEnabled = $false }\n            Update-MgPolicyIdentitySecurityDefaultEnforcementPolicy -BodyParameter $params\n    Warning: It is recommended not to disable security defaults until you are ready to implement conditional access rules in the benchmark. Rules such as requiring MFA for all users and blocking legacy protocols are required in CA to make up for the gap created by disabling defaults. Plan accordingly. See the reference section for more details on what coverage Security Defaults provide.'\n\n  desc 'rationale',\n       'Security defaults provide secure default settings that are managed on behalf of\n        organizations to keep customers safe until they are ready to manage their own identity\n        security settings.\n        For example, doing the following:\n          • Requiring all users and admins to register for MFA.\n          • Challenging users with MFA - mostly when they show up on a new device or app,\n        but more often for critical roles and tasks.\n          • Disabling authentication from legacy authentication clients, which can’t do MFA.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['untracked'] }]\n  tag default_value: 'Enabled.'\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/concept-fundamentals-security-defaults'\n  ref 'https://techcommunity.microsoft.com/t5/azure-active-directory-identity/introducing-security-defaults/ba-p/1061414'\n\n  ensure_security_defaults_disabled_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}' # SAME AS APPLICATION ID.   TERMS often interchangeable\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}' #This should not be stored inside of any script; supplied to transmit detail\n    import-module microsoft.graph\n    $password = ConvertTo-SecureString -String $clientSecret -AsPlainText -Force\n    $ClientSecretCredential = New-Object -TypeName System.Management.Automation.PSCredential($client_id,$password)\n    Connect-MgGraph -TenantId \"$tenantid\" -ClientSecretCredential $ClientSecretCredential -NoWelcome\n    Connect-MgGraph -Scopes \"Policy.Read.All\" -NoWelcome\n    Write-Output (Get-MgPolicyIdentitySecurityDefaultEnforcementPolicy).IsEnabled\n    }\n\n  powershell_output = powershell(ensure_security_defaults_disabled_script)\n  describe 'Ensure security defaults option MgPolicyIdentitySecurityDefaultEnforcementPolicy on Azure Active Directory' do\n    subject { powershell_output.stdout.strip }\n    it 'is disabled' do\n      expect(subject).to eq('False')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.1.1.1.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure security defaults option MgPolicyIdentitySecurityDefaultEnforcementPolicy on Azure Active Directory is disabled","run_time":138.081114,"start_time":"2024-09-24T15:39:45-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure security defaults option MgPolicyIdentitySecurityDefaultEnforcementPolicy on Azure Active Directory"}]},{"id":"microsoft-365-foundations-5.1.2.1","title":"Ensure 'Per-user MFA' is disabled","desc":"Legacy per-user Multi-Factor Authentication (MFA) can be configured to require individual users to provide multiple authentication factors, such as passwords and additional verification codes, to access their accounts. It was introduced in earlier versions of Office 365, prior to the more comprehensive implementation of Conditional Access (CA).","descriptions":[{"label":"default","data":"Legacy per-user Multi-Factor Authentication (MFA) can be configured to require individual users to provide multiple authentication factors, such as passwords and additional verification codes, to access their accounts. It was introduced in earlier versions of Office 365, prior to the more comprehensive implementation of Conditional Access (CA)."},{"label":"check","data":"To audit per-user MFA using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Users select All users.\n        3. Click on Per-user MFA on the top row.\n        4. Ensure under the column Multi-factor Auth Status that each account is set to Disabled"},{"label":"fix","data":"Disable per-user MFA using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Users select All users.\n        3. Click on Per-user MFA on the top row.\n        4. Click the empty box next to Display Name to select all accounts.\n        5. On the far right under quick steps click Disable."},{"label":"rationale","data":"Both security defaults and conditional access with security defaults turned off are not\n        compatible with per-user multi-factor authentication (MFA), which can lead to\n        undesirable user authentication states. The CIS Microsoft 365 Benchmark explicitly\n        employs Conditional Access for MFA as an enhancement over security defaults and as\n        a replacement for the outdated per-user MFA. To ensure a consistent authentication\n        state disable per-user MFA on all accounts."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/authentication/howto-mfa-userstates#convert-users-from-per-user-mfa-to-conditional-access"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/admin/security-and-compliance/set-up-multi-factor-authentication?view=o365-worldwide#use-conditional-access-policies"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/authentication/howto-mfa-userstates#convert-per-user-mfa-enabled-and-enforced-users-to-disabled"}],"tags":{"severity":"medium","cis_controls":[{"8":["6.3"]}],"default_value":"Disabled","nist":["IA-2(1)","IA-2(2)"]},"code":"control 'microsoft-365-foundations-5.1.2.1' do\n  title \"Ensure 'Per-user MFA' is disabled\"\n  desc 'Legacy per-user Multi-Factor Authentication (MFA) can be configured to require individual users to provide multiple authentication factors, such as passwords and additional verification codes, to access their accounts. It was introduced in earlier versions of Office 365, prior to the more comprehensive implementation of Conditional Access (CA).'\n\n  desc 'check',\n       \"To audit per-user MFA using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Users select All users.\n        3. Click on Per-user MFA on the top row.\n        4. Ensure under the column Multi-factor Auth Status that each account is set to Disabled\"\n\n  desc 'fix',\n       \"Disable per-user MFA using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Users select All users.\n        3. Click on Per-user MFA on the top row.\n        4. Click the empty box next to Display Name to select all accounts.\n        5. On the far right under quick steps click Disable.\"\n\n  desc 'rationale',\n       'Both security defaults and conditional access with security defaults turned off are not\n        compatible with per-user multi-factor authentication (MFA), which can lead to\n        undesirable user authentication states. The CIS Microsoft 365 Benchmark explicitly\n        employs Conditional Access for MFA as an enhancement over security defaults and as\n        a replacement for the outdated per-user MFA. To ensure a consistent authentication\n        state disable per-user MFA on all accounts.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['6.3'] }]\n  tag default_value: 'Disabled'\n  tag nist: ['IA-2(1)', 'IA-2(2)']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/authentication/howto-mfa-userstates#convert-users-from-per-user-mfa-to-conditional-access'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/admin/security-and-compliance/set-up-multi-factor-authentication?view=o365-worldwide#use-conditional-access-policies'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/authentication/howto-mfa-userstates#convert-per-user-mfa-enabled-and-enforced-users-to-disabled'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.1.2.1.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":1.0e-05,"start_time":"2024-09-24T15:42:03-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.1.2.2","title":"Ensure third party integrated applications are not allowed","desc":"App registration allows users to register custom-developed applications for use within the directory.","descriptions":[{"label":"default","data":"App registration allows users to register custom-developed applications for use within the directory."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Users select Users settings.\n        3. Verify Users can register applications is set to No.\n        To audit using PowerShell:\n        1. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"Policy.Read.All\"\n        2. Run the following command:\n            (Get-MgPolicyAuthorizationPolicy).DefaultUserRolePermissions | fl AllowedToCreateApps\n        3. Ensure the returned value is False."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Users select Users settings.\n        3. Set Users can register applications to No.\n        4. Click Save.\n    To remediate using PowerShell:\n        1. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"Policy.ReadWrite.Authorization\"\n        2. Run the following commands:\n            $param = @{ AllowedToCreateApps = \"$false\" }\n            Update-MgPolicyAuthorizationPolicy -DefaultUserRolePermissions $param"},{"label":"rationale","data":"Third-party integrated applications connection to services should be disabled unless\n        there is a very clear value and robust security controls are in place. While there are\n        legitimate uses, attackers can grant access from breached accounts to third party\n        applications to exfiltrate data from your tenancy without having to maintain the breached\n        account."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/develop/active-directory-how-applications-are-added"}],"tags":{"severity":"medium","cis_controls":[{"8":["2.5"]},{"7":["18.4"]}],"default_value":"Yes (Users can register applications.)","nist":["CM-7(5)","CM-10"]},"code":"control 'microsoft-365-foundations-5.1.2.2' do\n  title 'Ensure third party integrated applications are not allowed'\n  desc 'App registration allows users to register custom-developed applications for use within the directory.'\n\n  desc 'check',\n       'To audit using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Users select Users settings.\n        3. Verify Users can register applications is set to No.\n        To audit using PowerShell:\n        1. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"Policy.Read.All\"\n        2. Run the following command:\n            (Get-MgPolicyAuthorizationPolicy).DefaultUserRolePermissions | fl AllowedToCreateApps\n        3. Ensure the returned value is False.'\n\n  desc 'fix',\n       'To remediate using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Users select Users settings.\n        3. Set Users can register applications to No.\n        4. Click Save.\n    To remediate using PowerShell:\n        1. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"Policy.ReadWrite.Authorization\"\n        2. Run the following commands:\n            $param = @{ AllowedToCreateApps = \"$false\" }\n            Update-MgPolicyAuthorizationPolicy -DefaultUserRolePermissions $param'\n\n  desc 'rationale',\n       'Third-party integrated applications connection to services should be disabled unless\n        there is a very clear value and robust security controls are in place. While there are\n        legitimate uses, attackers can grant access from breached accounts to third party\n        applications to exfiltrate data from your tenancy without having to maintain the breached\n        account.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['2.5'] }, { '7' => ['18.4'] }]\n  tag default_value: 'Yes (Users can register applications.)'\n  tag nist: ['CM-7(5)', 'CM-10']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/develop/active-directory-how-applications-are-added'\n\n  ensure_third_party_apps_not_allowed_script = %{\n  $appName = 'cisBenchmarkL512'\n  $client_id = '#{input('client_id')}'\n  $tenantid = '#{input('tenant_id')}'\n  $clientSecret = '#{input('client_secret')}' #This should not be stored inside of any script; supplied to transmit detail\n  import-module microsoft.graph\n  $password = ConvertTo-SecureString -String $clientSecret -AsPlainText -Force\n  $ClientSecretCredential = New-Object -TypeName System.Management.Automation.PSCredential($client_id,$password)\n  Connect-MgGraph -TenantId \"$tenantid\" -ClientSecretCredential $ClientSecretCredential -NoWelcome\n  Connect-MgGraph -Scopes \"Policy.Read.All\" -NoWelcome\n  $thirdPartyAllowance = (Get-MgPolicyAuthorizationPolicy).DefaultUserRolePermissions\n  Write-Output $thirdPartyAllowance.AllowedToCreateApps\n  }\n\n  powershell_output = powershell(ensure_third_party_apps_not_allowed_script)\n  describe 'Ensure DefaultUserRolePermissions.AllowedToCreateApps' do\n    subject { powershell_output.stdout.strip }\n    it 'is set to false' do\n      expect(subject).to eq('False')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.1.2.2.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure DefaultUserRolePermissions.AllowedToCreateApps is set to false","run_time":141.840429,"start_time":"2024-09-24T15:42:03-04:00","message":"\nexpected: \"False\"\n     got: \"True\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure DefaultUserRolePermissions.AllowedToCreateApps"}]},{"id":"microsoft-365-foundations-5.1.2.3","title":"Ensure 'Restrict non-admin users from creating tenants' is set to 'Yes'","desc":"Non-privileged users can create tenants in the Entra administration portal under Manage tenant. The creation of a tenant is recorded in the Audit log as category \"DirectoryManagement\" and activity \"Create Company\". Anyone who creates a tenant becomes the Global Administrator of that tenant. The newly created tenant doesn't inherit any settings or configurations.","descriptions":[{"label":"default","data":"Non-privileged users can create tenants in the Entra administration portal under Manage tenant. The creation of a tenant is recorded in the Audit log as category \"DirectoryManagement\" and activity \"Create Company\". Anyone who creates a tenant becomes the Global Administrator of that tenant. The newly created tenant doesn't inherit any settings or configurations."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Identity> Users > User settings.\n        3. Ensure Restrict non-admin users from creating tenants is set to Yes\n    To audit using PowerShell:\n        1. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"Policy.Read.All\"\n        2. Run the following commands:\n            (Get-MgPolicyAuthorizationPolicy).DefaultUserRolePermissions | Select-Object AllowedToCreateTenants\n        3. Ensure the returned value is False"},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Identity> Users > User settings.\n        3. Set Restrict non-admin users from creating tenants to Yes then Save.\n    To remediate using PowerShell:\n        1. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"Policy.ReadWrite.Authorization\"\n        2. Run the following commands.\n            # Create hashtable and update the auth policy\n            $params = @{ AllowedToCreateTenants = $false }\n            Update-MgPolicyAuthorizationPolicy -DefaultUserRolePermissions $params"},{"label":"rationale","data":"Restricting tenant creation prevents unauthorized or uncontrolled deployment of\n        resources and ensures that the organization retains control over its infrastructure. User\n        generation of shadow IT could lead to multiple, disjointed environments that can make it\n        difficult for IT to manage and secure the organization's data, especially if other users in\n        the organization began using these tenants for business purposes under the\n        misunderstanding that they were secured by the organization's security team."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions#restrict-member-users-default-permissions"}],"tags":{"severity":"medium","cis_controls":[{"8":["untracked"]}],"default_value":"No - Non-administrators can create tenants.\n                      AllowedToCreateTenants is True","nist":["CM-6"]},"code":"control 'microsoft-365-foundations-5.1.2.3' do\n  title \"Ensure 'Restrict non-admin users from creating tenants' is set to 'Yes'\"\n  desc \"Non-privileged users can create tenants in the Entra administration portal under Manage tenant. The creation of a tenant is recorded in the Audit log as category \\\"DirectoryManagement\\\" and activity \\\"Create Company\\\". Anyone who creates a tenant becomes the Global Administrator of that tenant. The newly created tenant doesn't inherit any settings or configurations.\"\n\n  desc 'check',\n       'To audit using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Identity> Users > User settings.\n        3. Ensure Restrict non-admin users from creating tenants is set to Yes\n    To audit using PowerShell:\n        1. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"Policy.Read.All\"\n        2. Run the following commands:\n            (Get-MgPolicyAuthorizationPolicy).DefaultUserRolePermissions | Select-Object AllowedToCreateTenants\n        3. Ensure the returned value is False'\n\n  desc 'fix',\n       'To remediate using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Identity> Users > User settings.\n        3. Set Restrict non-admin users from creating tenants to Yes then Save.\n    To remediate using PowerShell:\n        1. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"Policy.ReadWrite.Authorization\"\n        2. Run the following commands.\n            # Create hashtable and update the auth policy\n            $params = @{ AllowedToCreateTenants = $false }\n            Update-MgPolicyAuthorizationPolicy -DefaultUserRolePermissions $params'\n\n  desc 'rationale',\n       \"Restricting tenant creation prevents unauthorized or uncontrolled deployment of\n        resources and ensures that the organization retains control over its infrastructure. User\n        generation of shadow IT could lead to multiple, disjointed environments that can make it\n        difficult for IT to manage and secure the organization's data, especially if other users in\n        the organization began using these tenants for business purposes under the\n        misunderstanding that they were secured by the organization's security team.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['untracked'] }]\n  tag default_value: 'No - Non-administrators can create tenants.\n                      AllowedToCreateTenants is True'\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions#restrict-member-users-default-permissions'\n\n  ensure_nonadmins_cant_make_tenants_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}' #This should not be stored inside of any script; supplied to transmit detail\n    import-module microsoft.graph\n    $password = ConvertTo-SecureString -String $clientSecret -AsPlainText -Force\n    $ClientSecretCredential = New-Object -TypeName System.Management.Automation.PSCredential($client_id,$password)\n    Connect-MgGraph -TenantId \"$tenantid\" -ClientSecretCredential $ClientSecretCredential -NoWelcome\n    Connect-MgGraph -Scopes \"Policy.Read.All\" -NoWelcome\n    $allowedToCreateTenants = (Get-MgPolicyAuthorizationPolicy).DefaultUserRolePermissions | Select-Object -ExpandProperty AllowedToCreateTenants\n    Write-Output $allowedToCreateTenants.toString()\n}\n\n  powershell_output = powershell(ensure_nonadmins_cant_make_tenants_script)\n  describe 'Ensure AllowedToCreateTenants' do\n    subject { powershell_output.stdout.strip }\n    it 'should not be able to create tenants for non-admins' do\n      expect(subject).to eq('False')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.1.2.3.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure AllowedToCreateTenants should not be able to create tenants for non-admins","run_time":140.257727,"start_time":"2024-09-24T15:44:25-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure AllowedToCreateTenants"}]},{"id":"microsoft-365-foundations-5.1.2.4","title":"Ensure 'Restrict access to the Azure AD administration portal' is set to 'Yes'","desc":"Restrict non-privileged users from signing into the Microsoft Entra admin center.\n        Note: This recommendation only affects access to the web portal. It does not prevent privileged users from using other methods such as Rest API or PowerShell to obtain information. Those channels are addressed elsewhere in this document.","descriptions":[{"label":"default","data":"Restrict non-privileged users from signing into the Microsoft Entra admin center.\n        Note: This recommendation only affects access to the web portal. It does not prevent privileged users from using other methods such as Rest API or PowerShell to obtain information. Those channels are addressed elsewhere in this document."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Identity> Users > User settings.\n        3. Verify under the Administration center section that Restrict access to Microsoft Entra admin center is set to Yes"},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Identity> Users > User settings.\n        3. Set Restrict access to Microsoft Entra admin center to Yes then Save."},{"label":"rationale","data":"The Microsoft Entra admin center contains sensitive data and permission settings,\n        which are still enforced based on the user's role. However, an end user may\n        inadvertently change properties or account settings that could result in increased\n        administrative overhead. Additionally, a compromised end user account could be used\n        by a malicious attacker as a means to gather additional information and escalate an\n        attack.\n        Note: Users will still be able to sign into Microsoft Entra admin center but will be\n        unable to see directory information."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions#restrict-member-users-default-permissions"}],"tags":{"severity":"medium","cis_controls":[{"8":["untracked"]}],"default_value":"No - Non-administrators can access the Microsoft Entra admin center.","nist":["CM-6"]},"code":"control 'microsoft-365-foundations-5.1.2.4' do\n  title \"Ensure 'Restrict access to the Azure AD administration portal' is set to 'Yes'\"\n  desc \"Restrict non-privileged users from signing into the Microsoft Entra admin center.\n        Note: This recommendation only affects access to the web portal. It does not prevent privileged users from using other methods such as Rest API or PowerShell to obtain information. Those channels are addressed elsewhere in this document.\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Identity> Users > User settings.\n        3. Verify under the Administration center section that Restrict access to Microsoft Entra admin center is set to Yes\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Identity> Users > User settings.\n        3. Set Restrict access to Microsoft Entra admin center to Yes then Save.\"\n\n  desc 'rationale',\n       \"The Microsoft Entra admin center contains sensitive data and permission settings,\n        which are still enforced based on the user's role. However, an end user may\n        inadvertently change properties or account settings that could result in increased\n        administrative overhead. Additionally, a compromised end user account could be used\n        by a malicious attacker as a means to gather additional information and escalate an\n        attack.\n        Note: Users will still be able to sign into Microsoft Entra admin center but will be\n        unable to see directory information.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['untracked'] }]\n  tag default_value: 'No - Non-administrators can access the Microsoft Entra admin center.'\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions#restrict-member-users-default-permissions'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.1.2.4.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":1.2e-05,"start_time":"2024-09-24T15:46:45-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.1.2.5","title":"Ensure the option to remain signed in is hidden","desc":"The option for the user to Stay signed in, or the Keep me signed in option, will prompt a user after a successful login. When the user selects this option, a persistent refresh token is created. The refresh token lasts for 90 days by default and does not prompt for sign-in or multifactor.","descriptions":[{"label":"default","data":"The option for the user to Stay signed in, or the Keep me signed in option, will prompt a user after a successful login. When the user selects this option, a persistent refresh token is created. The refresh token lasts for 90 days by default and does not prompt for sign-in or multifactor."},{"label":"check","data":"Ensure the option to remain signed in is hidden:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity> Users > User settings.\n        3. Ensure Show keep user signed in is highlighted No."},{"label":"fix","data":"To disable the option to remain signed in:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity> Users > User settings.\n        3. Set Show keep user signed in to No.\n        4. Click Save"},{"label":"rationale","data":"Allowing users to select this option presents risk, especially if the user signs into their\n        account on a publicly accessible computer/web browser. In this case it would be trivial\n        for an unauthorized person to gain access to any associated cloud data from that\n        account."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/entra/identity/authentication/concepts-azure-multi-factor-authentication-prompts-session-lifetime?source=recommendations"},{"ref":"https://learn.microsoft.com/en-us/entra/fundamentals/how-to-manage-stay-signed-in-prompt"}],"tags":{"severity":"medium","cis_controls":[{"7":["16.3"]}],"default_value":"Users may select stay signed in","nist":["SI-2"]},"code":"control 'microsoft-365-foundations-5.1.2.5' do\n  title 'Ensure the option to remain signed in is hidden'\n  desc 'The option for the user to Stay signed in, or the Keep me signed in option, will prompt a user after a successful login. When the user selects this option, a persistent refresh token is created. The refresh token lasts for 90 days by default and does not prompt for sign-in or multifactor.'\n\n  desc 'check',\n       \"Ensure the option to remain signed in is hidden:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity> Users > User settings.\n        3. Ensure Show keep user signed in is highlighted No.\"\n\n  desc 'fix',\n       \"To disable the option to remain signed in:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity> Users > User settings.\n        3. Set Show keep user signed in to No.\n        4. Click Save\"\n\n  desc 'rationale',\n       'Allowing users to select this option presents risk, especially if the user signs into their\n        account on a publicly accessible computer/web browser. In this case it would be trivial\n        for an unauthorized person to gain access to any associated cloud data from that\n        account.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '7' => ['16.3'] }]\n  tag default_value: 'Users may select stay signed in'\n  tag nist: ['SI-2']\n\n  ref 'https://learn.microsoft.com/en-us/entra/identity/authentication/concepts-azure-multi-factor-authentication-prompts-session-lifetime?source=recommendations'\n  ref 'https://learn.microsoft.com/en-us/entra/fundamentals/how-to-manage-stay-signed-in-prompt'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.1.2.5.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":9.0e-06,"start_time":"2024-09-24T15:46:45-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.1.2.6","title":"Ensure 'LinkedIn account connections' is disabled","desc":"LinkedIn account connections allow users to connect their Microsoft work or school account with LinkedIn. After a user connects their accounts, information and highlights from LinkedIn are available in some Microsoft apps and services.","descriptions":[{"label":"default","data":"LinkedIn account connections allow users to connect their Microsoft work or school account with LinkedIn. After a user connects their accounts, information and highlights from LinkedIn are available in some Microsoft apps and services."},{"label":"check","data":"Ensure that LinkedIn account connections is disabled:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Users select User settings.\n        3. Under LinkedIn account connections ensure No is highlighted."},{"label":"fix","data":"To disable LinkedIn account connections:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Users select User settings.\n        3. Under LinkedIn account connections select No.\n        4. Click Save."},{"label":"rationale","data":"Disabling LinkedIn integration prevents potential phishing attacks and risk scenarios\n        where an external party could accidentally disclose sensitive information."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/enterprise-users/linkedin-integration"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/enterprise-users/linkedin-user-consent"}],"tags":{"severity":"medium","cis_controls":[{"8":["4.8"]},{"7":["13.3"]}],"default_value":"LinkedIn integration is enabled by default.","nist":["CM-6","CM-7","SI-4","SI-4(4)"]},"code":"control 'microsoft-365-foundations-5.1.2.6' do\n  title \"Ensure 'LinkedIn account connections' is disabled\"\n  desc 'LinkedIn account connections allow users to connect their Microsoft work or school account with LinkedIn. After a user connects their accounts, information and highlights from LinkedIn are available in some Microsoft apps and services.'\n\n  desc 'check',\n       \"Ensure that LinkedIn account connections is disabled:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Users select User settings.\n        3. Under LinkedIn account connections ensure No is highlighted.\"\n\n  desc 'fix',\n       \"To disable LinkedIn account connections:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Users select User settings.\n        3. Under LinkedIn account connections select No.\n        4. Click Save.\"\n\n  desc 'rationale',\n       'Disabling LinkedIn integration prevents potential phishing attacks and risk scenarios\n        where an external party could accidentally disclose sensitive information.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['4.8'] }, { '7' => ['13.3'] }]\n  tag default_value: 'LinkedIn integration is enabled by default.'\n  tag nist: ['CM-6', 'CM-7', 'SI-4', 'SI-4(4)']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/enterprise-users/linkedin-integration'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/enterprise-users/linkedin-user-consent'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.1.2.6.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":5.0e-06,"start_time":"2024-09-24T15:46:45-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.1.3.1","title":"Ensure a dynamic group for guest users is created","desc":"A dynamic group is a dynamic configuration of security group membership for Microsoft Entra ID. Administrators can set rules to populate groups that are created in Entra ID based on user attributes (such as userType, department, or country/region). Members can be automatically added to or removed from a security group based on their attributes.\n        The recommended state is to create a dynamic group that includes guest accounts.","descriptions":[{"label":"default","data":"A dynamic group is a dynamic configuration of security group membership for Microsoft Entra ID. Administrators can set rules to populate groups that are created in Entra ID based on user attributes (such as userType, department, or country/region). Members can be automatically added to or removed from a security group based on their attributes.\n        The recommended state is to create a dynamic group that includes guest accounts."},{"label":"check","data":"Ensure a dynamic guest group is created:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Groups select All groups.\n        3. On the right of the search field click Add filter.\n        4. Set Filter to Membership type and Value to Dynamic then apply.\n        5. Identify a dynamic group and select it.\n        6. Under manage, select Dynamic membership rules and ensure the rule syntax contains (user.userType -eq \"Guest\")\n        7. If necessary, inspect other dynamic groups for the value above.\n    Using PowerShell:\n        1. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"Group.Read.All\"\n        2. Run the following commands:\n            $groups = Get-MgGroup | Where-Object { $_.GroupTypes -contains \"DynamicMembership\" }\n            $groups | ft DisplayName,GroupTypes,MembershipRule\n        3. Look for a dynamic group containing the rule (user.userType -eq \"Guest\")"},{"label":"fix","data":"Create a dynamic guest group:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Groups select All groups.\n        3. Select New group and assign the following values:\n            o Group type: Security\n            o Microsoft Entra roles can be assigned to the group: No\n            o Membership type: Dynamic User\n        4. Select Add dynamic query.\n        5. Above the Rule syntax text box, select Edit.\n        6. Place the following expression in the box:\n            (user.userType -eq \"Guest\")\n        7. Select OK and Save\n    Using PowerShell:\n        1. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"Group.ReadWrite.All\"\n        2. In the script below edit DisplayName and MailNickname as needed and run:\n            $params = @{ DisplayName = \"Dynamic Test Group\" MailNickname = \"DynGuestUsers\" MailEnabled = $false SecurityEnabled = $true GroupTypes = \"DynamicMembership\" MembershipRule = '(user.userType -eq \"Guest\")' MembershipRuleProcessingState = \"On\" } New-MgGroup @params"},{"label":"rationale","data":"Dynamic groups allow for an automated method to assign group membership.\n        Guest user accounts will be automatically added to this group and through this existing\n        conditional access rules, access controls and other security measures will ensure that\n        new guest accounts are restricted in the same manner as existing guest accounts."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/enterprise-users/groups-create-rule"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/enterprise-users/groups-dynamic-membership"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/external-identities/use-dynamic-groups"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.3"]}],"default_value":"Undefined","nist":["AC-3","AC-5","AC-6","MP-2"]},"code":"control 'microsoft-365-foundations-5.1.3.1' do\n  title 'Ensure a dynamic group for guest users is created'\n  desc \"A dynamic group is a dynamic configuration of security group membership for Microsoft Entra ID. Administrators can set rules to populate groups that are created in Entra ID based on user attributes (such as userType, department, or country/region). Members can be automatically added to or removed from a security group based on their attributes.\n        The recommended state is to create a dynamic group that includes guest accounts.\"\n\n  desc 'check',\n       'Ensure a dynamic guest group is created:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Groups select All groups.\n        3. On the right of the search field click Add filter.\n        4. Set Filter to Membership type and Value to Dynamic then apply.\n        5. Identify a dynamic group and select it.\n        6. Under manage, select Dynamic membership rules and ensure the rule syntax contains (user.userType -eq \"Guest\")\n        7. If necessary, inspect other dynamic groups for the value above.\n    Using PowerShell:\n        1. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"Group.Read.All\"\n        2. Run the following commands:\n            $groups = Get-MgGroup | Where-Object { $_.GroupTypes -contains \"DynamicMembership\" }\n            $groups | ft DisplayName,GroupTypes,MembershipRule\n        3. Look for a dynamic group containing the rule (user.userType -eq \"Guest\")'\n\n  desc 'fix',\n       %q{Create a dynamic guest group:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Groups select All groups.\n        3. Select New group and assign the following values:\n            o Group type: Security\n            o Microsoft Entra roles can be assigned to the group: No\n            o Membership type: Dynamic User\n        4. Select Add dynamic query.\n        5. Above the Rule syntax text box, select Edit.\n        6. Place the following expression in the box:\n            (user.userType -eq \"Guest\")\n        7. Select OK and Save\n    Using PowerShell:\n        1. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"Group.ReadWrite.All\"\n        2. In the script below edit DisplayName and MailNickname as needed and run:\n            $params = @{ DisplayName = \"Dynamic Test Group\" MailNickname = \"DynGuestUsers\" MailEnabled = $false SecurityEnabled = $true GroupTypes = \"DynamicMembership\" MembershipRule = '(user.userType -eq \"Guest\")' MembershipRuleProcessingState = \"On\" } New-MgGroup @params}\n\n  desc 'rationale',\n       'Dynamic groups allow for an automated method to assign group membership.\n        Guest user accounts will be automatically added to this group and through this existing\n        conditional access rules, access controls and other security measures will ensure that\n        new guest accounts are restricted in the same manner as existing guest accounts.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['3.3'] }]\n  tag default_value: 'Undefined'\n  tag nist: ['AC-3', 'AC-5', 'AC-6', 'MP-2']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/enterprise-users/groups-create-rule'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/enterprise-users/groups-dynamic-membership'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/external-identities/use-dynamic-groups'\n\n  ensure_dynamic_group_for_guest_users_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}' #This should not be stored inside of any script; supplied to transmit detail\n    import-module microsoft.graph\n    $password = ConvertTo-SecureString -String $clientSecret -AsPlainText -Force\n    $ClientSecretCredential = New-Object -TypeName System.Management.Automation.PSCredential($client_id,$password)\n    Connect-MgGraph -TenantId \"$tenantid\" -ClientSecretCredential $ClientSecretCredential -NoWelcome\n    $groups = Get-MgGroup | Where-Object { $_.GroupTypes -contains \"DynamicMembership\" -and $_.MembershipRule -notmatch '(user.userType -eq \"guest\")'}\n    $groups | ft DisplayName\n  }\n\n  powershell_output = powershell(ensure_dynamic_group_for_guest_users_script).stdout.strip.split(\"\\n\").drop(2).count\n  describe 'Ensure the number of dyanmic groups without guests' do\n    subject { powershell_output }\n    it 'should be 0' do\n      expect(subject).to eq 0\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.1.3.1.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure the number of dyanmic groups without guests should be 0","run_time":8.3e-05,"start_time":"2024-09-24T15:46:45-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the number of dyanmic groups without guests"}]},{"id":"microsoft-365-foundations-5.1.5.1","title":"Ensure the Application Usage report is reviewed at least weekly","desc":"The Application Usage report includes a usage summary for all Software as a Service (SaaS) applications that are integrated with the organization's directory.","descriptions":[{"label":"default","data":"The Application Usage report includes a usage summary for all Software as a Service (SaaS) applications that are integrated with the organization's directory."},{"label":"check","data":"To verify the report is being reviewed at least weekly, confirm that the necessary procedures are in place and being followed."},{"label":"fix","data":"To review the Application Usage report:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Applications select Enterprise applications.\n        3. Under Activity select Usage & insights.\n        4. Review the information."},{"label":"rationale","data":"Review the list of app registrations on a regular basis to look for risky apps that users\n        have enabled that could cause data spillage or accidental elevation of privilege.\n        Attackers can often get access to data illicitly through third-party SaaS applications."}],"impact":0.5,"refs":[],"tags":{"severity":"medium","cis_controls":[{"8":["8.11"]},{"7":["6.2"]}],"nist":["AU-6","AU-6(1)","AU-7(1)","AC-1","AC-2","AC-2(1)"]},"code":"control 'microsoft-365-foundations-5.1.5.1' do\n  title 'Ensure the Application Usage report is reviewed at least weekly'\n  desc \"The Application Usage report includes a usage summary for all Software as a Service (SaaS) applications that are integrated with the organization's directory.\"\n\n  desc 'check',\n       'To verify the report is being reviewed at least weekly, confirm that the necessary procedures are in place and being followed.'\n\n  desc 'fix',\n       \"To review the Application Usage report:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Applications select Enterprise applications.\n        3. Under Activity select Usage & insights.\n        4. Review the information.\"\n\n  desc 'rationale',\n       'Review the list of app registrations on a regular basis to look for risky apps that users\n        have enabled that could cause data spillage or accidental elevation of privilege.\n        Attackers can often get access to data illicitly through third-party SaaS applications.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['8.11'] }, { '7' => ['6.2'] }]\n  tag nist: ['AU-6', 'AU-6(1)', 'AU-7(1)', 'AC-1', 'AC-2', 'AC-2(1)']\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.1.5.1.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":9.0e-06,"start_time":"2024-09-24T15:46:45-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.1.5.2","title":"Ensure user consent to apps accessing company data on their behalf is not allowed","desc":"Control when end users and group owners are allowed to grant consent to applications, and when they will be required to request administrator review and approval. Allowing users to grant apps access to data helps them acquire useful applications and be productive but can represent a risk in some situations if it's not monitored and controlled carefully.","descriptions":[{"label":"default","data":"Control when end users and group owners are allowed to grant consent to applications, and when they will be required to request administrator review and approval. Allowing users to grant apps access to data helps them acquire useful applications and be productive but can represent a risk in some situations if it's not monitored and controlled carefully."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Applications select Enterprise applications.\n        3. Under Security select Consent and permissions > User consent settings.\n        4. Verify User consent for applications is set to Do not allow user consent.\n    To audit using PowerShell:\n        1. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"Policy.Read.All\"\n        2. Run the following command:\n            (Get-MgPolicyAuthorizationPolicy).DefaultUserRolePermissions | Select-Object -ExpandProperty PermissionGrantPoliciesAssigned\n        3. Ensure ManagePermissionGrantsForSelf.microsoft-user-default-low is not present OR that nothing is returned."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Applications select Enterprise applications.\n        3. Under Security select Consent and permissions > User consent settings.\n        4. Under User consent for applications select Do not allow user consent.\n        5. Click the Save option at the top of the window."},{"label":"rationale","data":"Attackers commonly use custom applications to trick users into granting them access to\n        company data. Disabling future user consent operations setting mitigates this risk, and\n        helps to reduce the threat-surface. If user consent is disabled previous consent grants\n        will still be honored but all future consent operations must be performed by an\n        administrator."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/configure-user-consent?tabs=azure-portal&pivots=portal"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.3"]},{"7":["14.6"]}],"default_value":"UI - Allow user consent for apps","nist":["AC-3","AC-5","AC-6","MP-2","AT-2"]},"code":"control 'microsoft-365-foundations-5.1.5.2' do\n  title 'Ensure user consent to apps accessing company data on their behalf is not allowed'\n  desc \"Control when end users and group owners are allowed to grant consent to applications, and when they will be required to request administrator review and approval. Allowing users to grant apps access to data helps them acquire useful applications and be productive but can represent a risk in some situations if it's not monitored and controlled carefully.\"\n\n  desc 'check',\n       'To audit using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Applications select Enterprise applications.\n        3. Under Security select Consent and permissions > User consent settings.\n        4. Verify User consent for applications is set to Do not allow user consent.\n    To audit using PowerShell:\n        1. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"Policy.Read.All\"\n        2. Run the following command:\n            (Get-MgPolicyAuthorizationPolicy).DefaultUserRolePermissions | Select-Object -ExpandProperty PermissionGrantPoliciesAssigned\n        3. Ensure ManagePermissionGrantsForSelf.microsoft-user-default-low is not present OR that nothing is returned.'\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Applications select Enterprise applications.\n        3. Under Security select Consent and permissions > User consent settings.\n        4. Under User consent for applications select Do not allow user consent.\n        5. Click the Save option at the top of the window.\"\n\n  desc 'rationale',\n       'Attackers commonly use custom applications to trick users into granting them access to\n        company data. Disabling future user consent operations setting mitigates this risk, and\n        helps to reduce the threat-surface. If user consent is disabled previous consent grants\n        will still be honored but all future consent operations must be performed by an\n        administrator.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['3.3'] }, { '7' => ['14.6'] }]\n  tag default_value: 'UI - Allow user consent for apps'\n  tag nist: ['AC-3', 'AC-5', 'AC-6', 'MP-2', 'AT-2']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/configure-user-consent?tabs=azure-portal&pivots=portal'\n\n  ensure_user_cant_access_company_data_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}' #This should not be stored inside of any script; supplied to transmit detail\n    import-module microsoft.graph\n    $password = ConvertTo-SecureString -String $clientSecret -AsPlainText -Force\n    $ClientSecretCredential = New-Object -TypeName System.Management.Automation.PSCredential($client_id,$password)\n    Connect-MgGraph -TenantId \"$tenantid\" -ClientSecretCredential $ClientSecretCredential -NoWelcome\n    (Get-MgPolicyAuthorizationPolicy).DefaultUserRolePermissions | Select-Object -ExpandProperty PermissionGrantPoliciesAssigned\n}\n\n  powershell_output = powershell(ensure_user_cant_access_company_data_script)\n\n  describe.one do\n    describe powershell_output do\n      its('stdout.strip') { should_not include('ManagePermissionGrantsForSelf.microsoft-user-default-low') }\n    end\n\n    describe powershell_output do\n      its('stdout.strip') { should be_empty }\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.1.5.2.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Powershell stdout.strip is expected not to include \"ManagePermissionGrantsForSelf.microsoft-user-default-low\"","run_time":9.5e-05,"start_time":"2024-09-24T15:46:45-04:00","resource_class":"powershell","resource_params":"[\"\\n    $appName = 'cisBenchmarkL512'\\n    $client_id = '6de379b3-8a31-4aae-8e9f-63098388cf79'\\n    $tenantid = 'dbe11796-cbe6-41ca-8ae7-bc1aadb2a567'\\n    $clientSecret = 'jO68Q~hlZfZ-Nqcf8NJyI-dT0lNOha5Q' #This should not be stored inside of any script; supplied to transmit detail\\n    import-module microsoft.graph\\n    $password = ConvertTo-SecureString -String $clientSecret -AsPlainText -Force\\n    $ClientSecretCredential = New-Object -TypeName System.Management.Automation.PSCredential($client_id,$password)\\n    Connect-MgGraph -TenantId \\\"$tenantid\\\" -ClientSecretCredential $ClientSecretCredential -NoWelcome\\n    (Get-MgPolicyAuthorizationPolicy).DefaultUserRolePermissions | Select-Object -ExpandProperty PermissionGrantPoliciesAssigned\\n\"]","resource_id":"Powershell"},{"status":"passed","code_desc":"Powershell stdout.strip is expected to be empty","run_time":0.000114,"start_time":"2024-09-24T15:46:45-04:00","resource_class":"powershell","resource_params":"[\"\\n    $appName = 'cisBenchmarkL512'\\n    $client_id = '6de379b3-8a31-4aae-8e9f-63098388cf79'\\n    $tenantid = 'dbe11796-cbe6-41ca-8ae7-bc1aadb2a567'\\n    $clientSecret = 'jO68Q~hlZfZ-Nqcf8NJyI-dT0lNOha5Q' #This should not be stored inside of any script; supplied to transmit detail\\n    import-module microsoft.graph\\n    $password = ConvertTo-SecureString -String $clientSecret -AsPlainText -Force\\n    $ClientSecretCredential = New-Object -TypeName System.Management.Automation.PSCredential($client_id,$password)\\n    Connect-MgGraph -TenantId \\\"$tenantid\\\" -ClientSecretCredential $ClientSecretCredential -NoWelcome\\n    (Get-MgPolicyAuthorizationPolicy).DefaultUserRolePermissions | Select-Object -ExpandProperty PermissionGrantPoliciesAssigned\\n\"]","resource_id":"Powershell"}]},{"id":"microsoft-365-foundations-5.1.5.3","title":"Ensure the admin consent workflow is enabled","desc":"The admin consent workflow gives admins a secure way to grant access to applications that require admin approval. When a user tries to access an application but is unable to provide consent, they can send a request for admin approval. The request is sent via email to admins who have been designated as reviewers. A reviewer takes action on the request, and the user is notified of the action.","descriptions":[{"label":"default","data":"The admin consent workflow gives admins a secure way to grant access to applications that require admin approval. When a user tries to access an application but is unable to provide consent, they can send a request for admin approval. The request is sent via email to admins who have been designated as reviewers. A reviewer takes action on the request, and the user is notified of the action."},{"label":"check","data":"Ensure the admin consent workflow is enabled:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Applications select Enterprise applications.\n        3. Under Security select Consent and permissions.\n        4. Under Manage select Admin consent settings.\n        5. Verify that Users can request admin consent to apps they are unable to consent to is set to Yes."},{"label":"fix","data":"To enable the admin consent workflow, use the Microsoft 365 Admin Center:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Applications select Enterprise applications.\n        3. Under Security select Consent and permissions.\n        4. Under Manage select Admin consent settings.\n        5. Set Users can request admin consent to apps they are unable to consent to to Yes under Admin consent requests.\n        6. Under the Reviewers choose the Roles and Groups that will review user generated app consent requests.\n        7. Set Selected users will receive email notifications for requests to Yes\n        8. Select Save at the top of the window."},{"label":"rationale","data":"The admin consent workflow (Preview) gives admins a secure way to grant access to\n        applications that require admin approval. When a user tries to access an application but\n        is unable to provide consent, they can send a request for admin approval. The request\n        is sent via email to admins who have been designated as reviewers. A reviewer acts on\n        the request, and the user is notified of the action."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/configure-admin-consent-workflow"}],"tags":{"severity":"medium","cis_controls":[{"8":["2.5"]},{"7":["18.3"]}],"default_value":" Users can request admin consent to apps they are unable to consent to:No\n                        • Selected users to review admin consent requests: None\n                        • Selected users will receive email notifications for requests: Yes\n                        • Selected users will receive request expiration reminders: Yes\n                        • Consent request expires after (days): 30","nist":["CM-7(5)","CM-10"]},"code":"control 'microsoft-365-foundations-5.1.5.3' do\n  title 'Ensure the admin consent workflow is enabled'\n  desc 'The admin consent workflow gives admins a secure way to grant access to applications that require admin approval. When a user tries to access an application but is unable to provide consent, they can send a request for admin approval. The request is sent via email to admins who have been designated as reviewers. A reviewer takes action on the request, and the user is notified of the action.'\n\n  desc 'check',\n       \"Ensure the admin consent workflow is enabled:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Applications select Enterprise applications.\n        3. Under Security select Consent and permissions.\n        4. Under Manage select Admin consent settings.\n        5. Verify that Users can request admin consent to apps they are unable to consent to is set to Yes.\"\n\n  desc 'fix',\n       \"To enable the admin consent workflow, use the Microsoft 365 Admin Center:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Applications select Enterprise applications.\n        3. Under Security select Consent and permissions.\n        4. Under Manage select Admin consent settings.\n        5. Set Users can request admin consent to apps they are unable to consent to to Yes under Admin consent requests.\n        6. Under the Reviewers choose the Roles and Groups that will review user generated app consent requests.\n        7. Set Selected users will receive email notifications for requests to Yes\n        8. Select Save at the top of the window.\"\n\n  desc 'rationale',\n       'The admin consent workflow (Preview) gives admins a secure way to grant access to\n        applications that require admin approval. When a user tries to access an application but\n        is unable to provide consent, they can send a request for admin approval. The request\n        is sent via email to admins who have been designated as reviewers. A reviewer acts on\n        the request, and the user is notified of the action.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['2.5'] }, { '7' => ['18.3'] }]\n  tag default_value: ' Users can request admin consent to apps they are unable to consent to:No\n                        • Selected users to review admin consent requests: None\n                        • Selected users will receive email notifications for requests: Yes\n                        • Selected users will receive request expiration reminders: Yes\n                        • Consent request expires after (days): 30'\n  tag nist: ['CM-7(5)', 'CM-10']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/configure-admin-consent-workflow'\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.1.5.3.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":4.0e-06,"start_time":"2024-09-24T15:46:45-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.1.6.1","title":"Ensure that collaboration invitations are sent to allowed domains only","desc":"B2B collaboration is a feature within Microsoft Entra External ID that allows for guest invitations to an organization.\n        Ensure users can only send invitations to specified domains.\n        NOTE: This list works independently from OneDrive for Business and SharePoint Online allow/block lists. To restrict individual file sharing in SharePoint Online, set up an allow or blocklist for OneDrive for Business and SharePoint Online. For instance, in SharePoint or OneDrive users can still share with external users from prohibited domains by using Anyone links if they haven't been disabled.","descriptions":[{"label":"default","data":"B2B collaboration is a feature within Microsoft Entra External ID that allows for guest invitations to an organization.\n        Ensure users can only send invitations to specified domains.\n        NOTE: This list works independently from OneDrive for Business and SharePoint Online allow/block lists. To restrict individual file sharing in SharePoint Online, set up an allow or blocklist for OneDrive for Business and SharePoint Online. For instance, in SharePoint or OneDrive users can still share with external users from prohibited domains by using Anyone links if they haven't been disabled."},{"label":"check","data":"Ensure that collaboration invitations are sent to allowed domains only:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > External Identities select External collaboration settings.\n        3. Under Collaboration restrictions, verify that Allow invitations only to the specified domains (most restrictive) is selected. Then verify allowed domains are specified under Target domains."},{"label":"fix","data":"To restrict collaboration invitations only to the specified domains:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > External Identities select External collaboration settings.\n        3. Under Collaboration restrictions, select Allow invitations only to the specified domains (most restrictive) is selected. Then specify the allowed domains under Target domains."},{"label":"rationale","data":"By specifying allowed domains for collaborations, external user’s companies are\n        explicitly identified. Also, this prevents internal users from inviting unknown external\n        users such as personal accounts and granting them access to resources."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/external-identities/allow-deny-list"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/external-identities/what-is-b2b"}],"tags":{"severity":"medium","cis_controls":[{"8":["6.1"]},{"7":["13.1"]}],"default_value":"Allow invitations to be sent to any domain (most inclusive)","nist":["IA-4","IA-5","AC-1","AC-2","AC-2(1)"]},"code":"control 'microsoft-365-foundations-5.1.6.1' do\n  title 'Ensure that collaboration invitations are sent to allowed domains only'\n  desc \"B2B collaboration is a feature within Microsoft Entra External ID that allows for guest invitations to an organization.\n        Ensure users can only send invitations to specified domains.\n        NOTE: This list works independently from OneDrive for Business and SharePoint Online allow/block lists. To restrict individual file sharing in SharePoint Online, set up an allow or blocklist for OneDrive for Business and SharePoint Online. For instance, in SharePoint or OneDrive users can still share with external users from prohibited domains by using Anyone links if they haven't been disabled.\"\n\n  desc 'check',\n       \"Ensure that collaboration invitations are sent to allowed domains only:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > External Identities select External collaboration settings.\n        3. Under Collaboration restrictions, verify that Allow invitations only to the specified domains (most restrictive) is selected. Then verify allowed domains are specified under Target domains.\"\n\n  desc 'fix',\n       \"To restrict collaboration invitations only to the specified domains:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > External Identities select External collaboration settings.\n        3. Under Collaboration restrictions, select Allow invitations only to the specified domains (most restrictive) is selected. Then specify the allowed domains under Target domains.\"\n\n  desc 'rationale',\n       'By specifying allowed domains for collaborations, external user’s companies are\n        explicitly identified. Also, this prevents internal users from inviting unknown external\n        users such as personal accounts and granting them access to resources.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['6.1'] }, { '7' => ['13.1'] }]\n  tag default_value: 'Allow invitations to be sent to any domain (most inclusive)'\n  tag nist: ['IA-4', 'IA-5', 'AC-1', 'AC-2', 'AC-2(1)']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/external-identities/allow-deny-list'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/external-identities/what-is-b2b'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.1.6.1.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":1.0e-05,"start_time":"2024-09-24T15:46:45-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.1.8.1","title":"Ensure that password hash sync is enabled for hybrid deployments","desc":"Password hash synchronization is one of the sign-in methods used to accomplish hybrid identity synchronization. Microsoft Entra Connect synchronizes a hash, of the hash, of a user's password from an on-premises Active Directory instance to a cloud-based Entra ID instance.\n        Note: Audit and remediation procedures in this recommendation only apply to Microsoft 365 tenants operating in a hybrid configuration using Entra Connect sync.","descriptions":[{"label":"default","data":"Password hash synchronization is one of the sign-in methods used to accomplish hybrid identity synchronization. Microsoft Entra Connect synchronizes a hash, of the hash, of a user's password from an on-premises Active Directory instance to a cloud-based Entra ID instance.\n        Note: Audit and remediation procedures in this recommendation only apply to Microsoft 365 tenants operating in a hybrid configuration using Entra Connect sync."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Hybrid management > Microsoft Entra Connect.\n        3. Select Connect Sync\n        4. Under Microsoft Entra Connect sync, verify Password Hash Sync is Enabled.\n    To audit for the on-prem tool:\n        1. Log in to the server that hosts the Microsoft Entra Connect tool.\n        2. Run Azure AD Connect, and then click Configure and View or export current configuration.\n        3. Determine whether PASSWORD HASH SYNCHRONIZATION is enabled on your tenant.\n    This information is also available via the Microsoft Graph Security API:\n        GET https://graph.microsoft.com/beta/security/secureScores\n    To audit using PowerShell:\n        1. Connect to the Microsoft Graph service using Connect-MgGraph -Scopes \"Organization.Read.All\".\n        2. Run the following Microsoft Graph PowerShell command:\n            Get-MgOrganization | ft OnPremisesSyncEnabled\n        3. If nothing returns then password sync is not enabled for the on premises AD."},{"label":"fix","data":"To setup Password Hash Sync, use the following steps:\n        1. Log in to the on premises server that hosts the Microsoft Entra Connect tool\n        2. Double-click the Azure AD Connect icon that was created on the desktop\n        3. Click Configure.\n        4. On the Additional tasks page, select Customize synchronization options and click Next.\n        5. Enter the username and password for your global administrator.\n        6. On the Connect your directories screen, click Next.\n        7. On the Domain and OU filtering screen, click Next.\n        8. On the Optional features screen, check Password hash synchronization and click Next.\n        9. On the Ready to configure screen click Configure.\n        10. Once the configuration completes, click Exit."},{"label":"rationale","data":"Password hash synchronization helps by reducing the number of passwords your users\n        need to maintain to just one and enables leaked credential detection for your hybrid\n        accounts. Leaked credential protection is leveraged through Entra ID Protection and is a\n        subset of that feature which can help identify if an organization's user account\n        passwords have appeared on the dark web or public spaces.\n        Using other options for your directory synchronization may be less resilient as Microsoft\n        can still process sign-ins to 365 with Hash Sync even if a network connection to your\n        on-premises environment is not available."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/concept-identity-protection-risks#user-linked-detections"},{"ref":"https://www.microsoft.com/en-us/download/details.aspx?id=47594"}],"tags":{"severity":"medium","cis_controls":[{"8":["6.7"]},{"7":["16.4"]}],"default_value":"• Microsoft Entra Connect sync disabled by default\n                      • Password Hash Sync is Microsoft's recommended setting for new deployments","nist":["AC-2(1)","AC-3","CM-8"]},"code":"control 'microsoft-365-foundations-5.1.8.1' do\n  title 'Ensure that password hash sync is enabled for hybrid deployments'\n  desc \"Password hash synchronization is one of the sign-in methods used to accomplish hybrid identity synchronization. Microsoft Entra Connect synchronizes a hash, of the hash, of a user's password from an on-premises Active Directory instance to a cloud-based Entra ID instance.\n        Note: Audit and remediation procedures in this recommendation only apply to Microsoft 365 tenants operating in a hybrid configuration using Entra Connect sync.\"\n\n  desc 'check',\n       'To audit using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity > Hybrid management > Microsoft Entra Connect.\n        3. Select Connect Sync\n        4. Under Microsoft Entra Connect sync, verify Password Hash Sync is Enabled.\n    To audit for the on-prem tool:\n        1. Log in to the server that hosts the Microsoft Entra Connect tool.\n        2. Run Azure AD Connect, and then click Configure and View or export current configuration.\n        3. Determine whether PASSWORD HASH SYNCHRONIZATION is enabled on your tenant.\n    This information is also available via the Microsoft Graph Security API:\n        GET https://graph.microsoft.com/beta/security/secureScores\n    To audit using PowerShell:\n        1. Connect to the Microsoft Graph service using Connect-MgGraph -Scopes \"Organization.Read.All\".\n        2. Run the following Microsoft Graph PowerShell command:\n            Get-MgOrganization | ft OnPremisesSyncEnabled\n        3. If nothing returns then password sync is not enabled for the on premises AD.'\n\n  desc 'fix',\n       \"To setup Password Hash Sync, use the following steps:\n        1. Log in to the on premises server that hosts the Microsoft Entra Connect tool\n        2. Double-click the Azure AD Connect icon that was created on the desktop\n        3. Click Configure.\n        4. On the Additional tasks page, select Customize synchronization options and click Next.\n        5. Enter the username and password for your global administrator.\n        6. On the Connect your directories screen, click Next.\n        7. On the Domain and OU filtering screen, click Next.\n        8. On the Optional features screen, check Password hash synchronization and click Next.\n        9. On the Ready to configure screen click Configure.\n        10. Once the configuration completes, click Exit.\"\n\n  desc 'rationale',\n       \"Password hash synchronization helps by reducing the number of passwords your users\n        need to maintain to just one and enables leaked credential detection for your hybrid\n        accounts. Leaked credential protection is leveraged through Entra ID Protection and is a\n        subset of that feature which can help identify if an organization's user account\n        passwords have appeared on the dark web or public spaces.\n        Using other options for your directory synchronization may be less resilient as Microsoft\n        can still process sign-ins to 365 with Hash Sync even if a network connection to your\n        on-premises environment is not available.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['6.7'] }, { '7' => ['16.4'] }]\n  tag default_value: \"• Microsoft Entra Connect sync disabled by default\n                      • Password Hash Sync is Microsoft's recommended setting for new deployments\"\n  tag nist: ['AC-2(1)', 'AC-3', 'CM-8']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/concept-identity-protection-risks#user-linked-detections'\n  ref 'https://www.microsoft.com/en-us/download/details.aspx?id=47594'\n\n  ensure_password_hash_enabled_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}' #This should not be stored inside of any script; supplied to transmit detail\n    import-module microsoft.graph\n    $password = ConvertTo-SecureString -String $clientSecret -AsPlainText -Force\n    $ClientSecretCredential = New-Object -TypeName System.Management.Automation.PSCredential($client_id,$password)\n    Connect-MgGraph -TenantId \"$tenantid\" -ClientSecretCredential $ClientSecretCredential -NoWelcome\n    $onPremisesSyncEnabled = (Get-MgOrganization).OnPremisesSyncEnabled\n    Write-Output $onPremisesSyncEnabled\n  }\n\n  powershell_output = powershell(ensure_password_hash_enabled_script)\n  describe 'Ensure OnPremisesSyncEnabled count' do\n    subject { powershell_output.stdout.strip }\n    it 'should not be empty' do\n      expect(subject).not_to be_empty\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.1.8.1.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure OnPremisesSyncEnabled count should not be empty","run_time":139.590159,"start_time":"2024-09-24T15:46:45-04:00","message":"expected `\"\".empty?` to be falsey, got true","resource_class":"Object","resource_params":"[]","resource_id":"Ensure OnPremisesSyncEnabled count"}]},{"id":"microsoft-365-foundations-5.2.2.1","title":"Ensure multifactor authentication is enabled for all users in administrative roles","desc":"Multifactor authentication is a process that requires an additional form of identification during the sign-in process, such as a code from a mobile device or a fingerprint scan, to enhance security.\n        Ensure users in administrator roles have MFA capabilities enabled.","descriptions":[{"label":"default","data":"Multifactor authentication is a process that requires an additional form of identification during the sign-in process, such as a code from a mobile device or a fingerprint scan, to enhance security.\n        Ensure users in administrator roles have MFA capabilities enabled."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click to expand Protection > Conditional Access select Policies.\n        3. Review the list of policies and ensure that there is a policy meeting at least the following criteria:\n            o Users: Include: Directory roles specific to administrators are selected.\n            o Target resources: All cloud apps.\n            o Grant: Grant access with Require multifactor authentication checked.\n        4. Ensure Enable policy is set to On.\n    To audit using SecureScore:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Select Secure score.\n        3. Select Recommended actions.\n        4. Click on Ensure multifactor authentication is enabled for all users in administrative roles.\n        5. Review the number of Admin users who do not have MFA configured.\n    This information is also available via the Microsoft Graph Security API:\n        GET https://graph.microsoft.com/beta/security/secureScores\n    Note: A list of required Directory roles can be found in the Remediation section."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Click New policy.\n        4. Go to Assignments > Users and groups > Include > Select users and groups > check Directory roles.\n        5. At a minimum, select the Directory roles listed below in this section of the document.\n        6. Go to Cloud apps or actions > Cloud apps > Include > select All cloud apps (and don't exclude any apps).\n        7. Under Access controls > Grant > select Grant access > check Require multi-factor authentication.\n        8. Set Enable policy to Report-only or On.\n        9. Create.\n    At minimum these directory roles should be included for MFA:\n        • Application administrator\n        • Authentication administrator\n        • Billing administrator\n        • Cloud application administrator\n        • Conditional Access administrator\n        • Exchange administrator\n        • Global administrator\n        • Global reader\n        • Helpdesk administrator\n        • Password administrator\n        • Privileged authentication administrator\n        • Privileged role administrator\n        • Security administrator\n        • SharePoint administrator\n        • User administrator\n    Note: Report-only is an acceptable first stage when introducing any CA policy. The control, however, is not complete until the policy is on."},{"label":"rationale","data":"Multifactor authentication requires an individual to present a minimum of two separate\n        forms of authentication before access is granted. Multifactor authentication provides\n        additional assurance that the individual attempting to gain access is who they claim to\n        be. With multifactor authentication, an attacker would need to compromise at least two\n        different authentication mechanisms, increasing the difficulty of compromise and thus\n        reducing the risk."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/graph/api/resources/security-api-overview?view=graph-rest-beta"}],"tags":{"severity":"medium","cis_controls":[{"8":["6.5"]},{"7":["16.3"]}],"nist":["IA-2(1)","SI-2"]},"code":"control 'microsoft-365-foundations-5.2.2.1' do\n  title 'Ensure multifactor authentication is enabled for all users in administrative roles'\n  desc \"Multifactor authentication is a process that requires an additional form of identification during the sign-in process, such as a code from a mobile device or a fingerprint scan, to enhance security.\n        Ensure users in administrator roles have MFA capabilities enabled.\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click to expand Protection > Conditional Access select Policies.\n        3. Review the list of policies and ensure that there is a policy meeting at least the following criteria:\n            o Users: Include: Directory roles specific to administrators are selected.\n            o Target resources: All cloud apps.\n            o Grant: Grant access with Require multifactor authentication checked.\n        4. Ensure Enable policy is set to On.\n    To audit using SecureScore:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Select Secure score.\n        3. Select Recommended actions.\n        4. Click on Ensure multifactor authentication is enabled for all users in administrative roles.\n        5. Review the number of Admin users who do not have MFA configured.\n    This information is also available via the Microsoft Graph Security API:\n        GET https://graph.microsoft.com/beta/security/secureScores\n    Note: A list of required Directory roles can be found in the Remediation section.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Click New policy.\n        4. Go to Assignments > Users and groups > Include > Select users and groups > check Directory roles.\n        5. At a minimum, select the Directory roles listed below in this section of the document.\n        6. Go to Cloud apps or actions > Cloud apps > Include > select All cloud apps (and don't exclude any apps).\n        7. Under Access controls > Grant > select Grant access > check Require multi-factor authentication.\n        8. Set Enable policy to Report-only or On.\n        9. Create.\n    At minimum these directory roles should be included for MFA:\n        • Application administrator\n        • Authentication administrator\n        • Billing administrator\n        • Cloud application administrator\n        • Conditional Access administrator\n        • Exchange administrator\n        • Global administrator\n        • Global reader\n        • Helpdesk administrator\n        • Password administrator\n        • Privileged authentication administrator\n        • Privileged role administrator\n        • Security administrator\n        • SharePoint administrator\n        • User administrator\n    Note: Report-only is an acceptable first stage when introducing any CA policy. The control, however, is not complete until the policy is on.\"\n\n  desc 'rationale',\n       'Multifactor authentication requires an individual to present a minimum of two separate\n        forms of authentication before access is granted. Multifactor authentication provides\n        additional assurance that the individual attempting to gain access is who they claim to\n        be. With multifactor authentication, an attacker would need to compromise at least two\n        different authentication mechanisms, increasing the difficulty of compromise and thus\n        reducing the risk.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['6.5'] }, { '7' => ['16.3'] }]\n  tag nist: ['IA-2(1)', 'SI-2']\n\n  ref 'https://learn.microsoft.com/en-us/graph/api/resources/security-api-overview?view=graph-rest-beta'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.2.2.1.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":7.0e-06,"start_time":"2024-09-24T15:49:05-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.2.2.2","title":"Ensure multifactor authentication is enabled for all users","desc":"Enable multifactor authentication for all users in the Microsoft 365 tenant. Users will be prompted to authenticate with a second factor upon logging in to Microsoft 365 services. The second factor is most commonly a text message to a registered mobile phone number where they type in an authorization code, or with a mobile application like Microsoft Authenticator.","descriptions":[{"label":"default","data":"Enable multifactor authentication for all users in the Microsoft 365 tenant. Users will be prompted to authenticate with a second factor upon logging in to Microsoft 365 services. The second factor is most commonly a text message to a registered mobile phone number where they type in an authorization code, or with a mobile application like Microsoft Authenticator."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Review the list of policies and ensure that there is a policy meeting at least the following criteria:\n            o Users: Include: All users.\n            o Target resources: All cloud apps.\n            o Grant: Grant access with Require multifactor authentication checked.\n        4. Ensure Enable policy is set to On.\n    To audit using SecureScore:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Select Secure score.\n        3. Select Recommended actions.\n        4. Click on Ensure multifactor authentication is enabled for all users.\n        5. Review the list of users who do not have MFA configured."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Click New policy.\n        4. Go to Assignments > Users and groups > Include > select All users (and do not exclude any user).\n        5. Select Cloud apps or actions > All cloud apps (and don't exclude any apps).\n        6. Access Controls > Grant > Require multi-factor authentication.\n        7. Set Enable policy to Report-only or On.\n        8. Create.\n    Note: Report-only is an acceptable first stage when introducing any CA policy. The control, however, is not complete until the policy is on."},{"label":"rationale","data":"Multifactor authentication requires an individual to present a minimum of two separate\n        forms of authentication before access is granted. Multifactor authentication provides\n        additional assurance that the individual attempting to gain access is who they claim to\n        be. With multifactor authentication, an attacker would need to compromise at least two\n        different authentication mechanisms, increasing the difficulty of compromise and thus\n        reducing the risk."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/howto-conditional-access-policy-all-users-mfa"}],"tags":{"severity":"medium","cis_controls":[{"8":["6.3"]},{"7":["16.3"]}],"default_value":"Disabled","nist":["IA-2(1)","IA-2(2)","SI-2"]},"code":"control 'microsoft-365-foundations-5.2.2.2' do\n  title 'Ensure multifactor authentication is enabled for all users'\n  desc 'Enable multifactor authentication for all users in the Microsoft 365 tenant. Users will be prompted to authenticate with a second factor upon logging in to Microsoft 365 services. The second factor is most commonly a text message to a registered mobile phone number where they type in an authorization code, or with a mobile application like Microsoft Authenticator.'\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Review the list of policies and ensure that there is a policy meeting at least the following criteria:\n            o Users: Include: All users.\n            o Target resources: All cloud apps.\n            o Grant: Grant access with Require multifactor authentication checked.\n        4. Ensure Enable policy is set to On.\n    To audit using SecureScore:\n        1. Navigate to Microsoft 365 Defender https://security.microsoft.com.\n        2. Select Secure score.\n        3. Select Recommended actions.\n        4. Click on Ensure multifactor authentication is enabled for all users.\n        5. Review the list of users who do not have MFA configured.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Click New policy.\n        4. Go to Assignments > Users and groups > Include > select All users (and do not exclude any user).\n        5. Select Cloud apps or actions > All cloud apps (and don't exclude any apps).\n        6. Access Controls > Grant > Require multi-factor authentication.\n        7. Set Enable policy to Report-only or On.\n        8. Create.\n    Note: Report-only is an acceptable first stage when introducing any CA policy. The control, however, is not complete until the policy is on.\"\n\n  desc 'rationale',\n       'Multifactor authentication requires an individual to present a minimum of two separate\n        forms of authentication before access is granted. Multifactor authentication provides\n        additional assurance that the individual attempting to gain access is who they claim to\n        be. With multifactor authentication, an attacker would need to compromise at least two\n        different authentication mechanisms, increasing the difficulty of compromise and thus\n        reducing the risk.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['6.3'] }, { '7' => ['16.3'] }]\n  tag default_value: 'Disabled'\n  tag nist: ['IA-2(1)', 'IA-2(2)', 'SI-2']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/howto-conditional-access-policy-all-users-mfa'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.2.2.2.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":7.0e-06,"start_time":"2024-09-24T15:49:05-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.2.2.3","title":"Enable Conditional Access policies to block legacy authentication","desc":"Entra ID supports the most widely used authentication and authorization protocols including legacy authentication. This authentication pattern includes basic authentication, a widely used industry-standard method for collecting username and password information.\n        The following messaging protocols support legacy authentication:\n            • Authenticated SMTP - Used to send authenticated email messages.\n            • Autodiscover - Used by Outlook and EAS clients to find and connect to mailboxes in Exchange Online.\n            • Exchange ActiveSync (EAS) - Used to connect to mailboxes in Exchange Online.\n            • Exchange Online PowerShell - Used to connect to Exchange Online with remote PowerShell. If you block Basic authentication for Exchange Online PowerShell, you need to use the Exchange Online PowerShell Module to connect. For instructions, see Connect to Exchange Online PowerShell using multifactor authentication.\n            • Exchange Web Services (EWS) - A programming interface that's used by Outlook, Outlook for Mac, and third-party apps.\n            • IMAP4 - Used by IMAP email clients.\n            • MAPI over HTTP (MAPI/HTTP) - Primary mailbox access protocol used by Outlook 2010 SP2 and later.\n            • Offline Address Book (OAB) - A copy of address list collections that are downloaded and used by Outlook.\n            • Outlook Anywhere (RPC over HTTP) - Legacy mailbox access protocol supported by all current Outlook versions.\n            • POP3 - Used by POP email clients.\n            • Reporting Web Services - Used to retrieve report data in Exchange Online.\n            • Universal Outlook - Used by the Mail and Calendar app for Windows 10.\n            • Other clients - Other protocols identified as utilizing legacy authentication.","descriptions":[{"label":"default","data":"Entra ID supports the most widely used authentication and authorization protocols including legacy authentication. This authentication pattern includes basic authentication, a widely used industry-standard method for collecting username and password information.\n        The following messaging protocols support legacy authentication:\n            • Authenticated SMTP - Used to send authenticated email messages.\n            • Autodiscover - Used by Outlook and EAS clients to find and connect to mailboxes in Exchange Online.\n            • Exchange ActiveSync (EAS) - Used to connect to mailboxes in Exchange Online.\n            • Exchange Online PowerShell - Used to connect to Exchange Online with remote PowerShell. If you block Basic authentication for Exchange Online PowerShell, you need to use the Exchange Online PowerShell Module to connect. For instructions, see Connect to Exchange Online PowerShell using multifactor authentication.\n            • Exchange Web Services (EWS) - A programming interface that's used by Outlook, Outlook for Mac, and third-party apps.\n            • IMAP4 - Used by IMAP email clients.\n            • MAPI over HTTP (MAPI/HTTP) - Primary mailbox access protocol used by Outlook 2010 SP2 and later.\n            • Offline Address Book (OAB) - A copy of address list collections that are downloaded and used by Outlook.\n            • Outlook Anywhere (RPC over HTTP) - Legacy mailbox access protocol supported by all current Outlook versions.\n            • POP3 - Used by POP email clients.\n            • Reporting Web Services - Used to retrieve report data in Exchange Online.\n            • Universal Outlook - Used by the Mail and Calendar app for Windows 10.\n            • Other clients - Other protocols identified as utilizing legacy authentication."},{"label":"check","data":"Ensure a Conditional Access policy to block legacy authentication is enabled:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Verify that either the policy Baseline policy: Block legacy authentication is set to On or find another with the following settings enabled:\n            o Under Conditions then Client apps ensure the settings are enabled for and Exchange ActiveSync clients and other clients.\n            o Under Access controls ensure the Grant is set to Block access\n            o Under Assignments ensure All users is enabled\n            o Under Assignments and Users and groups ensure the Exclude is set to least one low risk account or directory role. This is required as a best practice.\n        This information is also available via the Microsoft Graph Security API:\n            GET https://graph.microsoft.com/beta/security/secureScores\n\n        More Granular Instructions:\n\n        To verify basic authentication is disabled, use the Exchange Online PowerShell Module:\n            1. Run the Microsoft Exchange Online PowerShell Module.\n            2. Connect using Connect-ExchangeOnline.\n            3. Run the following PowerShell command:\n                Get-OrganizationConfig | Select-Object -ExpandProperty\n                DefaultAuthenticationPolicy | ForEach { Get-AuthenticationPolicy $_ | Select-Object AllowBasicAuth* }\n            4. Verify each of the basic authentication types is set to false. If no results are shown or an error is displayed, then no default authentication policy has been defined for your organization.\n            5. Verify Exchange Online users are configured to use the appropriate authentication policy (in this case Block Basic Auth) by running the following PowerShell command:\n                Get-User -ResultSize Unlimited | Select-Object UserPrincipalName, AuthenticationPolicy"},{"label":"fix","data":"To setup a conditional access policy to block legacy authentication, use the following steps:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Create a new policy by selecting New policy.\n        4. Set the following conditions within the policy.\n            o Select Conditions then Client apps enable the settings for and Exchange ActiveSync clients and other clients.\n            o Under Access controls set the Grant section to Block access\n            o Under Assignments enable All users\n            o Under Assignments and Users and groups set the Exclude to be at least one low risk account or directory role. This is required as a best practice.\n\n        More Granular Instructions:\n\n        To disable basic authentication, use the Exchange Online PowerShell Module:\n            1. Run the Microsoft Exchange Online PowerShell Module.\n            2. Connect using Connect-ExchangeOnline.\n            3. Run the following PowerShell command:\n        *Note: If a policy exists and a command fails you may run Remove-AuthenticationPolicy first to ensure policy creation/application occurs as expected.\n            $AuthenticationPolicy = Get-OrganizationConfig | Select-Object DefaultAuthenticationPolicy\n            If (-not $AuthenticationPolicy.Identity) {\n                $AuthenticationPolicy = New-AuthenticationPolicy \"Block Basic Auth\"\n                Set-OrganizationConfig -DefaultAuthenticationPolicy $AuthenticationPolicy.Identity\n            }\n            Set-AuthenticationPolicy -Identity $AuthenticationPolicy.Identity -AllowBasicAuthActiveSync:$false -AllowBasicAuthAutodiscover:$false -AllowBasicAuthImap:$false -AllowBasicAuthMapi:$false -AllowBasicAuthOfflineAddressBook:$false -AllowBasicAuthOutlookService:$false -AllowBasicAuthPop:$false -AllowBasicAuthPowershell:$false -AllowBasicAuthReportingWebServices:$false -AllowBasicAuthRpc:$false -AllowBasicAuthSmtp:$false -AllowBasicAuthWebServices:$false\n            Get-User -ResultSize Unlimited | ForEach-Object { Set-User -Identity $_.Identity -AuthenticationPolicy $AuthenticationPolicy.Identity -STSRefreshTokensValidFrom $([System.DateTime]::UtcNow) }"},{"label":"rationale","data":"Legacy authentication protocols do not support multi-factor authentication. These\n        protocols are often used by attackers because of this deficiency. Blocking legacy\n        authentication makes it harder for attackers to gain access."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/exchange/clients-and-mobile-in-exchange-online/disable-basic-authentication-in-exchange-online"},{"ref":"https://learn.microsoft.com/en-us/exchange/mail-flow-best-practices/how-to-set-up-a-multifunction-device-or-application-to-send-email-using-microsoft-365-or-office-365"},{"ref":"https://learn.microsoft.com/en-us/exchange/clients-and-mobile-in-exchange-online/deprecation-of-basic-authentication-exchange-online"}],"tags":{"severity":"medium","cis_controls":[{"8":["4.8"]},{"7":["9.2"]}],"default_value":"Basic authentication is disabled by default as of January 2023.","nist":["CM-6","CM-7","SI-8"]},"code":"control 'microsoft-365-foundations-5.2.2.3' do\n  title 'Enable Conditional Access policies to block legacy authentication'\n  desc \"Entra ID supports the most widely used authentication and authorization protocols including legacy authentication. This authentication pattern includes basic authentication, a widely used industry-standard method for collecting username and password information.\n        The following messaging protocols support legacy authentication:\n            • Authenticated SMTP - Used to send authenticated email messages.\n            • Autodiscover - Used by Outlook and EAS clients to find and connect to mailboxes in Exchange Online.\n            • Exchange ActiveSync (EAS) - Used to connect to mailboxes in Exchange Online.\n            • Exchange Online PowerShell - Used to connect to Exchange Online with remote PowerShell. If you block Basic authentication for Exchange Online PowerShell, you need to use the Exchange Online PowerShell Module to connect. For instructions, see Connect to Exchange Online PowerShell using multifactor authentication.\n            • Exchange Web Services (EWS) - A programming interface that's used by Outlook, Outlook for Mac, and third-party apps.\n            • IMAP4 - Used by IMAP email clients.\n            • MAPI over HTTP (MAPI/HTTP) - Primary mailbox access protocol used by Outlook 2010 SP2 and later.\n            • Offline Address Book (OAB) - A copy of address list collections that are downloaded and used by Outlook.\n            • Outlook Anywhere (RPC over HTTP) - Legacy mailbox access protocol supported by all current Outlook versions.\n            • POP3 - Used by POP email clients.\n            • Reporting Web Services - Used to retrieve report data in Exchange Online.\n            • Universal Outlook - Used by the Mail and Calendar app for Windows 10.\n            • Other clients - Other protocols identified as utilizing legacy authentication.\"\n\n  desc 'check',\n       \"Ensure a Conditional Access policy to block legacy authentication is enabled:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Verify that either the policy Baseline policy: Block legacy authentication is set to On or find another with the following settings enabled:\n            o Under Conditions then Client apps ensure the settings are enabled for and Exchange ActiveSync clients and other clients.\n            o Under Access controls ensure the Grant is set to Block access\n            o Under Assignments ensure All users is enabled\n            o Under Assignments and Users and groups ensure the Exclude is set to least one low risk account or directory role. This is required as a best practice.\n        This information is also available via the Microsoft Graph Security API:\n            GET https://graph.microsoft.com/beta/security/secureScores\n\n        More Granular Instructions:\n\n        To verify basic authentication is disabled, use the Exchange Online PowerShell Module:\n            1. Run the Microsoft Exchange Online PowerShell Module.\n            2. Connect using Connect-ExchangeOnline.\n            3. Run the following PowerShell command:\n                Get-OrganizationConfig | Select-Object -ExpandProperty\n                DefaultAuthenticationPolicy | ForEach { Get-AuthenticationPolicy $_ | Select-Object AllowBasicAuth* }\n            4. Verify each of the basic authentication types is set to false. If no results are shown or an error is displayed, then no default authentication policy has been defined for your organization.\n            5. Verify Exchange Online users are configured to use the appropriate authentication policy (in this case Block Basic Auth) by running the following PowerShell command:\n                Get-User -ResultSize Unlimited | Select-Object UserPrincipalName, AuthenticationPolicy\"\n\n  desc 'fix',\n       'To setup a conditional access policy to block legacy authentication, use the following steps:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Create a new policy by selecting New policy.\n        4. Set the following conditions within the policy.\n            o Select Conditions then Client apps enable the settings for and Exchange ActiveSync clients and other clients.\n            o Under Access controls set the Grant section to Block access\n            o Under Assignments enable All users\n            o Under Assignments and Users and groups set the Exclude to be at least one low risk account or directory role. This is required as a best practice.\n\n        More Granular Instructions:\n\n        To disable basic authentication, use the Exchange Online PowerShell Module:\n            1. Run the Microsoft Exchange Online PowerShell Module.\n            2. Connect using Connect-ExchangeOnline.\n            3. Run the following PowerShell command:\n        *Note: If a policy exists and a command fails you may run Remove-AuthenticationPolicy first to ensure policy creation/application occurs as expected.\n            $AuthenticationPolicy = Get-OrganizationConfig | Select-Object DefaultAuthenticationPolicy\n            If (-not $AuthenticationPolicy.Identity) {\n                $AuthenticationPolicy = New-AuthenticationPolicy \"Block Basic Auth\"\n                Set-OrganizationConfig -DefaultAuthenticationPolicy $AuthenticationPolicy.Identity\n            }\n            Set-AuthenticationPolicy -Identity $AuthenticationPolicy.Identity -AllowBasicAuthActiveSync:$false -AllowBasicAuthAutodiscover:$false -AllowBasicAuthImap:$false -AllowBasicAuthMapi:$false -AllowBasicAuthOfflineAddressBook:$false -AllowBasicAuthOutlookService:$false -AllowBasicAuthPop:$false -AllowBasicAuthPowershell:$false -AllowBasicAuthReportingWebServices:$false -AllowBasicAuthRpc:$false -AllowBasicAuthSmtp:$false -AllowBasicAuthWebServices:$false\n            Get-User -ResultSize Unlimited | ForEach-Object { Set-User -Identity $_.Identity -AuthenticationPolicy $AuthenticationPolicy.Identity -STSRefreshTokensValidFrom $([System.DateTime]::UtcNow) }'\n\n  desc 'rationale',\n       'Legacy authentication protocols do not support multi-factor authentication. These\n        protocols are often used by attackers because of this deficiency. Blocking legacy\n        authentication makes it harder for attackers to gain access.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['4.8'] }, { '7' => ['9.2'] }]\n  tag default_value: 'Basic authentication is disabled by default as of January 2023.'\n  tag nist: ['CM-6', 'CM-7', 'SI-8']\n\n  ref 'https://learn.microsoft.com/en-us/exchange/clients-and-mobile-in-exchange-online/disable-basic-authentication-in-exchange-online'\n  ref 'https://learn.microsoft.com/en-us/exchange/mail-flow-best-practices/how-to-set-up-a-multifunction-device-or-application-to-send-email-using-microsoft-365-or-office-365'\n  ref 'https://learn.microsoft.com/en-us/exchange/clients-and-mobile-in-exchange-online/deprecation-of-basic-authentication-exchange-online'\n\n  check_basic_authentication_types_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    $defaultPolicy = Get-OrganizationConfig | Select-Object -ExpandProperty DefaultAuthenticationPolicy\n    $authSettings = Get-AuthenticationPolicy $defaultPolicy | Select-Object AllowBasicAuth*\n    $trueSettings = $authSettings.PSObject.Properties | Where-Object { $_.Value -eq $true } | Select-Object Name, Value\n    $jsonOutput = $trueSettings | ConvertTo-Json\n  }\n  powershell_authentication_types_output = powershell(check_basic_authentication_types_script).stdout.strip\n\n  authentication_policy_data = JSON.parse(powershell_authentication_types_output) unless powershell_authentication_types_output.empty?\n  describe 'Ensure there is no Conditional Access policy that' do\n    subject { authentication_policy_data }\n    it 'with a AllowBasicAuth* state set to True' do\n      failure_message = \"Policies that failed: #{JSON.pretty_generate(authentication_policy_data)}\"\n      expect(subject).to be_nil, failure_message\n    end\n  end\n  check_authentication_block_basic_auth_policy_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    $users = Get-User -ResultSize Unlimited | Where-Object { $_.AuthenticationPolicy -ne \"Block Basic Auth\" } | Select-Object UserPrincipalName, AuthenticationPolicy\n    $jsonOutput = $users | ConvertTo-Json\n    $jsonOutput\n    }\n  powershell_block_basic_output = powershell(check_authentication_block_basic_auth_policy_script).stdout.strip\n\n  block_basic_policy_data = JSON.parse(powershell_block_basic_output) unless powershell_block_basic_output.empty?\n  describe 'Ensure there is no Exchange Online User' do\n    subject { block_basic_policy_data }\n    it 'with AuthenticationPolicy state that is not Block Basic Auth' do\n      failure_message = \"Users that failed: #{JSON.pretty_generate(block_basic_policy_data)}\"\n      expect(subject).to be_nil, failure_message\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.2.2.3.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure there is no Conditional Access policy that with a AllowBasicAuth* state set to True","run_time":0.000209,"start_time":"2024-09-24T15:49:05-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure there is no Conditional Access policy that"},{"status":"failed","code_desc":"Ensure there is no Exchange Online User with AuthenticationPolicy state that is not Block Basic Auth","run_time":0.000257,"start_time":"2024-09-24T15:49:05-04:00","message":"Users that failed: [\n  {\n    \"UserPrincipalName\": \"DiscoverySearchMailbox{D919BA05-46A6-415f-80AD-7E09334BB852}@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"mcannava@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"phebenstreit@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"savo365admin@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"m365systemaccount@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"marianne@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"rwolfe@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jcsganga@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"alopez@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"asalah@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"rrawal@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"glazarte@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"spandolfi@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"mrodrigues@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"aalbaran@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"njacobs@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"cchang@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"forbes@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"iwright@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"bedford-csl-mtr@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"mclean-csl-mtr@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"scbrown@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"aabramkin@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"tenantAuditLogReader@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jtat@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"junger@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"bpalumbo@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"mmamo@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"akotaru@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"nguyenm@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"lkeenan@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jcho@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"sbarber@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"kferrante@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"fcriscione@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"nkatikaneni@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"AABRAMKIN_MITRE.ORG#EXT#@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"ali@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"afgp@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"bfgp@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"wgabree@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"eschermerhorn@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"bbascom@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"ecottom@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"nspatel@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"mitreatworkdev@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"mitreatworkint@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"SLITTLEHALE@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"lfinn@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"dproulx@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"gpasku@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"mhartley@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"mmoulton@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"tririgasa@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G6883cc876738418dac007a555754bbe1@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Ga963219c79e840a38a1c71860e735b89@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Ge6e28df5713b45a2a75878d213461601@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G5190954b52aa44988e669f971487213c@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gea1cce529c204c76bf965e36d6f9f091@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G1c8fe71ce9084ae682ed08e5ab786379@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gae43b3316b474731b01ceed83a80cc06@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"phebenstreit_mitre-engenuity.org#EXT#@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"phebenstreit_mitre-ext.org#EXT#@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"phebenstreit_mitre.org#EXT#@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"scbrown_mitre-ext.org#EXT#@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"scbrown_mitre-engenuity.org#EXT#@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"scbrown_mitre.org#EXT#@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jgallivan@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"1E301_vConf@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"roliver@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"acleavenger@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"phebenstreit_admin_hssedidev.onmicrosoft.us#EXT#@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"petertest@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"prajaram@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"lavender@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jduncan@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"oeris@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jimhickey@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"mkramer@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"gertner@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"ehiner@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"lfischetti@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"dcuomo@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"kmholmes@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"kwarren@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jhall@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"bdowney@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jzarrella@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"briananderson@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jamesmk@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"dpowner@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"bdowney_mitre.org#EXT#@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"tlee@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jmixon@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"vmartzahl@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"efinney@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"ard@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"pierce@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"pnoonan@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jplopez@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"kkennedy@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"mtufekci@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"swarup@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"sudakar@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"tneale@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"mjphillips@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jharrison@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jasonprovidakesceo@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"kirin@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"bmeinert@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jomijie@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"mhalper@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"akeller@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"m29772_mitre.org#EXT#@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"mtyler@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"abuehne@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"cberger@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"cwinsor@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"wkirkman@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"scorley@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"thoang@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"hzhang@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"ako@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"cschlick@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"lovans@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"pabrams@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"mdube@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"sjaniak@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"kristinalawson@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"sroe@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"lyn@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"dtkim@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"sryder@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"shylaja@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"ksa@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jcmoore@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"csl_phonebooth@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"ldebellis@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"ltiv@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"scolangelo@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"iprusky@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"nwill@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"gshieh@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"iprusky_mitre.org#EXT#@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"srjones@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jcanadas@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"raymondchan@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"cballen@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"atanoor@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"dvitenko@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"lmavroudakis@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"odennehy@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"psorenson@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"sburgoyne@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"dbarr@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"sshearing@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"rteague@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"henri@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"tmoran@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"narcaro@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"azaini@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"rguntor@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"snad-e-ali@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jhoyns@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"oktaFed@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"njtestuser@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gf2b5fc5b55c14ec1b4ce233927e17c80@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gd9fa4c0b46c14d169be97c7d1f80d611@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"lebrandt@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"CommonPhone@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"userglazarte@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"efaulder@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"kszot@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"gkuhn@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"pverrill@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jseifert@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"tscholfield@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"dzic@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"dweinman@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"kcigler@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"gmorgan@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jhiggins@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"adost@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gaab45bb639c647138d357bb4e0c5e6bc@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G9f51a038b7b5474ab32298510125961f@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"gkuhn_mitre.org#EXT#@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"kszot_mitre.org#EXT#@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"glazarte_mitre.org#EXT#@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"catorre@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"maryf@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"P860_dev@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"lmazuca_mitre.org#EXT#@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"dshackley@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"snoel@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"ewolos@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"igross@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"amukherjee@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G2245e453758d4b5ab3defe3bba084e2b@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"acheck@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"CSL_MTRA_CART@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jma@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"npando@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"gcase@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jflorie@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"cristinaoh@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"secooper@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"chad@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"cenkl@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"dweiss@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"zrobin@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"qwang@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"rspringer@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"chrisgoode@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"mchung@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"nima@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jmaziarz@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jblaine@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"cbellar@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"bamado@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"imatthews@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"glading@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"schepeni@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"nbos@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"dpoltar@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"mraguso@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"knayak@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"mgeiser@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"vjamba@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"damirault@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"nforleo@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"karacm@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"acoursen@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jschommer@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"jbaskerville@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"atapaswi@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"rhochgraf@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"eclough@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"dsarkhel@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G96c34d2fb36b44a6861a560ba8f0b71d@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"ccompton@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"rchaudhry@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"drozdetski@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"eddiep@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"kchong@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"DKENDALL@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G2b24fe1832ad4025b04ffa0a3e2cf1ce@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G367cb91473ae4cb5b6a9845d0b213c39@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G1ca481ae87b14060a0e0a8c54dfa0c3e@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gaf2c8ed63ad44695825da75b4e86d2f6@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G8e55bde00237415ba9d9c67ecd999531@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gd561bbc3219b463cbe6f35e93e5766bb@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G3e13b51e848f484cb1638d698bad240c@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gbb7cf61507a44d768529bbe4486e121a@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gc039ba7764964abbae78c027f58087c2@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gd523b17f3b21409d89e8fee71b0fd31d@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G566d71833987490d9735ec9bed17c3a0@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G0c675cf9d0184c6caf44c39e8a4b0a60@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gb105f1f90a9a4f80b29c7cb56a2a8b54@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G98988bceb6ad4b6789d6516e3320b633@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G9ec70147c21d4d54be2256f5745db6d3@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gdfe7a80c2295477293449f42c1f0be9e@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G7dcae2c99ec641d680c1d44f87d53ecf@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gae9dbd54b45b4c30b9a5a71cde6606e3@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G7c633dc0c92f441b99f81677f616af8a@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G8651f561aebd47cb80ca65ea4cd3e535@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G4d948762291d4b6a8972245e5ff75ad7@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Geb52bd32f3244d4bb425699634618b1a@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gb70968aa1e3a4eaa845e1d87548abd31@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G89a5c6746e5c432fa9194c3ca76d42ea@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gca9ad98156214e3395b4d475e0b23b97@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G97d44347b08f4cb080a660302a7c5918@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gd5291d8a560d46b5ae5f8333dda2b2ff@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G92764785c24f4ddbb3fbc778a3f3ec8c@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gd00d979e95464e46a86c72085d25a45a@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G356946da3f24493b894f44117389bdf5@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G935bf5df5ccc4491a22779e85df28fa7@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G1c736c9597d24c519a887c64e50ac8b5@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G638d8627de4743fd88a85fe42e229afa@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G0de78aa867a343689d5f32d13edd3b28@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G71ac6c7b4b39435b9d1915ebb01f0f19@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gf20c0c67ea774b5ca89c81ad42c44010@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gc948b7c5bc354c3695fd3cf874e64e4f@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G0a21edbdec9644418fa98a05f6605369@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gb5e4884dacae445a84140d7ce3664af8@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"C-05_vConf@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"AW-05_vConf@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G3078c72f3e0342f793eef5ca75791e12@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gb4ba334e615a4a8ea52ed815f3380395@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gf89a9cb87ece43eb9730aaeac318bcf2@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gaca915d02bb84ec6be421ba9ab620e02@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G8b570a0ea0ae4b719f45783ac0651955@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Ge167cc796ab146269f496dd94fd752c1@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Geae63c18684d4600a934c48ab45be3f3@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G664660cf287d4948a972c63720d9d177@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gf3ae7f7c5d8d406cbf2b3aec22b2875a@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G0069f76603a74db7b7e4b15b92c3a50b@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gc988eb1b4aab4b19bff93dcd19f8fe3b@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G9046ea35319a4bf691ca24077a086214@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G6a17f1dd81de4be0a0e4515c0f05d099@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gf0ca81aec9fe45fab2408ca6ca13acb4@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G0e3236b3e08a4307b2f6c18a4f925af0@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gcbf9ced77eb847d7ae3c963ec87b2e8f@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Bedford_Secure1@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"McLean_Secure1@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Bedford_Secure2@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"McLean_Secure2@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Aberdeen_Secure1@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Aberdeen_Secure2@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"SanDiego_Secure1@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"SanDiego_Secure2@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"skandwal@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G4c093acb43bb47258d8c9c67ca7a215a@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gf650fdfae69543b0af5a3bd9f0167938@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gdd150c173b8d41a391ac1a527de93dca@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G086a3610c3dc484f95c296e62a403af2@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"G4ee2e521175c4447808cfb8837c90823@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"Gda5ca1b904384a8fa632312a37350b1c@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"rnovak@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"cbarlow@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  },\n  {\n    \"UserPrincipalName\": \"abouffard@mitredev.onmicrosoft.com\",\n    \"AuthenticationPolicy\": null\n  }\n]","resource_class":"Object","resource_params":"[]","resource_id":"Ensure there is no Exchange Online User"}]},{"id":"microsoft-365-foundations-5.2.2.4","title":"Ensure Sign-in frequency is enabled and browser sessions are not persistent for Administrative users","desc":"In complex deployments, organizations might have a need to restrict authentication sessions. Conditional Access policies allow for the targeting of specific user accounts. Some scenarios might include:\n            • Resource access from an unmanaged or shared device\n            • Access to sensitive information from an external network\n            • High-privileged users\n            • Business-critical applications\n        Ensure Sign-in frequency does not exceed 4 hours for E3 tenants, or 24 hours for E5 tenants using Privileged Identity Management.\n        Ensure Persistent browser session is set to Never persist\n        NOTE: This CA policy can be added to the previous CA policy in this benchmark \"Ensure multifactor authentication is enabled for all users in administrative roles\"","descriptions":[{"label":"default","data":"In complex deployments, organizations might have a need to restrict authentication sessions. Conditional Access policies allow for the targeting of specific user accounts. Some scenarios might include:\n            • Resource access from an unmanaged or shared device\n            • Access to sensitive information from an external network\n            • High-privileged users\n            • Business-critical applications\n        Ensure Sign-in frequency does not exceed 4 hours for E3 tenants, or 24 hours for E5 tenants using Privileged Identity Management.\n        Ensure Persistent browser session is set to Never persist\n        NOTE: This CA policy can be added to the previous CA policy in this benchmark \"Ensure multifactor authentication is enabled for all users in administrative roles\""},{"label":"check","data":"Ensure Sign-in frequency is enabled and browser sessions are not persistent for Administrative users:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Protection > Conditional Access Select Policies.\n        3. Review the list of policies and ensure that there is a policy that have Sign-in frequency set to the time determined by your organization and that Persistent browser session is set to Never persistent.\n        4. Ensure Sign-in frequency does not exceed 4 hours for E3 tenants. E5 tenants using PIM may be set to a maximum of 24 hours.\n            • A list of directory role applying to Administrators can be found in the remediation section."},{"label":"fix","data":"To configure Sign-in frequency and browser sessions persistence for Administrative users:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Protection > Conditional Access Select Policies.\n        3. Click New policy\n        4. Click Users and groups\n        5. Under Include select Select users and groups and then select Directory roles.\n        6. At a minimum, select the roles in the section below.\n        7. Go to Cloud apps or actions > Cloud apps > Include > select All cloud apps (and don't exclude any apps).\n        8. Under Access controls > Grant > select Grant access > check Require multi-factor authentication (and nothing else).\n        9. Under Session select Sign-in frequency and set to at most 4 hours for E3 tenants. E5 tenants with PIM can be set to a maximum value of 24 hours.\n        10. Check Persistent browser session then select Never persistent in the drop-down menu.\n        11. For Enable Policy select On and click Save\n    At minimum these directory roles should be included for MFA:\n        • Application administrator\n        • Authentication administrator\n        • Billing administrator\n        • Cloud application administrator\n        • Conditional Access administrator\n        • Exchange administrator\n        • Global administrator\n        • Global reader\n        • Helpdesk administrator\n        • Password administrator\n        • Privileged authentication administrator\n        • Privileged role administrator\n        • Security administrator\n        • SharePoint administrator\n        • User administrator"},{"label":"rationale","data":"Forcing a time out for MFA will help ensure that sessions are not kept alive for an\n        indefinite period of time, ensuring that browser sessions are not persistent will help in\n        prevention of drive-by attacks in web browsers, this also prevents creation and saving of\n        session cookies leaving nothing for an attacker to take."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/howto-conditional-access-session-lifetime"}],"tags":{"severity":"medium","cis_controls":[{"8":["4.3"]},{"7":["16.3"]}],"default_value":"The default configuration for user sign-in frequency is a rolling window of 90 days.","nist":["AC-2(5)","AC-11","AC-11(1)","AC-12","SI-2"]},"code":"control 'microsoft-365-foundations-5.2.2.4' do\n  title 'Ensure Sign-in frequency is enabled and browser sessions are not persistent for Administrative users'\n  desc 'In complex deployments, organizations might have a need to restrict authentication sessions. Conditional Access policies allow for the targeting of specific user accounts. Some scenarios might include:\n            • Resource access from an unmanaged or shared device\n            • Access to sensitive information from an external network\n            • High-privileged users\n            • Business-critical applications\n        Ensure Sign-in frequency does not exceed 4 hours for E3 tenants, or 24 hours for E5 tenants using Privileged Identity Management.\n        Ensure Persistent browser session is set to Never persist\n        NOTE: This CA policy can be added to the previous CA policy in this benchmark \"Ensure multifactor authentication is enabled for all users in administrative roles\"'\n\n  desc 'check',\n       \"Ensure Sign-in frequency is enabled and browser sessions are not persistent for Administrative users:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Protection > Conditional Access Select Policies.\n        3. Review the list of policies and ensure that there is a policy that have Sign-in frequency set to the time determined by your organization and that Persistent browser session is set to Never persistent.\n        4. Ensure Sign-in frequency does not exceed 4 hours for E3 tenants. E5 tenants using PIM may be set to a maximum of 24 hours.\n            • A list of directory role applying to Administrators can be found in the remediation section.\"\n\n  desc 'fix',\n       \"To configure Sign-in frequency and browser sessions persistence for Administrative users:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Protection > Conditional Access Select Policies.\n        3. Click New policy\n        4. Click Users and groups\n        5. Under Include select Select users and groups and then select Directory roles.\n        6. At a minimum, select the roles in the section below.\n        7. Go to Cloud apps or actions > Cloud apps > Include > select All cloud apps (and don't exclude any apps).\n        8. Under Access controls > Grant > select Grant access > check Require multi-factor authentication (and nothing else).\n        9. Under Session select Sign-in frequency and set to at most 4 hours for E3 tenants. E5 tenants with PIM can be set to a maximum value of 24 hours.\n        10. Check Persistent browser session then select Never persistent in the drop-down menu.\n        11. For Enable Policy select On and click Save\n    At minimum these directory roles should be included for MFA:\n        • Application administrator\n        • Authentication administrator\n        • Billing administrator\n        • Cloud application administrator\n        • Conditional Access administrator\n        • Exchange administrator\n        • Global administrator\n        • Global reader\n        • Helpdesk administrator\n        • Password administrator\n        • Privileged authentication administrator\n        • Privileged role administrator\n        • Security administrator\n        • SharePoint administrator\n        • User administrator\"\n\n  desc 'rationale',\n       'Forcing a time out for MFA will help ensure that sessions are not kept alive for an\n        indefinite period of time, ensuring that browser sessions are not persistent will help in\n        prevention of drive-by attacks in web browsers, this also prevents creation and saving of\n        session cookies leaving nothing for an attacker to take.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['4.3'] }, { '7' => ['16.3'] }]\n  tag default_value: 'The default configuration for user sign-in frequency is a rolling window of 90 days.'\n  tag nist: ['AC-2(5)', 'AC-11', 'AC-11(1)', 'AC-12', 'SI-2']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/howto-conditional-access-session-lifetime'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.2.2.4.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":7.0e-06,"start_time":"2024-09-24T15:49:05-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.2.2.5","title":"Ensure 'Phishing-resistant MFA strength' is required for Administrators","desc":"Authentication strength is a Conditional Access control that allows administrators to specify which combination of authentication methods can be used to access a resource. For example, they can make only phishing-resistant authentication methods available to access a sensitive resource. But to access a non-sensitive resource, they can allow less secure multifactor authentication (MFA) combinations, such as password + SMS.\n        Microsoft has 3 built-in authentication strengths. MFA strength, Passwordless MFA strength, and Phishing-resistant MFA strength. Ensure administrator roles are using a CA policy with Phishing-resistant MFA strength.\n        Administrators can then enroll using one of 3 methods:\n            • FIDO2 Security Key\n            • Windows Hello for Business\n            • Certificate-based authentication (Multi-Factor)\n        Note: Additional steps to configure methods such as FIDO2 keys are not covered here but can be found in related MS articles in the references section. The Conditional Access policy only ensures 1 of the 3 methods is used.\n        Warning: Administrators should be pre-registered for a strong authentication mechanism before this Conditional Access Policy is enforced. Additionally, as stated elsewhere in the CIS Benchmark a break-glass administrator account should be excluded from this policy to ensure unfettered access in the case of an emergency.","descriptions":[{"label":"default","data":"Authentication strength is a Conditional Access control that allows administrators to specify which combination of authentication methods can be used to access a resource. For example, they can make only phishing-resistant authentication methods available to access a sensitive resource. But to access a non-sensitive resource, they can allow less secure multifactor authentication (MFA) combinations, such as password + SMS.\n        Microsoft has 3 built-in authentication strengths. MFA strength, Passwordless MFA strength, and Phishing-resistant MFA strength. Ensure administrator roles are using a CA policy with Phishing-resistant MFA strength.\n        Administrators can then enroll using one of 3 methods:\n            • FIDO2 Security Key\n            • Windows Hello for Business\n            • Certificate-based authentication (Multi-Factor)\n        Note: Additional steps to configure methods such as FIDO2 keys are not covered here but can be found in related MS articles in the references section. The Conditional Access policy only ensures 1 of the 3 methods is used.\n        Warning: Administrators should be pre-registered for a strong authentication mechanism before this Conditional Access Policy is enforced. Additionally, as stated elsewhere in the CIS Benchmark a break-glass administrator account should be excluded from this policy to ensure unfettered access in the case of an emergency."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Review the list of policies and ensure that there is a policy with the Grant access control set to Require authentication strength (Preview): Phishing-resistant MFA\n        4. Ensure the above policy conforms to these settings:\n            o Users > Include > Select users and groups > Directory Roles to include at minimum the roles listed in the remediation section.\n            o Cloud apps or actions > All cloud apps\n            o Grant > Grant Access with Require authentication strength (Preview): Phishing-resistant MFA set.\n        5. The policy is set to On."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Click New policy.\n        4. Go to Users > Users and groups > Include > Select users and groups > Directory roles\n        5. Add at least the Directory roles listed after these steps.\n        6. Select Cloud apps or actions > All cloud apps (and don't exclude any apps).\n        7. Grant > Grant Access with Require authentication strength (Preview): Phishing-resistant MFA\n        8. Click `Select'\n        9. Set Enable policy to Report-only and click Create\n    At minimum these directory roles should be included for the policy:\n        • Application administrator\n        • Authentication administrator\n        • Billing administrator\n        • Cloud application administrator\n        • Conditional Access administrator\n        • Exchange administrator\n        • Global administrator\n        • Global reader\n        • Helpdesk administrator\n        • Password administrator\n        • Privileged authentication administrator\n        • Privileged role administrator\n        • Security administrator\n        • SharePoint administrator\n        • User administrator\n    Warning: Ensure administrators are pre-registered with strong authentication before enforcing the policy. After which the policy must be set to On."},{"label":"rationale","data":"Sophisticated attacks targeting MFA are more prevalent as the use of it becomes more\n        widespread. These 3 methods are considered phishing-resistant as they remove\n        passwords from the login workflow. It also ensures that public/private key exchange can\n        only happen between the devices and a registered provider which prevents login to fake\n        or phishing websites."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/authentication/concept-authentication-passwordless#fido2-security-keys"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/authentication/howto-authentication-passwordless-security-key"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/authentication/concept-authentication-strengths"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/howto-identity-protection-configure-mfa-policy"}],"tags":{"severity":"medium","cis_controls":[{"8":["6.5"]}],"nist":["IA-2(1)"]},"code":"control 'microsoft-365-foundations-5.2.2.5' do\n  title \"Ensure 'Phishing-resistant MFA strength' is required for Administrators\"\n  desc \"Authentication strength is a Conditional Access control that allows administrators to specify which combination of authentication methods can be used to access a resource. For example, they can make only phishing-resistant authentication methods available to access a sensitive resource. But to access a non-sensitive resource, they can allow less secure multifactor authentication (MFA) combinations, such as password + SMS.\n        Microsoft has 3 built-in authentication strengths. MFA strength, Passwordless MFA strength, and Phishing-resistant MFA strength. Ensure administrator roles are using a CA policy with Phishing-resistant MFA strength.\n        Administrators can then enroll using one of 3 methods:\n            • FIDO2 Security Key\n            • Windows Hello for Business\n            • Certificate-based authentication (Multi-Factor)\n        Note: Additional steps to configure methods such as FIDO2 keys are not covered here but can be found in related MS articles in the references section. The Conditional Access policy only ensures 1 of the 3 methods is used.\n        Warning: Administrators should be pre-registered for a strong authentication mechanism before this Conditional Access Policy is enforced. Additionally, as stated elsewhere in the CIS Benchmark a break-glass administrator account should be excluded from this policy to ensure unfettered access in the case of an emergency.\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Review the list of policies and ensure that there is a policy with the Grant access control set to Require authentication strength (Preview): Phishing-resistant MFA\n        4. Ensure the above policy conforms to these settings:\n            o Users > Include > Select users and groups > Directory Roles to include at minimum the roles listed in the remediation section.\n            o Cloud apps or actions > All cloud apps\n            o Grant > Grant Access with Require authentication strength (Preview): Phishing-resistant MFA set.\n        5. The policy is set to On.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Click New policy.\n        4. Go to Users > Users and groups > Include > Select users and groups > Directory roles\n        5. Add at least the Directory roles listed after these steps.\n        6. Select Cloud apps or actions > All cloud apps (and don't exclude any apps).\n        7. Grant > Grant Access with Require authentication strength (Preview): Phishing-resistant MFA\n        8. Click `Select'\n        9. Set Enable policy to Report-only and click Create\n    At minimum these directory roles should be included for the policy:\n        • Application administrator\n        • Authentication administrator\n        • Billing administrator\n        • Cloud application administrator\n        • Conditional Access administrator\n        • Exchange administrator\n        • Global administrator\n        • Global reader\n        • Helpdesk administrator\n        • Password administrator\n        • Privileged authentication administrator\n        • Privileged role administrator\n        • Security administrator\n        • SharePoint administrator\n        • User administrator\n    Warning: Ensure administrators are pre-registered with strong authentication before enforcing the policy. After which the policy must be set to On.\"\n\n  desc 'rationale',\n       'Sophisticated attacks targeting MFA are more prevalent as the use of it becomes more\n        widespread. These 3 methods are considered phishing-resistant as they remove\n        passwords from the login workflow. It also ensures that public/private key exchange can\n        only happen between the devices and a registered provider which prevents login to fake\n        or phishing websites.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['6.5'] }]\n  tag nist: ['IA-2(1)']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/authentication/concept-authentication-passwordless#fido2-security-keys'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/authentication/howto-authentication-passwordless-security-key'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/authentication/concept-authentication-strengths'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/howto-identity-protection-configure-mfa-policy'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.2.2.5.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":5.0e-06,"start_time":"2024-09-24T15:49:05-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.2.2.6","title":"Enable Azure AD Identity Protection user risk policies","desc":"Microsoft Entra ID Protection user risk policies detect the probability that a user account has been compromised.\n        Note: While Identity Protection also provides two risk policies with limited conditions, Microsoft highly recommends setting up risk-based policies in Conditional Access as opposed to the \"legacy method\" for the following benefits:\n            • Enhanced diagnostic data\n            • Report-only mode integration\n            • Graph API support\n            • Use more Conditional Access attributes like sign-in frequency in the policy","descriptions":[{"label":"default","data":"Microsoft Entra ID Protection user risk policies detect the probability that a user account has been compromised.\n        Note: While Identity Protection also provides two risk policies with limited conditions, Microsoft highly recommends setting up risk-based policies in Conditional Access as opposed to the \"legacy method\" for the following benefits:\n            • Enhanced diagnostic data\n            • Report-only mode integration\n            • Graph API support\n            • Use more Conditional Access attributes like sign-in frequency in the policy"},{"label":"check","data":"Ensure a user risk policy is enabled:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Ensure that a policy exist with the following characteristics and is set to On:\n            o Under Users or workload identities choose All users\n            o Under Cloud apps or actions choose All cloud apps\n            o Under Conditions choose User risk then Yes is set to High.\n            o Under Access Controls select Grant then in the right pane click Grant access, then select Require multifactor authentication and Require password change.\n            o Under Session ensure Sign-in frequency is set to Every time."},{"label":"fix","data":"To configure a User risk policy, use the following steps:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Create a new policy by selecting New policy.\n        4. Set the following conditions within the policy:\n            o Under Users or workload identities choose All users\n            o Under Cloud apps or actions choose All cloud apps\n            o Under Conditions choose User risk then Yes and select the user risk level High.\n            o Under Access Controls select Grant then in the right pane click Grant access then select Require multifactor authentication and Require password change.\n            o Under Session ensure Sign-in frequency is set to Every time.\n        5. Click Select.\n        6. You may opt to begin in a state of Report Only as you step through implementation however, the policy will need to be set to On to be in effect.\n        7. Click Create."},{"label":"rationale","data":"With the user risk policy turned on, Entra ID protection detects the probability that a user\n        account has been compromised. Administrators can configure a user risk conditional\n        access policy to automatically respond to a specific user risk level."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/howto-identity-protection-risk-feedback"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/concept-identity-protection-risks"}],"tags":{"severity":"medium","cis_controls":[{"8":["13.3"]},{"7":["16.13"]}],"nist":["SI-4","SI-4(4)"]},"code":"control 'microsoft-365-foundations-5.2.2.6' do\n  title 'Enable Azure AD Identity Protection user risk policies'\n  desc 'Microsoft Entra ID Protection user risk policies detect the probability that a user account has been compromised.\n        Note: While Identity Protection also provides two risk policies with limited conditions, Microsoft highly recommends setting up risk-based policies in Conditional Access as opposed to the \"legacy method\" for the following benefits:\n            • Enhanced diagnostic data\n            • Report-only mode integration\n            • Graph API support\n            • Use more Conditional Access attributes like sign-in frequency in the policy'\n\n  desc 'check',\n       \"Ensure a user risk policy is enabled:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Ensure that a policy exist with the following characteristics and is set to On:\n            o Under Users or workload identities choose All users\n            o Under Cloud apps or actions choose All cloud apps\n            o Under Conditions choose User risk then Yes is set to High.\n            o Under Access Controls select Grant then in the right pane click Grant access, then select Require multifactor authentication and Require password change.\n            o Under Session ensure Sign-in frequency is set to Every time.\"\n\n  desc 'fix',\n       \"To configure a User risk policy, use the following steps:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Create a new policy by selecting New policy.\n        4. Set the following conditions within the policy:\n            o Under Users or workload identities choose All users\n            o Under Cloud apps or actions choose All cloud apps\n            o Under Conditions choose User risk then Yes and select the user risk level High.\n            o Under Access Controls select Grant then in the right pane click Grant access then select Require multifactor authentication and Require password change.\n            o Under Session ensure Sign-in frequency is set to Every time.\n        5. Click Select.\n        6. You may opt to begin in a state of Report Only as you step through implementation however, the policy will need to be set to On to be in effect.\n        7. Click Create.\"\n\n  desc 'rationale',\n       'With the user risk policy turned on, Entra ID protection detects the probability that a user\n        account has been compromised. Administrators can configure a user risk conditional\n        access policy to automatically respond to a specific user risk level.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['13.3'] }, { '7' => ['16.13'] }]\n  tag nist: ['SI-4', 'SI-4(4)']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/howto-identity-protection-risk-feedback'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/concept-identity-protection-risks'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.2.2.6.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":6.0e-06,"start_time":"2024-09-24T15:49:05-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.2.2.7","title":"Enable Azure AD Identity Protection sign-in risk policies","desc":"Microsoft Entra ID Protection sign-in risk detects risks in real-time and offline. A risky sign-in is an indicator for a sign-in attempt that might not have been performed by the legitimate owner of a user account.\n        Note: While Identity Protection also provides two risk policies with limited conditions, Microsoft highly recommends setting up risk-based policies in Conditional Access as opposed to the \"legacy method\" for the following benefits:\n            • Enhanced diagnostic data\n            • Report-only mode integration\n            • Graph API support\n            • Use more Conditional Access attributes like sign-in frequency in the policy","descriptions":[{"label":"default","data":"Microsoft Entra ID Protection sign-in risk detects risks in real-time and offline. A risky sign-in is an indicator for a sign-in attempt that might not have been performed by the legitimate owner of a user account.\n        Note: While Identity Protection also provides two risk policies with limited conditions, Microsoft highly recommends setting up risk-based policies in Conditional Access as opposed to the \"legacy method\" for the following benefits:\n            • Enhanced diagnostic data\n            • Report-only mode integration\n            • Graph API support\n            • Use more Conditional Access attributes like sign-in frequency in the policy"},{"label":"check","data":"To ensure Sign-In a risk policy is enabled:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Ensure that a policy exist with the following characteristics and is set to On:\n            o Under Users or workload identities choose All users\n            o Under Cloud apps or actions choose All cloud apps\n            o Under Conditions choose Sign-in risk then Yes ensuring High and Medium are selected.\n            o Under Access Controls select Grant then in the right pane click Grant access then select Require multifactor authentication.\n            o Under Session select Sign-in Frequency is set to Every time."},{"label":"fix","data":"To configure a Sign-In risk policy, use the following steps:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Create a new policy by selecting New policy.\n        4. Set the following conditions within the policy.\n            o Under Users or workload identities choose All users\n            o Under Cloud apps or actions choose All cloud apps\n            o Under Conditions choose Sign-in risk then Yes and check the risk level boxes High and Medium\n            o Under Access Controls select Grant then in the right pane click Grant access then select Require multifactor authentication.\n            o Under Session select Sign-in Frequency and set to Every time.\n        5. Click Select\n        6. You may opt to begin in a state of Report Only as you step through implementation however, the policy will need to be set to On to be in effect.\n        7. Click Create\n    NOTE: for more information regarding risk levels refer to Microsoft's Identity Protection & Risk Doc"},{"label":"rationale","data":"Turning on the sign-in risk policy ensures that suspicious sign-ins are challenged for\n        multi-factor authentication."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/howto-identity-protection-risk-feedback"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/concept-identity-protection-risks"}],"tags":{"severity":"medium","cis_controls":[{"8":["13.3"]},{"7":["16.13"]}],"nist":["SI-4","SI-4(4)"]},"code":"control 'microsoft-365-foundations-5.2.2.7' do\n  title 'Enable Azure AD Identity Protection sign-in risk policies'\n  desc 'Microsoft Entra ID Protection sign-in risk detects risks in real-time and offline. A risky sign-in is an indicator for a sign-in attempt that might not have been performed by the legitimate owner of a user account.\n        Note: While Identity Protection also provides two risk policies with limited conditions, Microsoft highly recommends setting up risk-based policies in Conditional Access as opposed to the \"legacy method\" for the following benefits:\n            • Enhanced diagnostic data\n            • Report-only mode integration\n            • Graph API support\n            • Use more Conditional Access attributes like sign-in frequency in the policy'\n\n  desc 'check',\n       \"To ensure Sign-In a risk policy is enabled:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Ensure that a policy exist with the following characteristics and is set to On:\n            o Under Users or workload identities choose All users\n            o Under Cloud apps or actions choose All cloud apps\n            o Under Conditions choose Sign-in risk then Yes ensuring High and Medium are selected.\n            o Under Access Controls select Grant then in the right pane click Grant access then select Require multifactor authentication.\n            o Under Session select Sign-in Frequency is set to Every time.\"\n\n  desc 'fix',\n       \"To configure a Sign-In risk policy, use the following steps:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Create a new policy by selecting New policy.\n        4. Set the following conditions within the policy.\n            o Under Users or workload identities choose All users\n            o Under Cloud apps or actions choose All cloud apps\n            o Under Conditions choose Sign-in risk then Yes and check the risk level boxes High and Medium\n            o Under Access Controls select Grant then in the right pane click Grant access then select Require multifactor authentication.\n            o Under Session select Sign-in Frequency and set to Every time.\n        5. Click Select\n        6. You may opt to begin in a state of Report Only as you step through implementation however, the policy will need to be set to On to be in effect.\n        7. Click Create\n    NOTE: for more information regarding risk levels refer to Microsoft's Identity Protection & Risk Doc\"\n\n  desc 'rationale',\n       'Turning on the sign-in risk policy ensures that suspicious sign-ins are challenged for\n        multi-factor authentication.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['13.3'] }, { '7' => ['16.13'] }]\n  tag nist: ['SI-4', 'SI-4(4)']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/howto-identity-protection-risk-feedback'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/concept-identity-protection-risks'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.2.2.7.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":5.0e-06,"start_time":"2024-09-24T15:49:05-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.2.2.8","title":"Ensure admin center access is limited to administrative roles","desc":"When a Conditional Access policy targets the Microsoft Admin Portals cloud app, the policy is enforced for tokens issued to application IDs of the following Microsoft administrative portals:\n            • Azure portal\n            • Exchange admin center\n            • Microsoft 365 admin center\n            • Microsoft 365 Defender portal\n            • Microsoft Entra admin center\n            • Microsoft Intune admin center\n            • Microsoft Purview compliance portal\n            • Power Platform admin center\n            • SharePoint admin center\n            • Microsoft Teams admin center\n        Microsoft Admin Portals should be restricted to specific pre-determined administrative roles.","descriptions":[{"label":"default","data":"When a Conditional Access policy targets the Microsoft Admin Portals cloud app, the policy is enforced for tokens issued to application IDs of the following Microsoft administrative portals:\n            • Azure portal\n            • Exchange admin center\n            • Microsoft 365 admin center\n            • Microsoft 365 Defender portal\n            • Microsoft Entra admin center\n            • Microsoft Intune admin center\n            • Microsoft Purview compliance portal\n            • Power Platform admin center\n            • SharePoint admin center\n            • Microsoft Teams admin center\n        Microsoft Admin Portals should be restricted to specific pre-determined administrative roles."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Inspect and identify existing policies for the parameters below:\n            o Users set to Include All Users\n            o Users > Exclude Verify Guest or external users and Users and groups contain only a group of PIM eligible users.\n            o Users > Exclude Verify Directory Roles only contains administrative roles. See below for details on roles.\n            o Target resources Cloud apps Includes Select apps Microsoft Admin Portals.\n            o Grant is equal to Block Access\n            o Enable policy is set to On\n        4. If any of these conditions are not met, then the audit fails.\n\n        In Directory roles > Exclude the role Global Administrator at a minimum should be selected to avoid I.T. being locked out. The organization should pre-determine roles in the exclusion list as there is not a one size fits all. Auditors and system administrators should exercise due diligence balancing operation while exercising least privilege. As the size of the organization increases so will the number of roles being utilized. A an example starting list of Administrator roles can be found under Additional Information\n        Note: In order for PIM to function a group of users eligible for PIM roles must be excluded from the policy.\n\n        Additional Information:\n\n        Below is an example list of Administrator roles that could be excluded\n            • Application administrator\n            • Authentication administrator\n            • Billing administrator\n            • Cloud application administrator\n            • Conditional Access administrator\n            • Exchange administrator\n            • Global administrator\n            • Global reader\n            • Helpdesk administrator\n            • Password administrator\n            • Privileged authentication administrator\n            • Privileged role administrator\n            • Security administrator\n            • SharePoint administrator\n            • User administrator"},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Click New Policy and then name the policy.\n        4. Select Users > Include > All Users\n        5. Select Users > Exclude > Directory roles and select only administrative roles and a group of PIM eligible users.\n        6. Select Target resources select Cloud apps > Select apps then select Microsoft Admin Portals on the right.\n        7. Confirm by clicking Select.\n        8. Select Grant > Block access and click Select.\n        9. Ensure Enable Policy is On or Report-only then click Create.\n    Warning: Exclude Global Administrator at a minimum to avoid being locked out. Report-only is a good option to use when testing any Conditional Access policy for the first time. Note: In order for PIM to function a group of users eligible for PIM roles must be excluded from the policy."},{"label":"rationale","data":"By default, users can sign into the various portals but are restricted by what they can\n        view. Blocking sign-in to Microsoft Admin Portals enhances security of sensitive data by\n        restricting access to privileged users. This mitigates potential exposure due to\n        administrative errors or software vulnerabilities introduced by a CSP, as well as acting\n        as a defense in depth measure against security breaches."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/entra/identity/conditional-access/concept-conditional-access-cloud-apps#microsoft-admin-portals"}],"tags":{"severity":"medium","cis_controls":[{"8":["untracked"]}],"default_value":"No - Non-administrators can access the Microsoft admin portals.","nist":["CM-6"]},"code":"control 'microsoft-365-foundations-5.2.2.8' do\n  title 'Ensure admin center access is limited to administrative roles'\n  desc \"When a Conditional Access policy targets the Microsoft Admin Portals cloud app, the policy is enforced for tokens issued to application IDs of the following Microsoft administrative portals:\n            • Azure portal\n            • Exchange admin center\n            • Microsoft 365 admin center\n            • Microsoft 365 Defender portal\n            • Microsoft Entra admin center\n            • Microsoft Intune admin center\n            • Microsoft Purview compliance portal\n            • Power Platform admin center\n            • SharePoint admin center\n            • Microsoft Teams admin center\n        Microsoft Admin Portals should be restricted to specific pre-determined administrative roles.\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Inspect and identify existing policies for the parameters below:\n            o Users set to Include All Users\n            o Users > Exclude Verify Guest or external users and Users and groups contain only a group of PIM eligible users.\n            o Users > Exclude Verify Directory Roles only contains administrative roles. See below for details on roles.\n            o Target resources Cloud apps Includes Select apps Microsoft Admin Portals.\n            o Grant is equal to Block Access\n            o Enable policy is set to On\n        4. If any of these conditions are not met, then the audit fails.\n\n        In Directory roles > Exclude the role Global Administrator at a minimum should be selected to avoid I.T. being locked out. The organization should pre-determine roles in the exclusion list as there is not a one size fits all. Auditors and system administrators should exercise due diligence balancing operation while exercising least privilege. As the size of the organization increases so will the number of roles being utilized. A an example starting list of Administrator roles can be found under Additional Information\n        Note: In order for PIM to function a group of users eligible for PIM roles must be excluded from the policy.\n\n        Additional Information:\n\n        Below is an example list of Administrator roles that could be excluded\n            • Application administrator\n            • Authentication administrator\n            • Billing administrator\n            • Cloud application administrator\n            • Conditional Access administrator\n            • Exchange administrator\n            • Global administrator\n            • Global reader\n            • Helpdesk administrator\n            • Password administrator\n            • Privileged authentication administrator\n            • Privileged role administrator\n            • Security administrator\n            • SharePoint administrator\n            • User administrator\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection > Conditional Access select Policies.\n        3. Click New Policy and then name the policy.\n        4. Select Users > Include > All Users\n        5. Select Users > Exclude > Directory roles and select only administrative roles and a group of PIM eligible users.\n        6. Select Target resources select Cloud apps > Select apps then select Microsoft Admin Portals on the right.\n        7. Confirm by clicking Select.\n        8. Select Grant > Block access and click Select.\n        9. Ensure Enable Policy is On or Report-only then click Create.\n    Warning: Exclude Global Administrator at a minimum to avoid being locked out. Report-only is a good option to use when testing any Conditional Access policy for the first time. Note: In order for PIM to function a group of users eligible for PIM roles must be excluded from the policy.\"\n\n  desc 'rationale',\n       'By default, users can sign into the various portals but are restricted by what they can\n        view. Blocking sign-in to Microsoft Admin Portals enhances security of sensitive data by\n        restricting access to privileged users. This mitigates potential exposure due to\n        administrative errors or software vulnerabilities introduced by a CSP, as well as acting\n        as a defense in depth measure against security breaches.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['untracked'] }]\n  tag default_value: 'No - Non-administrators can access the Microsoft admin portals.'\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-us/entra/identity/conditional-access/concept-conditional-access-cloud-apps#microsoft-admin-portals'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.2.2.8.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":4.0e-06,"start_time":"2024-09-24T15:49:05-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.2.3.1","title":"Ensure Microsoft Authenticator is configured to protect against MFA fatigue","desc":"Microsoft has released additional settings to enhance the configuration of the Microsoft Authenticator application. These settings provide additional information and context to users who receive MFA passwordless and push requests, such as geographic location the request came from, the requesting application and requiring a number match.\n        Ensure the following are Enabled.\n            • Require number matching for push notifications\n            • Show application name in push and passwordless notifications\n            • Show geographic location in push and passwordless notifications\n        NOTE: On February 27, 2023 Microsoft started enforcing number matching tenant-wide for all users using Microsoft Authenticator.","descriptions":[{"label":"default","data":"Microsoft has released additional settings to enhance the configuration of the Microsoft Authenticator application. These settings provide additional information and context to users who receive MFA passwordless and push requests, such as geographic location the request came from, the requesting application and requiring a number match.\n        Ensure the following are Enabled.\n            • Require number matching for push notifications\n            • Show application name in push and passwordless notifications\n            • Show geographic location in push and passwordless notifications\n        NOTE: On February 27, 2023 Microsoft started enforcing number matching tenant-wide for all users using Microsoft Authenticator."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click to expand Protection > Authentication methods select Policies.\n        3. Under Method select Microsoft Authenticator.\n        4. Under Enable and Target verify the setting is set to Enable.\n        5. In the Include tab ensure All users is selected.\n        6. In the Exclude tab ensure only valid groups are present (i.e. Break Glass accounts).\n        7. Select Configure\n        8. Verify the following Microsoft Authenticator settings:\n            o Require number matching for push notifications Status is set to Enabled, Target All users\n            o Show application name in push and passwordless notifications is set to Enabled, Target All users\n            o Show geographic location in push and passwordless notifications is set to Enabled, Target All users\n        9. In each setting select Exclude and verify only groups are present (i.e. Break Glass accounts)."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click to expand Protection > Authentication methods select Policies.\n        3. Select Microsoft Authenticator\n        4. Under Enable and Target ensure the setting is set to Enable.\n        5. Select Configure\n        6. Set the following Microsoft Authenticator settings:\n            o Require number matching for push notifications Status is set to Enabled, Target All users\n            o Show application name in push and passwordless notifications is set to Enabled, Target All users\n            o Show geographic location in push and passwordless notifications is set to Enabled, Target All users\n        Note: Valid groups such as break glass accounts can be excluded per organization policy."},{"label":"rationale","data":"As the use of strong authentication has become more widespread, attackers have\n        started to exploit the tendency of users to experience \"MFA fatigue.\" This occurs when\n        users are repeatedly asked to provide additional forms of identification, leading them to\n        eventually approve requests without fully verifying the source. To counteract this,\n        number matching can be employed to ensure the security of the authentication process.\n        With this method, users are prompted to confirm a number displayed on their original\n        device and enter it into the device being used for MFA. Additionally, other information\n        such as geolocation and application details are displayed to enhance the end user's\n        awareness. Among these 3 options, number matching provides the strongest net\n        security gain."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/authentication/concept-authentication-default-enablement"},{"ref":"https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/defend-your-users-from-mfa-fatigue-attacks/ba-p/2365677"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/authentication/how-to-mfa-number-match"}],"tags":{"severity":"medium","cis_controls":[{"8":["6.4"]}],"default_value":"Microsoft-managed","nist":["AC-19","IA-2(1)"]},"code":"control 'microsoft-365-foundations-5.2.3.1' do\n  title 'Ensure Microsoft Authenticator is configured to protect against MFA fatigue'\n  desc \"Microsoft has released additional settings to enhance the configuration of the Microsoft Authenticator application. These settings provide additional information and context to users who receive MFA passwordless and push requests, such as geographic location the request came from, the requesting application and requiring a number match.\n        Ensure the following are Enabled.\n            • Require number matching for push notifications\n            • Show application name in push and passwordless notifications\n            • Show geographic location in push and passwordless notifications\n        NOTE: On February 27, 2023 Microsoft started enforcing number matching tenant-wide for all users using Microsoft Authenticator.\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click to expand Protection > Authentication methods select Policies.\n        3. Under Method select Microsoft Authenticator.\n        4. Under Enable and Target verify the setting is set to Enable.\n        5. In the Include tab ensure All users is selected.\n        6. In the Exclude tab ensure only valid groups are present (i.e. Break Glass accounts).\n        7. Select Configure\n        8. Verify the following Microsoft Authenticator settings:\n            o Require number matching for push notifications Status is set to Enabled, Target All users\n            o Show application name in push and passwordless notifications is set to Enabled, Target All users\n            o Show geographic location in push and passwordless notifications is set to Enabled, Target All users\n        9. In each setting select Exclude and verify only groups are present (i.e. Break Glass accounts).\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click to expand Protection > Authentication methods select Policies.\n        3. Select Microsoft Authenticator\n        4. Under Enable and Target ensure the setting is set to Enable.\n        5. Select Configure\n        6. Set the following Microsoft Authenticator settings:\n            o Require number matching for push notifications Status is set to Enabled, Target All users\n            o Show application name in push and passwordless notifications is set to Enabled, Target All users\n            o Show geographic location in push and passwordless notifications is set to Enabled, Target All users\n        Note: Valid groups such as break glass accounts can be excluded per organization policy.\"\n\n  desc 'rationale',\n       \"As the use of strong authentication has become more widespread, attackers have\n        started to exploit the tendency of users to experience \\\"MFA fatigue.\\\" This occurs when\n        users are repeatedly asked to provide additional forms of identification, leading them to\n        eventually approve requests without fully verifying the source. To counteract this,\n        number matching can be employed to ensure the security of the authentication process.\n        With this method, users are prompted to confirm a number displayed on their original\n        device and enter it into the device being used for MFA. Additionally, other information\n        such as geolocation and application details are displayed to enhance the end user's\n        awareness. Among these 3 options, number matching provides the strongest net\n        security gain.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['6.4'] }]\n  tag default_value: 'Microsoft-managed'\n  tag nist: ['AC-19', 'IA-2(1)']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/authentication/concept-authentication-default-enablement'\n  ref 'https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/defend-your-users-from-mfa-fatigue-attacks/ba-p/2365677'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/authentication/how-to-mfa-number-match'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.2.3.1.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":5.0e-06,"start_time":"2024-09-24T15:49:05-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.2.3.2","title":"Ensure custom banned passwords lists are used","desc":"With Entra Password Protection, default global banned password lists are automatically applied to all users in an Entra ID tenant. To support business and security needs, custom banned password lists can be defined. When users change or reset their passwords, these banned password lists are checked to enforce the use of strong passwords.\n        A custom banned password list should include some of the following examples:\n            • Brand names\n            • Product names\n            • Locations, such as company headquarters\n            • Company-specific internal terms\n            • Abbreviations that have specific company meaning","descriptions":[{"label":"default","data":"With Entra Password Protection, default global banned password lists are automatically applied to all users in an Entra ID tenant. To support business and security needs, custom banned password lists can be defined. When users change or reset their passwords, these banned password lists are checked to enforce the use of strong passwords.\n        A custom banned password list should include some of the following examples:\n            • Brand names\n            • Product names\n            • Locations, such as company headquarters\n            • Company-specific internal terms\n            • Abbreviations that have specific company meaning"},{"label":"check","data":"Ensure a custom banned password list is in place:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Protection > Authentication methods\n        3. Select Password protection\n        4. Verify Enforce custom list is set to Yes\n        5. Verify Custom banned password list contains entries specific to the organization or matches a pre-determined list."},{"label":"fix","data":"Create a custom banned password list:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Protection > Authentication methods\n        3. Select Password protection\n        4. Set Enforce custom list to Yes\n        5. In Custom banned password list create a list using suggestions outlined in this document.\n        6. Click Save\n        NOTE: Below is a list of examples that can be used as a starting place. The references section contains more suggestions.\n        • Brand names\n        • Product names\n        • Locations, such as company headquarters\n        • Company-specific internal terms\n        • Abbreviations that have specific company meaning"},{"label":"rationale","data":"Creating a new password can be difficult regardless of one's technical background. It is\n        common to look around one's environment for suggestions when building a password,\n        however, this may include picking words specific to the organization as inspiration for a\n        password. An adversary may employ what is called a 'mangler' to create permutations\n        of these specific words in an attempt to crack passwords or hashes making it easier to\n        reach their goal."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/authentication/concept-password-ban-bad#custom-banned-password-list"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/authentication/tutorial-configure-custom-password-protection"}],"tags":{"severity":"medium","cis_controls":[{"8":["5.2"]}],"nist":["IA-5(1)"]},"code":"control 'microsoft-365-foundations-5.2.3.2' do\n  title 'Ensure custom banned passwords lists are used'\n  desc \"With Entra Password Protection, default global banned password lists are automatically applied to all users in an Entra ID tenant. To support business and security needs, custom banned password lists can be defined. When users change or reset their passwords, these banned password lists are checked to enforce the use of strong passwords.\n        A custom banned password list should include some of the following examples:\n            • Brand names\n            • Product names\n            • Locations, such as company headquarters\n            • Company-specific internal terms\n            • Abbreviations that have specific company meaning\"\n\n  desc 'check',\n       \"Ensure a custom banned password list is in place:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Protection > Authentication methods\n        3. Select Password protection\n        4. Verify Enforce custom list is set to Yes\n        5. Verify Custom banned password list contains entries specific to the organization or matches a pre-determined list.\"\n\n  desc 'fix',\n       \"Create a custom banned password list:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Protection > Authentication methods\n        3. Select Password protection\n        4. Set Enforce custom list to Yes\n        5. In Custom banned password list create a list using suggestions outlined in this document.\n        6. Click Save\n        NOTE: Below is a list of examples that can be used as a starting place. The references section contains more suggestions.\n        • Brand names\n        • Product names\n        • Locations, such as company headquarters\n        • Company-specific internal terms\n        • Abbreviations that have specific company meaning\"\n\n  desc 'rationale',\n       \"Creating a new password can be difficult regardless of one's technical background. It is\n        common to look around one's environment for suggestions when building a password,\n        however, this may include picking words specific to the organization as inspiration for a\n        password. An adversary may employ what is called a 'mangler' to create permutations\n        of these specific words in an attempt to crack passwords or hashes making it easier to\n        reach their goal.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['5.2'] }]\n  tag nist: ['IA-5(1)']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/authentication/concept-password-ban-bad#custom-banned-password-list'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/authentication/tutorial-configure-custom-password-protection'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.2.3.2.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":8.0e-06,"start_time":"2024-09-24T15:49:05-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.2.3.3","title":"Ensure password protection is enabled for on-prem Active Directory","desc":"Microsoft Entra Password Protection provides a global and custom banned password list. A password change request fails if there's a match in these banned password list. To protect on-premises Active Directory Domain Services (AD DS) environment, install and configure Entra Password Protection.\n        Note: This recommendation applies to Hybrid deployments only and will have no impact unless working with on-premises Active Directory.","descriptions":[{"label":"default","data":"Microsoft Entra Password Protection provides a global and custom banned password list. A password change request fails if there's a match in these banned password list. To protect on-premises Active Directory Domain Services (AD DS) environment, install and configure Entra Password Protection.\n        Note: This recommendation applies to Hybrid deployments only and will have no impact unless working with on-premises Active Directory."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Protection select Authentication methods.\n        3. Select Password protection and ensure that Enable password protection on Windows Server Active Directory is set to Yes and that Mode is set to Enforced."},{"label":"fix","data":"To remediate using the UI:\n        • Download and install the Azure AD Password Proxies and DC Agents from the following location: https://www.microsoft.com/download/details.aspx?id=57071 After installed follow the steps below.\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Protection select Authentication methods.\n        3. Select Password protection and set Enable password protection on Windows Server Active Directory to Yes and Mode to Enforced."},{"label":"rationale","data":"This feature protects an organization by prohibiting the use of weak or leaked\n        passwords. In addition, organizations can create custom banned password lists to\n        prevent their users from using easily guessed passwords that are specific to their\n        industry. Deploying this feature to Active Directory will strengthen the passwords that\n        are used in the environment."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/authentication/howto-password-ban-bad-on-premises-operations"}],"tags":{"severity":"medium","cis_controls":[{"8":["5.2"]},{"7":["4.4"]}],"default_value":"Enable - Yes\n                      Mode - Audit","nist":["IA-5(1)","CA-9","SC-7","SC-7(5)"]},"code":"control 'microsoft-365-foundations-5.2.3.3' do\n  title 'Ensure password protection is enabled for on-prem Active Directory'\n  desc \"Microsoft Entra Password Protection provides a global and custom banned password list. A password change request fails if there's a match in these banned password list. To protect on-premises Active Directory Domain Services (AD DS) environment, install and configure Entra Password Protection.\n        Note: This recommendation applies to Hybrid deployments only and will have no impact unless working with on-premises Active Directory.\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Protection select Authentication methods.\n        3. Select Password protection and ensure that Enable password protection on Windows Server Active Directory is set to Yes and that Mode is set to Enforced.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        • Download and install the Azure AD Password Proxies and DC Agents from the following location: https://www.microsoft.com/download/details.aspx?id=57071 After installed follow the steps below.\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Protection select Authentication methods.\n        3. Select Password protection and set Enable password protection on Windows Server Active Directory to Yes and Mode to Enforced.\"\n\n  desc 'rationale',\n       'This feature protects an organization by prohibiting the use of weak or leaked\n        passwords. In addition, organizations can create custom banned password lists to\n        prevent their users from using easily guessed passwords that are specific to their\n        industry. Deploying this feature to Active Directory will strengthen the passwords that\n        are used in the environment.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['5.2'] }, { '7' => ['4.4'] }]\n  tag default_value: 'Enable - Yes\n                      Mode - Audit'\n  tag nist: ['IA-5(1)', 'CA-9', 'SC-7', 'SC-7(5)']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/authentication/howto-password-ban-bad-on-premises-operations'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.2.3.3.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":8.0e-06,"start_time":"2024-09-24T15:49:05-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.2.3.4","title":"Ensure all member users are 'MFA capable'","desc":"Microsoft defines Multifactor authentication capable as being registered and enabled for a strong authentication method. The method must also be allowed by the authentication methods policy.\n        Ensure all member users are MFA capable.","descriptions":[{"label":"default","data":"Microsoft defines Multifactor authentication capable as being registered and enabled for a strong authentication method. The method must also be allowed by the authentication methods policy.\n        Ensure all member users are MFA capable."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Protection select Authentication methods.\n        3. Select User registration details.\n        4. Set the filter option Multifactor authentication capable to Not Capable.\n        5. Review the non-guest users in this list.\n        6. Excluding any exceptions users found in this report may require remediation.\n    To audit using PowerShell:\n        1. Connect to Graph using Connect-MgGraph -Scopes \"UserAuthenticationMethod.Read.All,AuditLog.Read.All\"\n        2. Run the following:\n            Get-MgReportAuthenticationMethodUserRegistrationDetail ` -Filter \"IsMfaCapable eq false and UserType eq 'Member'\" | ft UserPrincipalName,IsMfaCapable,IsAdmin\n        3. Ensure IsMfaCapable is set to True.\n        4. Excluding any exceptions users found in this report may require remediation.\n    Note: The CA rule must be in place for a successful deployment of Multifactor Authentication. This policy is outlined in the conditional access section 5.2.2\n    Note 2: Possible exceptions include on-premises synchronization accounts."},{"label":"fix","data":"Remediation steps will depend on the status of the personnel in question or configuration of Conditional Access policies and will not be covered in detail. Administrators should review each user identified on a case-by-case basis using the conditions below. User has never signed on:\n        • Employment status should be reviewed, and appropriate action taken on the user account's roles, licensing and enablement.\n    Conditional Access policy applicability:\n        • Ensure a CA policy is in place requiring all users to use MFA.\n        • Ensure the user is not excluded from the CA MFA policy.\n        • Ensure the policy's state is set to On.\n        • Use What if to determine applicable CA policies. (Protection > Conditional Access > Policies)\n        • Review the user account in Sign-in logs. Under the Activity Details pane click the Conditional Access tab to view applied policies.\n    Note: Conditional Access is covered step by step in section 5.2.2"},{"label":"rationale","data":"Multifactor authentication requires an individual to present a minimum of two separate\n        forms of authentication before access is granted.\n        Users who are not MFA Capable have never registered a strong authentication method\n        for multifactor authentication that is within policy and may not be using MFA. This could\n        be a result of having never signed in, exclusion from a Conditional Access (CA) policy\n        requiring MFA, or a CA policy does not exist. Reviewing this list of users will help\n        identify possible lapses in policy or procedure."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/powershell/module/microsoft.graph.reports/update-mgreportauthenticationmethoduserregistrationdetail?view=graph-powershell-1.0#-ismfacapable"},{"ref":"https://learn.microsoft.com/en-us/entra/identity/monitoring-health/how-to-view-applied-conditional-access-policies"},{"ref":"https://learn.microsoft.com/en-us/entra/identity/conditional-access/what-if-tool"},{"ref":"https://learn.microsoft.com/en-us/entra/identity/authentication/howto-authentication-methods-activity"}],"tags":{"severity":"medium","cis_controls":[{"8":["6.3"]},{"7":["16.3"]}],"nist":["IA-2(1)","IA-2(2)","SI-2"]},"code":"control 'microsoft-365-foundations-5.2.3.4' do\n  title \"Ensure all member users are 'MFA capable'\"\n  desc \"Microsoft defines Multifactor authentication capable as being registered and enabled for a strong authentication method. The method must also be allowed by the authentication methods policy.\n        Ensure all member users are MFA capable.\"\n\n  desc 'check',\n       'To audit using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Protection select Authentication methods.\n        3. Select User registration details.\n        4. Set the filter option Multifactor authentication capable to Not Capable.\n        5. Review the non-guest users in this list.\n        6. Excluding any exceptions users found in this report may require remediation.\n    To audit using PowerShell:\n        1. Connect to Graph using Connect-MgGraph -Scopes \"UserAuthenticationMethod.Read.All,AuditLog.Read.All\"\n        2. Run the following:\n            Get-MgReportAuthenticationMethodUserRegistrationDetail ` -Filter \"IsMfaCapable eq false and UserType eq \\'Member\\'\" | ft UserPrincipalName,IsMfaCapable,IsAdmin\n        3. Ensure IsMfaCapable is set to True.\n        4. Excluding any exceptions users found in this report may require remediation.\n    Note: The CA rule must be in place for a successful deployment of Multifactor Authentication. This policy is outlined in the conditional access section 5.2.2\n    Note 2: Possible exceptions include on-premises synchronization accounts.'\n\n  desc 'fix',\n       \"Remediation steps will depend on the status of the personnel in question or configuration of Conditional Access policies and will not be covered in detail. Administrators should review each user identified on a case-by-case basis using the conditions below. User has never signed on:\n        • Employment status should be reviewed, and appropriate action taken on the user account's roles, licensing and enablement.\n    Conditional Access policy applicability:\n        • Ensure a CA policy is in place requiring all users to use MFA.\n        • Ensure the user is not excluded from the CA MFA policy.\n        • Ensure the policy's state is set to On.\n        • Use What if to determine applicable CA policies. (Protection > Conditional Access > Policies)\n        • Review the user account in Sign-in logs. Under the Activity Details pane click the Conditional Access tab to view applied policies.\n    Note: Conditional Access is covered step by step in section 5.2.2\"\n\n  desc 'rationale',\n       'Multifactor authentication requires an individual to present a minimum of two separate\n        forms of authentication before access is granted.\n        Users who are not MFA Capable have never registered a strong authentication method\n        for multifactor authentication that is within policy and may not be using MFA. This could\n        be a result of having never signed in, exclusion from a Conditional Access (CA) policy\n        requiring MFA, or a CA policy does not exist. Reviewing this list of users will help\n        identify possible lapses in policy or procedure.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['6.3'] }, { '7' => ['16.3'] }]\n  tag nist: ['IA-2(1)', 'IA-2(2)', 'SI-2']\n\n  ref 'https://learn.microsoft.com/en-us/powershell/module/microsoft.graph.reports/update-mgreportauthenticationmethoduserregistrationdetail?view=graph-powershell-1.0#-ismfacapable'\n  ref 'https://learn.microsoft.com/en-us/entra/identity/monitoring-health/how-to-view-applied-conditional-access-policies'\n  ref 'https://learn.microsoft.com/en-us/entra/identity/conditional-access/what-if-tool'\n  ref 'https://learn.microsoft.com/en-us/entra/identity/authentication/howto-authentication-methods-activity'\n\n  ensure_member_users_mfa_capable_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}' #This should not be stored inside of any script; supplied to transmit detail\n    import-module microsoft.graph\n    $password = ConvertTo-SecureString -String $clientSecret -AsPlainText -Force\n    $ClientSecretCredential = New-Object -TypeName System.Management.Automation.PSCredential($client_id,$password)\n    Connect-MgGraph -TenantId \"$tenantid\" -ClientSecretCredential $ClientSecretCredential -NoWelcome\n    Connect-MgGraph -Scopes \"UserAuthenticationMethod.Read.All,AuditLog.Read.All\" -NoWelcome\n    $count = Get-MgReportAuthenticationMethodUserRegistrationDetail ` -Filter \"IsMfaCapable eq false and UserType eq 'Member'\" | Measure-Object\n    Write-Output $count.Count\n  }\n\n  powershell_output = powershell(ensure_member_users_mfa_capable_script)\n  describe 'Ensure count for IsMfaCapable equals false' do\n    subject { powershell_output.stdout.strip }\n    it 'should be 0 for all member users' do\n      expect(subject).to eq(0)\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.2.3.4.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure count for IsMfaCapable equals false should be 0 for all member users","run_time":140.691032,"start_time":"2024-09-24T15:49:05-04:00","message":"\nexpected: 0\n     got: \"119\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure count for IsMfaCapable equals false"}]},{"id":"microsoft-365-foundations-5.2.4.1","title":"Ensure 'Self service password reset enabled' is set to 'All'","desc":"Enabling self-service password reset allows users to reset their own passwords in Entra ID. When users sign in to Microsoft 365, they will be prompted to enter additional contact information that will help them reset their password in the future. If combined registration is enabled additional information, outside of multi-factor, will not be needed.\n        NOTE: Effective Oct. 1st, 2022, Microsoft will begin to enable combined registration for all users in Entra ID tenants created before August 15th, 2020. Tenants created after this date are enabled with combined registration by default.","descriptions":[{"label":"default","data":"Enabling self-service password reset allows users to reset their own passwords in Entra ID. When users sign in to Microsoft 365, they will be prompted to enter additional contact information that will help them reset their password in the future. If combined registration is enabled additional information, outside of multi-factor, will not be needed.\n        NOTE: Effective Oct. 1st, 2022, Microsoft will begin to enable combined registration for all users in Entra ID tenants created before August 15th, 2020. Tenants created after this date are enabled with combined registration by default."},{"label":"check","data":"Ensure self-service password reset is enabled:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Protection > Password reset select Properties.\n        3. Ensure Self service password reset enabled is set to All"},{"label":"fix","data":"To enable self-service password reset:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Protection > Password reset select Properties.\n        3. Set Self service password reset enabled to All"},{"label":"rationale","data":"Users will no longer need to engage the helpdesk for password resets, and the\n        password reset mechanism will automatically block common, easily guessable\n        passwords."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/admin/add-users/let-users-reset-passwords?view=o365-worldwide"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/authentication/tutorial-enable-sspr"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/authentication/howto-registration-mfa-sspr-combined"}],"tags":{"severity":"medium","cis_controls":[{"8":["untracked"]}],"nist":["CM-6"]},"code":"control 'microsoft-365-foundations-5.2.4.1' do\n  title \"Ensure 'Self service password reset enabled' is set to 'All'\"\n  desc \"Enabling self-service password reset allows users to reset their own passwords in Entra ID. When users sign in to Microsoft 365, they will be prompted to enter additional contact information that will help them reset their password in the future. If combined registration is enabled additional information, outside of multi-factor, will not be needed.\n        NOTE: Effective Oct. 1st, 2022, Microsoft will begin to enable combined registration for all users in Entra ID tenants created before August 15th, 2020. Tenants created after this date are enabled with combined registration by default.\"\n\n  desc 'check',\n       \"Ensure self-service password reset is enabled:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Protection > Password reset select Properties.\n        3. Ensure Self service password reset enabled is set to All\"\n\n  desc 'fix',\n       \"To enable self-service password reset:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Protection > Password reset select Properties.\n        3. Set Self service password reset enabled to All\"\n\n  desc 'rationale',\n       'Users will no longer need to engage the helpdesk for password resets, and the\n        password reset mechanism will automatically block common, easily guessable\n        passwords.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['untracked'] }]\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/admin/add-users/let-users-reset-passwords?view=o365-worldwide'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/authentication/tutorial-enable-sspr'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/authentication/howto-registration-mfa-sspr-combined'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.2.4.1.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":1.0e-05,"start_time":"2024-09-24T15:51:25-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.2.4.2","title":"Ensure the self-service password reset activity report is reviewed at least weekly","desc":"The Microsoft 365 platform allows users to reset their password in the event they forget it. The self-service password reset activity report logs each time a user successfully resets their password this way. The self-service password reset activity report should be reviewed at least weekly.","descriptions":[{"label":"default","data":"The Microsoft 365 platform allows users to reset their password in the event they forget it. The self-service password reset activity report logs each time a user successfully resets their password this way. The self-service password reset activity report should be reviewed at least weekly."},{"label":"check","data":"To verify the report is being reviewed at least weekly, confirm that the necessary procedures are in place and being followed."},{"label":"fix","data":"To review the self-service password reset activity report:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Protection > Password reset select Audit logs.\n        3. Review the list of users who have reset their passwords by setting the Date to Last 7 days and Service to Self-service Password Management"},{"label":"rationale","data":"An attacker will commonly compromise an account, then change the password to\n        something they control and can manage."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/authentication/howto-sspr-reporting"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/authentication/troubleshoot-sspr"}],"tags":{"severity":"medium","cis_controls":[{"8":["8.11"]},{"7":["6.2"]}],"nist":["AU-6","AU-6(1)","AU-7(1)","AC-1","AC-2","AC-2(1)"]},"code":"control 'microsoft-365-foundations-5.2.4.2' do\n  title 'Ensure the self-service password reset activity report is reviewed at least weekly'\n  desc 'The Microsoft 365 platform allows users to reset their password in the event they forget it. The self-service password reset activity report logs each time a user successfully resets their password this way. The self-service password reset activity report should be reviewed at least weekly.'\n\n  desc 'check',\n       'To verify the report is being reviewed at least weekly, confirm that the necessary procedures are in place and being followed.'\n\n  desc 'fix',\n       \"To review the self-service password reset activity report:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Protection > Password reset select Audit logs.\n        3. Review the list of users who have reset their passwords by setting the Date to Last 7 days and Service to Self-service Password Management\"\n\n  desc 'rationale',\n       'An attacker will commonly compromise an account, then change the password to\n        something they control and can manage.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['8.11'] }, { '7' => ['6.2'] }]\n  tag nist: ['AU-6', 'AU-6(1)', 'AU-7(1)', 'AC-1', 'AC-2', 'AC-2(1)']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/authentication/howto-sspr-reporting'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/authentication/troubleshoot-sspr'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.2.4.2.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":1.0e-05,"start_time":"2024-09-24T15:51:25-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.2.6.1","title":"Ensure the Azure AD 'Risky sign-ins' report is reviewed at least weekly","desc":"This report contains records of accounts that have had activity that could indicate they are compromised, such as accounts that have:\n        • Successfully signed in after multiple failures, which is an indication that the accounts have cracked passwords.\n        • Signed in to tenant from a client IP address that has been recognized by Microsoft as an anonymous proxy IP address (such as a TOR network).\n        • Successful sign-ins from users where two sign-ins appeared to originate from different regions and the time between sign-ins makes it impossible for the user to have traveled between those regions.","descriptions":[{"label":"default","data":"This report contains records of accounts that have had activity that could indicate they are compromised, such as accounts that have:\n        • Successfully signed in after multiple failures, which is an indication that the accounts have cracked passwords.\n        • Signed in to tenant from a client IP address that has been recognized by Microsoft as an anonymous proxy IP address (such as a TOR network).\n        • Successful sign-ins from users where two sign-ins appeared to originate from different regions and the time between sign-ins makes it impossible for the user to have traveled between those regions."},{"label":"check","data":"To verify the report is being reviewed at least weekly, confirm that the necessary procedures are in place and being followed."},{"label":"fix","data":"To review the 'Risky sign-ins' report:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection select Risky activities.\n        3. Under Report click on Risky sign-ins.\n        4. Review by Risk level (aggregate)."},{"label":"rationale","data":"Reviewing this report on a regular basis allows for identification and remediation of\n        compromised accounts."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/overview-identity-protection"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/howto-identity-protection-remediate-unblock"}],"tags":{"severity":"medium","cis_controls":[{"8":["8.11"]},{"7":["6.2"]}],"nist":["AU-6","AU-6(1)","AU-7(1)","AC-1","AC-2","AC-2(1)"]},"code":"control 'microsoft-365-foundations-5.2.6.1' do\n  title \"Ensure the Azure AD 'Risky sign-ins' report is reviewed at least weekly\"\n  desc \"This report contains records of accounts that have had activity that could indicate they are compromised, such as accounts that have:\n        • Successfully signed in after multiple failures, which is an indication that the accounts have cracked passwords.\n        • Signed in to tenant from a client IP address that has been recognized by Microsoft as an anonymous proxy IP address (such as a TOR network).\n        • Successful sign-ins from users where two sign-ins appeared to originate from different regions and the time between sign-ins makes it impossible for the user to have traveled between those regions.\"\n\n  desc 'check',\n       'To verify the report is being reviewed at least weekly, confirm that the necessary procedures are in place and being followed.'\n\n  desc 'fix',\n       \"To review the 'Risky sign-ins' report:\n        1. Navigate to the Microsoft Entra admin center https://entra.microsoft.com.\n        2. Click expand Protection select Risky activities.\n        3. Under Report click on Risky sign-ins.\n        4. Review by Risk level (aggregate).\"\n\n  desc 'rationale',\n       'Reviewing this report on a regular basis allows for identification and remediation of\n        compromised accounts.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['8.11'] }, { '7' => ['6.2'] }]\n  tag nist: ['AU-6', 'AU-6(1)', 'AU-7(1)', 'AC-1', 'AC-2', 'AC-2(1)']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/overview-identity-protection'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/howto-identity-protection-remediate-unblock'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.2.6.1.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":5.0e-06,"start_time":"2024-09-24T15:51:25-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.3.1","title":"Ensure 'Privileged Identity Management' is used to manage roles","desc":"Microsoft Entra Privileged Identity Management can be used to audit roles, allow just in time activation of roles and allow for periodic role attestation. Organizations should remove permanent members from privileged Office 365 roles and instead make them eligible, through a JIT activation workflow.","descriptions":[{"label":"default","data":"Microsoft Entra Privileged Identity Management can be used to audit roles, allow just in time activation of roles and allow for periodic role attestation. Organizations should remove permanent members from privileged Office 365 roles and instead make them eligible, through a JIT activation workflow."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity Governance select Privileged Identity Management.\n        3. Select Microsoft Entra Roles.\n        4. Select Roles beneath Manage.\n        5. Inspect at a minimum the following sensitive roles to ensure the members are Eligible and not Permanent:\n            Application Administrator\n            Authentication Administrator\n            Billing Administrator\n            Cloud Application Administrator\n            Cloud Device Administrator\n            Compliance Administrator\n            Customer LockBox Access Approver\n            Device Administrators\n            Exchange Administrators\n            Global Administrators\n            HelpDesk Administrator\n            Information Protection Administrator\n            Intune Service Administrator\n            Kaizala Administrator\n            License Administrator\n            Password Administrator\n            PowerBI Service Administrator\n            Privileged Authentication Administrator\n            Privileged Role Administrator\n            Security Administrator\n            SharePoint Service Administrator\n            Skype for Business Administrator\n            Teams Service Administrator\n            User Administrator"},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity Governance select Privileged Identity Management.\n        3. Select Microsoft Entra Roles.\n        4. Select Roles beneath Manage.\n        5. Inspect at a minimum the following sensitive roles. For each of the members that have an ASSIGNMENT TYPE of Permanent, click on the ... and choose Make eligible:\n            Application Administrator\n            Authentication Administrator\n            Billing Administrator\n            Cloud Application Administrator\n            Cloud Device Administrator\n            Compliance Administrator\n            Customer LockBox Access Approver\n            Device Administrators\n            Exchange Administrators\n            Global Administrators\n            HelpDesk Administrator\n            Information Protection Administrator\n            Intune Service Administrator\n            Kaizala Administrator\n            License Administrator\n            Password Administrator\n            PowerBI Service Administrator\n            Privileged Authentication Administrator\n            Privileged Role Administrator\n            Security Administrator\n            SharePoint Service Administrator\n            Skype for Business Administrator\n            Teams Service Administrator\n            User Administrator"},{"label":"rationale","data":"Organizations want to minimize the number of people who have access to secure\n        information or resources, because that reduces the chance of a malicious actor getting\n        that access, or an authorized user inadvertently impacting a sensitive resource.\n        However, users still need to carry out privileged operations in Entra ID. Organizations\n        can give users just-in-time (JIT) privileged access to roles. There is a need for oversight\n        for what those users are doing with their administrator privileges. PIM helps to mitigate\n        the risk of excessive, unnecessary, or misused access rights."}],"impact":0.5,"refs":[],"tags":{"severity":"medium","cis_controls":[{"8":["6.1"]},{"8":["6.2"]},{"7":["4.1"]}],"nist":["IA-4","IA-5","AC-1","AC-2","AC-2(1)","CM-1","CM-2","CM-6","CM-7","CM-7(1)","CM-9","SA-3","SA-8","SA-10"]},"code":"control 'microsoft-365-foundations-5.3.1' do\n  title \"Ensure 'Privileged Identity Management' is used to manage roles\"\n  desc 'Microsoft Entra Privileged Identity Management can be used to audit roles, allow just in time activation of roles and allow for periodic role attestation. Organizations should remove permanent members from privileged Office 365 roles and instead make them eligible, through a JIT activation workflow.'\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity Governance select Privileged Identity Management.\n        3. Select Microsoft Entra Roles.\n        4. Select Roles beneath Manage.\n        5. Inspect at a minimum the following sensitive roles to ensure the members are Eligible and not Permanent:\n            Application Administrator\n            Authentication Administrator\n            Billing Administrator\n            Cloud Application Administrator\n            Cloud Device Administrator\n            Compliance Administrator\n            Customer LockBox Access Approver\n            Device Administrators\n            Exchange Administrators\n            Global Administrators\n            HelpDesk Administrator\n            Information Protection Administrator\n            Intune Service Administrator\n            Kaizala Administrator\n            License Administrator\n            Password Administrator\n            PowerBI Service Administrator\n            Privileged Authentication Administrator\n            Privileged Role Administrator\n            Security Administrator\n            SharePoint Service Administrator\n            Skype for Business Administrator\n            Teams Service Administrator\n            User Administrator\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n        2. Click to expand Identity Governance select Privileged Identity Management.\n        3. Select Microsoft Entra Roles.\n        4. Select Roles beneath Manage.\n        5. Inspect at a minimum the following sensitive roles. For each of the members that have an ASSIGNMENT TYPE of Permanent, click on the ... and choose Make eligible:\n            Application Administrator\n            Authentication Administrator\n            Billing Administrator\n            Cloud Application Administrator\n            Cloud Device Administrator\n            Compliance Administrator\n            Customer LockBox Access Approver\n            Device Administrators\n            Exchange Administrators\n            Global Administrators\n            HelpDesk Administrator\n            Information Protection Administrator\n            Intune Service Administrator\n            Kaizala Administrator\n            License Administrator\n            Password Administrator\n            PowerBI Service Administrator\n            Privileged Authentication Administrator\n            Privileged Role Administrator\n            Security Administrator\n            SharePoint Service Administrator\n            Skype for Business Administrator\n            Teams Service Administrator\n            User Administrator\"\n\n  desc 'rationale',\n       'Organizations want to minimize the number of people who have access to secure\n        information or resources, because that reduces the chance of a malicious actor getting\n        that access, or an authorized user inadvertently impacting a sensitive resource.\n        However, users still need to carry out privileged operations in Entra ID. Organizations\n        can give users just-in-time (JIT) privileged access to roles. There is a need for oversight\n        for what those users are doing with their administrator privileges. PIM helps to mitigate\n        the risk of excessive, unnecessary, or misused access rights.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['6.1'] }, { '8' => ['6.2'] }, { '7' => ['4.1'] }]\n  tag nist: ['IA-4', 'IA-5', 'AC-1', 'AC-2', 'AC-2(1)', 'CM-1', 'CM-2', 'CM-6', 'CM-7', 'CM-7(1)', 'CM-9', 'SA-3', 'SA-8', 'SA-10']\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.3.1.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":4.0e-06,"start_time":"2024-09-24T15:51:25-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.3.2","title":"Ensure 'Access reviews' for Guest Users are configured","desc":"Access reviews enable administrators to establish an efficient automated process for reviewing group memberships, access to enterprise applications, and role assignments. These reviews can be scheduled to recur regularly, with flexible options for delegating the task of reviewing membership to different members of the organization.\n        Ensure Access reviews for Guest Users are configured to be performed no less frequently than monthly.","descriptions":[{"label":"default","data":"Access reviews enable administrators to establish an efficient automated process for reviewing group memberships, access to enterprise applications, and role assignments. These reviews can be scheduled to recur regularly, with flexible options for delegating the task of reviewing membership to different members of the organization.\n        Ensure Access reviews for Guest Users are configured to be performed no less frequently than monthly."},{"label":"check","data":"Verify an access review for Guest Users is in place:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Identity Governance and select Access reviews\n        3. Inspect the access reviews, and ensure an access review is created with the following criteria:\n            o Overview: Scope is set to Guest users only and status is Active\n            o Reviewers: Ensure appropriate reviewer(s) are designated.\n            o Settings > General: Mail notifications and Reminders are set to Enable\n            o Reviewers: Require reason on approval is set to Enable\n            o Scheduling: Frequency is Monthly or more frequent.\n            o When completed: Auto apply results to resource is set to Enable\n            o When completed: If reviewers don't respond is set to Remove access"},{"label":"fix","data":"Create an access review for Guest Users:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Identity Governance and select Access reviews\n        3. Click New access review.\n        4. Select what to review choose Teams + Groups.\n        5. Review Scope set to All Microsoft 365 groups with guest users, do not exclude groups.\n        6. Scope set to Guest users only then click Next: Reviews.\n        7. Select reviewers an appropriate user that is NOT the guest user themselves.\n        8. Duration (in days) at most 3.\n        9. Review recurrence is Monthly or more frequent.\n        10. End is set to Never, then click Next: Settings.\n        11. Check Auto apply results to resource.\n        12. Set If reviewers don't respond to Remove access.\n        13. Check the following: Justification required, E-mail notifications, Reminders.\n        14. Click Next: Review + Create and finally click Create."},{"label":"rationale","data":"Access to groups and applications for guests can change over time. If a guest user's\n        access to a particular folder goes unnoticed, they may unintentionally gain access to\n        sensitive data if a member adds new files or data to the folder or application. Access\n        reviews can help reduce the risks associated with outdated assignments by requiring a\n        member of the organization to conduct the reviews. Furthermore, these reviews can\n        enable a fail-closed mechanism to remove access to the subject if the reviewer does not\n        respond to the review."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/governance/create-access-review"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/governance/access-reviews-overview"}],"tags":{"severity":"medium","cis_controls":[{"8":["5.1"]},{"8":["5.3"]}],"default_value":"By default access reviews are not configured.","nist":["AC-2","AC-2(3)"]},"code":"control 'microsoft-365-foundations-5.3.2' do\n  title \"Ensure 'Access reviews' for Guest Users are configured\"\n  desc \"Access reviews enable administrators to establish an efficient automated process for reviewing group memberships, access to enterprise applications, and role assignments. These reviews can be scheduled to recur regularly, with flexible options for delegating the task of reviewing membership to different members of the organization.\n        Ensure Access reviews for Guest Users are configured to be performed no less frequently than monthly.\"\n\n  desc 'check',\n       \"Verify an access review for Guest Users is in place:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Identity Governance and select Access reviews\n        3. Inspect the access reviews, and ensure an access review is created with the following criteria:\n            o Overview: Scope is set to Guest users only and status is Active\n            o Reviewers: Ensure appropriate reviewer(s) are designated.\n            o Settings > General: Mail notifications and Reminders are set to Enable\n            o Reviewers: Require reason on approval is set to Enable\n            o Scheduling: Frequency is Monthly or more frequent.\n            o When completed: Auto apply results to resource is set to Enable\n            o When completed: If reviewers don't respond is set to Remove access\"\n\n  desc 'fix',\n       \"Create an access review for Guest Users:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Identity Governance and select Access reviews\n        3. Click New access review.\n        4. Select what to review choose Teams + Groups.\n        5. Review Scope set to All Microsoft 365 groups with guest users, do not exclude groups.\n        6. Scope set to Guest users only then click Next: Reviews.\n        7. Select reviewers an appropriate user that is NOT the guest user themselves.\n        8. Duration (in days) at most 3.\n        9. Review recurrence is Monthly or more frequent.\n        10. End is set to Never, then click Next: Settings.\n        11. Check Auto apply results to resource.\n        12. Set If reviewers don't respond to Remove access.\n        13. Check the following: Justification required, E-mail notifications, Reminders.\n        14. Click Next: Review + Create and finally click Create.\"\n\n  desc 'rationale',\n       \"Access to groups and applications for guests can change over time. If a guest user's\n        access to a particular folder goes unnoticed, they may unintentionally gain access to\n        sensitive data if a member adds new files or data to the folder or application. Access\n        reviews can help reduce the risks associated with outdated assignments by requiring a\n        member of the organization to conduct the reviews. Furthermore, these reviews can\n        enable a fail-closed mechanism to remove access to the subject if the reviewer does not\n        respond to the review.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['5.1'] }, { '8' => ['5.3'] }]\n  tag default_value: 'By default access reviews are not configured.'\n  tag nist: ['AC-2', 'AC-2(3)']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/governance/create-access-review'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/governance/access-reviews-overview'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.3.2.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":9.0e-06,"start_time":"2024-09-24T15:51:25-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-5.3.3","title":"Ensure 'Access reviews' for high privileged Azure AD roles are configured","desc":"Access reviews enable administrators to establish an efficient automated process for reviewing group memberships, access to enterprise applications, and role assignments. These reviews can be scheduled to recur regularly, with flexible options for delegating the task of reviewing membership to different members of the organization.\n        Ensure Access reviews for high privileged Entra ID roles are done no less frequently than weekly. These reviews should include at a minimum the roles listed below:\n            • Global Administrator\n            • Exchange Administrator\n            • SharePoint Administrator\n            • Teams Administrator\n            • Security Administrator\n        NOTE: An access review is created for each role selected after completing the process.","descriptions":[{"label":"default","data":"Access reviews enable administrators to establish an efficient automated process for reviewing group memberships, access to enterprise applications, and role assignments. These reviews can be scheduled to recur regularly, with flexible options for delegating the task of reviewing membership to different members of the organization.\n        Ensure Access reviews for high privileged Entra ID roles are done no less frequently than weekly. These reviews should include at a minimum the roles listed below:\n            • Global Administrator\n            • Exchange Administrator\n            • SharePoint Administrator\n            • Teams Administrator\n            • Security Administrator\n        NOTE: An access review is created for each role selected after completing the process."},{"label":"check","data":"Verify access reviews for high privileged roles is in place:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Identity Governance and select Privileged Identity Management\n        3. Select Microsoft Entra Roles under Manage\n        4. Select Access reviews\n        5. Ensure there are access reviews configured for each high privileged roles and each meets the criteria laid out below:\n            o Scope - Everyone\n            o Status - Active\n            o Reviewers - Role reviewers should be designated personnel. Preferably not a self-review.\n            o Mail notifications - Enable\n            o Reminders - Enable\n            o Require reason on approval - Enable\n            o Frequency - Monthly or more frequent\n            o Duration (in days) - 4 at most\n            o Auto apply results to resource - Enable\n            o If reviewers don't respond - No change\n        Any remaining settings are discretionary.\n        NOTE: Reviewers will have the ability to revoke roles should be trusted individuals who understand the impact of the access reviews. The principal of separation of duties should be considered so that no one administrator is reviewing their own access levels.\n        NOTE2: The setting If reviewers don't respond is recommended to be set to Remove access due to the potential of all Global Administrators being unassigned if the review is not addressed."},{"label":"fix","data":"Create an access review for high privileged roles:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Identity Governance and select Privileged Identity Management\n        3. Select Microsoft Entra Roles under Manage\n        4. Select Access reviews and click New access review.\n        5. Provide a name and description.\n        6. Frequency set to Weekly or more frequent.\n        7. Duration (in days) is set to at most 3.\n        8. End set to Never.\n        9. Role select these roles: Global Administrator,Exchange Administrator,SharePoint Administrator,Teams Administrator,Security Administrator\n        10. Assignment type set to All active and eligible assignments.\n        11. Reviewers set to Selected user(s) or group(s)\n        12. Select reviewers are member(s) responsible for this type of review.\n        13. Auto apply results to resource set to Enable\n        14. If reviewers don't respond is set to No change\n        15. Show recommendations set to Enable\n        16. Require reason or approval set to Enable\n        17. Mail notifications set to Enable\n        18. Reminders set to Enable\n        19. Click Start to save the review.\n    NOTE: Reviewers will have the ability to revoke roles should be trusted individuals who understand the impact of the access reviews. The principle of separation of duties should be considered so that no one administrator is reviewing their own access levels."},{"label":"rationale","data":"Regular review of critical high privileged roles in Entra ID will help identify role drift, or\n        potential malicious activity. This will enable the practice and application of \"separation of\n        duties\" where even non-privileged users like security auditors can be assigned to review\n        assigned roles in an organization. Furthermore, if configured these reviews can enable\n        a fail-closed mechanism to remove access to the subject if the reviewer does not\n        respond to the review."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/privileged-identity-management/pim-create-azure-ad-roles-and-resource-roles-review"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/governance/access-reviews-overview"}],"tags":{"severity":"medium","cis_controls":[{"8":["5.1"]},{"8":["5.3"]}],"default_value":"By default access reviews are not configured.","nist":["AC-2","AC-2(3)"]},"code":"control 'microsoft-365-foundations-5.3.3' do\n  title \"Ensure 'Access reviews' for high privileged Azure AD roles are configured\"\n  desc \"Access reviews enable administrators to establish an efficient automated process for reviewing group memberships, access to enterprise applications, and role assignments. These reviews can be scheduled to recur regularly, with flexible options for delegating the task of reviewing membership to different members of the organization.\n        Ensure Access reviews for high privileged Entra ID roles are done no less frequently than weekly. These reviews should include at a minimum the roles listed below:\n            • Global Administrator\n            • Exchange Administrator\n            • SharePoint Administrator\n            • Teams Administrator\n            • Security Administrator\n        NOTE: An access review is created for each role selected after completing the process.\"\n\n  desc 'check',\n       \"Verify access reviews for high privileged roles is in place:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Identity Governance and select Privileged Identity Management\n        3. Select Microsoft Entra Roles under Manage\n        4. Select Access reviews\n        5. Ensure there are access reviews configured for each high privileged roles and each meets the criteria laid out below:\n            o Scope - Everyone\n            o Status - Active\n            o Reviewers - Role reviewers should be designated personnel. Preferably not a self-review.\n            o Mail notifications - Enable\n            o Reminders - Enable\n            o Require reason on approval - Enable\n            o Frequency - Monthly or more frequent\n            o Duration (in days) - 4 at most\n            o Auto apply results to resource - Enable\n            o If reviewers don't respond - No change\n        Any remaining settings are discretionary.\n        NOTE: Reviewers will have the ability to revoke roles should be trusted individuals who understand the impact of the access reviews. The principal of separation of duties should be considered so that no one administrator is reviewing their own access levels.\n        NOTE2: The setting If reviewers don't respond is recommended to be set to Remove access due to the potential of all Global Administrators being unassigned if the review is not addressed.\"\n\n  desc 'fix',\n       \"Create an access review for high privileged roles:\n        1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/\n        2. Click to expand Identity Governance and select Privileged Identity Management\n        3. Select Microsoft Entra Roles under Manage\n        4. Select Access reviews and click New access review.\n        5. Provide a name and description.\n        6. Frequency set to Weekly or more frequent.\n        7. Duration (in days) is set to at most 3.\n        8. End set to Never.\n        9. Role select these roles: Global Administrator,Exchange Administrator,SharePoint Administrator,Teams Administrator,Security Administrator\n        10. Assignment type set to All active and eligible assignments.\n        11. Reviewers set to Selected user(s) or group(s)\n        12. Select reviewers are member(s) responsible for this type of review.\n        13. Auto apply results to resource set to Enable\n        14. If reviewers don't respond is set to No change\n        15. Show recommendations set to Enable\n        16. Require reason or approval set to Enable\n        17. Mail notifications set to Enable\n        18. Reminders set to Enable\n        19. Click Start to save the review.\n    NOTE: Reviewers will have the ability to revoke roles should be trusted individuals who understand the impact of the access reviews. The principle of separation of duties should be considered so that no one administrator is reviewing their own access levels.\"\n\n  desc 'rationale',\n       'Regular review of critical high privileged roles in Entra ID will help identify role drift, or\n        potential malicious activity. This will enable the practice and application of \"separation of\n        duties\" where even non-privileged users like security auditors can be assigned to review\n        assigned roles in an organization. Furthermore, if configured these reviews can enable\n        a fail-closed mechanism to remove access to the subject if the reviewer does not\n        respond to the review.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['5.1'] }, { '8' => ['5.3'] }]\n  tag default_value: 'By default access reviews are not configured.'\n  tag nist: ['AC-2', 'AC-2(3)']\n\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/privileged-identity-management/pim-create-azure-ad-roles-and-resource-roles-review'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/governance/access-reviews-overview'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-5.3.3.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":8.0e-06,"start_time":"2024-09-24T15:51:25-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-6.1.1","title":"Ensure 'AuditDisabled' organizationally is set to 'False'","desc":"The value False indicates that mailbox auditing on by default is turned on for the organization. Mailbox auditing on by default in the organization overrides the mailbox auditing settings on individual mailboxes. For example, if mailbox auditing is turned off for a mailbox (the AuditEnabled property on the mailbox is False), the default mailbox actions are still audited for the mailbox, because mailbox auditing on by default is turned on for the organization.\n        Turning off mailbox auditing on by default ($true) has the following results:\n            • Mailbox auditing is turned off for your organization.\n            • From the time you turn off mailbox auditing on by default, no mailbox actions are audited, even if mailbox auditing is enabled on a mailbox (the AuditEnabled property on the mailbox is True).\n            • Mailbox auditing isn't turned on for new mailboxes and setting the AuditEnabled property on a new or existing mailbox to True is ignored.\n            • Any mailbox audit bypass association settings (configured by using the Set-MailboxAuditBypassAssociation cmdlet) are ignored.\n            • Existing mailbox audit records are retained until the audit log age limit for the record expires.\n        The recommended state for this setting is False at the organization level. This will enable auditing and enforce the default.","descriptions":[{"label":"default","data":"The value False indicates that mailbox auditing on by default is turned on for the organization. Mailbox auditing on by default in the organization overrides the mailbox auditing settings on individual mailboxes. For example, if mailbox auditing is turned off for a mailbox (the AuditEnabled property on the mailbox is False), the default mailbox actions are still audited for the mailbox, because mailbox auditing on by default is turned on for the organization.\n        Turning off mailbox auditing on by default ($true) has the following results:\n            • Mailbox auditing is turned off for your organization.\n            • From the time you turn off mailbox auditing on by default, no mailbox actions are audited, even if mailbox auditing is enabled on a mailbox (the AuditEnabled property on the mailbox is True).\n            • Mailbox auditing isn't turned on for new mailboxes and setting the AuditEnabled property on a new or existing mailbox to True is ignored.\n            • Any mailbox audit bypass association settings (configured by using the Set-MailboxAuditBypassAssociation cmdlet) are ignored.\n            • Existing mailbox audit records are retained until the audit log age limit for the record expires.\n        The recommended state for this setting is False at the organization level. This will enable auditing and enforce the default."},{"label":"check","data":"Ensure mailbox auditing is enabled by default at the organizational level:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Get-OrganizationConfig | Format-List AuditDisabled\n        3. Ensure AuditDisabled is set to False."},{"label":"fix","data":"Enable mailbox auditing at the organizational level:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Set-OrganizationConfig -AuditDisabled $false"},{"label":"rationale","data":"Enforcing the default ensures auditing was not turned off intentionally or accidentally.\n        Auditing mailbox actions will allow forensics and IR teams to trace various malicious\n        activities that can generate TTPs caused by inbox access and tampering.\n        NOTE: Without advanced auditing (E5 function) the logs are limited to 90 days."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/compliance/audit-mailboxes?view=o365-worldwide"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/exchange/set-organizationconfig?view=exchange-ps#-auditdisabled"}],"tags":{"severity":"medium","cis_controls":[{"8":["8.2"]},{"7":["6.2"]}],"default_value":"False","nist":["AU-2","AU-7","AU-12","AC-1","AC-2","AC-2(1)"]},"code":"control 'microsoft-365-foundations-6.1.1' do\n  title \"Ensure 'AuditDisabled' organizationally is set to 'False'\"\n  desc \"The value False indicates that mailbox auditing on by default is turned on for the organization. Mailbox auditing on by default in the organization overrides the mailbox auditing settings on individual mailboxes. For example, if mailbox auditing is turned off for a mailbox (the AuditEnabled property on the mailbox is False), the default mailbox actions are still audited for the mailbox, because mailbox auditing on by default is turned on for the organization.\n        Turning off mailbox auditing on by default ($true) has the following results:\n            • Mailbox auditing is turned off for your organization.\n            • From the time you turn off mailbox auditing on by default, no mailbox actions are audited, even if mailbox auditing is enabled on a mailbox (the AuditEnabled property on the mailbox is True).\n            • Mailbox auditing isn't turned on for new mailboxes and setting the AuditEnabled property on a new or existing mailbox to True is ignored.\n            • Any mailbox audit bypass association settings (configured by using the Set-MailboxAuditBypassAssociation cmdlet) are ignored.\n            • Existing mailbox audit records are retained until the audit log age limit for the record expires.\n        The recommended state for this setting is False at the organization level. This will enable auditing and enforce the default.\"\n\n  desc 'check',\n       \"Ensure mailbox auditing is enabled by default at the organizational level:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Get-OrganizationConfig | Format-List AuditDisabled\n        3. Ensure AuditDisabled is set to False.\"\n\n  desc 'fix',\n       \"Enable mailbox auditing at the organizational level:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Set-OrganizationConfig -AuditDisabled $false\"\n\n  desc 'rationale',\n       'Enforcing the default ensures auditing was not turned off intentionally or accidentally.\n        Auditing mailbox actions will allow forensics and IR teams to trace various malicious\n        activities that can generate TTPs caused by inbox access and tampering.\n        NOTE: Without advanced auditing (E5 function) the logs are limited to 90 days.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['8.2'] }, { '7' => ['6.2'] }]\n  tag default_value: 'False'\n  tag nist: ['AU-2', 'AU-7', 'AU-12', 'AC-1', 'AC-2', 'AC-2(1)']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/compliance/audit-mailboxes?view=o365-worldwide'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/exchange/set-organizationconfig?view=exchange-ps#-auditdisabled'\n\n  ensure_auditdisabled_set_false_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    (Get-OrganizationConfig).AuditDisabled\n }\n\n  powershell_output = powershell(ensure_auditdisabled_set_false_script)\n  describe 'Ensure the AuditDisabled state from Get-OrganizationConfig' do\n    subject { powershell_output.stdout.strip }\n    it 'is set to False' do\n      expect(subject).to eq('False')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-6.1.1.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure the AuditDisabled state from Get-OrganizationConfig is set to False","run_time":7.49168,"start_time":"2024-09-24T15:51:25-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the AuditDisabled state from Get-OrganizationConfig"}]},{"id":"microsoft-365-foundations-6.1.2","title":"Ensure mailbox auditing for E3 users is Enabled","desc":"Mailbox audit logging is turned on by default in all organizations. This effort started in January 2019, and means that certain actions performed by mailbox owners, delegates, and admins are automatically logged. The corresponding mailbox audit records are available for admins to search in the mailbox audit log.\n        Mailboxes and shared mailboxes have actions assigned to them individually in order to audit the data the organization determines valuable at the mailbox level.\n        The recommended state is AuditEnabled to True on all user mailboxes along with additional audit actions beyond the Microsoft defaults.\n        Note: Due to some differences in defaults for audit actions this recommendation is specific to users assigned an E3 license only.","descriptions":[{"label":"default","data":"Mailbox audit logging is turned on by default in all organizations. This effort started in January 2019, and means that certain actions performed by mailbox owners, delegates, and admins are automatically logged. The corresponding mailbox audit records are available for admins to search in the mailbox audit log.\n        Mailboxes and shared mailboxes have actions assigned to them individually in order to audit the data the organization determines valuable at the mailbox level.\n        The recommended state is AuditEnabled to True on all user mailboxes along with additional audit actions beyond the Microsoft defaults.\n        Note: Due to some differences in defaults for audit actions this recommendation is specific to users assigned an E3 license only."},{"label":"check","data":"To manually verify mailbox auditing is enabled and configured for all mailboxes:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell script:\n            $MailAudit = Get-EXOMailbox -PropertySets Audit -ResultSize Unlimited | Select-Object UserPrincipalName, AuditEnabled, AuditAdmin, AuditDelegate, AuditOwner\n            $MailAudit | Export-Csv -Path C:\\CIS\\AuditSettings.csv -NoTypeInformation\n        3. Analyze the output and verify AuditEnabled is set to True and all audit actions are included in what is defined in the script in the remediation section.\n    Optionally, this more comprehensive script can assess each user mailbox:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following script:\n\n            $AdminActions = @( \"ApplyRecord\", \"Copy\", \"Create\", \"FolderBind\", \"HardDelete\", \"Move\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\"\n            )\n            DelegateActions = @( \"ApplyRecord\", \"Create\", \"FolderBind\", \"HardDelete\", \"Move\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"SoftDelete\", \"Update\", \"UpdateFolderPermissions\", \"UpdateInboxRules\"\n            )\n            $OwnerActions = @( \"ApplyRecord\", \"Create\", \"HardDelete\", \"MailboxLogin\", \"Move\", \"MoveToDeletedItems\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\"\n            )\n            function VerifyActions {\n                param ( [string]$type, [array]$actions, [array]$auditProperty, [string]$mailboxName\n                )\n                $missingActions = @()\n                $actionCount = 0\n                foreach ($action in $actions) {\n                    if ($auditProperty -notcontains $action) {\n                        $missingActions += \" Failure: Audit action '$action' missing from $type\"\n                        $actionCount++\n                    }\n                }\n                if ($actionCount -eq 0) {\n                    Write-Host \"[$mailboxName]: $type actions are verified.\" -ForegroundColor Green\n                }\n                else {\n                    Write-Host \"[$mailboxName]: $type actions are not all verified.\" -ForegroundColor Red\n                    foreach ($missingAction in $missingActions) {\n                        Write-Host \" $missingAction\" -ForegroundColor Red\n                    }\n                }\n            }\n            $mailboxes = Get-EXOMailbox -PropertySets Audit,Minimum -ResultSize Unlimited | Where-Object { $_.RecipientTypeDetails -eq \"UserMailbox\" }\n            foreach ($mailbox in $mailboxes) {\n                Write-Host \"--- Now assessing [$($mailbox.UserPrincipalName)] ---\"\n                if ($mailbox.AuditEnabled) {\n                    Write-Host \"[$($mailbox.UserPrincipalName)]: AuditEnabled is true\" -ForegroundColor Green\n                }\n                else {\n                    Write-Host \"[$($mailbox.UserPrincipalName)]: AuditEnabled is false\" -ForegroundColor Red\n                }\n                VerifyActions -type \"AuditAdmin\" -actions $AdminActions -auditProperty $mailbox.AuditAdmin ` -mailboxName $mailbox.UserPrincipalName\n                VerifyActions -type \"AuditDelegate\" -actions $DelegateActions -auditProperty $mailbox.AuditDelegate ` -mailboxName $mailbox.UserPrincipalName\n                VerifyActions -type \"AuditOwner\" -actions $OwnerActions -auditProperty $mailbox.AuditOwner ` -mailboxName $mailbox.UserPrincipalName\n                Write-Host\n            }"},{"label":"fix","data":"To enable mailbox auditing for all user mailboxes using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell script:\n            $AuditAdmin = @( \"ApplyRecord\", \"Copy\", \"Create\", \"FolderBind\", \"HardDelete\", \"Move\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n            $AuditDelegate = @( \"ApplyRecord\", \"Create\", \"FolderBind\", \"HardDelete\", \"Move\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"SoftDelete\", \"Update\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n            $AuditOwner = @( \"ApplyRecord\", \"Create\", \"HardDelete\", \"MailboxLogin\", \"Move\", \"MoveToDeletedItems\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n            $MBX = Get-EXOMailbox -ResultSize Unlimited | Where-Object { $_.RecipientTypeDetails -eq \"UserMailbox\" }\n            $MBX | Set-Mailbox -AuditEnabled $true ` -AuditLogAgeLimit 90 -AuditAdmin $AuditAdmin -AuditDelegate $AuditDelegate ` -AuditOwner $AuditOwner"},{"label":"rationale","data":"Whether it is for regulatory compliance or for tracking unauthorized configuration\n        changes in Microsoft 365, enabling mailbox auditing, and ensuring the proper mailbox\n        actions are accounted for allows for Microsoft 365 teams to run security operations,\n        forensics or general investigations on mailbox activities.\n        The following mailbox types ignore the organizational default and must have\n        AuditEnabled set to True at the mailbox level in order to capture relevant audit data.\n            • Resource Mailboxes\n            • Public Folder Mailboxes\n            • DiscoverySearch Mailbox\n        Note: Without advanced auditing (E5 function) the logs are limited to 90 days."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/compliance/audit-mailboxes?view=o365-worldwide"}],"tags":{"severity":"medium","cis_controls":[{"8":["8.2"]},{"7":["6.2"]}],"default_value":"AuditEnabled: True for all mailboxes except below:\n                        • Resource Mailboxes\n                        • Public Folder Mailboxes\n                        • DiscoverySearch Mailbox\n                    AuditAdmin: ApplyRecord, Create, HardDelete, MoveToDeletedItems, SendAs,\n                    SendOnBehalf, SoftDelete, Update, UpdateCalendarDelegation,\n                    UpdateFolderPermissions, UpdateInboxRules\n                    AuditDelegate: ApplyRecord, Create, HardDelete, MoveToDeletedItems, SendAs,\n                    SendOnBehalf, SoftDelete, Update, UpdateFolderPermissions, UpdateInboxRules\n                    AuditOwner: ApplyRecord, HardDelete, MoveToDeletedItems, SoftDelete, Update,\n                    UpdateCalendarDelegation, UpdateFolderPermissions, UpdateInboxRules","nist":["AU-2","AU-7","AU-12","AC-1","AC-2","AC-2(1)"]},"code":"control 'microsoft-365-foundations-6.1.2' do\n  title 'Ensure mailbox auditing for E3 users is Enabled'\n  desc \"Mailbox audit logging is turned on by default in all organizations. This effort started in January 2019, and means that certain actions performed by mailbox owners, delegates, and admins are automatically logged. The corresponding mailbox audit records are available for admins to search in the mailbox audit log.\n        Mailboxes and shared mailboxes have actions assigned to them individually in order to audit the data the organization determines valuable at the mailbox level.\n        The recommended state is AuditEnabled to True on all user mailboxes along with additional audit actions beyond the Microsoft defaults.\n        Note: Due to some differences in defaults for audit actions this recommendation is specific to users assigned an E3 license only.\"\n\n  desc 'check',\n       'To manually verify mailbox auditing is enabled and configured for all mailboxes:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell script:\n            $MailAudit = Get-EXOMailbox -PropertySets Audit -ResultSize Unlimited | Select-Object UserPrincipalName, AuditEnabled, AuditAdmin, AuditDelegate, AuditOwner\n            $MailAudit | Export-Csv -Path C:\\CIS\\AuditSettings.csv -NoTypeInformation\n        3. Analyze the output and verify AuditEnabled is set to True and all audit actions are included in what is defined in the script in the remediation section.\n    Optionally, this more comprehensive script can assess each user mailbox:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following script:\n\n            $AdminActions = @( \"ApplyRecord\", \"Copy\", \"Create\", \"FolderBind\", \"HardDelete\", \"Move\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\"\n            )\n            DelegateActions = @( \"ApplyRecord\", \"Create\", \"FolderBind\", \"HardDelete\", \"Move\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"SoftDelete\", \"Update\", \"UpdateFolderPermissions\", \"UpdateInboxRules\"\n            )\n            $OwnerActions = @( \"ApplyRecord\", \"Create\", \"HardDelete\", \"MailboxLogin\", \"Move\", \"MoveToDeletedItems\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\"\n            )\n            function VerifyActions {\n                param ( [string]$type, [array]$actions, [array]$auditProperty, [string]$mailboxName\n                )\n                $missingActions = @()\n                $actionCount = 0\n                foreach ($action in $actions) {\n                    if ($auditProperty -notcontains $action) {\n                        $missingActions += \" Failure: Audit action \\'$action\\' missing from $type\"\n                        $actionCount++\n                    }\n                }\n                if ($actionCount -eq 0) {\n                    Write-Host \"[$mailboxName]: $type actions are verified.\" -ForegroundColor Green\n                }\n                else {\n                    Write-Host \"[$mailboxName]: $type actions are not all verified.\" -ForegroundColor Red\n                    foreach ($missingAction in $missingActions) {\n                        Write-Host \" $missingAction\" -ForegroundColor Red\n                    }\n                }\n            }\n            $mailboxes = Get-EXOMailbox -PropertySets Audit,Minimum -ResultSize Unlimited | Where-Object { $_.RecipientTypeDetails -eq \"UserMailbox\" }\n            foreach ($mailbox in $mailboxes) {\n                Write-Host \"--- Now assessing [$($mailbox.UserPrincipalName)] ---\"\n                if ($mailbox.AuditEnabled) {\n                    Write-Host \"[$($mailbox.UserPrincipalName)]: AuditEnabled is true\" -ForegroundColor Green\n                }\n                else {\n                    Write-Host \"[$($mailbox.UserPrincipalName)]: AuditEnabled is false\" -ForegroundColor Red\n                }\n                VerifyActions -type \"AuditAdmin\" -actions $AdminActions -auditProperty $mailbox.AuditAdmin ` -mailboxName $mailbox.UserPrincipalName\n                VerifyActions -type \"AuditDelegate\" -actions $DelegateActions -auditProperty $mailbox.AuditDelegate ` -mailboxName $mailbox.UserPrincipalName\n                VerifyActions -type \"AuditOwner\" -actions $OwnerActions -auditProperty $mailbox.AuditOwner ` -mailboxName $mailbox.UserPrincipalName\n                Write-Host\n            }'\n  desc 'fix',\n       'To enable mailbox auditing for all user mailboxes using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell script:\n            $AuditAdmin = @( \"ApplyRecord\", \"Copy\", \"Create\", \"FolderBind\", \"HardDelete\", \"Move\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n            $AuditDelegate = @( \"ApplyRecord\", \"Create\", \"FolderBind\", \"HardDelete\", \"Move\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"SoftDelete\", \"Update\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n            $AuditOwner = @( \"ApplyRecord\", \"Create\", \"HardDelete\", \"MailboxLogin\", \"Move\", \"MoveToDeletedItems\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n            $MBX = Get-EXOMailbox -ResultSize Unlimited | Where-Object { $_.RecipientTypeDetails -eq \"UserMailbox\" }\n            $MBX | Set-Mailbox -AuditEnabled $true ` -AuditLogAgeLimit 90 -AuditAdmin $AuditAdmin -AuditDelegate $AuditDelegate ` -AuditOwner $AuditOwner'\n\n  desc 'rationale',\n       'Whether it is for regulatory compliance or for tracking unauthorized configuration\n        changes in Microsoft 365, enabling mailbox auditing, and ensuring the proper mailbox\n        actions are accounted for allows for Microsoft 365 teams to run security operations,\n        forensics or general investigations on mailbox activities.\n        The following mailbox types ignore the organizational default and must have\n        AuditEnabled set to True at the mailbox level in order to capture relevant audit data.\n            • Resource Mailboxes\n            • Public Folder Mailboxes\n            • DiscoverySearch Mailbox\n        Note: Without advanced auditing (E5 function) the logs are limited to 90 days.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['8.2'] }, { '7' => ['6.2'] }]\n  tag default_value: 'AuditEnabled: True for all mailboxes except below:\n                        • Resource Mailboxes\n                        • Public Folder Mailboxes\n                        • DiscoverySearch Mailbox\n                    AuditAdmin: ApplyRecord, Create, HardDelete, MoveToDeletedItems, SendAs,\n                    SendOnBehalf, SoftDelete, Update, UpdateCalendarDelegation,\n                    UpdateFolderPermissions, UpdateInboxRules\n                    AuditDelegate: ApplyRecord, Create, HardDelete, MoveToDeletedItems, SendAs,\n                    SendOnBehalf, SoftDelete, Update, UpdateFolderPermissions, UpdateInboxRules\n                    AuditOwner: ApplyRecord, HardDelete, MoveToDeletedItems, SoftDelete, Update,\n                    UpdateCalendarDelegation, UpdateFolderPermissions, UpdateInboxRules'\n  tag nist: ['AU-2', 'AU-7', 'AU-12', 'AC-1', 'AC-2', 'AC-2(1)']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/compliance/audit-mailboxes?view=o365-worldwide'\n\n  e3_user_mailbox_auditing_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    $AdminActions = @( \"ApplyRecord\", \"Copy\", \"Create\", \"FolderBind\", \"HardDelete\", \"Move\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n    $DelegateActions = @( \"ApplyRecord\", \"Create\", \"FolderBind\", \"HardDelete\", \"Move\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"SoftDelete\", \"Update\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n    $OwnerActions = @( \"ApplyRecord\", \"Create\", \"HardDelete\", \"MailboxLogin\", \"Move\", \"MoveToDeletedItems\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n\n    function VerifyActions {\n        param (\n            [string]$type,\n            [array]$actions,\n            [array]$auditProperty,\n            [string]$mailboxName\n        )\n        $missingActions = @()\n        $actionCount = 0\n        foreach ($action in $actions) {\n            if ($auditProperty -notcontains $action) {\n                $missingActions += \" Failure: Audit action '$action' missing from $type\"\n                $actionCount++\n            }\n        }\n        if ($actionCount -eq 0) {\n        } else {\n            Write-Host \"[$mailboxName]: $type actions are not all verified.\" -ForegroundColor Red\n            foreach ($missingAction in $missingActions) {\n                Write-Host \" $missingAction\" -ForegroundColor Red\n            }\n        }\n    }\n\n    $mailboxes = Get-EXOMailbox -PropertySets Audit,Minimum -ResultSize Unlimited | Where-Object { $_.RecipientTypeDetails -eq \"UserMailbox\" }\n    foreach ($mailbox in $mailboxes) {\n        if ($mailbox.AuditEnabled) {\n        } else {\n            Write-Host \"[$($mailbox.UserPrincipalName)]: AuditEnabled is false\" -ForegroundColor Red\n        }\n        VerifyActions -type \"AuditAdmin\" -actions $AdminActions -auditProperty $mailbox.AuditAdmin `\n            -mailboxName $mailbox.UserPrincipalName\n        VerifyActions -type \"AuditDelegate\" -actions $DelegateActions -auditProperty $mailbox.AuditDelegate `\n            -mailboxName $mailbox.UserPrincipalName\n        VerifyActions -type \"AuditOwner\" -actions $OwnerActions -auditProperty $mailbox.AuditOwner `\n            -mailboxName $mailbox.UserPrincipalName\n        Write-Host\n    }\n    }\n  powershell_output = powershell(e3_user_mailbox_auditing_script).stdout.strip\n  describe 'Ensure that Mailbox auditing for E3 users' do\n    subject { powershell_output }\n    it 'returns no actions needed from auditing' do\n      failure_message = \"The following mailboxes failed with the following issues: #{powershell_output.split(\"\\n\").join(',')}\"\n      expect(subject).to be_empty, failure_message\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-6.1.2.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure that Mailbox auditing for E3 users returns no actions needed from auditing","run_time":0.004998,"start_time":"2024-09-24T15:51:33-04:00","message":"The following mailboxes failed with the following issues: [sjaniak@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[sjaniak@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[sjaniak@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[rhochgraf@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[rhochgraf@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[rhochgraf@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[lavender@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[lavender@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[lavender@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[mhartley@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[mhartley@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[mhartley@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[vmartzahl@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[vmartzahl@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[vmartzahl@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[azaini@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[azaini@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[azaini@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dpoltar@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dpoltar@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dpoltar@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jflorie@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jflorie@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jflorie@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[mgeiser@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[mgeiser@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[mgeiser@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[tscholfield@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[tscholfield@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[tscholfield@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[iprusky@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[iprusky@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[iprusky@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[rteague@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[rteague@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[rteague@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dweiss@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dweiss@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dweiss@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[SLITTLEHALE@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[SLITTLEHALE@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[SLITTLEHALE@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[ldebellis@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[ldebellis@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[ldebellis@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jhiggins@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jhiggins@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jhiggins@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dzic@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dzic@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dzic@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[rnovak@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[rnovak@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[rnovak@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[psorenson@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[psorenson@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[psorenson@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[bbascom@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[bbascom@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[bbascom@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[nwill@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[nwill@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[nwill@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[cbarlow@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[cbarlow@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[cbarlow@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[mdube@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[mdube@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[mdube@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[mmoulton@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[mmoulton@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[mmoulton@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[adost@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[adost@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[adost@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[acoursen@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[acoursen@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[acoursen@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[gmorgan@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[gmorgan@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[gmorgan@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[amukherjee@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[amukherjee@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[amukherjee@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[rchaudhry@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[rchaudhry@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[rchaudhry@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[mitreatworkdev@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[mitreatworkdev@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[mitreatworkdev@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[eddiep@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[eddiep@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[eddiep@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[bamado@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[bamado@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[bamado@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jbaskerville@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jbaskerville@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jbaskerville@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[odennehy@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[odennehy@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[odennehy@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[cristinaoh@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[cristinaoh@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[cristinaoh@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[njtestuser@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[njtestuser@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[njtestuser@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[efaulder@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[efaulder@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[efaulder@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[tririgasa@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[tririgasa@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[tririgasa@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[abuehne@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[abuehne@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[abuehne@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[lebrandt@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[lebrandt@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[lebrandt@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jhall@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jhall@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jhall@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dcuomo@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dcuomo@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dcuomo@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[acleavenger@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[acleavenger@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[acleavenger@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jschommer@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jschommer@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jschommer@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[gkuhn@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[gkuhn@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[gkuhn@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[gcase@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[gcase@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[gcase@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[ltiv@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[ltiv@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[ltiv@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[lfinn@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[lfinn@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[lfinn@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[scolangelo@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[scolangelo@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[scolangelo@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[tlee@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[tlee@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[tlee@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dtkim@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dtkim@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dtkim@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[zrobin@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[zrobin@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[zrobin@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dvitenko@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dvitenko@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dvitenko@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[chad@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[chad@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[chad@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[pverrill@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[pverrill@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[pverrill@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[narcaro@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[narcaro@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[narcaro@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[kcigler@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[kcigler@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[kcigler@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[roliver@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[roliver@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[roliver@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[catorre@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[catorre@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[catorre@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[lmavroudakis@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[lmavroudakis@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[lmavroudakis@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[nspatel@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[nspatel@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[nspatel@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[userglazarte@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[userglazarte@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[userglazarte@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jseifert@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jseifert@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jseifert@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[aabramkin@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[aabramkin@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[aabramkin@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[igross@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[igross@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[igross@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[alopez@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[alopez@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[alopez@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[asalah@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[asalah@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[asalah@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[prajaram@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[prajaram@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[prajaram@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[wgabree@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[wgabree@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[wgabree@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[sudakar@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[sudakar@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[sudakar@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[nforleo@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[nforleo@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[nforleo@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[abouffard@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[abouffard@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[abouffard@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[bpalumbo@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[bpalumbo@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[bpalumbo@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[imatthews@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[imatthews@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[imatthews@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[csl_phonebooth@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[csl_phonebooth@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[csl_phonebooth@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[damirault@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[damirault@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[damirault@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[npando@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[npando@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[npando@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dshackley@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dshackley@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dshackley@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dproulx@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dproulx@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dproulx@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[eclough@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[eclough@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[eclough@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[nbos@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[nbos@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[nbos@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[cschlick@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[cschlick@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[cschlick@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[secooper@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[secooper@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[secooper@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[cchang@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[cchang@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[cchang@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[eschermerhorn@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[eschermerhorn@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[eschermerhorn@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[P860_dev@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[P860_dev@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[P860_dev@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[sburgoyne@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[sburgoyne@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[sburgoyne@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[mitreatworkint@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[mitreatworkint@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[mitreatworkint@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jplopez@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jplopez@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jplopez@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[karacm@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[karacm@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[karacm@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jcmoore@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jcmoore@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jcmoore@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dweinman@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dweinman@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dweinman@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[nima@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[nima@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[nima@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[glading@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[glading@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[glading@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[efinney@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[efinney@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[efinney@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[cenkl@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[cenkl@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[cenkl@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[atanoor@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[atanoor@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[atanoor@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[gshieh@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[gshieh@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[gshieh@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[gpasku@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[gpasku@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[gpasku@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[vjamba@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[vjamba@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[vjamba@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[drozdetski@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[drozdetski@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[drozdetski@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dsarkhel@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dsarkhel@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dsarkhel@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[bdowney@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[bdowney@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[bdowney@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jma@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jma@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jma@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[fcriscione@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[fcriscione@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[fcriscione@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[ecottom@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[ecottom@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[ecottom@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[forbes@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[forbes@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[forbes@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[glazarte@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[glazarte@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[glazarte@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[iwright@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[iwright@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[iwright@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jcsganga@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jcsganga@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jcsganga@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[junger@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[junger@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[junger@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[kferrante@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[kferrante@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[kferrante@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[mcannava@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[mcannava@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[mcannava@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[marianne@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[marianne@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[marianne@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[mmamo@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[mmamo@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[mmamo@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[mrodrigues@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[mrodrigues@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[mrodrigues@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[nguyenm@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[nguyenm@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[nguyenm@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[njacobs@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[njacobs@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[njacobs@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[nkatikaneni@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[nkatikaneni@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[nkatikaneni@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[phebenstreit@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[phebenstreit@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[phebenstreit@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[rrawal@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[rrawal@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[rrawal@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[rwolfe@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[rwolfe@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[rwolfe@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[sbarber@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[sbarber@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[sbarber@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[scbrown@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[scbrown@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[scbrown@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[spandolfi@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[spandolfi@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[spandolfi@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that Mailbox auditing for E3 users"}]},{"id":"microsoft-365-foundations-6.1.3","title":"Ensure mailbox auditing for E5 users is Enabled","desc":"Mailbox audit logging is turned on by default in all organizations. This effort started in January 2019, and means that certain actions performed by mailbox owners, delegates, and admins are automatically logged. The corresponding mailbox audit records are available for admins to search in the mailbox audit log.\n        Mailboxes and shared mailboxes have actions assigned to them individually in order to audit the data the organization determines valuable at the mailbox level.\n        The recommended state is AuditEnabled to True on all user mailboxes along with additional audit actions beyond the Microsoft defaults.\n        Note: Due to some differences in defaults for audit actions this recommendation is specific to users assigned an E5 license, or auditing addon license, only.","descriptions":[{"label":"default","data":"Mailbox audit logging is turned on by default in all organizations. This effort started in January 2019, and means that certain actions performed by mailbox owners, delegates, and admins are automatically logged. The corresponding mailbox audit records are available for admins to search in the mailbox audit log.\n        Mailboxes and shared mailboxes have actions assigned to them individually in order to audit the data the organization determines valuable at the mailbox level.\n        The recommended state is AuditEnabled to True on all user mailboxes along with additional audit actions beyond the Microsoft defaults.\n        Note: Due to some differences in defaults for audit actions this recommendation is specific to users assigned an E5 license, or auditing addon license, only."},{"label":"check","data":"To manually verify mailbox auditing is enabled and configured for all mailboxes:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell script: $MailAudit = Get-EXOMailbox -PropertySets Audit -ResultSize Unlimited | Select-Object UserPrincipalName, AuditEnabled, AuditAdmin, AuditDelegate, AuditOwner $MailAudit | Export-Csv -Path C:\\CIS\\AuditSettings.csv -NoTypeInformation\n        3. Analyze the output and verify AuditEnabled is set to True and all audit actions are included in what is defined in the script in the remediation section.\n    Optionally, this more comprehensive script can assess each user mailbox:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following script:\n\n            $AdminActions = @( \"ApplyRecord\", \"Copy\", \"Create\", \"FolderBind\", \"HardDelete\", \"MailItemsAccessed\", \"Move\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"Send\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n            $DelegateActions = @( \"ApplyRecord\", \"Create\", \"FolderBind\", \"HardDelete\", \"Move\", \"MailItemsAccessed\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"SoftDelete\", \"Update\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n            $OwnerActions = @( \"ApplyRecord\", \"Create\", \"HardDelete\", \"MailboxLogin\", \"Move\", \"MailItemsAccessed\", \"MoveToDeletedItems\", \"Send\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n            function VerifyActions {\n                param ( [string]$type, [array]$actions, [array]$auditProperty, [string]$mailboxName )\n                $missingActions = @()\n                $actionCount = 0\n                foreach ($action in $actions) {\n                    if ($auditProperty -notcontains $action) {\n                        $missingActions += \" Failure: Audit action '$action' missing from $type\"\n                        $actionCount++\n                    }\n                }\n                if ($actionCount -eq 0) {\n                    Write-Host \"[$mailboxName]: $type actions are verified.\" -ForegroundColor Green\n                }\n                else {\n                    Write-Host \"[$mailboxName]: $type actions are not all verified.\" -ForegroundColor Red\n                    foreach ($missingAction in $missingActions) {\n                        Write-Host \" $missingAction\" -ForegroundColor Red\n                    }\n                }\n            }\n            $mailboxes = Get-EXOMailbox -PropertySets Audit,Minimum -ResultSize Unlimited | Where-Object { $_.RecipientTypeDetails -eq \"UserMailbox\" }\n            foreach ($mailbox in $mailboxes) {\n                Write-Host \"--- Now assessing [$($mailbox.UserPrincipalName)] ---\"\n                if ($mailbox.AuditEnabled) {\n                    Write-Host \"[$($mailbox.UserPrincipalName)]: AuditEnabled is true\" -ForegroundColor Green\n                }\n                else {\n                    Write-Host \"[$($mailbox.UserPrincipalName)]: AuditEnabled is false\" -ForegroundColor Red\n                }\n                VerifyActions -type \"AuditAdmin\" -actions $AdminActions -auditProperty $mailbox.AuditAdmin ` -mailboxName $mailbox.UserPrincipalName\n                VerifyActions -type \"AuditDelegate\" -actions $DelegateActions -auditProperty $mailbox.AuditDelegate ` -mailboxName $mailbox.UserPrincipalName\n                VerifyActions -type \"AuditOwner\" -actions $OwnerActions -auditProperty $mailbox.AuditOwner ` -mailboxName $mailbox.UserPrincipalName\n                Write-Host\n            }\n    Note: In order for a mailbox to pass the above it must have an E5 or Microsoft Purview Audit Premium addon license assigned to it. For the purposes of this recommendation shared mailboxes are ignored"},{"label":"fix","data":"To enable mailbox auditing for all user mailboxes using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell script:\n            $AuditAdmin = @( \"ApplyRecord\", \"Copy\", \"Create\", \"FolderBind\", \"HardDelete\", \"MailItemsAccessed\", \"Move\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"Send\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n            $AuditDelegate = @( \"ApplyRecord\", \"Create\", \"FolderBind\", \"HardDelete\", \"Move\", \"MailItemsAccessed\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"SoftDelete\", \"Update\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n            $AuditOwner = @( \"ApplyRecord\", \"Create\", \"HardDelete\", \"MailboxLogin\", \"Move\", \"MailItemsAccessed\", \"MoveToDeletedItems\", \"Send\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n            $MBX = Get-EXOMailbox -ResultSize Unlimited | Where-Object { $_.RecipientTypeDetails -eq \"UserMailbox\" }\n            $MBX | Set-Mailbox -AuditEnabled $true ` -AuditLogAgeLimit 180 -AuditAdmin $AuditAdmin -AuditDelegate $AuditDelegate ` -AuditOwner $AuditOwner\n    Note: When running this script mailboxes without an E5 or Azure Audit Premium license applied will generate an error as they are not licensed for the additional actions which come default with E5."},{"label":"rationale","data":"Whether it is for regulatory compliance or for tracking unauthorized configuration\n        changes in Microsoft 365, enabling mailbox auditing and ensuring the proper mailbox\n        actions are accounted for allows for Microsoft 365 teams to run security operations,\n        forensics or general investigations on mailbox activities.\n        The following mailbox types ignore the organizational default and must have\n        AuditEnabled set to True at the mailbox level in order to capture relevant audit data.\n            • Resource Mailboxes\n            • Public Folder Mailboxes\n            • DiscoverySearch Mailbox\n        NOTE: Without advanced auditing (E5 function) the logs are limited to 90 days."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/compliance/audit-mailboxes?view=o365-worldwide"}],"tags":{"severity":"medium","cis_controls":[{"8":["8.2"]},{"7":["6.2"]}],"default_value":"AuditEnabled: True for all mailboxes except below:\n                        • Resource Mailboxes\n                        • Public Folder Mailboxes\n                        • DiscoverySearch Mailbox\n                    AuditAdmin: ApplyRecord, Create, HardDelete, MailItemsAccessed,\n                    MoveToDeletedItems, Send, SendAs, SendOnBehalf, SoftDelete, Update,\n                    UpdateCalendarDelegation, UpdateFolderPermissions, UpdateInboxRules\n                    AuditDelegate: ApplyRecord, Create, HardDelete, MailItemsAccessed,\n                    MoveToDeletedItems, SendAs, SendOnBehalf, SoftDelete, Update,\n                    UpdateFolderPermissions, UpdateInboxRules\n                    AuditOwner: ApplyRecord, HardDelete, MailItemsAccessed, MoveToDeletedItems,\n                    Send, SoftDelete, Update, UpdateCalendarDelegation, UpdateFolderPermissions,\n                    UpdateInboxRules","nist":["AU-2","AU-7","AU-12","AC-1","AC-2","AC-2(1)"]},"code":"control 'microsoft-365-foundations-6.1.3' do\n  title 'Ensure mailbox auditing for E5 users is Enabled'\n  desc \"Mailbox audit logging is turned on by default in all organizations. This effort started in January 2019, and means that certain actions performed by mailbox owners, delegates, and admins are automatically logged. The corresponding mailbox audit records are available for admins to search in the mailbox audit log.\n        Mailboxes and shared mailboxes have actions assigned to them individually in order to audit the data the organization determines valuable at the mailbox level.\n        The recommended state is AuditEnabled to True on all user mailboxes along with additional audit actions beyond the Microsoft defaults.\n        Note: Due to some differences in defaults for audit actions this recommendation is specific to users assigned an E5 license, or auditing addon license, only.\"\n\n  desc 'check',\n       'To manually verify mailbox auditing is enabled and configured for all mailboxes:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell script: $MailAudit = Get-EXOMailbox -PropertySets Audit -ResultSize Unlimited | Select-Object UserPrincipalName, AuditEnabled, AuditAdmin, AuditDelegate, AuditOwner $MailAudit | Export-Csv -Path C:\\CIS\\AuditSettings.csv -NoTypeInformation\n        3. Analyze the output and verify AuditEnabled is set to True and all audit actions are included in what is defined in the script in the remediation section.\n    Optionally, this more comprehensive script can assess each user mailbox:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following script:\n\n            $AdminActions = @( \"ApplyRecord\", \"Copy\", \"Create\", \"FolderBind\", \"HardDelete\", \"MailItemsAccessed\", \"Move\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"Send\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n            $DelegateActions = @( \"ApplyRecord\", \"Create\", \"FolderBind\", \"HardDelete\", \"Move\", \"MailItemsAccessed\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"SoftDelete\", \"Update\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n            $OwnerActions = @( \"ApplyRecord\", \"Create\", \"HardDelete\", \"MailboxLogin\", \"Move\", \"MailItemsAccessed\", \"MoveToDeletedItems\", \"Send\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n            function VerifyActions {\n                param ( [string]$type, [array]$actions, [array]$auditProperty, [string]$mailboxName )\n                $missingActions = @()\n                $actionCount = 0\n                foreach ($action in $actions) {\n                    if ($auditProperty -notcontains $action) {\n                        $missingActions += \" Failure: Audit action \\'$action\\' missing from $type\"\n                        $actionCount++\n                    }\n                }\n                if ($actionCount -eq 0) {\n                    Write-Host \"[$mailboxName]: $type actions are verified.\" -ForegroundColor Green\n                }\n                else {\n                    Write-Host \"[$mailboxName]: $type actions are not all verified.\" -ForegroundColor Red\n                    foreach ($missingAction in $missingActions) {\n                        Write-Host \" $missingAction\" -ForegroundColor Red\n                    }\n                }\n            }\n            $mailboxes = Get-EXOMailbox -PropertySets Audit,Minimum -ResultSize Unlimited | Where-Object { $_.RecipientTypeDetails -eq \"UserMailbox\" }\n            foreach ($mailbox in $mailboxes) {\n                Write-Host \"--- Now assessing [$($mailbox.UserPrincipalName)] ---\"\n                if ($mailbox.AuditEnabled) {\n                    Write-Host \"[$($mailbox.UserPrincipalName)]: AuditEnabled is true\" -ForegroundColor Green\n                }\n                else {\n                    Write-Host \"[$($mailbox.UserPrincipalName)]: AuditEnabled is false\" -ForegroundColor Red\n                }\n                VerifyActions -type \"AuditAdmin\" -actions $AdminActions -auditProperty $mailbox.AuditAdmin ` -mailboxName $mailbox.UserPrincipalName\n                VerifyActions -type \"AuditDelegate\" -actions $DelegateActions -auditProperty $mailbox.AuditDelegate ` -mailboxName $mailbox.UserPrincipalName\n                VerifyActions -type \"AuditOwner\" -actions $OwnerActions -auditProperty $mailbox.AuditOwner ` -mailboxName $mailbox.UserPrincipalName\n                Write-Host\n            }\n    Note: In order for a mailbox to pass the above it must have an E5 or Microsoft Purview Audit Premium addon license assigned to it. For the purposes of this recommendation shared mailboxes are ignored'\n\n  desc 'fix',\n       'To enable mailbox auditing for all user mailboxes using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell script:\n            $AuditAdmin = @( \"ApplyRecord\", \"Copy\", \"Create\", \"FolderBind\", \"HardDelete\", \"MailItemsAccessed\", \"Move\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"Send\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n            $AuditDelegate = @( \"ApplyRecord\", \"Create\", \"FolderBind\", \"HardDelete\", \"Move\", \"MailItemsAccessed\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"SoftDelete\", \"Update\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n            $AuditOwner = @( \"ApplyRecord\", \"Create\", \"HardDelete\", \"MailboxLogin\", \"Move\", \"MailItemsAccessed\", \"MoveToDeletedItems\", \"Send\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n            $MBX = Get-EXOMailbox -ResultSize Unlimited | Where-Object { $_.RecipientTypeDetails -eq \"UserMailbox\" }\n            $MBX | Set-Mailbox -AuditEnabled $true ` -AuditLogAgeLimit 180 -AuditAdmin $AuditAdmin -AuditDelegate $AuditDelegate ` -AuditOwner $AuditOwner\n    Note: When running this script mailboxes without an E5 or Azure Audit Premium license applied will generate an error as they are not licensed for the additional actions which come default with E5.'\n\n  desc 'rationale',\n       'Whether it is for regulatory compliance or for tracking unauthorized configuration\n        changes in Microsoft 365, enabling mailbox auditing and ensuring the proper mailbox\n        actions are accounted for allows for Microsoft 365 teams to run security operations,\n        forensics or general investigations on mailbox activities.\n        The following mailbox types ignore the organizational default and must have\n        AuditEnabled set to True at the mailbox level in order to capture relevant audit data.\n            • Resource Mailboxes\n            • Public Folder Mailboxes\n            • DiscoverySearch Mailbox\n        NOTE: Without advanced auditing (E5 function) the logs are limited to 90 days.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['8.2'] }, { '7' => ['6.2'] }]\n  tag default_value: 'AuditEnabled: True for all mailboxes except below:\n                        • Resource Mailboxes\n                        • Public Folder Mailboxes\n                        • DiscoverySearch Mailbox\n                    AuditAdmin: ApplyRecord, Create, HardDelete, MailItemsAccessed,\n                    MoveToDeletedItems, Send, SendAs, SendOnBehalf, SoftDelete, Update,\n                    UpdateCalendarDelegation, UpdateFolderPermissions, UpdateInboxRules\n                    AuditDelegate: ApplyRecord, Create, HardDelete, MailItemsAccessed,\n                    MoveToDeletedItems, SendAs, SendOnBehalf, SoftDelete, Update,\n                    UpdateFolderPermissions, UpdateInboxRules\n                    AuditOwner: ApplyRecord, HardDelete, MailItemsAccessed, MoveToDeletedItems,\n                    Send, SoftDelete, Update, UpdateCalendarDelegation, UpdateFolderPermissions,\n                    UpdateInboxRules'\n  tag nist: ['AU-2', 'AU-7', 'AU-12', 'AC-1', 'AC-2', 'AC-2(1)']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/compliance/audit-mailboxes?view=o365-worldwide'\n\n  e5_user_mailbox_auditing_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    $AdminActions = @( \"ApplyRecord\", \"Copy\", \"Create\", \"FolderBind\", \"HardDelete\", \"MailItemsAccessed\", \"Move\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"Send\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n    $DelegateActions = @( \"ApplyRecord\", \"Create\", \"FolderBind\", \"HardDelete\", \"Move\", \"MailItemsAccessed\", \"MoveToDeletedItems\", \"SendAs\", \"SendOnBehalf\", \"SoftDelete\", \"Update\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n    $OwnerActions = @( \"ApplyRecord\", \"Create\", \"HardDelete\", \"MailboxLogin\", \"Move\", \"MailItemsAccessed\", \"MoveToDeletedItems\", \"Send\", \"SoftDelete\", \"Update\", \"UpdateCalendarDelegation\", \"UpdateFolderPermissions\", \"UpdateInboxRules\" )\n\n        function VerifyActions {\n          param (\n            [string]$type,\n            [array]$actions,\n            [array]$auditProperty,\n            [string]$mailboxName\n          )\n          $missingActions = @()\n          $actionCount = 0\n          foreach ($action in $actions) {\n            if ($auditProperty -notcontains $action) {\n              $missingActions += \" Failure: Audit action '$action' missing from $type\"\n              $actionCount++\n            }\n          }\n          if ($actionCount -eq 0) {\n          } else {\n            Write-Host \"[$mailboxName]: $type actions are not all verified.\" -ForegroundColor Red\n            foreach ($missingAction in $missingActions) {\n              Write-Host \" $missingAction\" -ForegroundColor Red\n            }\n          }\n        }\n\n        $mailboxes = Get-EXOMailbox -PropertySets Audit,Minimum -ResultSize Unlimited | Where-Object { $_.RecipientTypeDetails -eq \"UserMailbox\" }\n\n        foreach ($mailbox in $mailboxes) {\n          if ($mailbox.AuditEnabled) {\n          } else {\n            Write-Host \"[$($mailbox.UserPrincipalName)]: AuditEnabled is false\" -ForegroundColor Red\n          }\n          VerifyActions -type \"AuditAdmin\" -actions $AdminActions -auditProperty $mailbox.AuditAdmin `\n            -mailboxName $mailbox.UserPrincipalName\n          VerifyActions -type \"AuditDelegate\" -actions $DelegateActions -auditProperty $mailbox.AuditDelegate `\n            -mailboxName $mailbox.UserPrincipalName\n          VerifyActions -type \"AuditOwner\" -actions $OwnerActions -auditProperty $mailbox.AuditOwner `\n            -mailboxName $mailbox.UserPrincipalName\n          Write-Host\n        }\n    }\n  powershell_output = powershell(e5_user_mailbox_auditing_script).stdout.strip\n  describe 'Ensure that mailbox auditing for E5 users' do\n    subject { powershell_output }\n    it 'returns no actions needed from auditing' do\n      failure_message = \"The following mailboxes failed with the following issues: #{powershell_output.split(\"\\n\").join(',')}\"\n      expect(subject).to be_empty, failure_message\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-6.1.3.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure that mailbox auditing for E5 users returns no actions needed from auditing","run_time":0.003431,"start_time":"2024-09-24T15:51:33-04:00","message":"The following mailboxes failed with the following issues: [sjaniak@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[sjaniak@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[sjaniak@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[rhochgraf@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[rhochgraf@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[rhochgraf@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[lavender@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[lavender@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[lavender@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[mhartley@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[mhartley@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[mhartley@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[vmartzahl@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[vmartzahl@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[vmartzahl@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[azaini@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[azaini@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[azaini@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dpoltar@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dpoltar@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dpoltar@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jflorie@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jflorie@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jflorie@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[mgeiser@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[mgeiser@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[mgeiser@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[tscholfield@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[tscholfield@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[tscholfield@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[iprusky@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[iprusky@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[iprusky@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[rteague@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[rteague@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[rteague@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dweiss@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dweiss@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dweiss@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[SLITTLEHALE@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[SLITTLEHALE@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[SLITTLEHALE@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[ldebellis@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[ldebellis@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[ldebellis@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jhiggins@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jhiggins@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jhiggins@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dzic@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dzic@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dzic@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[rnovak@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[rnovak@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[rnovak@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[psorenson@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[psorenson@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[psorenson@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[bbascom@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[bbascom@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[bbascom@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[nwill@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[nwill@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[nwill@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[cbarlow@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[cbarlow@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[cbarlow@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[mdube@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[mdube@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[mdube@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[mmoulton@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[mmoulton@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[mmoulton@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[adost@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[adost@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[adost@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[acoursen@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[acoursen@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[acoursen@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[gmorgan@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[gmorgan@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[gmorgan@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[amukherjee@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[amukherjee@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[amukherjee@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[rchaudhry@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[rchaudhry@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[rchaudhry@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[mitreatworkdev@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[mitreatworkdev@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[mitreatworkdev@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[eddiep@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[eddiep@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[eddiep@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[bamado@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[bamado@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[bamado@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jbaskerville@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jbaskerville@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jbaskerville@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[odennehy@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[odennehy@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[odennehy@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[cristinaoh@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[cristinaoh@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[cristinaoh@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[njtestuser@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[njtestuser@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[njtestuser@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[efaulder@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[efaulder@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[efaulder@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[tririgasa@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[tririgasa@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[tririgasa@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[abuehne@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[abuehne@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[abuehne@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[lebrandt@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[lebrandt@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[lebrandt@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jhall@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jhall@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jhall@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dcuomo@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dcuomo@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dcuomo@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[acleavenger@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[acleavenger@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[acleavenger@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jschommer@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jschommer@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jschommer@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[gkuhn@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[gkuhn@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[gkuhn@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[gcase@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[gcase@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[gcase@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[ltiv@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[ltiv@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[ltiv@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[lfinn@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[lfinn@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[lfinn@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[scolangelo@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[scolangelo@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[scolangelo@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[tlee@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[tlee@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[tlee@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dtkim@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dtkim@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dtkim@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[zrobin@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[zrobin@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[zrobin@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dvitenko@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dvitenko@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dvitenko@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[chad@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[chad@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[chad@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[pverrill@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[pverrill@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[pverrill@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[narcaro@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[narcaro@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[narcaro@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[kcigler@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[kcigler@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[kcigler@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[roliver@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[roliver@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[roliver@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[catorre@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[catorre@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[catorre@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[lmavroudakis@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[lmavroudakis@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[lmavroudakis@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[nspatel@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[nspatel@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[nspatel@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[userglazarte@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[userglazarte@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[userglazarte@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jseifert@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jseifert@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jseifert@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[aabramkin@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[aabramkin@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[aabramkin@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[igross@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[igross@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[igross@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[alopez@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[alopez@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[alopez@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[asalah@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[asalah@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[asalah@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[prajaram@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[prajaram@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[prajaram@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[wgabree@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[wgabree@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[wgabree@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[sudakar@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[sudakar@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[sudakar@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[nforleo@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[nforleo@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[nforleo@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[abouffard@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[abouffard@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[abouffard@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[bpalumbo@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[bpalumbo@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[bpalumbo@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[imatthews@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[imatthews@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[imatthews@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[csl_phonebooth@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[csl_phonebooth@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[csl_phonebooth@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[damirault@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[damirault@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[damirault@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[npando@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[npando@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[npando@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dshackley@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dshackley@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dshackley@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dproulx@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dproulx@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dproulx@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[eclough@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[eclough@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[eclough@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[nbos@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[nbos@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[nbos@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[cschlick@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[cschlick@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[cschlick@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[secooper@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[secooper@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[secooper@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[cchang@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[cchang@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[cchang@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[eschermerhorn@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[eschermerhorn@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[eschermerhorn@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[P860_dev@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[P860_dev@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[P860_dev@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[sburgoyne@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[sburgoyne@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[sburgoyne@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[mitreatworkint@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[mitreatworkint@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[mitreatworkint@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jplopez@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jplopez@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jplopez@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[karacm@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[karacm@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[karacm@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jcmoore@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jcmoore@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jcmoore@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dweinman@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dweinman@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dweinman@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[nima@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[nima@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[nima@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[glading@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[glading@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[glading@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[efinney@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[efinney@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[efinney@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[cenkl@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[cenkl@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[cenkl@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[atanoor@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[atanoor@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[atanoor@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[gshieh@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[gshieh@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[gshieh@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[gpasku@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[gpasku@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[gpasku@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[vjamba@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[vjamba@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[vjamba@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[drozdetski@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[drozdetski@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[drozdetski@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[dsarkhel@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[dsarkhel@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[dsarkhel@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[bdowney@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[bdowney@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[bdowney@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jma@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jma@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jma@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[fcriscione@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[fcriscione@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[fcriscione@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[ecottom@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[ecottom@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[ecottom@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[forbes@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[forbes@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[forbes@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[glazarte@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[glazarte@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[glazarte@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[iwright@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[iwright@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[iwright@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[jcsganga@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[jcsganga@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[jcsganga@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[junger@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[junger@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[junger@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[kferrante@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[kferrante@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[kferrante@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[mcannava@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[mcannava@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[mcannava@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[marianne@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[marianne@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[marianne@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[mmamo@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[mmamo@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[mmamo@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[mrodrigues@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[mrodrigues@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[mrodrigues@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[nguyenm@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[nguyenm@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[nguyenm@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[njacobs@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[njacobs@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[njacobs@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[nkatikaneni@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[nkatikaneni@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[nkatikaneni@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[phebenstreit@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[phebenstreit@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[phebenstreit@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[rrawal@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[rrawal@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[rrawal@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[rwolfe@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[rwolfe@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[rwolfe@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[sbarber@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[sbarber@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[sbarber@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[scbrown@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[scbrown@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[scbrown@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner,,[spandolfi@mitredev.onmicrosoft.com]: AuditAdmin actions are not all verified.,  Failure: Audit action 'Copy' missing from AuditAdmin,  Failure: Audit action 'FolderBind' missing from AuditAdmin,  Failure: Audit action 'Move' missing from AuditAdmin,[spandolfi@mitredev.onmicrosoft.com]: AuditDelegate actions are not all verified.,  Failure: Audit action 'FolderBind' missing from AuditDelegate,  Failure: Audit action 'Move' missing from AuditDelegate,[spandolfi@mitredev.onmicrosoft.com]: AuditOwner actions are not all verified.,  Failure: Audit action 'Create' missing from AuditOwner,  Failure: Audit action 'MailboxLogin' missing from AuditOwner,  Failure: Audit action 'Move' missing from AuditOwner","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that mailbox auditing for E5 users"}]},{"id":"microsoft-365-foundations-6.1.4","title":"Ensure 'AuditBypassEnabled' is not enabled on mailboxes","desc":"When configuring a user or computer account to bypass mailbox audit logging, the system will not record any access, or actions performed by the said user or computer account on any mailbox. Administratively this was introduced to reduce the volume of entries in the mailbox audit logs on trusted user or computer accounts.\n        Ensure AuditBypassEnabled is not enabled on accounts without a written exception.","descriptions":[{"label":"default","data":"When configuring a user or computer account to bypass mailbox audit logging, the system will not record any access, or actions performed by the said user or computer account on any mailbox. Administratively this was introduced to reduce the volume of entries in the mailbox audit logs on trusted user or computer accounts.\n        Ensure AuditBypassEnabled is not enabled on accounts without a written exception."},{"label":"check","data":"Ensure Audit Bypass is not enabled using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            $MBX = Get-MailboxAuditBypassAssociation -ResultSize unlimited\n            $MBX | where {$_.AuditBypassEnabled -eq $true} | Format-Table Name,AuditBypassEnabled\n        3. If nothing is returned, then there are no accounts with Audit Bypass enabled."},{"label":"fix","data":"Disable Audit Bypass on all mailboxes using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. The following example PowerShell script will disable AuditBypass for all mailboxes which currently have it enabled:\n\n            # Get mailboxes with AuditBypassEnabled set to $true\n            $MBXAudit = Get-MailboxAuditBypassAssociation -ResultSize unlimited | Where-Object { $_.AuditBypassEnabled -eq $true }\n            foreach ($mailbox in $MBXAudit) {\n                $mailboxName = $mailbox.Name\n                Set-MailboxAuditBypassAssociation -Identity $mailboxName -AuditBypassEnabled $false\n                Write-Host \"Audit Bypass disabled for mailbox Identity: $mailboxName\" -ForegroundColor Green\n            }"},{"label":"rationale","data":"If a mailbox audit bypass association is added for an account, the account can access\n        any mailbox in the organization to which it has been assigned access permissions,\n        without generating any mailbox audit logging entries for such access or recording any\n        actions taken, such as message deletions.\n        Enabling this parameter, whether intentionally or unintentionally, could allow insiders or\n        malicious actors to conceal their activity on specific mailboxes. Ensuring proper logging\n        of user actions and mailbox operations in the audit log will enable comprehensive\n        incident response and forensics."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/powershell/module/exchange/get-mailboxauditbypassassociation?view=exchange-ps"}],"tags":{"severity":"medium","cis_controls":[{"8":["8.5"]}],"default_value":"AuditBypassEnabled False","nist":["AU-3","AU-3(1)","AU-7","AU-12"]},"code":"control 'microsoft-365-foundations-6.1.4' do\n  title \"Ensure 'AuditBypassEnabled' is not enabled on mailboxes\"\n  desc \"When configuring a user or computer account to bypass mailbox audit logging, the system will not record any access, or actions performed by the said user or computer account on any mailbox. Administratively this was introduced to reduce the volume of entries in the mailbox audit logs on trusted user or computer accounts.\n        Ensure AuditBypassEnabled is not enabled on accounts without a written exception.\"\n\n  desc 'check',\n       \"Ensure Audit Bypass is not enabled using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            $MBX = Get-MailboxAuditBypassAssociation -ResultSize unlimited\n            $MBX | where {$_.AuditBypassEnabled -eq $true} | Format-Table Name,AuditBypassEnabled\n        3. If nothing is returned, then there are no accounts with Audit Bypass enabled.\"\n\n  desc 'fix',\n       'Disable Audit Bypass on all mailboxes using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. The following example PowerShell script will disable AuditBypass for all mailboxes which currently have it enabled:\n\n            # Get mailboxes with AuditBypassEnabled set to $true\n            $MBXAudit = Get-MailboxAuditBypassAssociation -ResultSize unlimited | Where-Object { $_.AuditBypassEnabled -eq $true }\n            foreach ($mailbox in $MBXAudit) {\n                $mailboxName = $mailbox.Name\n                Set-MailboxAuditBypassAssociation -Identity $mailboxName -AuditBypassEnabled $false\n                Write-Host \"Audit Bypass disabled for mailbox Identity: $mailboxName\" -ForegroundColor Green\n            }'\n\n  desc 'rationale',\n       'If a mailbox audit bypass association is added for an account, the account can access\n        any mailbox in the organization to which it has been assigned access permissions,\n        without generating any mailbox audit logging entries for such access or recording any\n        actions taken, such as message deletions.\n        Enabling this parameter, whether intentionally or unintentionally, could allow insiders or\n        malicious actors to conceal their activity on specific mailboxes. Ensuring proper logging\n        of user actions and mailbox operations in the audit log will enable comprehensive\n        incident response and forensics.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['8.5'] }]\n  tag default_value: 'AuditBypassEnabled False'\n  tag nist: ['AU-3', 'AU-3(1)', 'AU-7', 'AU-12']\n\n  ref 'https://learn.microsoft.com/en-us/powershell/module/exchange/get-mailboxauditbypassassociation?view=exchange-ps'\n\n  ensure_auditbybass_not_enabled_mailbox_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    $MBX = Get-MailboxAuditBypassAssociation -ResultSize unlimited\n    $MBX | where {$_.AuditBypassEnabled -eq $true} | Select-Object Name, AuditBypassEnabled | ConvertTo-Json\n }\n\n  powershell_output = powershell(ensure_auditbybass_not_enabled_mailbox_script).stdout.strip\n  mailboxes_with_true = JSON.parse(powershell_output) unless powershell_output.empty?\n  describe 'Ensure the number of mailboxes with the AuditBypassEnabled state set to True' do\n    subject { powershell_output }\n    it 'is 0' do\n      failure_message = \"Mailboxes that failed: #{JSON.pretty_generate(mailboxes_with_true)}\"\n      expect(subject).to be_empty, failure_message\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-6.1.4.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure the number of mailboxes with the AuditBypassEnabled state set to True is 0","run_time":0.002528,"start_time":"2024-09-24T15:51:33-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the number of mailboxes with the AuditBypassEnabled state set to True"}]},{"id":"microsoft-365-foundations-6.2.1","title":"Ensure all forms of mail forwarding are blocked and/or disabled","desc":"Exchange Online offers several methods of managing the flow of email messages. These are Remote domain, Transport Rules, and Anti-spam outbound policies. These methods work together to provide comprehensive coverage for potential automatic forwarding channels:\n            • Outlook forwarding using inbox rules.\n            • Outlook forwarding configured using OOF rule.\n            • OWA forwarding setting (ForwardingSmtpAddress).\n            • Forwarding set by the admin using EAC (ForwardingAddress).\n            • Forwarding using Power Automate / Flow.\n        Ensure a Transport rule and Anti-spam outbound policy are used to block mail forwarding.\n        NOTE: Any exclusions should be implemented based on organizational policy.","descriptions":[{"label":"default","data":"Exchange Online offers several methods of managing the flow of email messages. These are Remote domain, Transport Rules, and Anti-spam outbound policies. These methods work together to provide comprehensive coverage for potential automatic forwarding channels:\n            • Outlook forwarding using inbox rules.\n            • Outlook forwarding configured using OOF rule.\n            • OWA forwarding setting (ForwardingSmtpAddress).\n            • Forwarding set by the admin using EAC (ForwardingAddress).\n            • Forwarding using Power Automate / Flow.\n        Ensure a Transport rule and Anti-spam outbound policy are used to block mail forwarding.\n        NOTE: Any exclusions should be implemented based on organizational policy."},{"label":"check","data":"Note: Audit is a two step procedure as follows:\n        STEP 1: Transport rules To verify the mail transport rules do not forward email to external domains using the UI:\n                1. Select Exchange to open the Exchange admin center.\n                2. Select Mail Flow then Rules.\n                3. Review the rules and verify that none of them are forwards or redirects e-mail to external domains.\n            To audit using PowerShell:\n                1. Connect to Exchange online using Connect-ExchangeOnline.\n                2. Run the following PowerShell command to review the Transport Rules that are redirecting email:\n                    Get-TransportRule | Where-Object {$_.RedirectMessageTo -ne $null} | ft Name,RedirectMessageTo\n                3. Verify that none of the addresses listed belong to external domains outside of the organization. If nothing returns then there are no transport rules set to redirect messages.\n        STEP 2: Anti-spam outbound policy Ensure an anti-spam outbound policy is properly configured using the UI:\n                1. Navigate to Microsoft 365 Defender https://security.microsoft.com/\n                2. Expand E-mail & collaboration then select Policies & rules.\n                3. Select Threat policies > Anti-spam.\n                4. Inspect Anti-spam outbound policy (default) and ensure Automatic forwarding is set to Off - Forwarding is disabled\n                5. Inspect any additional custom outbound policies and ensure Automatic forwarding is set to Off - Forwarding is disabled, in accordance with the organization's exclusion policies.\n            To audit using PowerShell:\n                1. Connect to Exchange online using Connect-ExchangeOnline.\n                2. Run the following PowerShell cmdlet:\n                    Get-HostedOutboundSpamFilterPolicy | ft Name, AutoForwardingMode\n                3. In each outbound policy verify AutoForwardingMode is Off.\n            Note: According to Microsoft if a recipient is defined in multiple policies of the same type (anti-spam, anti-phishing, etc.), only the policy with the highest priority is applied to the recipient. Any remaining policies of that type are not evaluated for the recipient (including the default policy). However, it is our recommendation to audit the default policy as well in the case a higher priority custom policy is removed. This will keep the organization's security posture strong."},{"label":"fix","data":"Note: Remediation is a two step procedure as follows: STEP 1: Transport rules To alter the mail transport rules so they do not forward email to external domains using the UI:\n            1. Select Exchange to open the Exchange admin center.\n            2. Select Mail Flow then Rules.\n            3. For each rule that redirects email to external domains, select the rule and click the 'Delete' icon.\n        To remediate using PowerShell:\n            1. Connect to Exchange Online using Connect-ExchangeOnline.\n            2. Run the following PowerShell command:\n                Remove-TransportRule {RuleName}\n    STEP 2: Anti-spam outbound policy To configure an anti-spam outbound policy using the UI:\n            1. Navigate to Microsoft 365 Defender https://security.microsoft.com/\n            2. Expand E-mail & collaboration then select Policies & rules.\n            3. Select Threat policies > Anti-spam.\n            4. Select Anti-spam outbound policy (default)\n            5. Click Edit protection settings\n            6. Set Automatic forwarding rules dropdown to Off - Forwarding is disabled and click Save\n            7. Repeat steps 4-6 for any additional higher priority, custom policies.\n        To remediate using PowerShell:\n            1. Connect to Exchange Online using Connect-ExchangeOnline.\n            2. Run the following PowerShell command: Set-HostedOutboundSpamFilterPolicy -Identity {policyName} -AutoForwardingMode Off\n            3. To remove AutoForwarding from all outbound policies you can also run: Get-HostedOutboundSpamFilterPolicy | Set-HostedOutboundSpamFilterPolicy -AutoForwardingMode Off"},{"label":"rationale","data":"Attackers often create these rules to exfiltrate data from your tenancy, this could be\n        accomplished via access to an end-user account or otherwise. An insider could also use\n        one of these methods as a secondary channel to exfiltrate sensitive data."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/exchange/policy-and-compliance/mail-flow-rules/mail-flow-rule-procedures?view=exchserver-2019"},{"ref":"https://techcommunity.microsoft.com/t5/exchange-team-blog/all-you-need-to-know-about-automatic-email-forwarding-in/ba-p/2074888#:~:text=%20%20%20Automatic%20forwarding%20option%20%20,%"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/outbound-spam-policies-external-email-forwarding?view=o365-worldwide"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/exchange/Remove-TransportRule?view=exchange-ps"}],"tags":{"severity":"medium","cis_controls":[{"8":["untracked"]}],"nist":["CM-6"]},"code":"control 'microsoft-365-foundations-6.2.1' do\n  title 'Ensure all forms of mail forwarding are blocked and/or disabled'\n  desc \"Exchange Online offers several methods of managing the flow of email messages. These are Remote domain, Transport Rules, and Anti-spam outbound policies. These methods work together to provide comprehensive coverage for potential automatic forwarding channels:\n            • Outlook forwarding using inbox rules.\n            • Outlook forwarding configured using OOF rule.\n            • OWA forwarding setting (ForwardingSmtpAddress).\n            • Forwarding set by the admin using EAC (ForwardingAddress).\n            • Forwarding using Power Automate / Flow.\n        Ensure a Transport rule and Anti-spam outbound policy are used to block mail forwarding.\n        NOTE: Any exclusions should be implemented based on organizational policy.\"\n\n  desc 'check',\n       \"Note: Audit is a two step procedure as follows:\n        STEP 1: Transport rules To verify the mail transport rules do not forward email to external domains using the UI:\n                1. Select Exchange to open the Exchange admin center.\n                2. Select Mail Flow then Rules.\n                3. Review the rules and verify that none of them are forwards or redirects e-mail to external domains.\n            To audit using PowerShell:\n                1. Connect to Exchange online using Connect-ExchangeOnline.\n                2. Run the following PowerShell command to review the Transport Rules that are redirecting email:\n                    Get-TransportRule | Where-Object {$_.RedirectMessageTo -ne $null} | ft Name,RedirectMessageTo\n                3. Verify that none of the addresses listed belong to external domains outside of the organization. If nothing returns then there are no transport rules set to redirect messages.\n        STEP 2: Anti-spam outbound policy Ensure an anti-spam outbound policy is properly configured using the UI:\n                1. Navigate to Microsoft 365 Defender https://security.microsoft.com/\n                2. Expand E-mail & collaboration then select Policies & rules.\n                3. Select Threat policies > Anti-spam.\n                4. Inspect Anti-spam outbound policy (default) and ensure Automatic forwarding is set to Off - Forwarding is disabled\n                5. Inspect any additional custom outbound policies and ensure Automatic forwarding is set to Off - Forwarding is disabled, in accordance with the organization's exclusion policies.\n            To audit using PowerShell:\n                1. Connect to Exchange online using Connect-ExchangeOnline.\n                2. Run the following PowerShell cmdlet:\n                    Get-HostedOutboundSpamFilterPolicy | ft Name, AutoForwardingMode\n                3. In each outbound policy verify AutoForwardingMode is Off.\n            Note: According to Microsoft if a recipient is defined in multiple policies of the same type (anti-spam, anti-phishing, etc.), only the policy with the highest priority is applied to the recipient. Any remaining policies of that type are not evaluated for the recipient (including the default policy). However, it is our recommendation to audit the default policy as well in the case a higher priority custom policy is removed. This will keep the organization's security posture strong.\"\n\n  desc 'fix',\n       \"Note: Remediation is a two step procedure as follows: STEP 1: Transport rules To alter the mail transport rules so they do not forward email to external domains using the UI:\n            1. Select Exchange to open the Exchange admin center.\n            2. Select Mail Flow then Rules.\n            3. For each rule that redirects email to external domains, select the rule and click the 'Delete' icon.\n        To remediate using PowerShell:\n            1. Connect to Exchange Online using Connect-ExchangeOnline.\n            2. Run the following PowerShell command:\n                Remove-TransportRule {RuleName}\n    STEP 2: Anti-spam outbound policy To configure an anti-spam outbound policy using the UI:\n            1. Navigate to Microsoft 365 Defender https://security.microsoft.com/\n            2. Expand E-mail & collaboration then select Policies & rules.\n            3. Select Threat policies > Anti-spam.\n            4. Select Anti-spam outbound policy (default)\n            5. Click Edit protection settings\n            6. Set Automatic forwarding rules dropdown to Off - Forwarding is disabled and click Save\n            7. Repeat steps 4-6 for any additional higher priority, custom policies.\n        To remediate using PowerShell:\n            1. Connect to Exchange Online using Connect-ExchangeOnline.\n            2. Run the following PowerShell command: Set-HostedOutboundSpamFilterPolicy -Identity {policyName} -AutoForwardingMode Off\n            3. To remove AutoForwarding from all outbound policies you can also run: Get-HostedOutboundSpamFilterPolicy | Set-HostedOutboundSpamFilterPolicy -AutoForwardingMode Off\"\n\n  desc 'rationale',\n       'Attackers often create these rules to exfiltrate data from your tenancy, this could be\n        accomplished via access to an end-user account or otherwise. An insider could also use\n        one of these methods as a secondary channel to exfiltrate sensitive data.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['untracked'] }]\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-us/exchange/policy-and-compliance/mail-flow-rules/mail-flow-rule-procedures?view=exchserver-2019'\n  ref 'https://techcommunity.microsoft.com/t5/exchange-team-blog/all-you-need-to-know-about-automatic-email-forwarding-in/ba-p/2074888#:~:text=%20%20%20Automatic%20forwarding%20option%20%20,%'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/outbound-spam-policies-external-email-forwarding?view=o365-worldwide'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/exchange/Remove-TransportRule?view=exchange-ps'\n\n  ensure_no_external_address_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    Get-TransportRule | Where-Object {\n    $_.RedirectMessageTo -ne $null -and\n    $_.RedirectMessageTo -notmatch '#{input('internal_domains_transport_rule').join('|')}'\n  } | Select-Object -ExpandProperty Name\n }\n  powershell_output_address = powershell(ensure_no_external_address_script).stdout.strip\n  external_rules = powershell_output_address.split(\"\\n\") unless powershell_output_address.empty?\n  describe 'Ensure only internal domains' do\n    subject { powershell_output_address }\n    it 'are present in transport rules' do\n      failure_message = \"Rules with external domains present: #{external_rules}\"\n      expect(subject).to be_empty, failure_message\n    end\n  end\n\n  ensure_all_mail_forwarding_blocked_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    Get-HostedOutboundSpamFilterPolicy | Where-Object { $_.AutoForwardingMode -ne \"Off\" } | Select-Object Name, AutoForwardingMode | ConvertTo-Json\n }\n\n  powershell_output = powershell(ensure_all_mail_forwarding_blocked_script).stdout.strip\n  mailboxes_without_off = JSON.parse(powershell_output) unless powershell_output.empty?\n  describe 'Ensure the number of mailboxes with the AutoForwardingMode state not set to Off' do\n    subject { powershell_output }\n    it 'is 0' do\n      failure_message = \"Mailboxes that failed: #{JSON.pretty_generate(mailboxes_without_off)}\"\n      expect(subject).to be_empty, failure_message\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-6.2.1.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure only internal domains are present in transport rules","run_time":0.00252,"start_time":"2024-09-24T15:51:33-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure only internal domains"},{"status":"failed","code_desc":"Ensure the number of mailboxes with the AutoForwardingMode state not set to Off is 0","run_time":0.002367,"start_time":"2024-09-24T15:51:33-04:00","message":"Mailboxes that failed: {\n  \"Name\": \"Default\",\n  \"AutoForwardingMode\": \"Automatic\"\n}","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the number of mailboxes with the AutoForwardingMode state not set to Off"}]},{"id":"microsoft-365-foundations-6.2.2","title":"Ensure mail transport rules do not whitelist specific domains","desc":"Mail flow rules (transport rules) in Exchange Online are used to identify and take action on messages that flow through the organization.","descriptions":[{"label":"default","data":"Mail flow rules (transport rules) in Exchange Online are used to identify and take action on messages that flow through the organization."},{"label":"check","data":"Ensure mail transport rules do not whitelist specific domains:\n        1. Navigate to Exchange admin center https://admin.exchange.microsoft.com..\n        2. Click to expand Mail Flow and then select Rules.\n        3. Review the rules and verify that none of them whitelist any specific domains.\n    To verify that mail transport rules do not whitelist any domains using PowerShell:\n        1. Connect to Exchange online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Get-TransportRule | Where-Object {($_.setscl -eq -1 -and $_.SenderDomainIs -ne $null)} | ft Name,SenderDomainIs"},{"label":"fix","data":"To alter the mail transport rules so they do not whitelist any specific domains:\n        1. Navigate to Exchange admin center https://admin.exchange.microsoft.com..\n        2. Click to expand Mail Flow and then select Rules.\n        3. For each rule that whitelists specific domains, select the rule and click the 'Delete' icon.\n    To remove mail transport rules using PowerShell:\n        1. Connect to Exchange online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Remove-TransportRule {RuleName}\n        3. Verify the rules no longer exists.\n            Get-TransportRule | Where-Object {($_.setscl -eq -1 -and $_.SenderDomainIs -ne $null)} | ft Name,SenderDomainIs"},{"label":"rationale","data":"Whitelisting domains in transport rules bypasses regular malware and phishing\n        scanning, which can enable an attacker to launch attacks against your users from a\n        safe haven domain."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/exchange/security-and-compliance/mail-flow-rules/configuration-best-practices"},{"ref":"https://learn.microsoft.com/en-us/exchange/security-and-compliance/mail-flow-rules/mail-flow-rules"}],"tags":{"severity":"medium","cis_controls":[{"8":["untracked"]}],"nist":["CM-6"]},"code":"control 'microsoft-365-foundations-6.2.2' do\n  title 'Ensure mail transport rules do not whitelist specific domains'\n  desc 'Mail flow rules (transport rules) in Exchange Online are used to identify and take action on messages that flow through the organization.'\n\n  desc 'check',\n       \"Ensure mail transport rules do not whitelist specific domains:\n        1. Navigate to Exchange admin center https://admin.exchange.microsoft.com..\n        2. Click to expand Mail Flow and then select Rules.\n        3. Review the rules and verify that none of them whitelist any specific domains.\n    To verify that mail transport rules do not whitelist any domains using PowerShell:\n        1. Connect to Exchange online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Get-TransportRule | Where-Object {($_.setscl -eq -1 -and $_.SenderDomainIs -ne $null)} | ft Name,SenderDomainIs\"\n\n  desc 'fix',\n       \"To alter the mail transport rules so they do not whitelist any specific domains:\n        1. Navigate to Exchange admin center https://admin.exchange.microsoft.com..\n        2. Click to expand Mail Flow and then select Rules.\n        3. For each rule that whitelists specific domains, select the rule and click the 'Delete' icon.\n    To remove mail transport rules using PowerShell:\n        1. Connect to Exchange online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Remove-TransportRule {RuleName}\n        3. Verify the rules no longer exists.\n            Get-TransportRule | Where-Object {($_.setscl -eq -1 -and $_.SenderDomainIs -ne $null)} | ft Name,SenderDomainIs\"\n\n  desc 'rationale',\n       'Whitelisting domains in transport rules bypasses regular malware and phishing\n        scanning, which can enable an attacker to launch attacks against your users from a\n        safe haven domain.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['untracked'] }]\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-us/exchange/security-and-compliance/mail-flow-rules/configuration-best-practices'\n  ref 'https://learn.microsoft.com/en-us/exchange/security-and-compliance/mail-flow-rules/mail-flow-rules'\n\n  ensure_mail_transport_rules_dont_whitelist_specific_domains_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    Get-TransportRule | Where-Object { ($_.SetScl -eq -1 -and $_.SenderDomainIs -ne $null) } | Select-Object -ExpandProperty Name\n }\n  powershell_output = powershell(ensure_mail_transport_rules_dont_whitelist_specific_domains_script).stdout.strip\n  whitelisted_domain_rules = powershell_output.split(\"\\n\") unless powershell_output.empty?\n  describe 'Ensure the mail transport rules' do\n    subject { powershell_output }\n    it 'do not have specific domains whitelisted' do\n      failure_message = \"Rules with specific whitelisted domains: #{whitelisted_domain_rules}\"\n      expect(subject).to be_empty, failure_message\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-6.2.2.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure the mail transport rules do not have specific domains whitelisted","run_time":0.002351,"start_time":"2024-09-24T15:51:33-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the mail transport rules"}]},{"id":"microsoft-365-foundations-6.2.3","title":"Ensure email from external senders is identified","desc":"External callouts provide a native experience to identify emails from senders outside the organization. This is achieved by presenting a new tag on emails called \"External\" (the string is localized based on the client language setting) and exposing related user interface at the top of the message reading view to see and verify the real sender's email address.\n        Once this feature is enabled via PowerShell, it might take 24-48 hours for users to start seeing the External sender tag in email messages received from external sources (outside of your organization), providing their Outlook version supports it.\n        The recommended state is ExternalInOutlook set to Enabled True\n        Note: Mail flow rules are often used by Exchange administrators to accomplish the External email tagging by appending a tag to the front of a subject line. There are limitations to this outlined here. The preferred method in the CIS Benchmark is to use the native experience.","descriptions":[{"label":"default","data":"External callouts provide a native experience to identify emails from senders outside the organization. This is achieved by presenting a new tag on emails called \"External\" (the string is localized based on the client language setting) and exposing related user interface at the top of the message reading view to see and verify the real sender's email address.\n        Once this feature is enabled via PowerShell, it might take 24-48 hours for users to start seeing the External sender tag in email messages received from external sources (outside of your organization), providing their Outlook version supports it.\n        The recommended state is ExternalInOutlook set to Enabled True\n        Note: Mail flow rules are often used by Exchange administrators to accomplish the External email tagging by appending a tag to the front of a subject line. There are limitations to this outlined here. The preferred method in the CIS Benchmark is to use the native experience."},{"label":"check","data":"To verify external sender tagging using PowerShell:\n        1. Connect to Exchange online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Get-ExternalInOutlook\n        3. For each identity verify Enabled is set to True and the AllowList only contains email addresses the organization has permitted to bypass external tagging."},{"label":"fix","data":"To enable external tagging using PowerShell:\n        1. Connect to Exchange online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Set-ExternalInOutlook -Enabled $true"},{"label":"rationale","data":"Tagging emails from external senders helps to inform end users about the origin of the\n        email. This can allow them to proceed with more caution and make informed decisions\n        when it comes to identifying spam or phishing emails.\n        Note: Existing emails in a user's inbox from external senders are not tagged\n        retroactively."}],"impact":0.5,"refs":[{"ref":"https://techcommunity.microsoft.com/t5/exchange-team-blog/native-external-sender-callouts-on-email-in-outlook/ba-p/2250098"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/exchange/set-externalinoutlook?view=exchange-ps"}],"tags":{"severity":"medium","default_value":"Disabled (False)","cis_controls":[{"8":["untracked"]},{"7":["untracked"]}],"nist":["CM-6"]},"code":"control 'microsoft-365-foundations-6.2.3' do\n  title 'Ensure email from external senders is identified'\n  desc %q(External callouts provide a native experience to identify emails from senders outside the organization. This is achieved by presenting a new tag on emails called \"External\" (the string is localized based on the client language setting) and exposing related user interface at the top of the message reading view to see and verify the real sender's email address.\n        Once this feature is enabled via PowerShell, it might take 24-48 hours for users to start seeing the External sender tag in email messages received from external sources (outside of your organization), providing their Outlook version supports it.\n        The recommended state is ExternalInOutlook set to Enabled True\n        Note: Mail flow rules are often used by Exchange administrators to accomplish the External email tagging by appending a tag to the front of a subject line. There are limitations to this outlined here. The preferred method in the CIS Benchmark is to use the native experience.)\n\n  desc 'check',\n       \"To verify external sender tagging using PowerShell:\n        1. Connect to Exchange online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Get-ExternalInOutlook\n        3. For each identity verify Enabled is set to True and the AllowList only contains email addresses the organization has permitted to bypass external tagging.\"\n\n  desc 'fix',\n       \"To enable external tagging using PowerShell:\n        1. Connect to Exchange online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Set-ExternalInOutlook -Enabled $true\"\n\n  desc 'rationale',\n       \"Tagging emails from external senders helps to inform end users about the origin of the\n        email. This can allow them to proceed with more caution and make informed decisions\n        when it comes to identifying spam or phishing emails.\n        Note: Existing emails in a user's inbox from external senders are not tagged\n        retroactively.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag default_value: 'Disabled (False)'\n  tag cis_controls: [{ '8' => ['untracked'] }, { '7' => ['untracked'] }]\n  tag nist: ['CM-6']\n\n  ref 'https://techcommunity.microsoft.com/t5/exchange-team-blog/native-external-sender-callouts-on-email-in-outlook/ba-p/2250098'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/exchange/set-externalinoutlook?view=exchange-ps'\n\n  permitted_emails = input('email_addresses_bypass_external_tagging')\n  email_pattern = permitted_emails.map { |email| \"'#{email}'\" }.join(', ')\n  ensure_email_from_external_senders_identified_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    $allowedEmails = @(#{email_pattern})\n    $object = Get-ExternalInOutlook\n    $object | Where-Object {\n      $_.Enabled -eq $false -or\n      ($_.AllowList | ForEach-Object { $allowedEmails -contains $_ } | Where-Object { $_ -eq $false } | Measure-Object).Count -gt 0\n   } | Select-Object -ExpandProperty Identity\n  }\n  powershell_output = powershell(ensure_email_from_external_senders_identified_script).stdout.strip\n  error_identities = powershell_output.split(\"\\n\") unless powershell_output.empty?\n  describe 'Ensure the number of identities with Enabled state as False and AllowedList with non-permitted email addresses' do\n    subject { powershell_output }\n    it 'is 0' do\n      failure_message = \"Identities breaking the rules: #{error_identities}\"\n      expect(subject).to be_empty, failure_message\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-6.2.3.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the number of identities with Enabled state as False and AllowedList with non-permitted email addresses is 0","run_time":0.002359,"start_time":"2024-09-24T15:51:33-04:00","message":"Identities breaking the rules: [\"dbe11796-cbe6-41ca-8ae7-bc1aadb2a567\"]","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the number of identities with Enabled state as False and AllowedList with non-permitted email addresses"}]},{"id":"microsoft-365-foundations-6.3.1","title":"Ensure users installing Outlook add-ins is not allowed","desc":"Specify the administrators and users who can install and manage add-ins for Outlook in Exchange Online\n        By default, users can install add-ins in their Microsoft Outlook Desktop client, allowing data access within the client application.","descriptions":[{"label":"default","data":"Specify the administrators and users who can install and manage add-ins for Outlook in Exchange Online\n        By default, users can install add-ins in their Microsoft Outlook Desktop client, allowing data access within the client application."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Exchange admin center https://admin.exchange.microsoft.com.\n        2. Click to expand Roles select User roles.\n        3. Select Default Role Assignment Policy.\n        4. In the properties pane on the right click on Manage permissions.\n        5. Under Other roles verify My Custom Apps, My Marketplace Apps and My ReadWriteMailboxApps are unchecked.\n    To audit using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following command:\n            Get-EXOMailbox | Select-Object -Unique RoleAssignmentPolicy |\n            ForEach-Object {\n                Get-RoleAssignmentPolicy -Identity $_.RoleAssignmentPolicy |\n                Where-Object {$_.AssignedRoles -like \"*Apps*\"}\n            } | Select-Object Identity, @{Name=\"AssignedRoles\"; Expression={ Get-Mailbox | Select-Object -Unique RoleAssignmentPolicy |\n            ForEach-Object {\n                Get-RoleAssignmentPolicy -Identity $_.RoleAssignmentPolicy |\n                Select-Object -ExpandProperty AssignedRoles |\n                Where-Object {$_ -like \"*Apps*\"}\n                }\n            }}\n        3. Verify My Custom Apps, My Marketplace Apps and My ReadWriteMailboxApps are not present.\n    Note: As of the current release the manage permissions link no longer displays anything when a user assigned the Global Reader role clicks on it. Global Readers as an alternative can inspect the Roles column or use the PowerShell method to perform the audit."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Exchange admin center https://admin.exchange.microsoft.com.\n        2. Click to expand Roles select User roles.\n        3. Select Default Role Assignment Policy.\n        4. In the properties pane on the right click on Manage permissions.\n        5. Under Other roles uncheck My Custom Apps, My Marketplace Apps and My ReadWriteMailboxApps.\n        6. Click Save changes.\n    To remediate using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following command:\n            $policy = \"Role Assignment Policy - Prevent Add-ins\"\n            $roles = \"MyTextMessaging\", \"MyDistributionGroups\", ` \"MyMailSubscriptions\", \"MyBaseOptions\", \"MyVoiceMail\", ` \"MyProfileInformation\", \"MyContactInformation\", \"MyRetentionPolicies\", ` \"MyDistributionGroupMembership\"\n            New-RoleAssignmentPolicy -Name $policy -Roles $roles\n            Set-RoleAssignmentPolicy -id $policy -IsDefault\n            # Assign new policy to all mailboxes\n            Get-EXOMailbox -ResultSize Unlimited | Set-Mailbox -RoleAssignmentPolicy $policy\n        If you have other Role Assignment Policies modify the last line to filter out your custom policies"},{"label":"rationale","data":"Attackers exploit vulnerable or custom add-ins to access user data. Disabling user-\n        installed add-ins in Microsoft Outlook reduces this threat surface."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/exchange/clients-and-mobile-in-exchange-online/add-ins-for-outlook/specify-who-can-install-and-manage-add-ins?source=recommendations"},{"ref":"https://learn.microsoft.com/en-us/exchange/permissions-exo/role-assignment-policies"}],"tags":{"severity":"medium","cis_controls":[{"8":["9.4"]},{"7":["5.1"]}],"default_value":"UI - My Custom Apps, My Marketplace Apps, and My ReadWriteMailboxApps are checked\n                    PowerShell - My Custom Apps My Marketplace Apps and My ReadWriteMailboxApps are assigned","nist":["CM-10","CM-11","SC-18","AC-2"]},"code":"control 'microsoft-365-foundations-6.3.1' do\n  title 'Ensure users installing Outlook add-ins is not allowed'\n  desc \"Specify the administrators and users who can install and manage add-ins for Outlook in Exchange Online\n        By default, users can install add-ins in their Microsoft Outlook Desktop client, allowing data access within the client application.\"\n\n  desc 'check',\n       'To audit using the UI:\n        1. Navigate to Exchange admin center https://admin.exchange.microsoft.com.\n        2. Click to expand Roles select User roles.\n        3. Select Default Role Assignment Policy.\n        4. In the properties pane on the right click on Manage permissions.\n        5. Under Other roles verify My Custom Apps, My Marketplace Apps and My ReadWriteMailboxApps are unchecked.\n    To audit using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following command:\n            Get-EXOMailbox | Select-Object -Unique RoleAssignmentPolicy |\n            ForEach-Object {\n                Get-RoleAssignmentPolicy -Identity $_.RoleAssignmentPolicy |\n                Where-Object {$_.AssignedRoles -like \"*Apps*\"}\n            } | Select-Object Identity, @{Name=\"AssignedRoles\"; Expression={ Get-Mailbox | Select-Object -Unique RoleAssignmentPolicy |\n            ForEach-Object {\n                Get-RoleAssignmentPolicy -Identity $_.RoleAssignmentPolicy |\n                Select-Object -ExpandProperty AssignedRoles |\n                Where-Object {$_ -like \"*Apps*\"}\n                }\n            }}\n        3. Verify My Custom Apps, My Marketplace Apps and My ReadWriteMailboxApps are not present.\n    Note: As of the current release the manage permissions link no longer displays anything when a user assigned the Global Reader role clicks on it. Global Readers as an alternative can inspect the Roles column or use the PowerShell method to perform the audit.'\n\n  desc 'fix',\n       'To remediate using the UI:\n        1. Navigate to Exchange admin center https://admin.exchange.microsoft.com.\n        2. Click to expand Roles select User roles.\n        3. Select Default Role Assignment Policy.\n        4. In the properties pane on the right click on Manage permissions.\n        5. Under Other roles uncheck My Custom Apps, My Marketplace Apps and My ReadWriteMailboxApps.\n        6. Click Save changes.\n    To remediate using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following command:\n            $policy = \"Role Assignment Policy - Prevent Add-ins\"\n            $roles = \"MyTextMessaging\", \"MyDistributionGroups\", ` \"MyMailSubscriptions\", \"MyBaseOptions\", \"MyVoiceMail\", ` \"MyProfileInformation\", \"MyContactInformation\", \"MyRetentionPolicies\", ` \"MyDistributionGroupMembership\"\n            New-RoleAssignmentPolicy -Name $policy -Roles $roles\n            Set-RoleAssignmentPolicy -id $policy -IsDefault\n            # Assign new policy to all mailboxes\n            Get-EXOMailbox -ResultSize Unlimited | Set-Mailbox -RoleAssignmentPolicy $policy\n        If you have other Role Assignment Policies modify the last line to filter out your custom policies'\n\n  desc 'rationale',\n       'Attackers exploit vulnerable or custom add-ins to access user data. Disabling user-\n        installed add-ins in Microsoft Outlook reduces this threat surface.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['9.4'] }, { '7' => ['5.1'] }]\n  tag default_value: 'UI - My Custom Apps, My Marketplace Apps, and My ReadWriteMailboxApps are checked\n                    PowerShell - My Custom Apps My Marketplace Apps and My ReadWriteMailboxApps are assigned'\n  tag nist: ['CM-10', 'CM-11', 'SC-18', 'AC-2']\n\n  ref 'https://learn.microsoft.com/en-us/exchange/clients-and-mobile-in-exchange-online/add-ins-for-outlook/specify-who-can-install-and-manage-add-ins?source=recommendations'\n  ref 'https://learn.microsoft.com/en-us/exchange/permissions-exo/role-assignment-policies'\n\n  ensure_installing_outlook_addins_not_allowed_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    Get-EXOMailbox |\n    Select-Object -Unique RoleAssignmentPolicy |\n    ForEach-Object {\n        $policy = Get-RoleAssignmentPolicy -Identity $_.RoleAssignmentPolicy\n        $appsRoles = $policy.AssignedRoles | Where-Object {$_ -like \"*Apps*\"}\n\n        if ($appsRoles -contains \"My Custom Apps\" -or\n            $appsRoles -contains \"My Marketplace Apps\" -or\n            $appsRoles -contains \"My ReadWriteMailbox Apps\") {\n\n            $policy.Identity\n        }\n    }\n    }\n  powershell_output = powershell(ensure_installing_outlook_addins_not_allowed_script).stdout.strip\n  error_identities = powershell_output.split(\"\\n\") unless powershell_output.empty?\n  describe 'Ensure the number of policies that contain My Custom Apps, My Marketplace Apps, or My ReadWriteMailboxApps' do\n    subject { powershell_output }\n    it 'is 0' do\n      failure_message = \"Identites of policies breaking the rules: #{error_identities}\"\n      expect(subject).to be_empty, failure_message\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-6.3.1.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the number of policies that contain My Custom Apps, My Marketplace Apps, or My ReadWriteMailboxApps is 0","run_time":0.002565,"start_time":"2024-09-24T15:51:33-04:00","message":"Identites of policies breaking the rules: [\"Default Role Assignment Policy\"]","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the number of policies that contain My Custom Apps, My Marketplace Apps, or My ReadWriteMailboxApps"}]},{"id":"microsoft-365-foundations-6.4.1","title":"Ensure mail forwarding rules are reviewed at least weekly","desc":"The Exchange Online environment can be configured in a way that allows for automatic forwarding of e-mail. This can be done using Transport Rules in the Admin Center, Auto Forwarding per mailbox, and client-based rules in Outlook. Administrators and users both are given several methods to automatically and quickly send e-mails outside of your organization.","descriptions":[{"label":"default","data":"The Exchange Online environment can be configured in a way that allows for automatic forwarding of e-mail. This can be done using Transport Rules in the Admin Center, Auto Forwarding per mailbox, and client-based rules in Outlook. Administrators and users both are given several methods to automatically and quickly send e-mails outside of your organization."},{"label":"check","data":"To verify mail forwarding rules are being reviewed at least weekly, confirm that the necessary procedures are in place and being followed by the assigned employee."},{"label":"fix","data":"To review mail forwarding rules:\n        1. Navigate to Exchange admin center https://admin.exchange.microsoft.com.\n        2. Expand Reports then select Mail flow.\n        3. Click on Auto forwarded messages report.\n        4. Review.\n    Note: Mail flow reports cannot be viewed from the Classic Exchange Admin Center\n    To review mail forwarding rules using PowerShell:\n        1. Connect to Exchange Online PowerShell using Connect-ExchangeOnline\n            # Uses the administrator user credential to export Mail forwarding rules, User Delegates\n            # and SMTP Forwarding policies to multiple csv files.\n            $allUsers = Get-User -ResultSize Unlimited -Filter {RecipientTypeDetails -eq \"UserMailbox\" } | Where-Object {$_.AccountDisabled -like \"False\"}\n            $UserInboxRules = @()\n            $UserDelegates = @()\n            foreach ($User in $allUsers) {\n                Write-Host \"Checking inbox rules and delegates for user: \" $User.UserPrincipalName $UserInboxRules += Get-InboxRule -Mailbox $User.UserPrincipalName | Select-Object Name, Description, Enabled, Priority, ForwardTo, ForwardAsAttachmentTo, RedirectTo, DeleteMessage | Where-Object { ($_.ForwardTo -ne $null) -or ($_.ForwardAsAttachmentTo -ne $null) -or ($_.RedirectsTo -ne $null) } $UserDelegates += Get-MailboxPermission -Identity $User.UserPrincipalName | Where-Object { ($_.IsInherited -ne \"True\") -and ($_.User -notlike \"*SELF*\") }\n            }\n            $SMTPForwarding = Get-Mailbox -ResultSize Unlimited | Select-Object DisplayName, ForwardingAddress, ForwardingSMTPAddress, DeliverToMailboxandForward | Where-Object {$_.ForwardingSMTPAddress -ne $null}\n            # Export list of inbox rules, delegates, and SMTP forwards\n            $UserInboxRules | Export-Csv MailForwardingRulesToExternalDomains.csv -NoTypeInformation\n            $UserDelegates | Export-Csv MailboxDelegatePermissions.csv -NoTypeInformation\n            $SMTPForwarding | Export-Csv Mailboxsmtpforwarding.csv -NoTypeInformation"},{"label":"rationale","data":"Reviewing mail forwarding rules will provide the Messaging Administrator with insight\n        into possible attempts to exfiltrate data from the organization. Weekly review helps\n        create a recognition of baseline, legitimate activity of users. This will aid in helping\n        identify the more malicious activity of bad actors when/if they choose to use this side-\n        channel."}],"impact":0.5,"refs":[],"tags":{"severity":"medium","cis_controls":[{"8":["8.11"]},{"7":["6.2"]}],"nist":["AU-6","AU-6(1)","AU-7(1)","AC-1","AC-2","AC-2(1)"]},"code":"control 'microsoft-365-foundations-6.4.1' do\n  title 'Ensure mail forwarding rules are reviewed at least weekly'\n  desc 'The Exchange Online environment can be configured in a way that allows for automatic forwarding of e-mail. This can be done using Transport Rules in the Admin Center, Auto Forwarding per mailbox, and client-based rules in Outlook. Administrators and users both are given several methods to automatically and quickly send e-mails outside of your organization.'\n\n  desc 'check',\n       'To verify mail forwarding rules are being reviewed at least weekly, confirm that the necessary procedures are in place and being followed by the assigned employee.'\n\n  desc 'fix',\n       'To review mail forwarding rules:\n        1. Navigate to Exchange admin center https://admin.exchange.microsoft.com.\n        2. Expand Reports then select Mail flow.\n        3. Click on Auto forwarded messages report.\n        4. Review.\n    Note: Mail flow reports cannot be viewed from the Classic Exchange Admin Center\n    To review mail forwarding rules using PowerShell:\n        1. Connect to Exchange Online PowerShell using Connect-ExchangeOnline\n            # Uses the administrator user credential to export Mail forwarding rules, User Delegates\n            # and SMTP Forwarding policies to multiple csv files.\n            $allUsers = Get-User -ResultSize Unlimited -Filter {RecipientTypeDetails -eq \"UserMailbox\" } | Where-Object {$_.AccountDisabled -like \"False\"}\n            $UserInboxRules = @()\n            $UserDelegates = @()\n            foreach ($User in $allUsers) {\n                Write-Host \"Checking inbox rules and delegates for user: \" $User.UserPrincipalName $UserInboxRules += Get-InboxRule -Mailbox $User.UserPrincipalName | Select-Object Name, Description, Enabled, Priority, ForwardTo, ForwardAsAttachmentTo, RedirectTo, DeleteMessage | Where-Object { ($_.ForwardTo -ne $null) -or ($_.ForwardAsAttachmentTo -ne $null) -or ($_.RedirectsTo -ne $null) } $UserDelegates += Get-MailboxPermission -Identity $User.UserPrincipalName | Where-Object { ($_.IsInherited -ne \"True\") -and ($_.User -notlike \"*SELF*\") }\n            }\n            $SMTPForwarding = Get-Mailbox -ResultSize Unlimited | Select-Object DisplayName, ForwardingAddress, ForwardingSMTPAddress, DeliverToMailboxandForward | Where-Object {$_.ForwardingSMTPAddress -ne $null}\n            # Export list of inbox rules, delegates, and SMTP forwards\n            $UserInboxRules | Export-Csv MailForwardingRulesToExternalDomains.csv -NoTypeInformation\n            $UserDelegates | Export-Csv MailboxDelegatePermissions.csv -NoTypeInformation\n            $SMTPForwarding | Export-Csv Mailboxsmtpforwarding.csv -NoTypeInformation'\n\n  desc 'rationale',\n       'Reviewing mail forwarding rules will provide the Messaging Administrator with insight\n        into possible attempts to exfiltrate data from the organization. Weekly review helps\n        create a recognition of baseline, legitimate activity of users. This will aid in helping\n        identify the more malicious activity of bad actors when/if they choose to use this side-\n        channel.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['8.11'] }, { '7' => ['6.2'] }]\n  tag nist: ['AU-6', 'AU-6(1)', 'AU-7(1)', 'AC-1', 'AC-2', 'AC-2(1)']\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-6.4.1.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":9.0e-06,"start_time":"2024-09-24T15:51:33-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-6.5.1","title":"Ensure modern authentication for Exchange Online is enabled","desc":"Modern authentication in Microsoft 365 enables authentication features like multifactor authentication (MFA) using smart cards, certificate-based authentication (CBA), and third-party SAML identity providers. When you enable modern authentication in Exchange Online, Outlook 2016 and Outlook 2013 use modern authentication to log in to Microsoft 365 mailboxes. When you disable modern authentication in Exchange Online, Outlook 2016 and Outlook 2013 use basic authentication to log in to Microsoft 365 mailboxes.\n        When users initially configure certain email clients, like Outlook 2013 and Outlook 2016, they may be required to authenticate using enhanced authentication mechanisms, such as multifactor authentication. Other Outlook clients that are available in Microsoft 365 (for example, Outlook Mobile and Outlook for Mac 2016) always use modern authentication to log in to Microsoft 365 mailboxes.","descriptions":[{"label":"default","data":"Modern authentication in Microsoft 365 enables authentication features like multifactor authentication (MFA) using smart cards, certificate-based authentication (CBA), and third-party SAML identity providers. When you enable modern authentication in Exchange Online, Outlook 2016 and Outlook 2013 use modern authentication to log in to Microsoft 365 mailboxes. When you disable modern authentication in Exchange Online, Outlook 2016 and Outlook 2013 use basic authentication to log in to Microsoft 365 mailboxes.\n        When users initially configure certain email clients, like Outlook 2013 and Outlook 2016, they may be required to authenticate using enhanced authentication mechanisms, such as multifactor authentication. Other Outlook clients that are available in Microsoft 365 (for example, Outlook Mobile and Outlook for Mac 2016) always use modern authentication to log in to Microsoft 365 mailboxes."},{"label":"check","data":"To audit using PowerShell:\n        1. Run the Microsoft Exchange Online PowerShell Module.\n        2. Connect to Exchange Online using Connect-ExchangeOnline.\n        3. Run the following PowerShell command:\n            Get-OrganizationConfig | Format-Table -Auto Name, OAuth*\n        4. Verify OAuth2ClientProfileEnabled is True."},{"label":"fix","data":"To remediate using PowerShell:\n        1. Run the Microsoft Exchange Online PowerShell Module.\n        2. Connect to Exchange Online using Connect-ExchangeOnline.\n        3. Run the following PowerShell command:\n            Set-OrganizationConfig -OAuth2ClientProfileEnabled $True"},{"label":"rationale","data":"Strong authentication controls, such as the use of multifactor authentication, may be\n        circumvented if basic authentication is used by Exchange Online email clients such as\n        Outlook 2016 and Outlook 2013. Enabling modern authentication for Exchange Online\n        ensures strong authentication mechanisms are used when establishing sessions\n        between email clients and Exchange Online."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/exchange/clients-and-mobile-in-exchange-online/enable-or-disable-modern-authentication-in-exchange-online"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.10"]},{"7":["16.3"]},{"7":["16.5"]}],"default_value":"True","nist":["AC-17(2)","IA-5","IA-5(1)","SC-8","SC-8(1)","SI-2","SR-11"]},"code":"control 'microsoft-365-foundations-6.5.1' do\n  title 'Ensure modern authentication for Exchange Online is enabled'\n  desc \"Modern authentication in Microsoft 365 enables authentication features like multifactor authentication (MFA) using smart cards, certificate-based authentication (CBA), and third-party SAML identity providers. When you enable modern authentication in Exchange Online, Outlook 2016 and Outlook 2013 use modern authentication to log in to Microsoft 365 mailboxes. When you disable modern authentication in Exchange Online, Outlook 2016 and Outlook 2013 use basic authentication to log in to Microsoft 365 mailboxes.\n        When users initially configure certain email clients, like Outlook 2013 and Outlook 2016, they may be required to authenticate using enhanced authentication mechanisms, such as multifactor authentication. Other Outlook clients that are available in Microsoft 365 (for example, Outlook Mobile and Outlook for Mac 2016) always use modern authentication to log in to Microsoft 365 mailboxes.\"\n\n  desc 'check',\n       \"To audit using PowerShell:\n        1. Run the Microsoft Exchange Online PowerShell Module.\n        2. Connect to Exchange Online using Connect-ExchangeOnline.\n        3. Run the following PowerShell command:\n            Get-OrganizationConfig | Format-Table -Auto Name, OAuth*\n        4. Verify OAuth2ClientProfileEnabled is True.\"\n\n  desc 'fix',\n       \"To remediate using PowerShell:\n        1. Run the Microsoft Exchange Online PowerShell Module.\n        2. Connect to Exchange Online using Connect-ExchangeOnline.\n        3. Run the following PowerShell command:\n            Set-OrganizationConfig -OAuth2ClientProfileEnabled $True\"\n\n  desc 'rationale',\n       'Strong authentication controls, such as the use of multifactor authentication, may be\n        circumvented if basic authentication is used by Exchange Online email clients such as\n        Outlook 2016 and Outlook 2013. Enabling modern authentication for Exchange Online\n        ensures strong authentication mechanisms are used when establishing sessions\n        between email clients and Exchange Online.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [\n    { '8' => ['3.10'] },\n    { '7' => ['16.3'] },\n    { '7' => ['16.5'] }\n  ]\n  tag default_value: 'True'\n  tag nist: ['AC-17(2)', 'IA-5', 'IA-5(1)', 'SC-8', 'SC-8(1)', 'SI-2', 'SR-11']\n\n  ref 'https://learn.microsoft.com/en-us/exchange/clients-and-mobile-in-exchange-online/enable-or-disable-modern-authentication-in-exchange-online'\n\n  ensure_modern_authentication_for_exchange_enabled_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    (Get-OrganizationConfig).OAuth2ClientProfileEnabled\n }\n\n  powershell_output = powershell(ensure_modern_authentication_for_exchange_enabled_script)\n  describe 'Ensure the OAuth2ClientProfileEnabled state from Get-OrganizationConfig' do\n    subject { powershell_output.stdout.strip }\n    it 'is set to True' do\n      expect(subject).to eq('True')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-6.5.1.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure the OAuth2ClientProfileEnabled state from Get-OrganizationConfig is set to True","run_time":8.435475,"start_time":"2024-09-24T15:51:33-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the OAuth2ClientProfileEnabled state from Get-OrganizationConfig"}]},{"id":"microsoft-365-foundations-6.5.2","title":"Ensure MailTips are enabled for end users","desc":"MailTips are informative messages displayed to users while they're composing a message. While a new message is open and being composed, Exchange analyzes the message (including recipients). If a potential problem is detected, the user is notified with a MailTip prior to sending the message. Using the information in the MailTip, the user can adjust the message to avoid undesirable situations or non-delivery reports (also known as NDRs or bounce messages).","descriptions":[{"label":"default","data":"MailTips are informative messages displayed to users while they're composing a message. While a new message is open and being composed, Exchange analyzes the message (including recipients). If a potential problem is detected, the user is notified with a MailTip prior to sending the message. Using the information in the MailTip, the user can adjust the message to avoid undesirable situations or non-delivery reports (also known as NDRs or bounce messages)."},{"label":"check","data":"To audit using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Get-OrganizationConfig | fl MailTips*\n        3. Verify the values for MailTipsAllTipsEnabled, MailTipsExternalRecipientsTipsEnabled, and MailTipsGroupMetricsEnabled are set to True and MailTipsLargeAudienceThreshold is set to an acceptable value; 25 is the default value."},{"label":"fix","data":"To remediate using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            $TipsParams = @{ MailTipsAllTipsEnabled = $true MailTipsExternalRecipientsTipsEnabled = $true MailTipsGroupMetricsEnabled = $true MailTipsLargeAudienceThreshold = '25' }\n            Set-OrganizationConfig @TipsParams"},{"label":"rationale","data":"Setting up MailTips gives a visual aid to users when they send emails to large groups of\n        recipients or send emails to recipients not within the tenant."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/exchange/clients-and-mobile-in-exchange-online/mailtips/mailtips"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/exchange/set-organizationconfig?view=exchange-ps"}],"tags":{"severity":"medium","default_value":"MailTipsAllTipsEnabled: True MailTipsExternalRecipientsTipsEnabled: False\n                      MailTipsGroupMetricsEnabled: True MailTipsLargeAudienceThreshold: 25","cis_controls":[{"8":["untracked"]}],"nist":["CM-6"]},"code":"control 'microsoft-365-foundations-6.5.2' do\n  title 'Ensure MailTips are enabled for end users'\n  desc \"MailTips are informative messages displayed to users while they're composing a message. While a new message is open and being composed, Exchange analyzes the message (including recipients). If a potential problem is detected, the user is notified with a MailTip prior to sending the message. Using the information in the MailTip, the user can adjust the message to avoid undesirable situations or non-delivery reports (also known as NDRs or bounce messages).\"\n\n  desc 'check',\n       \"To audit using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Get-OrganizationConfig | fl MailTips*\n        3. Verify the values for MailTipsAllTipsEnabled, MailTipsExternalRecipientsTipsEnabled, and MailTipsGroupMetricsEnabled are set to True and MailTipsLargeAudienceThreshold is set to an acceptable value; 25 is the default value.\"\n\n  desc 'fix',\n       \"To remediate using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            $TipsParams = @{ MailTipsAllTipsEnabled = $true MailTipsExternalRecipientsTipsEnabled = $true MailTipsGroupMetricsEnabled = $true MailTipsLargeAudienceThreshold = '25' }\n            Set-OrganizationConfig @TipsParams\"\n\n  desc 'rationale',\n       'Setting up MailTips gives a visual aid to users when they send emails to large groups of\n        recipients or send emails to recipients not within the tenant.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag default_value: 'MailTipsAllTipsEnabled: True MailTipsExternalRecipientsTipsEnabled: False\n                      MailTipsGroupMetricsEnabled: True MailTipsLargeAudienceThreshold: 25'\n  tag cis_controls: [{ '8' => ['untracked'] }]\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-us/exchange/clients-and-mobile-in-exchange-online/mailtips/mailtips'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/exchange/set-organizationconfig?view=exchange-ps'\n\n  ensure_mailtip_enabled_for_end_users_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    Get-OrganizationConfig | Select-Object -Property MailTips* | ConvertTo-Json\n }\n  powershell_output = powershell(ensure_mailtip_enabled_for_end_users_script).stdout.strip\n  mailtips_settings = JSON.parse(powershell_output)\n  describe 'Ensure that the MailTip setting' do\n    subject { powershell_output }\n    it 'MailTipsAllTipsEnabled should be set to True' do\n      expect(mailtips_settings['MailTipsAllTipsEnabled']).to eq(true)\n    end\n    it 'MailTipsExternalRecipientsTipsEnabled should be set to True' do\n      expect(mailtips_settings['MailTipsExternalRecipientsTipsEnabled']).to eq(true)\n    end\n    it 'MailTipsGroupMetricsEnabled should be set to True' do\n      expect(mailtips_settings['MailTipsGroupMetricsEnabled']).to eq(true)\n    end\n    it 'MailTipsLargeAudienceThreshold should be set to an acceptable value' do\n      expect(mailtips_settings['MailTipsLargeAudienceThreshold']).to eq(input('mailtipslargeaudiencethreshold_value'))\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-6.5.2.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure that the MailTip setting MailTipsAllTipsEnabled should be set to True","run_time":7.0e-05,"start_time":"2024-09-24T15:51:41-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the MailTip setting"},{"status":"failed","code_desc":"Ensure that the MailTip setting MailTipsExternalRecipientsTipsEnabled should be set to True","run_time":0.002955,"start_time":"2024-09-24T15:51:41-04:00","message":"\nexpected: true\n     got: false\n\n(compared using ==)\n\nDiff:\n@@ -1 +1 @@\n-true\n+false\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the MailTip setting"},{"status":"passed","code_desc":"Ensure that the MailTip setting MailTipsGroupMetricsEnabled should be set to True","run_time":4.1e-05,"start_time":"2024-09-24T15:51:41-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the MailTip setting"},{"status":"passed","code_desc":"Ensure that the MailTip setting MailTipsLargeAudienceThreshold should be set to an acceptable value","run_time":6.2e-05,"start_time":"2024-09-24T15:51:41-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the MailTip setting"}]},{"id":"microsoft-365-foundations-6.5.3","title":"Ensure additional storage providers are restricted in Outlook on the web","desc":"This setting allows users to open certain external files while working in Outlook on the web. If allowed, keep in mind that Microsoft doesn't control the use terms or privacy policies of those third-party services.\n        Ensure AdditionalStorageProvidersAvailable are restricted.","descriptions":[{"label":"default","data":"This setting allows users to open certain external files while working in Outlook on the web. If allowed, keep in mind that Microsoft doesn't control the use terms or privacy policies of those third-party services.\n        Ensure AdditionalStorageProvidersAvailable are restricted."},{"label":"check","data":"To audit using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Get-OwaMailboxPolicy | Format-Table Name, AdditionalStorageProvidersAvailable\n        3. Verify that the value returned is False."},{"label":"fix","data":"To remediate using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Set-OwaMailboxPolicy -Identity OwaMailboxPolicy-Default -AdditionalStorageProvidersAvailable $false"},{"label":"rationale","data":"By default additional storage providers are allowed in Office on the Web (such as Box,\n        Dropbox, Facebook, Google Drive, OneDrive Personal, etc.). This could lead to\n        information leakage and additional risk of infection from organizational non-trusted\n        storage providers. Restricting this will inherently reduce risk as it will narrow\n        opportunities for infection and data leakage."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/powershell/module/exchange/set-owamailboxpolicy?view=exchange-ps"},{"ref":"https://support.microsoft.com/en-us/topic/3rd-party-cloud-storage-services-supported-by-office-apps-fce12782-eccc-4cf5-8f4b-d1ebec513f72"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.3"]},{"7":["13.1"]},{"7":["13.4"]}],"default_value":"Additional Storage Providers - True","nist":["AC-3","AC-5","AC-6","MP-2","AU-6(1)","AU-7","IR-4(1)","SI-4(2)","SI-4(5)","CA-9","SC-7"]},"code":"control 'microsoft-365-foundations-6.5.3' do\n  title 'Ensure additional storage providers are restricted in Outlook on the web'\n  desc \"This setting allows users to open certain external files while working in Outlook on the web. If allowed, keep in mind that Microsoft doesn't control the use terms or privacy policies of those third-party services.\n        Ensure AdditionalStorageProvidersAvailable are restricted.\"\n\n  desc 'check',\n       \"To audit using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Get-OwaMailboxPolicy | Format-Table Name, AdditionalStorageProvidersAvailable\n        3. Verify that the value returned is False.\"\n\n  desc 'fix',\n       \"To remediate using PowerShell:\n        1. Connect to Exchange Online using Connect-ExchangeOnline.\n        2. Run the following PowerShell command:\n            Set-OwaMailboxPolicy -Identity OwaMailboxPolicy-Default -AdditionalStorageProvidersAvailable $false\"\n\n  desc 'rationale',\n       'By default additional storage providers are allowed in Office on the Web (such as Box,\n        Dropbox, Facebook, Google Drive, OneDrive Personal, etc.). This could lead to\n        information leakage and additional risk of infection from organizational non-trusted\n        storage providers. Restricting this will inherently reduce risk as it will narrow\n        opportunities for infection and data leakage.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [\n    { '8' => ['3.3'] },\n    { '7' => ['13.1'] },\n    { '7' => ['13.4'] }\n  ]\n  tag default_value: 'Additional Storage Providers - True'\n  tag nist: ['AC-3', 'AC-5', 'AC-6', 'MP-2', 'AU-6(1)', 'AU-7', 'IR-4(1)', 'SI-4(2)', 'SI-4(5)', 'CA-9', 'SC-7']\n\n  ref 'https://learn.microsoft.com/en-us/powershell/module/exchange/set-owamailboxpolicy?view=exchange-ps'\n  ref 'https://support.microsoft.com/en-us/topic/3rd-party-cloud-storage-services-supported-by-office-apps-fce12782-eccc-4cf5-8f4b-d1ebec513f72'\n\n  ensure_additional_storage_providers_restricted_web_outlook_script = %{\n    $client_id = '#{input('client_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    (Get-OwaMailboxPolicy).AdditionalStorageProvidersAvailable\n }\n\n  powershell_output = powershell(ensure_additional_storage_providers_restricted_web_outlook_script)\n  describe 'Ensure the AdditionalStorageProvidersAvailable option from Get-OwaMailboxPolicy' do\n    subject { powershell_output.stdout.strip }\n    it 'is set to False' do\n      expect(subject).to eq('False')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-6.5.3.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the AdditionalStorageProvidersAvailable option from Get-OwaMailboxPolicy is set to False","run_time":8.814445,"start_time":"2024-09-24T15:51:41-04:00","message":"\nexpected: \"False\"\n     got: \"True\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the AdditionalStorageProvidersAvailable option from Get-OwaMailboxPolicy"}]},{"id":"microsoft-365-foundations-7.2.1","title":"Ensure modern authentication for SharePoint applications is required","desc":"Modern authentication in Microsoft 365 enables authentication features like multifactor authentication (MFA) using smart cards, certificate-based authentication (CBA), and third-party SAML identity providers.","descriptions":[{"label":"default","data":"Modern authentication in Microsoft 365 enables authentication features like multifactor authentication (MFA) using smart cards, certificate-based authentication (CBA), and third-party SAML identity providers."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint.\n        2. Click to expand Policies select Access control.\n        3. Select Apps that don't use modern authentication and ensure that it is set to Block access.\n    To audit using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService -Url https://tenant-admin.sharepoint.com replacing tenant with your value.\n        2. Run the following SharePoint Online PowerShell command:\n            Get-SPOTenant | ft LegacyAuthProtocolsEnabled\n        3. Ensure the returned value is False."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint.\n        2. Click to expand Policies select Access control.\n        3. Select Apps that don't use modern authentication.\n        4. Select the radio button for Block access.\n        5. Click Save.\n    To remediate using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService -Url https://tenant-admin.sharepoint.com replacing tenant with your value.\n        2. Run the following SharePoint Online PowerShell command:\n            Set-SPOTenant -LegacyAuthProtocolsEnabled $false"},{"label":"rationale","data":"Strong authentication controls, such as the use of multifactor authentication, may be\n        circumvented if basic authentication is used by SharePoint applications. Requiring\n        modern authentication for SharePoint applications ensures strong authentication\n        mechanisms are used when establishing sessions between these applications,\n        SharePoint, and connecting users."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/powershell/module/sharepoint-online/set-spotenant?view=sharepoint-ps"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.10"]},{"7":["16.3"]}],"default_value":"True (Apps that don't use modern authentication are allowed)","nist":["AC-17(2)","IA-5","IA-5(1)","SC-8","SC-8(1)","SI-2"]},"code":"control 'microsoft-365-foundations-7.2.1' do\n  title 'Ensure modern authentication for SharePoint applications is required'\n  desc 'Modern authentication in Microsoft 365 enables authentication features like multifactor authentication (MFA) using smart cards, certificate-based authentication (CBA), and third-party SAML identity providers.'\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint.\n        2. Click to expand Policies select Access control.\n        3. Select Apps that don't use modern authentication and ensure that it is set to Block access.\n    To audit using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService -Url https://tenant-admin.sharepoint.com replacing tenant with your value.\n        2. Run the following SharePoint Online PowerShell command:\n            Get-SPOTenant | ft LegacyAuthProtocolsEnabled\n        3. Ensure the returned value is False.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint.\n        2. Click to expand Policies select Access control.\n        3. Select Apps that don't use modern authentication.\n        4. Select the radio button for Block access.\n        5. Click Save.\n    To remediate using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService -Url https://tenant-admin.sharepoint.com replacing tenant with your value.\n        2. Run the following SharePoint Online PowerShell command:\n            Set-SPOTenant -LegacyAuthProtocolsEnabled $false\"\n\n  desc 'rationale',\n       'Strong authentication controls, such as the use of multifactor authentication, may be\n        circumvented if basic authentication is used by SharePoint applications. Requiring\n        modern authentication for SharePoint applications ensures strong authentication\n        mechanisms are used when establishing sessions between these applications,\n        SharePoint, and connecting users.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['3.10'] }, { '7' => ['16.3'] }]\n  tag default_value: \"True (Apps that don't use modern authentication are allowed)\"\n  tag nist: ['AC-17(2)', 'IA-5', 'IA-5(1)', 'SC-8', 'SC-8(1)', 'SI-2']\n\n  ref 'https://learn.microsoft.com/en-us/powershell/module/sharepoint-online/set-spotenant?view=sharepoint-ps'\n\n  ensure_modern_authentication_spo_applications_required_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $sharepoint_admin_url = '#{input('sharepoint_admin_url')}'\n    import-module pnp.powershell\n    $password = (ConvertTo-SecureString -AsPlainText $certificate_password -Force)\n    Connect-PnPOnline -Url $sharepoint_admin_url -ClientId $client_id -CertificatePath $certificate_path -CertificatePassword $password  -Tenant $tenantid\n\t(Get-PnPTenant).LegacyAuthProtocolsEnabled\n  }\n  powershell_output = powershell(ensure_modern_authentication_spo_applications_required_script).stdout.strip\n  describe 'Ensure the LegacyAuthProtocolsEnabled option for SharePoint' do\n    subject { powershell_output }\n    it 'is set to False' do\n      expect(subject).to eq('False')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-7.2.1.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the LegacyAuthProtocolsEnabled option for SharePoint is set to False","run_time":0.000128,"start_time":"2024-09-24T15:51:50-04:00","message":"\nexpected: \"False\"\n     got: \"True\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the LegacyAuthProtocolsEnabled option for SharePoint"}]},{"id":"microsoft-365-foundations-7.2.10","title":"Ensure reauthentication with verification code is restricted","desc":"This setting configures if guests who use a verification code to access the site or links are required to reauthenticate after a set number of days.\n        The recommended state is 15 or less.","descriptions":[{"label":"default","data":"This setting configures if guests who use a verification code to access the site or links are required to reauthenticate after a set number of days.\n        The recommended state is 15 or less."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Scroll to and expand More external sharing settings.\n        4. Ensure People who use a verification code must reauthenticate after this many days is set to 15 or less.\n    To audit using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following cmdlet:\n            Get-SPOTenant | fl EmailAttestationRequired,EmailAttestationReAuthDays\n        3. Ensure the following values are returned:\n            o EmailAttestationRequired True\n            o EmailAttestationReAuthDays 15 or less days."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Scroll to and expand More external sharing settings.\n        4. Set People who use a verification code must reauthenticate after this many days to 15 or less.\n    To remediate using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following cmdlet:\n            Set-SPOTenant -EmailAttestationRequired $true -EmailAttestationReAuthDays 15"},{"label":"rationale","data":"By increasing the frequency of times guests need to reauthenticate this ensures guest\n        user access to data is not prolonged beyond an acceptable amount of time."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-US/sharepoint/what-s-new-in-sharing-in-targeted-release?WT.mc_id=365AdminCSH_spo"},{"ref":"https://learn.microsoft.com/en-US/sharepoint/turn-external-sharing-on-or-off?WT.mc_id=365AdminCSH_spo#change-the-organization-level-external-sharing-setting"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/external-identities/one-time-passcode"}],"tags":{"severity":"medium","default_value":"EmailAttestationRequired : False\n                      EmailAttestationReAuthDays : 30","cis_controls":[{"8":["untracked"]},{"7":["untracked"]}],"nist":["CM-6"]},"code":"control 'microsoft-365-foundations-7.2.10' do\n  title 'Ensure reauthentication with verification code is restricted'\n  desc \"This setting configures if guests who use a verification code to access the site or links are required to reauthenticate after a set number of days.\n        The recommended state is 15 or less.\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Scroll to and expand More external sharing settings.\n        4. Ensure People who use a verification code must reauthenticate after this many days is set to 15 or less.\n    To audit using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following cmdlet:\n            Get-SPOTenant | fl EmailAttestationRequired,EmailAttestationReAuthDays\n        3. Ensure the following values are returned:\n            o EmailAttestationRequired True\n            o EmailAttestationReAuthDays 15 or less days.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Scroll to and expand More external sharing settings.\n        4. Set People who use a verification code must reauthenticate after this many days to 15 or less.\n    To remediate using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following cmdlet:\n            Set-SPOTenant -EmailAttestationRequired $true -EmailAttestationReAuthDays 15\"\n\n  desc 'rationale',\n       'By increasing the frequency of times guests need to reauthenticate this ensures guest\n        user access to data is not prolonged beyond an acceptable amount of time.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag default_value: 'EmailAttestationRequired : False\n                      EmailAttestationReAuthDays : 30'\n  tag cis_controls: [{ '8' => ['untracked'] }, { '7' => ['untracked'] }]\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-US/sharepoint/what-s-new-in-sharing-in-targeted-release?WT.mc_id=365AdminCSH_spo'\n  ref 'https://learn.microsoft.com/en-US/sharepoint/turn-external-sharing-on-or-off?WT.mc_id=365AdminCSH_spo#change-the-organization-level-external-sharing-setting'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/external-identities/one-time-passcode'\n\n  ensure_reauth_with_verification_code_restricted = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $sharepoint_admin_url = '#{input('sharepoint_admin_url')}'\n    import-module pnp.powershell\n    $password = (ConvertTo-SecureString -AsPlainText $certificate_password -Force)\n    Connect-PnPOnline -Url $sharepoint_admin_url -ClientId $client_id -CertificatePath $certificate_path -CertificatePassword $password  -Tenant $tenantid\n\t  Get-PnPTenant | Select-Object EmailAttestationRequired, EmailAttestationReAuthDays | ConvertTo-Json\n  }\n\n  powershell_output = JSON.parse(powershell(ensure_reauth_with_verification_code_restricted).stdout.strip)\n  describe 'Ensure the following setting' do\n    subject { powershell_output }\n    it 'EmailAttestationRequired in SharePoint is set to True' do\n      expect(subject['EmailAttestationRequired']).to eq(true)\n    end\n    it 'EmailAttestationReAuthDays in SharePoint is less than or equal to 15' do\n      expect(subject['EmailAttestationReAuthDays']).to be <= 15\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-7.2.10.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the following setting EmailAttestationRequired in SharePoint is set to True","run_time":0.001702,"start_time":"2024-09-24T15:51:50-04:00","message":"\nexpected: true\n     got: false\n\n(compared using ==)\n\nDiff:\n@@ -1 +1 @@\n-true\n+false\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following setting"},{"status":"failed","code_desc":"Ensure the following setting EmailAttestationReAuthDays in SharePoint is less than or equal to 15","run_time":0.000134,"start_time":"2024-09-24T15:51:50-04:00","message":"expected: <= 15\n     got:    30","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following setting"}]},{"id":"microsoft-365-foundations-7.2.2","title":"Ensure SharePoint and OneDrive integration with Azure AD B2B is enabled","desc":"Entra ID B2B provides authentication and management of guests. Authentication happens via one-time passcode when they don't already have a work or school account or a Microsoft account. Integration with SharePoint and OneDrive allows for more granular control of how guest user accounts are managed in the organization's AAD, unifying a similar guest experience already deployed in other Microsoft 365 services such as Teams.\n        Note: Global Reader role currently can't access SharePoint using PowerShell.","descriptions":[{"label":"default","data":"Entra ID B2B provides authentication and management of guests. Authentication happens via one-time passcode when they don't already have a work or school account or a Microsoft account. Integration with SharePoint and OneDrive allows for more granular control of how guest user accounts are managed in the organization's AAD, unifying a similar guest experience already deployed in other Microsoft 365 services such as Teams.\n        Note: Global Reader role currently can't access SharePoint using PowerShell."},{"label":"check","data":"To audit using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService\n        2. Run the following command:\n            Get-SPOTenant | ft EnableAzureADB2BIntegration\n        3. Ensure the returned value is True."},{"label":"fix","data":"To remediate using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService\n        2. Run the following command:\n            Set-SPOTenant -EnableAzureADB2BIntegration $true"},{"label":"rationale","data":"External users assigned guest accounts will be subject to Entra ID access policies, such\n        as multi-factor authentication. This provides a way to manage guest identities and\n        control access to SharePoint and OneDrive resources. Without this integration, files can\n        be shared without account registration, making it more challenging to audit and manage\n        who has access to the organization's data."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/sharepoint/sharepoint-azureb2b-integration#enabling-the-integration"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/external-identities/what-is-b2b"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/sharepoint-online/set-spotenant?view=sharepoint-ps"}],"tags":{"severity":"medium","default_value":"False","cis_controls":[{"8":["untracked"]}],"nist":["CM-6"]},"code":"control 'microsoft-365-foundations-7.2.2' do\n  title 'Ensure SharePoint and OneDrive integration with Azure AD B2B is enabled'\n  desc \"Entra ID B2B provides authentication and management of guests. Authentication happens via one-time passcode when they don't already have a work or school account or a Microsoft account. Integration with SharePoint and OneDrive allows for more granular control of how guest user accounts are managed in the organization's AAD, unifying a similar guest experience already deployed in other Microsoft 365 services such as Teams.\n        Note: Global Reader role currently can't access SharePoint using PowerShell.\"\n\n  desc 'check',\n       \"To audit using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService\n        2. Run the following command:\n            Get-SPOTenant | ft EnableAzureADB2BIntegration\n        3. Ensure the returned value is True.\"\n\n  desc 'fix',\n       \"To remediate using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService\n        2. Run the following command:\n            Set-SPOTenant -EnableAzureADB2BIntegration $true\"\n\n  desc 'rationale',\n       \"External users assigned guest accounts will be subject to Entra ID access policies, such\n        as multi-factor authentication. This provides a way to manage guest identities and\n        control access to SharePoint and OneDrive resources. Without this integration, files can\n        be shared without account registration, making it more challenging to audit and manage\n        who has access to the organization's data.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag default_value: 'False'\n  tag cis_controls: [{ '8' => ['untracked'] }]\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-us/sharepoint/sharepoint-azureb2b-integration#enabling-the-integration'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/external-identities/what-is-b2b'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/sharepoint-online/set-spotenant?view=sharepoint-ps'\n\n  ensure_spo_od_integration_with_azure_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $sharepoint_admin_url = '#{input('sharepoint_admin_url')}'\n    import-module pnp.powershell\n    $password = (ConvertTo-SecureString -AsPlainText $certificate_password -Force)\n    Connect-PnPOnline -Url $sharepoint_admin_url -ClientId $client_id -CertificatePath $certificate_path -CertificatePassword $password  -Tenant $tenantid\n\t  (Get-PnPTenant).EnableAzureADB2BIntegration\n  }\n  powershell_output = powershell(ensure_spo_od_integration_with_azure_script).stdout.strip\n  describe 'Ensure the EnableAzureADB2BIntegration option for SharePoint' do\n    subject { powershell_output }\n    it 'is set to True' do\n      expect(subject).to eq('True')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-7.2.2.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the EnableAzureADB2BIntegration option for SharePoint is set to True","run_time":9.0e-05,"start_time":"2024-09-24T15:51:50-04:00","message":"\nexpected: \"True\"\n     got: \"False\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the EnableAzureADB2BIntegration option for SharePoint"}]},{"id":"microsoft-365-foundations-7.2.3","title":"Ensure external content sharing is restricted","desc":"The external sharing settings govern sharing for the organization overall. Each site has its own sharing setting that can be set independently, though it must be at the same or more restrictive setting as the organization.\n        The new and existing guests option requires people who have received invitations to sign in with their work or school account (if their organization uses Microsoft 365) or a Microsoft account, or to provide a code to verify their identity. Users can share with guests already in your organization's directory, and they can send invitations to people who will be added to the directory if they sign in.\n        The recommended state is New and existing guests or less permissive.","descriptions":[{"label":"default","data":"The external sharing settings govern sharing for the organization overall. Each site has its own sharing setting that can be set independently, though it must be at the same or more restrictive setting as the organization.\n        The new and existing guests option requires people who have received invitations to sign in with their work or school account (if their organization uses Microsoft 365) or a Microsoft account, or to provide a code to verify their identity. Users can share with guests already in your organization's directory, and they can send invitations to people who will be added to the directory if they sign in.\n        The recommended state is New and existing guests or less permissive."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Locate the External sharing section.\n        4. Under SharePoint, ensure the slider bar is set to New and existing guests or a less permissive level.\n    To audit using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following cmdlet:\n            Get-SPOTenant | fl SharingCapability\n        3. Ensure SharingCapability is set to one of the following values:\n            o Value1: ExternalUserSharingOnly\n            o Value2: ExistingExternalUserSharingOnly\n            o Value3: Disabled"},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Locate the External sharing section.\n        4. Under SharePoint, move the slider bar to New and existing guests or a less permissive level.\n            o OneDrive will also be moved to the same level and can never be more permissive than SharePoint.\n    To remediate using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following cmdlet to establish the minimum recommended state: Set-SPOTenant -SharingCapability ExternalUserSharingOnly\n    Note: Other acceptable values for this parameter that are more restrictive include: Disabled and ExistingExternalUserSharingOnly."},{"label":"rationale","data":"Forcing guest authentication on the organization's tenant enables the implementation of\n        controls and oversight over external file sharing. When a guest is registered with the\n        organization, they now have an identity which can be accounted for. This identity can\n        also have other restrictions applied to it through group membership and conditional\n        access rules."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-US/sharepoint/turn-external-sharing-on-or-off?WT.mc_id=365AdminCSH_spo"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/sharepoint-online/set-spotenant?view=sharepoint-ps"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.3"]}],"default_value":"Anyone (ExternalUserAndGuestSharing)","nist":["AC-3","AC-5","AC-6","MP-2"]},"code":"control 'microsoft-365-foundations-7.2.3' do\n  title 'Ensure external content sharing is restricted'\n  desc \"The external sharing settings govern sharing for the organization overall. Each site has its own sharing setting that can be set independently, though it must be at the same or more restrictive setting as the organization.\n        The new and existing guests option requires people who have received invitations to sign in with their work or school account (if their organization uses Microsoft 365) or a Microsoft account, or to provide a code to verify their identity. Users can share with guests already in your organization's directory, and they can send invitations to people who will be added to the directory if they sign in.\n        The recommended state is New and existing guests or less permissive.\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Locate the External sharing section.\n        4. Under SharePoint, ensure the slider bar is set to New and existing guests or a less permissive level.\n    To audit using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following cmdlet:\n            Get-SPOTenant | fl SharingCapability\n        3. Ensure SharingCapability is set to one of the following values:\n            o Value1: ExternalUserSharingOnly\n            o Value2: ExistingExternalUserSharingOnly\n            o Value3: Disabled\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Locate the External sharing section.\n        4. Under SharePoint, move the slider bar to New and existing guests or a less permissive level.\n            o OneDrive will also be moved to the same level and can never be more permissive than SharePoint.\n    To remediate using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following cmdlet to establish the minimum recommended state: Set-SPOTenant -SharingCapability ExternalUserSharingOnly\n    Note: Other acceptable values for this parameter that are more restrictive include: Disabled and ExistingExternalUserSharingOnly.\"\n\n  desc 'rationale',\n       \"Forcing guest authentication on the organization's tenant enables the implementation of\n        controls and oversight over external file sharing. When a guest is registered with the\n        organization, they now have an identity which can be accounted for. This identity can\n        also have other restrictions applied to it through group membership and conditional\n        access rules.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['3.3'] }]\n  tag default_value: 'Anyone (ExternalUserAndGuestSharing)'\n  tag nist: ['AC-3', 'AC-5', 'AC-6', 'MP-2']\n\n  ref 'https://learn.microsoft.com/en-US/sharepoint/turn-external-sharing-on-or-off?WT.mc_id=365AdminCSH_spo'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/sharepoint-online/set-spotenant?view=sharepoint-ps'\n\n  acceptable_values = [\n    'ExternalUserSharingOnly',\n    'ExistingExternalUserSharingOnly',\n    'Disabled'\n  ]\n  ensure_external_content_sharing_restricted_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $sharepoint_admin_url = '#{input('sharepoint_admin_url')}'\n    import-module pnp.powershell\n    $password = (ConvertTo-SecureString -AsPlainText $certificate_password -Force)\n    Connect-PnPOnline -Url $sharepoint_admin_url -ClientId $client_id -CertificatePath $certificate_path -CertificatePassword $password  -Tenant $tenantid\n\t  (Get-PnPTenant).SharingCapability\n  }\n  powershell_output = powershell(ensure_external_content_sharing_restricted_script).stdout.strip\n  describe 'Ensure the SharingCapability option for SharePoint' do\n    subject { powershell_output }\n    it 'is set to either ExternalUserSharingOnly, ExistingExternalUserSharingOnly, or Disabled' do\n      expect(acceptable_values).to include(powershell_output)\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-7.2.3.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure the SharingCapability option for SharePoint is set to either ExternalUserSharingOnly, ExistingExternalUserSharingOnly, or Disabled","run_time":7.8e-05,"start_time":"2024-09-24T15:51:50-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the SharingCapability option for SharePoint"}]},{"id":"microsoft-365-foundations-7.2.4","title":"Ensure OneDrive content sharing is restricted","desc":"This setting governs the global permissiveness of OneDrive content sharing in the organization.\n        OneDrive content sharing can be restricted independent of SharePoint but can never be more permissive than the level established with SharePoint.\n        The recommended state is Only people in your organization","descriptions":[{"label":"default","data":"This setting governs the global permissiveness of OneDrive content sharing in the organization.\n        OneDrive content sharing can be restricted independent of SharePoint but can never be more permissive than the level established with SharePoint.\n        The recommended state is Only people in your organization"},{"label":"check","data":"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Locate the External sharing section.\n        4. Under OneDrive, ensure the slider bar is set to Only people in your organization.\n    To audit using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following cmdlet:\n            Get-SPOTenant | fl OneDriveSharingCapability\n        3. Ensure the returned value is Disabled.\n    Alternative audit method using PowerShell:\n        1. Connect to SharePoint Online.\n        2. Use one of the following methods:\n            # Replace [tenant] with your tenant id\n            Get-SPOSite -Identity https://[tenant]-my.sharepoint.com/ | fl Url,SharingCapability\n            # Or run this to filter to the specific site without supplying the tenant name.\n            $OneDriveSite = Get-SPOSite -Filter { Url -like \"*-my.sharepoint.com/\" }\n            Get-SPOSite -Identity $OneDriveSite | fl Url,SharingCapability\n        2. Ensure the returned value for SharingCapability is Disabled\n    Note: As of March 2024, using Get-SPOSite with Where-Object or filtering against the entire site and then returning the SharingCapability parameter can result in a different value as opposed to running the cmdlet specifically against the OneDrive specific site using the -Identity switch as shown in the example.\n    Note 2: The parameter OneDriveSharingCapability may not be yet fully available in all tenants. It is demonstrated in official Microsoft documentation as linked in the references section but not in the Set-SPOTenant cmdlet itself. If the parameter is unavailable, then either use the UI method or alternative PowerShell audit method."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Locate the External sharing section.\n        4. Under OneDrive, set the slider bar to Only people in your organization.\n    To remediate using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following cmdlet: Set-SPOTenant -OneDriveSharingCapability Disabled\n    Alternative remediation method using PowerShell:\n        1. Connect to SharePoint Online.\n        2. Run one of the following:\n            # Replace [tenant] with your tenant id\n            Set-SPOSite -Identity https://[tenant]-my.sharepoint.com/ -SharingCapability Disabled\n            # Or run this to filter to the specific site without supplying the tenant name.\n            $OneDriveSite = Get-SPOSite -Filter { Url -like \"*-my.sharepoint.com/\" }\n            Set-SPOSite -Identity $OneDriveSite -SharingCapability Disabled"},{"label":"rationale","data":"OneDrive, designed for end-user cloud storage, inherently provides less oversight and\n        control compared to SharePoint, which often involves additional content overseers or\n        site administrators. This autonomy can lead to potential risks such as inadvertent\n        sharing of privileged information by end users. Restricting external OneDrive sharing\n        will require users to transfer content to SharePoint folders first which have those tighter\n        controls."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/sharepoint/dev/embedded/concepts/app-concepts/sharing-and-perm#container-partition"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.3"]}],"default_value":"Anyone (ExternalUserAndGuestSharing)","nist":["AC-3","AC-5","AC-6","MP-2"]},"code":"control 'microsoft-365-foundations-7.2.4' do\n  title 'Ensure OneDrive content sharing is restricted'\n  desc \"This setting governs the global permissiveness of OneDrive content sharing in the organization.\n        OneDrive content sharing can be restricted independent of SharePoint but can never be more permissive than the level established with SharePoint.\n        The recommended state is Only people in your organization\"\n\n  desc 'check',\n       'To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Locate the External sharing section.\n        4. Under OneDrive, ensure the slider bar is set to Only people in your organization.\n    To audit using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following cmdlet:\n            Get-SPOTenant | fl OneDriveSharingCapability\n        3. Ensure the returned value is Disabled.\n    Alternative audit method using PowerShell:\n        1. Connect to SharePoint Online.\n        2. Use one of the following methods:\n            # Replace [tenant] with your tenant id\n            Get-SPOSite -Identity https://[tenant]-my.sharepoint.com/ | fl Url,SharingCapability\n            # Or run this to filter to the specific site without supplying the tenant name.\n            $OneDriveSite = Get-SPOSite -Filter { Url -like \"*-my.sharepoint.com/\" }\n            Get-SPOSite -Identity $OneDriveSite | fl Url,SharingCapability\n        2. Ensure the returned value for SharingCapability is Disabled\n    Note: As of March 2024, using Get-SPOSite with Where-Object or filtering against the entire site and then returning the SharingCapability parameter can result in a different value as opposed to running the cmdlet specifically against the OneDrive specific site using the -Identity switch as shown in the example.\n    Note 2: The parameter OneDriveSharingCapability may not be yet fully available in all tenants. It is demonstrated in official Microsoft documentation as linked in the references section but not in the Set-SPOTenant cmdlet itself. If the parameter is unavailable, then either use the UI method or alternative PowerShell audit method.'\n\n  desc 'fix',\n       'To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Locate the External sharing section.\n        4. Under OneDrive, set the slider bar to Only people in your organization.\n    To remediate using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following cmdlet: Set-SPOTenant -OneDriveSharingCapability Disabled\n    Alternative remediation method using PowerShell:\n        1. Connect to SharePoint Online.\n        2. Run one of the following:\n            # Replace [tenant] with your tenant id\n            Set-SPOSite -Identity https://[tenant]-my.sharepoint.com/ -SharingCapability Disabled\n            # Or run this to filter to the specific site without supplying the tenant name.\n            $OneDriveSite = Get-SPOSite -Filter { Url -like \"*-my.sharepoint.com/\" }\n            Set-SPOSite -Identity $OneDriveSite -SharingCapability Disabled'\n\n  desc 'rationale',\n       'OneDrive, designed for end-user cloud storage, inherently provides less oversight and\n        control compared to SharePoint, which often involves additional content overseers or\n        site administrators. This autonomy can lead to potential risks such as inadvertent\n        sharing of privileged information by end users. Restricting external OneDrive sharing\n        will require users to transfer content to SharePoint folders first which have those tighter\n        controls.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['3.3'] }]\n  tag default_value: 'Anyone (ExternalUserAndGuestSharing)'\n  tag nist: ['AC-3', 'AC-5', 'AC-6', 'MP-2']\n\n  ref 'https://learn.microsoft.com/en-us/sharepoint/dev/embedded/concepts/app-concepts/sharing-and-perm#container-partition'\n\n  ensure_od_content_sharing_restricted_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $sharepoint_admin_url = '#{input('sharepoint_admin_url')}'\n    import-module pnp.powershell\n    $password = (ConvertTo-SecureString -AsPlainText $certificate_password -Force)\n    Connect-PnPOnline -Url $sharepoint_admin_url -ClientId $client_id -CertificatePath $certificate_path -CertificatePassword $password  -Tenant $tenantid\n\t  (Get-PnPTenant).OneDriveSharingCapability\n  }\n  powershell_output = powershell(ensure_od_content_sharing_restricted_script).stdout.strip\n  describe 'Ensure the OneDriveSharingCapability option for SharePoint' do\n    subject { powershell_output }\n    it 'is set to Disabled' do\n      expect(subject).to eq('Disabled')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-7.2.4.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the OneDriveSharingCapability option for SharePoint is set to Disabled","run_time":5.9e-05,"start_time":"2024-09-24T15:51:50-04:00","message":"\nexpected: \"Disabled\"\n     got: \"ExternalUserSharingOnly\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the OneDriveSharingCapability option for SharePoint"}]},{"id":"microsoft-365-foundations-7.2.5","title":"Ensure that SharePoint guest users cannot share items they don't own","desc":"SharePoint gives users the ability to share files, folders, and site collections. Internal users can share with external collaborators, and with the right permissions could share to other external parties.","descriptions":[{"label":"default","data":"SharePoint gives users the ability to share files, folders, and site collections. Internal users can share with external collaborators, and with the right permissions could share to other external parties."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies then select Sharing.\n        3. Expand More external sharing settings, verify that Allow guests to share items they don't own is unchecked.\n    To audit using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following SharePoint Online PowerShell command:\n            Get-SPOTenant | ft PreventExternalUsersFromResharing\n        3. Ensure the returned value is True."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies then select Sharing.\n        3. Expand More external sharing settings, uncheck Allow guests to share items they don't own.\n        4. Click Save.\n    To remediate using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following SharePoint Online PowerShell command:\n            Set-SPOTenant -PreventExternalUsersFromResharing $True"},{"label":"rationale","data":"Sharing and collaboration are key; however, file, folder, or site collection owners should\n        have the authority over what external users get shared with to prevent unauthorized\n        disclosures of information."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/sharepoint/turn-external-sharing-on-or-off"},{"ref":"https://learn.microsoft.com/en-us/sharepoint/external-sharing-overview"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.3"]},{"7":["14.6"]}],"default_value":"Checked (False)","nist":["AC-3","AC-5","AC-6","MP-2","AT-2"]},"code":"control 'microsoft-365-foundations-7.2.5' do\n  title \"Ensure that SharePoint guest users cannot share items they don't own\"\n  desc 'SharePoint gives users the ability to share files, folders, and site collections. Internal users can share with external collaborators, and with the right permissions could share to other external parties.'\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies then select Sharing.\n        3. Expand More external sharing settings, verify that Allow guests to share items they don't own is unchecked.\n    To audit using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following SharePoint Online PowerShell command:\n            Get-SPOTenant | ft PreventExternalUsersFromResharing\n        3. Ensure the returned value is True.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies then select Sharing.\n        3. Expand More external sharing settings, uncheck Allow guests to share items they don't own.\n        4. Click Save.\n    To remediate using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following SharePoint Online PowerShell command:\n            Set-SPOTenant -PreventExternalUsersFromResharing $True\"\n\n  desc 'rationale',\n       'Sharing and collaboration are key; however, file, folder, or site collection owners should\n        have the authority over what external users get shared with to prevent unauthorized\n        disclosures of information.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['3.3'] }, { '7' => ['14.6'] }]\n  tag default_value: 'Checked (False)'\n  tag nist: ['AC-3', 'AC-5', 'AC-6', 'MP-2', 'AT-2']\n\n  ref 'https://learn.microsoft.com/en-us/sharepoint/turn-external-sharing-on-or-off'\n  ref 'https://learn.microsoft.com/en-us/sharepoint/external-sharing-overview'\n\n  ensure_spo_guest_users_cannot_share_items_dont_own_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $sharepoint_admin_url = '#{input('sharepoint_admin_url')}'\n    import-module pnp.powershell\n    $password = (ConvertTo-SecureString -AsPlainText $certificate_password -Force)\n    Connect-PnPOnline -Url $sharepoint_admin_url -ClientId $client_id -CertificatePath $certificate_path -CertificatePassword $password  -Tenant $tenantid\n\t  (Get-PnPTenant).PreventExternalUsersFromResharing\n  }\n  powershell_output = powershell(ensure_spo_guest_users_cannot_share_items_dont_own_script).stdout.strip\n  describe 'Ensure the PreventExternalUsersFromResharing option for SharePoint' do\n    subject { powershell_output }\n    it 'is set to True' do\n      expect(subject).to eq('True')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-7.2.5.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure the PreventExternalUsersFromResharing option for SharePoint is set to True","run_time":4.4e-05,"start_time":"2024-09-24T15:51:50-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the PreventExternalUsersFromResharing option for SharePoint"}]},{"id":"microsoft-365-foundations-7.2.6","title":"Ensure SharePoint external sharing is managed through domain whitelist/blacklists","desc":"Control sharing of documents to external domains by either blocking domains or only allowing sharing with specific named domains.","descriptions":[{"label":"default","data":"Control sharing of documents to external domains by either blocking domains or only allowing sharing with specific named domains."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Expand Policies then click Sharing.\n        3. Expand More external sharing settings and confirm that Limit external sharing by domain is checked.\n        4. Verify that an accurate list of allowed domains is listed.\n    To audit using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService.\n        2. Run the following PowerShell command:\n            Get-SPOTenant | fl SharingDomainRestrictionMode,SharingAllowedDomainList\n        3. Ensure that SharingDomainRestrictionMode is set to AllowList and SharingAllowedDomainList contains domains trusted by the organization for external sharing."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint.\n        2. Expand Policies then click Sharing.\n        3. Expand More external sharing settings and check Limit external sharing by domain.\n        4. Select Add domains to add a list of approved domains.\n        5. Click Save at the bottom of the page.\n    To remediate using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService.\n        2. Run the following PowerShell command:\n            Set-SPOTenant -SharingDomainRestrictionMode AllowList -SharingAllowedDomainList \"domain1.com domain2.com\""},{"label":"rationale","data":"Attackers will often attempt to expose sensitive information to external entities through\n        sharing, and restricting the domains that users can share documents with will reduce\n        that surface area."}],"impact":0.5,"refs":[],"tags":{"severity":"medium","cis_controls":[{"8":["3.3"]},{"7":["13.4"]},{"7":["14.6"]}],"default_value":"Limit external sharing by domain is unchecked\n                      SharingDomainRestrictionMode: None\n                      SharingDomainRestrictionMode: <Undefined>","nist":["AC-3","AC-5","AC-6","MP-2","CA-9","SC-7","AT-2"]},"code":"control 'microsoft-365-foundations-7.2.6' do\n  title 'Ensure SharePoint external sharing is managed through domain whitelist/blacklists'\n  desc 'Control sharing of documents to external domains by either blocking domains or only allowing sharing with specific named domains.'\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Expand Policies then click Sharing.\n        3. Expand More external sharing settings and confirm that Limit external sharing by domain is checked.\n        4. Verify that an accurate list of allowed domains is listed.\n    To audit using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService.\n        2. Run the following PowerShell command:\n            Get-SPOTenant | fl SharingDomainRestrictionMode,SharingAllowedDomainList\n        3. Ensure that SharingDomainRestrictionMode is set to AllowList and SharingAllowedDomainList contains domains trusted by the organization for external sharing.\"\n\n  desc 'fix',\n       'To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint.\n        2. Expand Policies then click Sharing.\n        3. Expand More external sharing settings and check Limit external sharing by domain.\n        4. Select Add domains to add a list of approved domains.\n        5. Click Save at the bottom of the page.\n    To remediate using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService.\n        2. Run the following PowerShell command:\n            Set-SPOTenant -SharingDomainRestrictionMode AllowList -SharingAllowedDomainList \"domain1.com domain2.com\"'\n\n  desc 'rationale',\n       'Attackers will often attempt to expose sensitive information to external entities through\n        sharing, and restricting the domains that users can share documents with will reduce\n        that surface area.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [\n    { '8' => ['3.3'] },\n    { '7' => ['13.4'] },\n    { '7' => ['14.6'] }\n  ]\n  tag default_value: 'Limit external sharing by domain is unchecked\n                      SharingDomainRestrictionMode: None\n                      SharingDomainRestrictionMode: <Undefined>'\n  tag nist: ['AC-3', 'AC-5', 'AC-6', 'MP-2', 'CA-9', 'SC-7', 'AT-2']\n\n  ensure_sharingdomainrestriction_set_to_allowlist_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $sharepoint_admin_url = '#{input('sharepoint_admin_url')}'\n    import-module pnp.powershell\n    $password = (ConvertTo-SecureString -AsPlainText $certificate_password -Force)\n    Connect-PnPOnline -Url $sharepoint_admin_url -ClientId $client_id -CertificatePath $certificate_path -CertificatePassword $password  -Tenant $tenantid\n\t  (Get-PnPTenant).SharingDomainRestrictionMode\n  }\n  powershell_output_allowlist = powershell(ensure_sharingdomainrestriction_set_to_allowlist_script).stdout.strip\n  describe 'Ensure the SharingDomainRestrictionMode option for SharePoint' do\n    subject { powershell_output_allowlist }\n    it 'is set to AllowList' do\n      expect(subject).to eq('AllowList')\n    end\n  end\n\n  trusted_domains = input('domains_trusted_by_organization')\n  domain_pattern = trusted_domains.map { |domain| \"'#{domain}'\" }.join(', ')\n  ensure_trusted_domains_allowed_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $sharepoint_admin_url = '#{input('sharepoint_admin_url')}'\n    import-module pnp.powershell\n    $password = (ConvertTo-SecureString -AsPlainText $certificate_password -Force)\n    Connect-PnPOnline -Url $sharepoint_admin_url -ClientId $client_id -CertificatePath $certificate_path -CertificatePassword $password  -Tenant $tenantid\n    $trustedDomains = @(\"trusted.com\", \"example.com\", \"secure.org\")\n    $domain_data = (Get-PnPTenant).SharingAllowedDomainList\n    $trustedDomains = @(#{domain_pattern})\n    $domainList = $domain_data -split ' '\n    $untrustedDomains = $domainList | Where-Object { -not ($trustedDomains -contains $_) }\n    if ($untrustedDomains.Count -gt 0) {\n        Write-Output \"Some domains are not in the list of trusted domains: $($untrustedDomains -join ', ')\"\n    }\n  }\n  powershell_output_domains = powershell(ensure_trusted_domains_allowed_script).stdout.strip\n  describe 'Ensure the number of domains not trusted by the organization outputted by SharingAllowedDomainList option on SharePoint' do\n    subject { powershell_output_domains }\n    failure_message = \"Failure: #{powershell_output_domains}\"\n    it 'is 0' do\n      expect(subject).to be_empty, failure_message\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-7.2.6.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure the SharingDomainRestrictionMode option for SharePoint is set to AllowList","run_time":3.6e-05,"start_time":"2024-09-24T15:51:50-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the SharingDomainRestrictionMode option for SharePoint"},{"status":"failed","code_desc":"Ensure the number of domains not trusted by the organization outputted by SharingAllowedDomainList option on SharePoint is 0","run_time":0.002755,"start_time":"2024-09-24T15:51:50-04:00","message":"Failure: Some domains are not in the list of trusted domains: mitre.org, mitre-engenuity.org, mitre-ext.org","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the number of domains not trusted by the organization outputted by SharingAllowedDomainList option on SharePoint"}]},{"id":"microsoft-365-foundations-7.2.7","title":"Ensure link sharing is restricted in SharePoint and OneDrive","desc":"This setting sets the default link type that a user will see when sharing content in OneDrive or SharePoint. It does not restrict or exclude any other options.\n        The recommended state is Specific people (only the people the user specifies)","descriptions":[{"label":"default","data":"This setting sets the default link type that a user will see when sharing content in OneDrive or SharePoint. It does not restrict or exclude any other options.\n        The recommended state is Specific people (only the people the user specifies)"},{"label":"check","data":"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Scroll to File and folder links.\n        4. Ensure that the setting Choose the type of link that's selected by default when users share files and folders in SharePoint and OneDrive is set to Specific people (only the people the user specifies)\n    To audit using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService.\n        2. Run the following PowerShell command:\n            Get-SPOTenant | fl DefaultSharingLinkType\n        3. Ensure the returned value is Direct."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Scroll to File and folder links.\n        4. Set Choose the type of link that's selected by default when users share files and folders in SharePoint and OneDrive to Specific people (only the people the user specifies)\n    To remediate using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService.\n        2. Run the following PowerShell command:\n            Set-SPOTenant -DefaultSharingLinkType Direct"},{"label":"rationale","data":"By defaulting to specific people, the user will first need to consider whether or not the\n        content being shared should be accessible by the entire organization versus select\n        individuals. This aids in reinforcing the concept of least privilege."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/powershell/module/sharepoint-online/set-spotenant?view=sharepoint-ps"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.3"]}],"default_value":"Only people in your organization (Internal)","nist":["AC-3","AC-5","AC-6","MP-2"]},"code":"control 'microsoft-365-foundations-7.2.7' do\n  title 'Ensure link sharing is restricted in SharePoint and OneDrive'\n  desc \"This setting sets the default link type that a user will see when sharing content in OneDrive or SharePoint. It does not restrict or exclude any other options.\n        The recommended state is Specific people (only the people the user specifies)\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Scroll to File and folder links.\n        4. Ensure that the setting Choose the type of link that's selected by default when users share files and folders in SharePoint and OneDrive is set to Specific people (only the people the user specifies)\n    To audit using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService.\n        2. Run the following PowerShell command:\n            Get-SPOTenant | fl DefaultSharingLinkType\n        3. Ensure the returned value is Direct.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Scroll to File and folder links.\n        4. Set Choose the type of link that's selected by default when users share files and folders in SharePoint and OneDrive to Specific people (only the people the user specifies)\n    To remediate using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService.\n        2. Run the following PowerShell command:\n            Set-SPOTenant -DefaultSharingLinkType Direct\"\n\n  desc 'rationale',\n       'By defaulting to specific people, the user will first need to consider whether or not the\n        content being shared should be accessible by the entire organization versus select\n        individuals. This aids in reinforcing the concept of least privilege.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['3.3'] }]\n  tag default_value: 'Only people in your organization (Internal)'\n  tag nist: ['AC-3', 'AC-5', 'AC-6', 'MP-2']\n\n  ref 'https://learn.microsoft.com/en-us/powershell/module/sharepoint-online/set-spotenant?view=sharepoint-ps'\n\n  ensure_link_sharing_restricted_spo_od_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $sharepoint_admin_url = '#{input('sharepoint_admin_url')}'\n    import-module pnp.powershell\n    $password = (ConvertTo-SecureString -AsPlainText $certificate_password -Force)\n    Connect-PnPOnline -Url $sharepoint_admin_url -ClientId $client_id -CertificatePath $certificate_path -CertificatePassword $password  -Tenant $tenantid\n\t  (Get-PnPTenant).DefaultSharingLinkType\n  }\n  powershell_output = powershell(ensure_link_sharing_restricted_spo_od_script).stdout.strip\n  describe 'Ensure the DefaultSharingLinkType option for SharePoint' do\n    subject { powershell_output }\n    it 'is set to Direct' do\n      expect(subject).to eq('Direct')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-7.2.7.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the DefaultSharingLinkType option for SharePoint is set to Direct","run_time":6.6e-05,"start_time":"2024-09-24T15:51:50-04:00","message":"\nexpected: \"Direct\"\n     got: \"Internal\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the DefaultSharingLinkType option for SharePoint"}]},{"id":"microsoft-365-foundations-7.2.8","title":"Ensure external sharing is restricted by security group","desc":"External sharing of content can be restricted to specific security groups. This setting is global, applies to sharing in both SharePoint and OneDrive and cannot be set at the site level in SharePoint.\n        The recommended state is Enabled or Checked.\n        Note: Users in these security groups must be allowed to invite guests in the guest invite settings in Microsoft Entra. Identity > External Identities > External collaboration settings","descriptions":[{"label":"default","data":"External sharing of content can be restricted to specific security groups. This setting is global, applies to sharing in both SharePoint and OneDrive and cannot be set at the site level in SharePoint.\n        The recommended state is Enabled or Checked.\n        Note: Users in these security groups must be allowed to invite guests in the guest invite settings in Microsoft Entra. Identity > External Identities > External collaboration settings"},{"label":"check","data":"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Scroll to and expand More external sharing settings.\n        4. Ensure the following:\n            o Verify Allow only users in specific security groups to share externally is checked\n            o Verify Manage security groups is defined and accordance with company procedure."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Scroll to and expand More external sharing settings.\n        4. Set the following:\n            o Check Allow only users in specific security groups to share externally\n            o Define Manage security groups in accordance with company procedure."},{"label":"rationale","data":"Organizations wishing to create tighter security controls for external sharing can set this\n        to enforce role-based access control by using security groups already defined in\n        Microsoft Entra."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/sharepoint/manage-security-groups"}],"tags":{"severity":"medium","cis_controls":[{"8":["6.8"]}],"default_value":"Unchecked/Undefined","nist":["AC-2","AC-5","AC-6","AC-6(1)","AC-6(7)","AU-9(4)"]},"code":"control 'microsoft-365-foundations-7.2.8' do\n  title 'Ensure external sharing is restricted by security group'\n  desc \"External sharing of content can be restricted to specific security groups. This setting is global, applies to sharing in both SharePoint and OneDrive and cannot be set at the site level in SharePoint.\n        The recommended state is Enabled or Checked.\n        Note: Users in these security groups must be allowed to invite guests in the guest invite settings in Microsoft Entra. Identity > External Identities > External collaboration settings\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Scroll to and expand More external sharing settings.\n        4. Ensure the following:\n            o Verify Allow only users in specific security groups to share externally is checked\n            o Verify Manage security groups is defined and accordance with company procedure.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Scroll to and expand More external sharing settings.\n        4. Set the following:\n            o Check Allow only users in specific security groups to share externally\n            o Define Manage security groups in accordance with company procedure.\"\n\n  desc 'rationale',\n       'Organizations wishing to create tighter security controls for external sharing can set this\n        to enforce role-based access control by using security groups already defined in\n        Microsoft Entra.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['6.8'] }]\n  tag default_value: 'Unchecked/Undefined'\n  tag nist: ['AC-2', 'AC-5', 'AC-6', 'AC-6(1)', 'AC-6(7)', 'AU-9(4)']\n\n  ref 'https://learn.microsoft.com/en-us/sharepoint/manage-security-groups'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-7.2.8.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":5.0e-06,"start_time":"2024-09-24T15:51:50-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-7.2.9","title":"Ensure guest access to a site or OneDrive will expire automatically","desc":"This policy setting configures the expiration time for each guest that is invited to the SharePoint site or with whom users share individual files and folders with.\n        The recommended state is 30 or less.","descriptions":[{"label":"default","data":"This policy setting configures the expiration time for each guest that is invited to the SharePoint site or with whom users share individual files and folders with.\n        The recommended state is 30 or less."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Scroll to and expand More external sharing settings.\n        4. Ensure Guest access to a site or OneDrive will expire automatically after this many days is checked and set to 30 or less.\n    To audit using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following cmdlet:\n            Get-SPOTenant | fl ExternalUserExpirationRequired,ExternalUserExpireInDays\n        3. Ensure the following values are returned:\n            o ExternalUserExpirationRequired is True.\n            o ExternalUserExpireInDays is 30 or less."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Scroll to and expand More external sharing settings.\n        4. Set Guest access to a site or OneDrive will expire automatically after this many days to 30\n    To remediate using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following cmdlet:\n            Set-SPOTenant -ExternalUserExpireInDays 30 -ExternalUserExpirationRequired $True"},{"label":"rationale","data":"This setting ensures that guests who no longer need access to the site or link no longer\n        have access after a set period of time. Allowing guest access for an indefinite amount of\n        time could lead to loss of data confidentiality and oversight.\n        Note: Guest membership applies at the Microsoft 365 group level. Guests who have\n        permission to view a SharePoint site or use a sharing link may also have access to a\n        Microsoft Teams team or security group."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-US/sharepoint/turn-external-sharing-on-or-off?WT.mc_id=365AdminCSH_spo#change-the-organization-level-external-sharing-setting"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/community/sharepoint-security-a-team-effort"}],"tags":{"severity":"medium","default_value":"ExternalUserExpirationRequired $false\n                      ExternalUserExpireInDays 60 days","cis_controls":[{"8":["untracked"]},{"7":["untracked"]}],"nist":["CM-6"]},"code":"control 'microsoft-365-foundations-7.2.9' do\n  title 'Ensure guest access to a site or OneDrive will expire automatically'\n  desc \"This policy setting configures the expiration time for each guest that is invited to the SharePoint site or with whom users share individual files and folders with.\n        The recommended state is 30 or less.\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Scroll to and expand More external sharing settings.\n        4. Ensure Guest access to a site or OneDrive will expire automatically after this many days is checked and set to 30 or less.\n    To audit using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following cmdlet:\n            Get-SPOTenant | fl ExternalUserExpirationRequired,ExternalUserExpireInDays\n        3. Ensure the following values are returned:\n            o ExternalUserExpirationRequired is True.\n            o ExternalUserExpireInDays is 30 or less.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click to expand Policies > Sharing.\n        3. Scroll to and expand More external sharing settings.\n        4. Set Guest access to a site or OneDrive will expire automatically after this many days to 30\n    To remediate using PowerShell:\n        1. Connect to SharePoint Online service using Connect-SPOService.\n        2. Run the following cmdlet:\n            Set-SPOTenant -ExternalUserExpireInDays 30 -ExternalUserExpirationRequired $True\"\n\n  desc 'rationale',\n       'This setting ensures that guests who no longer need access to the site or link no longer\n        have access after a set period of time. Allowing guest access for an indefinite amount of\n        time could lead to loss of data confidentiality and oversight.\n        Note: Guest membership applies at the Microsoft 365 group level. Guests who have\n        permission to view a SharePoint site or use a sharing link may also have access to a\n        Microsoft Teams team or security group.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag default_value: 'ExternalUserExpirationRequired $false\n                      ExternalUserExpireInDays 60 days'\n  tag cis_controls: [{ '8' => ['untracked'] }, { '7' => ['untracked'] }]\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-US/sharepoint/turn-external-sharing-on-or-off?WT.mc_id=365AdminCSH_spo#change-the-organization-level-external-sharing-setting'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/community/sharepoint-security-a-team-effort'\n\n  ensure_guest_access_to_od_will_expire_automatically_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $sharepoint_admin_url = '#{input('sharepoint_admin_url')}'\n    import-module pnp.powershell\n    $password = (ConvertTo-SecureString -AsPlainText $certificate_password -Force)\n    Connect-PnPOnline -Url $sharepoint_admin_url -ClientId $client_id -CertificatePath $certificate_path -CertificatePassword $password  -Tenant $tenantid\n\t  Get-PnPTenant | Select-Object ExternalUserExpirationRequired, ExternalUserExpireInDays | ConvertTo-Json\n  }\n\n  powershell_output = JSON.parse(powershell(ensure_guest_access_to_od_will_expire_automatically_script).stdout.strip)\n  describe 'Ensure the following setting' do\n    subject { powershell_output }\n    it 'ExternalUserExpirationRequired in SharePoint/OneDrive is set to True' do\n      expect(subject['ExternalUserExpirationRequired']).to eq(true)\n    end\n    it 'ExternalUserExpireInDays in SharePoint/OneDrive is less than or equal to 30' do\n      expect(subject['ExternalUserExpireInDays']).to be <= 30\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-7.2.9.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the following setting ExternalUserExpirationRequired in SharePoint/OneDrive is set to True","run_time":0.001217,"start_time":"2024-09-24T15:51:50-04:00","message":"\nexpected: true\n     got: false\n\n(compared using ==)\n\nDiff:\n@@ -1 +1 @@\n-true\n+false\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following setting"},{"status":"failed","code_desc":"Ensure the following setting ExternalUserExpireInDays in SharePoint/OneDrive is less than or equal to 30","run_time":5.8e-05,"start_time":"2024-09-24T15:51:50-04:00","message":"expected: <= 30\n     got:    60","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the following setting"}]},{"id":"microsoft-365-foundations-7.3.1","title":"Ensure Office 365 SharePoint infected files are disallowed for download","desc":"By default, SharePoint online allows files that Defender for Office 365 has detected as infected to be downloaded.","descriptions":[{"label":"default","data":"By default, SharePoint online allows files that Defender for Office 365 has detected as infected to be downloaded."},{"label":"check","data":"To audit using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService -Url https://tenant-admin.sharepoint.com, replacing \"tenant\" with the appropriate value.\n        2. Run the following PowerShell command:\n            Get-SPOTenant | Select-Object DisallowInfectedFileDownload\n        3. Ensure the value for DisallowInfectedFileDownload is set to True.\n    Note: According to Microsoft, SharePoint cannot be accessed through PowerShell by users with the Global Reader role. For further information, please refer to the reference section."},{"label":"fix","data":"To remediate using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService -Url https://tenant-admin.sharepoint.com, replacing \"tenant\" with the appropriate value.\n        2. Run the following PowerShell command to set the recommended value:\n            Set-SPOTenant –DisallowInfectedFileDownload $true\n    Note: The Global Reader role cannot access SharePoint using PowerShell according to Microsoft. See the reference section for more information."},{"label":"rationale","data":"Defender for Office 365 for SharePoint, OneDrive, and Microsoft Teams protects your\n        organization from inadvertently sharing malicious files. When an infected file is detected\n        that file is blocked so that no one can open, copy, move, or share it until further actions\n        are taken by the organization's security team."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/safe-attachments-for-spo-odfb-teams-configure?view=o365-worldwide"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/anti-malware-protection-for-spo-odfb-teams-about?view=o365-worldwide"},{"ref":"https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#global-reader"}],"tags":{"severity":"medium","cis_controls":[{"8":["10.1"]},{"7":["7.10"]},{"7":["8.1"]}],"default_value":"False","nist":["SI-3","AU-1","AU-2"]},"code":"control 'microsoft-365-foundations-7.3.1' do\n  title 'Ensure Office 365 SharePoint infected files are disallowed for download'\n  desc 'By default, SharePoint online allows files that Defender for Office 365 has detected as infected to be downloaded.'\n\n  desc 'check',\n       'To audit using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService -Url https://tenant-admin.sharepoint.com, replacing \"tenant\" with the appropriate value.\n        2. Run the following PowerShell command:\n            Get-SPOTenant | Select-Object DisallowInfectedFileDownload\n        3. Ensure the value for DisallowInfectedFileDownload is set to True.\n    Note: According to Microsoft, SharePoint cannot be accessed through PowerShell by users with the Global Reader role. For further information, please refer to the reference section.'\n\n  desc 'fix',\n       'To remediate using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService -Url https://tenant-admin.sharepoint.com, replacing \"tenant\" with the appropriate value.\n        2. Run the following PowerShell command to set the recommended value:\n            Set-SPOTenant –DisallowInfectedFileDownload $true\n    Note: The Global Reader role cannot access SharePoint using PowerShell according to Microsoft. See the reference section for more information.'\n\n  desc 'rationale',\n       \"Defender for Office 365 for SharePoint, OneDrive, and Microsoft Teams protects your\n        organization from inadvertently sharing malicious files. When an infected file is detected\n        that file is blocked so that no one can open, copy, move, or share it until further actions\n        are taken by the organization's security team.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [\n    { '8' => ['10.1'] },\n    { '7' => ['7.10'] },\n    { '7' => ['8.1'] }\n  ]\n  tag default_value: 'False'\n  tag nist: ['SI-3', 'AU-1', 'AU-2']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/safe-attachments-for-spo-odfb-teams-configure?view=o365-worldwide'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/anti-malware-protection-for-spo-odfb-teams-about?view=o365-worldwide'\n  ref 'https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#global-reader'\n\n  ensure_office_m365spo_infected_files_disallowed_download_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $sharepoint_admin_url = '#{input('sharepoint_admin_url')}'\n    import-module pnp.powershell\n    $password = (ConvertTo-SecureString -AsPlainText $certificate_password -Force)\n    Connect-PnPOnline -Url $sharepoint_admin_url -ClientId $client_id -CertificatePath $certificate_path -CertificatePassword $password  -Tenant $tenantid\n\t  (Get-PnPTenant).DisallowInfectedFileDownload\n  }\n\n  powershell_output = powershell(ensure_office_m365spo_infected_files_disallowed_download_script).stdout.strip\n  describe 'Ensure the DisallowInfectedFileDownload option for Office 365 SharePoint' do\n    subject { powershell_output }\n    it 'is set to True' do\n      expect(subject).to eq('True')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-7.3.1.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the DisallowInfectedFileDownload option for Office 365 SharePoint is set to True","run_time":0.000231,"start_time":"2024-09-24T15:51:50-04:00","message":"\nexpected: \"True\"\n     got: \"False\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the DisallowInfectedFileDownload option for Office 365 SharePoint"}]},{"id":"microsoft-365-foundations-7.3.2","title":"Ensure OneDrive sync is restricted for unmanaged devices","desc":"Microsoft OneDrive allows users to sign in their cloud tenant account and begin syncing select folders or the entire contents of OneDrive to a local computer. By default, this includes any computer with OneDrive already installed, whether it is Azure Domain Joined or Active Directory Domain joined.\n        The recommended state for this setting is Allow syncing only on computers joined to specific domains Enabled: Specify the AD domain GUID(s)","descriptions":[{"label":"default","data":"Microsoft OneDrive allows users to sign in their cloud tenant account and begin syncing select folders or the entire contents of OneDrive to a local computer. By default, this includes any computer with OneDrive already installed, whether it is Azure Domain Joined or Active Directory Domain joined.\n        The recommended state for this setting is Allow syncing only on computers joined to specific domains Enabled: Specify the AD domain GUID(s)"},{"label":"check","data":"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click Settings followed by OneDrive - Sync\n        3. Verify that Allow syncing only on computers joined to specific domains is checked.\n        4. Verify that the Active Directory domain GUIDS are listed in the box.\n            o Use the Get-ADDomain PowerShell command on the on-premises server to obtain the GUID for each on-premises domain.\n    To audit using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService -Url https://tenant-admin.sharepoint.com, replacing \"tenant\" with the appropriate value.\n        2. Run the following PowerShell command:\n            Get-SPOTenantSyncClientRestriction | fl TenantRestrictionEnabled,AllowedDomainList\n        3. Ensure TenantRestrictionEnabled is set to True and AllowedDomainList contains the trusted domains GUIDs from the on premises environment."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click Settings then select OneDrive - Sync.\n        3. Check the Allow syncing only on computers joined to specific domains.\n        4. Use the Get-ADDomain PowerShell command on the on-premises server to obtain the GUID for each on-premises domain.\n        5. Click Save.\n    To remediate using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService\n        2. Run the following PowerShell command and provide the DomainGuids from the Get-AADomain command:\n            Set-SPOTenantSyncClientRestriction -Enable -DomainGuids \"786548DD-877B-4760-A749-6B1EFBC1190A; 877564FF-877B-4760-A749-6B1EFBC1190A\"\n        Note: Utilize the -BlockMacSync:$true parameter if you are not using conditional access to ensure Macs cannot sync."},{"label":"rationale","data":"Unmanaged devices pose a risk, since their security cannot be verified through existing\n        security policies, brokers or endpoint protection. Allowing users to sync data to these\n        devices takes that data out of the control of the organization. This increases the risk of\n        the data either being intentionally or accidentally leaked.\n        Note: This setting is only applicable to Active Directory domains when operating in a\n        hybrid configuration. It does not apply to Entra ID domains. If there are devices which\n        are only Entra ID joined, consider using a Conditional Access Policy instead."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-US/sharepoint/allow-syncing-only-on-specific-domains?WT.mc_id=365AdminCSH_spo"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/sharepoint-online/set-spotenantsyncclientrestriction?view=sharepoint-ps"}],"tags":{"severity":"medium","default_value":"By default there are no restrictions applied to the syncing of OneDrive.\n                      TenantRestrictionEnabled : False\n                      AllowedDomainList : {}","cis_controls":[{"8":["untracked"]}],"nist":["CM-6"]},"code":"control 'microsoft-365-foundations-7.3.2' do\n  title 'Ensure OneDrive sync is restricted for unmanaged devices'\n  desc \"Microsoft OneDrive allows users to sign in their cloud tenant account and begin syncing select folders or the entire contents of OneDrive to a local computer. By default, this includes any computer with OneDrive already installed, whether it is Azure Domain Joined or Active Directory Domain joined.\n        The recommended state for this setting is Allow syncing only on computers joined to specific domains Enabled: Specify the AD domain GUID(s)\"\n\n  desc 'check',\n       'To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click Settings followed by OneDrive - Sync\n        3. Verify that Allow syncing only on computers joined to specific domains is checked.\n        4. Verify that the Active Directory domain GUIDS are listed in the box.\n            o Use the Get-ADDomain PowerShell command on the on-premises server to obtain the GUID for each on-premises domain.\n    To audit using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService -Url https://tenant-admin.sharepoint.com, replacing \"tenant\" with the appropriate value.\n        2. Run the following PowerShell command:\n            Get-SPOTenantSyncClientRestriction | fl TenantRestrictionEnabled,AllowedDomainList\n        3. Ensure TenantRestrictionEnabled is set to True and AllowedDomainList contains the trusted domains GUIDs from the on premises environment.'\n\n  desc 'fix',\n       'To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Click Settings then select OneDrive - Sync.\n        3. Check the Allow syncing only on computers joined to specific domains.\n        4. Use the Get-ADDomain PowerShell command on the on-premises server to obtain the GUID for each on-premises domain.\n        5. Click Save.\n    To remediate using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService\n        2. Run the following PowerShell command and provide the DomainGuids from the Get-AADomain command:\n            Set-SPOTenantSyncClientRestriction -Enable -DomainGuids \"786548DD-877B-4760-A749-6B1EFBC1190A; 877564FF-877B-4760-A749-6B1EFBC1190A\"\n        Note: Utilize the -BlockMacSync:$true parameter if you are not using conditional access to ensure Macs cannot sync.'\n\n  desc 'rationale',\n       'Unmanaged devices pose a risk, since their security cannot be verified through existing\n        security policies, brokers or endpoint protection. Allowing users to sync data to these\n        devices takes that data out of the control of the organization. This increases the risk of\n        the data either being intentionally or accidentally leaked.\n        Note: This setting is only applicable to Active Directory domains when operating in a\n        hybrid configuration. It does not apply to Entra ID domains. If there are devices which\n        are only Entra ID joined, consider using a Conditional Access Policy instead.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag default_value: 'By default there are no restrictions applied to the syncing of OneDrive.\n                      TenantRestrictionEnabled : False\n                      AllowedDomainList : {}'\n  tag cis_controls: [{ '8' => ['untracked'] }]\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-US/sharepoint/allow-syncing-only-on-specific-domains?WT.mc_id=365AdminCSH_spo'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/sharepoint-online/set-spotenantsyncclientrestriction?view=sharepoint-ps'\n\n  tenantrestrictionenabled_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $sharepoint_admin_url = '#{input('sharepoint_admin_url')}'\n    import-module pnp.powershell\n    $password = (ConvertTo-SecureString -AsPlainText $certificate_password -Force)\n    Connect-PnPOnline -Url $sharepoint_admin_url -ClientId $client_id -CertificatePath $certificate_path -CertificatePassword $password  -Tenant $tenantid\n\t  (Get-PnPTenantSyncClientRestriction).TenantRestrictionEnabled\n  }\n  powershell_output_tenant = powershell(tenantrestrictionenabled_script).stdout.strip\n  describe 'Ensure the TenantRestrictionEnabled option for SharePoint/OneDrive Sync' do\n    subject { powershell_output_tenant }\n    it 'is set to True' do\n      expect(subject).to eq('True')\n    end\n  end\n\n  trusted_domains = input('trusted_domains_guids')\n  domain_pattern = trusted_domains.map { |domain| \"'#{domain}'\" }.join(', ')\n  ensure_trusted_domains_guids = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $sharepoint_admin_url = '#{input('sharepoint_admin_url')}'\n    import-module pnp.powershell\n    $password = (ConvertTo-SecureString -AsPlainText $certificate_password -Force)\n    Connect-PnPOnline -Url $sharepoint_admin_url -ClientId $client_id -CertificatePath $certificate_path -CertificatePassword $password  -Tenant $tenantid\n    $allowedDomains = (Get-PnPTenant).AllowedDomainList\n    $trustedDomains = @(#{domain_pattern})\n    $domainList = $domain_data -split ' '\n    $untrustedDomains = $allowedDomains | Where-Object { -not ($trustedDomains -contains $_) }\n    if ($untrustedDomains.Count -gt 0) {\n        Write-Output \"Some domains are not in the list of trusted domains: $($untrustedDomains -join ', ')\"\n    }\n  }\n  powershell_output_domains = powershell(ensure_trusted_domains_guids).stdout.strip\n  describe 'Ensure the number of domains GUIDs not trusted from AllowedDomainList option on SharePoint' do\n    subject { powershell_output_domains }\n    failure_message = \"Failure: #{powershell_output_domains}\"\n    it 'is 0' do\n      expect(subject).to be_empty, failure_message\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-7.3.2.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the TenantRestrictionEnabled option for SharePoint/OneDrive Sync is set to True","run_time":5.3e-05,"start_time":"2024-09-24T15:51:50-04:00","message":"\nexpected: \"True\"\n     got: \"False\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the TenantRestrictionEnabled option for SharePoint/OneDrive Sync"},{"status":"passed","code_desc":"Ensure the number of domains GUIDs not trusted from AllowedDomainList option on SharePoint is 0","run_time":0.002355,"start_time":"2024-09-24T15:51:50-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the number of domains GUIDs not trusted from AllowedDomainList option on SharePoint"}]},{"id":"microsoft-365-foundations-7.3.3","title":"Ensure custom script execution is restricted on personal sites","desc":"This setting controls custom script execution on OneDrive or user-created sites.\n        Custom scripts can allow users to change the look, feel and behavior of sites and pages. Every script that runs in a SharePoint page (whether it's an HTML page in a document library or a JavaScript in a Script Editor Web Part) always runs in the context of the user visiting the page and the SharePoint application. This means:\n            • Scripts have access to everything the user has access to.\n            • Scripts can access content across several Microsoft 365 services and even beyond with Microsoft Graph integration.\n        The recommended state is Prevent users from running custom script on personal sites and Prevent users from running custom script on self-service created sites","descriptions":[{"label":"default","data":"This setting controls custom script execution on OneDrive or user-created sites.\n        Custom scripts can allow users to change the look, feel and behavior of sites and pages. Every script that runs in a SharePoint page (whether it's an HTML page in a document library or a JavaScript in a Script Editor Web Part) always runs in the context of the user visiting the page and the SharePoint application. This means:\n            • Scripts have access to everything the user has access to.\n            • Scripts can access content across several Microsoft 365 services and even beyond with Microsoft Graph integration.\n        The recommended state is Prevent users from running custom script on personal sites and Prevent users from running custom script on self-service created sites"},{"label":"check","data":"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Select Settings.\n        3. At the bottom of the page click the classic settings page hyperlink.\n        4. Scroll to locate the Custom Script section. On the right ensure the following:\n            o Verify Prevent users from running custom script on personal sites is set.\n            o Verify Prevent users from running custom script on self-service created sites is set."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Select Settings.\n        3. At the bottom of the page click the classic settings page hyperlink.\n        4. Scroll to locate the Custom Script section. On the right set the following:\n            o Select Prevent users from running custom script on personal sites.\n            o Select Prevent users from running custom script on self-service created sites."},{"label":"rationale","data":"Custom scripts could contain malicious instructions unknown to the user or\n        administrator. When users are allowed to run custom script, the organization can no\n        longer enforce governance, scope the capabilities of inserted code, block specific parts\n        of code, or block all custom code that has been deployed. If scripting is allowed the\n        following things can't be audited:\n          • What code has been inserted\n          • Where the code has been inserted\n          • Who inserted the code\n        Note: Microsoft recommends using the SharePoint Framework instead of custom\n        scripts."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/sharepoint/allow-or-prevent-custom-script"},{"ref":"https://learn.microsoft.com/en-us/sharepoint/security-considerations-of-allowing-custom-script"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/sharepoint-online/set-sposite?view=sharepoint-ps"}],"tags":{"severity":"medium","cis_controls":[{"8":["2.7"]}],"default_value":"Selected Prevent users from running custom script on personal sites\n                      Selected Prevent users from running custom script on self-service created\n                      sites","nist":["CM-7","CM-7(1)","SI-7","SI-7(1)"]},"code":"control 'microsoft-365-foundations-7.3.3' do\n  title 'Ensure custom script execution is restricted on personal sites'\n  desc \"This setting controls custom script execution on OneDrive or user-created sites.\n        Custom scripts can allow users to change the look, feel and behavior of sites and pages. Every script that runs in a SharePoint page (whether it's an HTML page in a document library or a JavaScript in a Script Editor Web Part) always runs in the context of the user visiting the page and the SharePoint application. This means:\n            • Scripts have access to everything the user has access to.\n            • Scripts can access content across several Microsoft 365 services and even beyond with Microsoft Graph integration.\n        The recommended state is Prevent users from running custom script on personal sites and Prevent users from running custom script on self-service created sites\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Select Settings.\n        3. At the bottom of the page click the classic settings page hyperlink.\n        4. Scroll to locate the Custom Script section. On the right ensure the following:\n            o Verify Prevent users from running custom script on personal sites is set.\n            o Verify Prevent users from running custom script on self-service created sites is set.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to SharePoint admin center https://admin.microsoft.com/sharepoint\n        2. Select Settings.\n        3. At the bottom of the page click the classic settings page hyperlink.\n        4. Scroll to locate the Custom Script section. On the right set the following:\n            o Select Prevent users from running custom script on personal sites.\n            o Select Prevent users from running custom script on self-service created sites.\"\n\n  desc 'rationale',\n       \"Custom scripts could contain malicious instructions unknown to the user or\n        administrator. When users are allowed to run custom script, the organization can no\n        longer enforce governance, scope the capabilities of inserted code, block specific parts\n        of code, or block all custom code that has been deployed. If scripting is allowed the\n        following things can't be audited:\n          • What code has been inserted\n          • Where the code has been inserted\n          • Who inserted the code\n        Note: Microsoft recommends using the SharePoint Framework instead of custom\n        scripts.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['2.7'] }]\n  tag default_value: 'Selected Prevent users from running custom script on personal sites\n                      Selected Prevent users from running custom script on self-service created\n                      sites'\n  tag nist: ['CM-7', 'CM-7(1)', 'SI-7', 'SI-7(1)']\n\n  ref 'https://learn.microsoft.com/en-us/sharepoint/allow-or-prevent-custom-script'\n  ref 'https://learn.microsoft.com/en-us/sharepoint/security-considerations-of-allowing-custom-script'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/sharepoint-online/set-sposite?view=sharepoint-ps'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-7.3.3.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":8.0e-06,"start_time":"2024-09-24T15:51:50-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-7.3.4","title":"Ensure custom script execution is restricted on site collections","desc":"This setting controls custom script execution on a particular site (previously called \"site collection\").\n        Custom scripts can allow users to change the look, feel and behavior of sites and pages. Every script that runs in a SharePoint page (whether it's an HTML page in a document library or a JavaScript in a Script Editor Web Part) always runs in the context of the user visiting the page and the SharePoint application. This means:\n            • Scripts have access to everything the user has access to.\n            • Scripts can access content across several Microsoft 365 services and even beyond with Microsoft Graph integration.\n        The recommended state is DenyAddAndCustomizePages set to $true.","descriptions":[{"label":"default","data":"This setting controls custom script execution on a particular site (previously called \"site collection\").\n        Custom scripts can allow users to change the look, feel and behavior of sites and pages. Every script that runs in a SharePoint page (whether it's an HTML page in a document library or a JavaScript in a Script Editor Web Part) always runs in the context of the user visiting the page and the SharePoint application. This means:\n            • Scripts have access to everything the user has access to.\n            • Scripts can access content across several Microsoft 365 services and even beyond with Microsoft Graph integration.\n        The recommended state is DenyAddAndCustomizePages set to $true."},{"label":"check","data":"To audit using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService.\n        2. Run the following PowerShell command to show non-compliant results:\n            Get-SPOSite | Where-Object { $_.DenyAddAndCustomizePages -eq \"Disabled\" ` -and $_.Url -notlike \"*-my.sharepoint.com/\" } | ft Title, Url, DenyAddAndCustomizePages\n        3. Ensure the returned value is for DenyAddAndCustomizePages is Enabled for each site.\n    Note: The property DenyAddAndCustomizePages cannot be set on the MySite host, which is displayed with a URL like https://tenant id-my.sharepoint.com/"},{"label":"fix","data":"To remediate using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService.\n        2. Edit the below and run for each site as needf8ed:\n            Set-SPOSite -Identity <SiteUrl> -DenyAddAndCustomizePages $true\n        Note: The property DenyAddAndCustomizePages cannot be set on the MySite host, which is displayed with a URL like https://tenant id-my.sharepoint.com/"},{"label":"rationale","data":"Custom scripts could contain malicious instructions unknown to the user or\n        administrator. When users are allowed to run custom script, the organization can no\n        longer enforce governance, scope the capabilities of inserted code, block specific parts\n        of code, or block all custom code that has been deployed. If scripting is allowed the\n        following things can't be audited:\n          • What code has been inserted\n          • Where the code has been inserted\n          • Who inserted the code\n        Note: Microsoft recommends using the SharePoint Framework instead of custom\n        scripts."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/sharepoint/allow-or-prevent-custom-script"},{"ref":"https://learn.microsoft.com/en-us/sharepoint/security-considerations-of-allowing-custom-script"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/sharepoint-online/set-sposite?view=sharepoint-ps"}],"tags":{"severity":"medium","cis_controls":[{"8":["2.7"]}],"default_value":"DenyAddAndCustomizePages $true or Enabled","nist":["CM-7","CM-7(1)","SI-7","SI-7(1)"]},"code":"control 'microsoft-365-foundations-7.3.4' do\n  title 'Ensure custom script execution is restricted on site collections'\n  desc \"This setting controls custom script execution on a particular site (previously called \\\"site collection\\\").\n        Custom scripts can allow users to change the look, feel and behavior of sites and pages. Every script that runs in a SharePoint page (whether it's an HTML page in a document library or a JavaScript in a Script Editor Web Part) always runs in the context of the user visiting the page and the SharePoint application. This means:\n            • Scripts have access to everything the user has access to.\n            • Scripts can access content across several Microsoft 365 services and even beyond with Microsoft Graph integration.\n        The recommended state is DenyAddAndCustomizePages set to $true.\"\n\n  desc 'check',\n       'To audit using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService.\n        2. Run the following PowerShell command to show non-compliant results:\n            Get-SPOSite | Where-Object { $_.DenyAddAndCustomizePages -eq \"Disabled\" ` -and $_.Url -notlike \"*-my.sharepoint.com/\" } | ft Title, Url, DenyAddAndCustomizePages\n        3. Ensure the returned value is for DenyAddAndCustomizePages is Enabled for each site.\n    Note: The property DenyAddAndCustomizePages cannot be set on the MySite host, which is displayed with a URL like https://tenant id-my.sharepoint.com/'\n\n  desc 'fix',\n       \"To remediate using PowerShell:\n        1. Connect to SharePoint Online using Connect-SPOService.\n        2. Edit the below and run for each site as needf8ed:\n            Set-SPOSite -Identity <SiteUrl> -DenyAddAndCustomizePages $true\n        Note: The property DenyAddAndCustomizePages cannot be set on the MySite host, which is displayed with a URL like https://tenant id-my.sharepoint.com/\"\n\n  desc 'rationale',\n       \"Custom scripts could contain malicious instructions unknown to the user or\n        administrator. When users are allowed to run custom script, the organization can no\n        longer enforce governance, scope the capabilities of inserted code, block specific parts\n        of code, or block all custom code that has been deployed. If scripting is allowed the\n        following things can't be audited:\n          • What code has been inserted\n          • Where the code has been inserted\n          • Who inserted the code\n        Note: Microsoft recommends using the SharePoint Framework instead of custom\n        scripts.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['2.7'] }]\n  tag default_value: 'DenyAddAndCustomizePages $true or Enabled'\n  tag nist: ['CM-7', 'CM-7(1)', 'SI-7', 'SI-7(1)']\n\n  ref 'https://learn.microsoft.com/en-us/sharepoint/allow-or-prevent-custom-script'\n  ref 'https://learn.microsoft.com/en-us/sharepoint/security-considerations-of-allowing-custom-script'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/sharepoint-online/set-sposite?view=sharepoint-ps'\n\n  ensure_spo_guest_users_cannot_share_items_dont_own_script = %{\n    $appName = 'cisBenchmarkL512'\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $clientSecret = '#{input('client_secret')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $sharepoint_admin_url = '#{input('sharepoint_admin_url')}'\n    import-module pnp.powershell\n    $password = (ConvertTo-SecureString -AsPlainText $certificate_password -Force)\n    Connect-PnPOnline -Url $sharepoint_admin_url -ClientId $client_id -CertificatePath $certificate_path -CertificatePassword $password  -Tenant $tenantid\n\t  Get-PnPTenantSite | Where-Object { $_.DenyAddAndCustomizePages -eq \"Disabled\" -and $_.Url -notlike \"*-my.sharepoint.com/\" } | Select-Object -ExpandProperty Url\n  }\n  powershell_output = powershell(ensure_spo_guest_users_cannot_share_items_dont_own_script).stdout.strip\n  disabled_urls = powershell_output.split(\"\\n\") unless powershell_output.empty?\n  describe 'Ensure the number of sites with DenyAddAndCustomizePages setting as Disabled' do\n    subject { powershell_output }\n    it 'is 0' do\n      failure_message = \"URLS with DenyAddAndCustomizePages setting as Disabled: #{disabled_urls}\"\n      expect(subject).to be_empty, failure_message\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-7.3.4.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the number of sites with DenyAddAndCustomizePages setting as Disabled is 0","run_time":0.002359,"start_time":"2024-09-24T15:51:50-04:00","message":"URLS with DenyAddAndCustomizePages setting as Disabled: [\"https://mitredev.sharepoint.com/sites/appcatalog\", \"https://mitredev.sharepoint.com/sites/Taylor-Swift\"]","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the number of sites with DenyAddAndCustomizePages setting as Disabled"}]},{"id":"microsoft-365-foundations-8.1.1","title":"Ensure external file sharing in Teams is enabled for only approved cloud storage services","desc":"Microsoft Teams enables collaboration via file sharing. This file sharing is conducted within Teams, using SharePoint Online, by default; however, third-party cloud services are allowed as well.\n        Note: Skype for business is deprecated as of July 31, 2021 although these settings may still be valid for a period of time. See the link in the references section for more information.","descriptions":[{"label":"default","data":"Microsoft Teams enables collaboration via file sharing. This file sharing is conducted within Teams, using SharePoint Online, by default; however, third-party cloud services are allowed as well.\n        Note: Skype for business is deprecated as of July 31, 2021 although these settings may still be valid for a period of time. See the link in the references section for more information."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Teams select Teams settings.\n        3. Under files verify that only authorized cloud storage options are set to On and all others Off.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams\n        2. Run the following to verify the recommended state:\n            Get-CsTeamsClientConfiguration | fl AllowDropbox,AllowBox,AllowGoogleDrive,AllowShareFile,AllowEgnyte\n        3. Verify that only authorized providers are set to True and all others False."},{"label":"fix","data":"To set external file sharing in Teams:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Teams select Teams settings.\n        3. Set any unauthorized providers to Off.\n    To set cloud sharing options using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams\n        2. Run the following PowerShell command to disable external providers that are not authorized. (the example disables Citrix Files, DropBox, Box, Google Drive and Egnyte)\n            $storageParams = @{ AllowGoogleDrive = $false AllowShareFile = $false AllowBox = $false AllowDropBox = $false AllowEgnyte = $false }\n            Set-CsTeamsClientConfiguration @storageParams"},{"label":"rationale","data":"Ensuring that only authorized cloud storage providers are accessible from Teams will\n        help to dissuade the use of non-approved storage providers."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/enterprise/manage-skype-for-business-online-with-microsoft-365-powershell?view=o365-worldwide"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.3"]},{"7":["14.7"]}],"default_value":"AllowDropBox : True\n                      AllowBox : True\n                      AllowGoogleDrive : True\n                      AllowShareFile : True\n                      AllowEgnyte : True","nist":["AC-3","AC-5","AC-6","MP-2","AT-2"]},"code":"control 'microsoft-365-foundations-8.1.1' do\n  title 'Ensure external file sharing in Teams is enabled for only approved cloud storage services'\n  desc \"Microsoft Teams enables collaboration via file sharing. This file sharing is conducted within Teams, using SharePoint Online, by default; however, third-party cloud services are allowed as well.\n        Note: Skype for business is deprecated as of July 31, 2021 although these settings may still be valid for a period of time. See the link in the references section for more information.\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Teams select Teams settings.\n        3. Under files verify that only authorized cloud storage options are set to On and all others Off.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams\n        2. Run the following to verify the recommended state:\n            Get-CsTeamsClientConfiguration | fl AllowDropbox,AllowBox,AllowGoogleDrive,AllowShareFile,AllowEgnyte\n        3. Verify that only authorized providers are set to True and all others False.\"\n\n  desc 'fix',\n       \"To set external file sharing in Teams:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Teams select Teams settings.\n        3. Set any unauthorized providers to Off.\n    To set cloud sharing options using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams\n        2. Run the following PowerShell command to disable external providers that are not authorized. (the example disables Citrix Files, DropBox, Box, Google Drive and Egnyte)\n            $storageParams = @{ AllowGoogleDrive = $false AllowShareFile = $false AllowBox = $false AllowDropBox = $false AllowEgnyte = $false }\n            Set-CsTeamsClientConfiguration @storageParams\"\n\n  desc 'rationale',\n       'Ensuring that only authorized cloud storage providers are accessible from Teams will\n        help to dissuade the use of non-approved storage providers.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['3.3'] }, { '7' => ['14.7'] }]\n  tag default_value: 'AllowDropBox : True\n                      AllowBox : True\n                      AllowGoogleDrive : True\n                      AllowShareFile : True\n                      AllowEgnyte : True'\n  tag nist: ['AC-3', 'AC-5', 'AC-6', 'MP-2', 'AT-2']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/enterprise/manage-skype-for-business-online-with-microsoft-365-powershell?view=o365-worldwide'\n\n  ensure_file_sharing_enabled_cloud_script = %{\n     $appName = 'cisBenchmarkL512'\n     $client_id = '#{input('client_id')}'\n     $tenantid = '#{input('tenant_id')}'\n     $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2('#{input('certificate_path')}','#{input('certificate_password')}')\n     import-module MicrosoftTeams\n     Connect-MicrosoftTeams -Certificate $cert -ApplicationId $client_id -TenantId $tenantid > $null\n\n     $teamsClientConfig = Get-CsTeamsClientConfiguration | Select-Object AllowDropbox,AllowBox,AllowGoogleDrive,AllowShareFile,AllowEgnyte\n     $allTrue = $false\n     foreach ($property in @('AllowDropbox', 'AllowBox', 'AllowGoogleDrive', 'AllowShareFile', 'AllowEgnyte')) {\n        if ($teamsClientConfig.$property -ne $true) {\n          $allTrue = $false\n          break\n        }\n      }\n      if ($allTrue) {\n          Write-Output \"True\"\n      } else {\n          Write-Output \"False\"\n      }\n    }\n\n  powershell_output = powershell(ensure_file_sharing_enabled_cloud_script)\n  describe 'Ensure that all the authorized cloud storage services ' do\n    subject { powershell_output.stdout.strip }\n    it 'are set to true' do\n      expect(subject).to eq('True')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-8.1.1.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure that all the authorized cloud storage services  are set to true","run_time":4.968797,"start_time":"2024-09-24T15:51:50-04:00","message":"\nexpected: \"True\"\n     got: \"False\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that all the authorized cloud storage services"}]},{"id":"microsoft-365-foundations-8.1.2","title":"Ensure users can't send emails to a channel email address","desc":"Teams channel email addresses are an optional feature that allows users to email the Teams channel directly.","descriptions":[{"label":"default","data":"Teams channel email addresses are an optional feature that allows users to email the Teams channel directly."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Teams select Teams settings.\n        3. Under email integration verify that Users can send emails to a channel email address is Off.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to verify the recommended state:\n            Get-CsTeamsClientConfiguration -Identity Global | fl AllowEmailIntoChannel\n        3. Ensure the returned value is False."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Teams select Teams settings.\n        3. Under email integration set Users can send emails to a channel email address to Off.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to set the recommended state:\n            Set-CsTeamsClientConfiguration -Identity Global -AllowEmailIntoChannel $false"},{"label":"rationale","data":"Channel email addresses are not under the tenant’s domain and organizations do not\n        have control over the security settings for this email address. An attacker could email\n        channels directly if they discover the channel email address."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/step-by-step-guides/reducing-attack-surface-in-microsoft-teams?view=o365-worldwide#restricting-channel-email-messages-to-approved-domains"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/skype/set-csteamsclientconfiguration?view=skype-ps"}],"tags":{"severity":"medium","cis_controls":[{"8":["untracked"]},{"7":["untracked"]}],"default_value":"On (True)","nist":["CM-6"]},"code":"control 'microsoft-365-foundations-8.1.2' do\n  title \"Ensure users can't send emails to a channel email address\"\n  desc 'Teams channel email addresses are an optional feature that allows users to email the Teams channel directly.'\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Teams select Teams settings.\n        3. Under email integration verify that Users can send emails to a channel email address is Off.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to verify the recommended state:\n            Get-CsTeamsClientConfiguration -Identity Global | fl AllowEmailIntoChannel\n        3. Ensure the returned value is False.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Teams select Teams settings.\n        3. Under email integration set Users can send emails to a channel email address to Off.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to set the recommended state:\n            Set-CsTeamsClientConfiguration -Identity Global -AllowEmailIntoChannel $false\"\n\n  desc 'rationale',\n       'Channel email addresses are not under the tenant’s domain and organizations do not\n        have control over the security settings for this email address. An attacker could email\n        channels directly if they discover the channel email address.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['untracked'] }, { '7' => ['untracked'] }]\n  tag default_value: 'On (True)'\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/step-by-step-guides/reducing-attack-surface-in-microsoft-teams?view=o365-worldwide#restricting-channel-email-messages-to-approved-domains'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/skype/set-csteamsclientconfiguration?view=skype-ps'\n\n  ensure_users_cant_send_emails_script = %{\n     $appName = 'cisBenchmarkL512'\n     $client_id = '#{input('client_id')}'\n     $tenantid = '#{input('tenant_id')}'\n     $clientSecret = '#{input('client_secret')}' #This should not be stored inside of any script; supplied to transmit detail #This should not be stored inside of any script; supplied to transmit detail\n     $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2('#{input('certificate_path')}','#{input('certificate_password')}')     $password = ConvertTo-SecureString -String $clientSecret -AsPlainText -Force\n     $ClientSecretCredential = New-Object -TypeName System.Management.Automation.PSCredential($client_id,$password)\n     import-module MicrosoftTeams\n     Connect-MicrosoftTeams -Certificate $cert -ApplicationId $client_id -TenantId $tenantid > $null\n     Write-Output (Get-CsTeamsClientConfiguration -Identity Global).AllowEmailIntoChannel\n  }\n\n  powershell_output = powershell(ensure_users_cant_send_emails_script)\n  describe 'Ensure that AllowEmailIntoChannel state' do\n    subject { powershell_output.stdout.strip }\n    it 'is set to False' do\n      expect(subject).to eq('False')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-8.1.2.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure that AllowEmailIntoChannel state is set to False","run_time":1.285459,"start_time":"2024-09-24T15:51:55-04:00","message":"\nexpected: \"False\"\n     got: \"\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that AllowEmailIntoChannel state"}]},{"id":"microsoft-365-foundations-8.2.1","title":"Ensure 'external access' is restricted in the Teams admin center","desc":"This policy setting controls chat with external unmanaged Skype and Teams users. Users in the organization will not be searchable by unmanaged Skype or Teams users and will have to initiate all communications with unmanaged users.\n        Note: As of December 2021, the default for Teams external communication is set to 'People in my organization can communicate with Teams users whose accounts aren't managed by an organization.'\n        Note #2: Skype for business is deprecated as of July 31, 2021, although these settings may still be valid for a period of time. See the link in the reference section for more information.","descriptions":[{"label":"default","data":"This policy setting controls chat with external unmanaged Skype and Teams users. Users in the organization will not be searchable by unmanaged Skype or Teams users and will have to initiate all communications with unmanaged users.\n        Note: As of December 2021, the default for Teams external communication is set to 'People in my organization can communicate with Teams users whose accounts aren't managed by an organization.'\n        Note #2: Skype for business is deprecated as of July 31, 2021, although these settings may still be valid for a period of time. See the link in the reference section for more information."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com/.\n        2. Click to expand Users select External access.\n        3. Under Teams and Skype for Business users in external organizations ensure Block all external domains\n            o If the organization's policy allows select Allow only specific external domains and add the allowed domains names.\n        4. Under Teams accounts not managed by an organization ensure the slider is set to Off.\n        5. Under Skype users ensure the slider is set to Off.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams\n        2. Run the following command: Get-CsTenantFederationConfiguration | fl AllowTeamsConsumer,AllowPublicUsers,AllowFederatedUsers,AllowedDomains\n            • State: AllowTeamsConsumer is False\n            • State: AllowPublicUsers is False\n            • State: AllowFederatedUsers is False OR,\n            • If: AllowFederatedUsers is True then ensure AllowedDomains contains authorized domain names."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com/.\n        2. Click to expand Users select External access.\n        3. Under Teams and Skype for Business users in external organizations Select Block all external domains\n            o If the organization's policy allows select any allowed external domains.\n        4. Under Teams accounts not managed by an organization move the slider to Off.\n        5. Under Skype users move the slider is to Off.\n        6. Click Save.\n    To remediate using PowerShell:\n        • Connect to Teams PowerShell using Connect-MicrosoftTeams\n        • Run the following command: Set-CsTenantFederationConfiguration -AllowTeamsConsumer False -AllowPublicUsers False -AllowFederatedUsers $false\n        • To allow only specific external domains run these commands replacing the example domains with approved domains: Set-CsTenantFederationConfiguration -AllowTeamsConsumer $false -AllowPublicUsers $false -AllowFederatedUsers $true $list = New-Object Collections.Generic.List[String] $list.add(\"contoso.com\") $list.add(\"fabrikam.com\") Set-CsTenantFederationConfiguration -AllowedDomainsAsAList $list\n        Default Value:\n            • AllowTeamsConsumer : True\n            • AllowPublicUsers : True\n            • AllowFederatedUsers : True\n            • AllowedDomains : AllowAllKnownDomains"},{"label":"rationale","data":"Allowing users to communicate with Skype or Teams users outside of an organization\n        presents a potential security threat as external users can interact with organization\n        users over Skype for Business or Teams. While legitimate, productivity-improving\n        scenarios exist, they are outweighed by the risk of data loss, phishing, and social\n        engineering attacks against organization users via Teams.\n        Some real-world attacks and exploits delivered via Teams over external access\n        channels include:\n        • DarkGate malware\n        • Social engineering / Phishing attacks by \"Midnight Blizzard\"\n        • GIFShell\n        • Username enumeration"}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/skypeforbusiness/set-up-skype-for-business-online/set-up-skype-for-business-online"},{"ref":"https://learn.microsoft.com/en-US/microsoftteams/manage-external-access?WT.mc_id=TeamsAdminCenterCSH"},{"ref":"https://cybersecurity.att.com/blogs/security-essentials/darkgate-malware-delivered-via-microsoft-teams-detection-and-response"},{"ref":"https://www.microsoft.com/en-us/security/blog/2023/08/02/midnight-blizzard-conducts-targeted-social-engineering-over-microsoft-teams/"},{"ref":"https://www.bitdefender.com/blog/hotforsecurity/gifshell-attack-lets-hackers-create-reverse-shell-through-microsoft-teams-gifs/"}],"tags":{"severity":"medium","cis_controls":[{"8":["untracked"]}],"default_value":"• AllowTeamsConsumer : True\n                    • AllowPublicUsers : True\n                    • AllowFederatedUsers : True\n                    • AllowedDomains : AllowAllKnownDomains","nist":["CM-6"]},"code":"control 'microsoft-365-foundations-8.2.1' do\n  title \"Ensure 'external access' is restricted in the Teams admin center\"\n  desc \"This policy setting controls chat with external unmanaged Skype and Teams users. Users in the organization will not be searchable by unmanaged Skype or Teams users and will have to initiate all communications with unmanaged users.\n        Note: As of December 2021, the default for Teams external communication is set to 'People in my organization can communicate with Teams users whose accounts aren't managed by an organization.'\n        Note #2: Skype for business is deprecated as of July 31, 2021, although these settings may still be valid for a period of time. See the link in the reference section for more information.\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com/.\n        2. Click to expand Users select External access.\n        3. Under Teams and Skype for Business users in external organizations ensure Block all external domains\n            o If the organization's policy allows select Allow only specific external domains and add the allowed domains names.\n        4. Under Teams accounts not managed by an organization ensure the slider is set to Off.\n        5. Under Skype users ensure the slider is set to Off.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams\n        2. Run the following command: Get-CsTenantFederationConfiguration | fl AllowTeamsConsumer,AllowPublicUsers,AllowFederatedUsers,AllowedDomains\n            • State: AllowTeamsConsumer is False\n            • State: AllowPublicUsers is False\n            • State: AllowFederatedUsers is False OR,\n            • If: AllowFederatedUsers is True then ensure AllowedDomains contains authorized domain names.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com/.\n        2. Click to expand Users select External access.\n        3. Under Teams and Skype for Business users in external organizations Select Block all external domains\n            o If the organization's policy allows select any allowed external domains.\n        4. Under Teams accounts not managed by an organization move the slider to Off.\n        5. Under Skype users move the slider is to Off.\n        6. Click Save.\n    To remediate using PowerShell:\n        • Connect to Teams PowerShell using Connect-MicrosoftTeams\n        • Run the following command: Set-CsTenantFederationConfiguration -AllowTeamsConsumer False -AllowPublicUsers False -AllowFederatedUsers $false\n        • To allow only specific external domains run these commands replacing the example domains with approved domains: Set-CsTenantFederationConfiguration -AllowTeamsConsumer $false -AllowPublicUsers $false -AllowFederatedUsers $true $list = New-Object Collections.Generic.List[String] $list.add(\\\"contoso.com\\\") $list.add(\\\"fabrikam.com\\\") Set-CsTenantFederationConfiguration -AllowedDomainsAsAList $list\n        Default Value:\n            • AllowTeamsConsumer : True\n            • AllowPublicUsers : True\n            • AllowFederatedUsers : True\n            • AllowedDomains : AllowAllKnownDomains\"\n\n  desc 'rationale',\n       'Allowing users to communicate with Skype or Teams users outside of an organization\n        presents a potential security threat as external users can interact with organization\n        users over Skype for Business or Teams. While legitimate, productivity-improving\n        scenarios exist, they are outweighed by the risk of data loss, phishing, and social\n        engineering attacks against organization users via Teams.\n        Some real-world attacks and exploits delivered via Teams over external access\n        channels include:\n        • DarkGate malware\n        • Social engineering / Phishing attacks by \"Midnight Blizzard\"\n        • GIFShell\n        • Username enumeration'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['untracked'] }]\n  tag default_value: '• AllowTeamsConsumer : True\n                    • AllowPublicUsers : True\n                    • AllowFederatedUsers : True\n                    • AllowedDomains : AllowAllKnownDomains'\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-us/skypeforbusiness/set-up-skype-for-business-online/set-up-skype-for-business-online'\n  ref 'https://learn.microsoft.com/en-US/microsoftteams/manage-external-access?WT.mc_id=TeamsAdminCenterCSH'\n  ref 'https://cybersecurity.att.com/blogs/security-essentials/darkgate-malware-delivered-via-microsoft-teams-detection-and-response'\n  ref 'https://www.microsoft.com/en-us/security/blog/2023/08/02/midnight-blizzard-conducts-targeted-social-engineering-over-microsoft-teams/'\n  ref 'https://www.bitdefender.com/blog/hotforsecurity/gifshell-attack-lets-hackers-create-reverse-shell-through-microsoft-teams-gifs/'\n\n  authorized_domains = input('authorized_domains_teams_admin_center')\n  domain_pattern = authorized_domains.map { |domain| \"'#{domain}'\" }.join(', ')\n  ensure_external_access_restricted_teams_admin_center_script = %{\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2('#{input('certificate_path')}','#{input('certificate_password')}')\n    import-module MicrosoftTeams\n    Connect-MicrosoftTeams -Certificate $cert -ApplicationId $client_id -TenantId $tenantid > $null\n    $authorizedDomains = @(#{domain_pattern})\n\n    $federationConfig = Get-CsTenantFederationConfiguration\n\n    $allowTeamsConsumer = $federationConfig.AllowTeamsConsumer -eq $false\n    $allowPublicUsers = $federationConfig.AllowPublicUsers -eq $false\n    $allowFederatedUsers = $federationConfig.AllowFederatedUsers\n\n    if ($allowTeamsConsumer) {\n    } else {\n        Write-Host \"AllowTeamsConsumer is not False\"\n    }\n\n    if ($allowPublicUsers) {\n    } else {\n        Write-Host \"AllowPublicUsers is not False\"\n    }\n\n    if (-not $allowFederatedUsers) {\n    } else {\n        $allowedDomains = $federationConfig.AllowedDomains\n        $unauthorizedDomains = $allowedDomains | Where-Object { $_ -notin $authorizedDomains }\n\n        if ($unauthorizedDomains.Count -eq 0) {\n        } else {\n            Write-Host \"There are also unauthorized domains: $unauthorizedDomains\"\n        }\n    }\n  }\n\n  powershell_output = powershell(ensure_external_access_restricted_teams_admin_center_script).stdout.strip\n  describe 'Ensure the AllowTeamsConsumer, AllowPublicUsers, AllowFederatedUsers, and AllowedDomains' do\n    subject { powershell_output }\n    it 'are set to appropriate values and authorized domains present' do\n      failure_message = \"The following failed:\\n#{powershell_output}\"\n      expect(subject).to be_empty, failure_message\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-8.2.1.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure the AllowTeamsConsumer, AllowPublicUsers, AllowFederatedUsers, and AllowedDomains are set to appropriate values and authorized domains present","run_time":0.003532,"start_time":"2024-09-24T15:51:57-04:00","message":"The following failed:\nAllowTeamsConsumer is not False\nAllowPublicUsers is not False\nThere are also unauthorized domains: AllowAllKnownDomains","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the AllowTeamsConsumer, AllowPublicUsers, AllowFederatedUsers, and AllowedDomains"}]},{"id":"microsoft-365-foundations-8.4.1","title":"Ensure app permission policies are configured","desc":"This policy setting controls which class of apps are available for users to install.","descriptions":[{"label":"default","data":"This policy setting controls which class of apps are available for users to install."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Teams apps select Manage apps.\n        3. In the upper right click Actions > Org-wide app settings.\n        4. For Microsoft apps verify that Let users install and use available apps by default is On or less permissive.\n        5. For Third-party apps verify Let users install and use available apps by default is Off.\n        6. For Custom apps verify Let users install and use available apps by default is Off.\n        7. For Custom apps verify Upload custom apps for personal use is Off.\n    Note: The Global Reader role is not able to view the Teams apps blade, Teams Administrator or higher is required."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Teams apps select Manage apps.\n        3. In the upper right click Actions > Org-wide app settings.\n        4. For Microsoft apps set Let users install and use available apps by default to On or less permissive.\n        5. For Third-party apps set Let users install and use available apps by default to Off.\n        6. For Custom apps set Let users install and use available apps by default to Off.\n        7. For Custom apps set Upload custom apps for personal use to Off."},{"label":"rationale","data":"Allowing users to install third-party or unverified apps poses a potential risk of\n        introducing malicious software to the environment."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoftteams/app-centric-management"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/step-by-step-guides/reducing-attack-surface-in-microsoft-teams?view=o365-worldwide#disabling-third-party--custom-apps"}],"tags":{"severity":"medium","cis_controls":[{"8":["2.5"]},{"7":["2.7"]}],"default_value":"Microsoft apps: On\n                      Third-party apps: On\n                      Custom apps: On","nist":["CM-7(5)","CM-10","CM-7","CM-7(1)","SI-7","SI-7(1)"]},"code":"control 'microsoft-365-foundations-8.4.1' do\n  title 'Ensure app permission policies are configured'\n  desc 'This policy setting controls which class of apps are available for users to install.'\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Teams apps select Manage apps.\n        3. In the upper right click Actions > Org-wide app settings.\n        4. For Microsoft apps verify that Let users install and use available apps by default is On or less permissive.\n        5. For Third-party apps verify Let users install and use available apps by default is Off.\n        6. For Custom apps verify Let users install and use available apps by default is Off.\n        7. For Custom apps verify Upload custom apps for personal use is Off.\n    Note: The Global Reader role is not able to view the Teams apps blade, Teams Administrator or higher is required.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Teams apps select Manage apps.\n        3. In the upper right click Actions > Org-wide app settings.\n        4. For Microsoft apps set Let users install and use available apps by default to On or less permissive.\n        5. For Third-party apps set Let users install and use available apps by default to Off.\n        6. For Custom apps set Let users install and use available apps by default to Off.\n        7. For Custom apps set Upload custom apps for personal use to Off.\"\n\n  desc 'rationale',\n       'Allowing users to install third-party or unverified apps poses a potential risk of\n        introducing malicious software to the environment.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['2.5'] }, { '7' => ['2.7'] }]\n  tag default_value: 'Microsoft apps: On\n                      Third-party apps: On\n                      Custom apps: On'\n  tag nist: ['CM-7(5)', 'CM-10', 'CM-7', 'CM-7(1)', 'SI-7', 'SI-7(1)']\n\n  ref 'https://learn.microsoft.com/en-us/microsoftteams/app-centric-management'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/step-by-step-guides/reducing-attack-surface-in-microsoft-teams?view=o365-worldwide#disabling-third-party--custom-apps'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-8.4.1.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":7.0e-06,"start_time":"2024-09-24T15:51:57-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-8.5.1","title":"Ensure anonymous users can't join a meeting","desc":"This policy setting can prevent anyone other than invited attendees (people directly invited by the organizer, or to whom an invitation was forwarded) from bypassing the lobby and entering the meeting.\n        For more information on how to setup a sensitive meeting, please visit Configure Teams meetings with protection for sensitive data - Microsoft Teams: https://learn.microsoft.com/en-us/MicrosoftTeams/configure-meetings-sensitive-protection","descriptions":[{"label":"default","data":"This policy setting can prevent anyone other than invited attendees (people directly invited by the organizer, or to whom an invitation was forwarded) from bypassing the lobby and entering the meeting.\n        For more information on how to setup a sensitive meeting, please visit Configure Teams meetings with protection for sensitive data - Microsoft Teams: https://learn.microsoft.com/en-us/MicrosoftTeams/configure-meetings-sensitive-protection"},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting join & lobby verify that Anonymous users can join a meeting is set to Off.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to verify the recommended state:\n            Get-CsTeamsMeetingPolicy -Identity Global | fl AllowAnonymousUsersToJoinMeeting\n        3. Ensure the returned value is False."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default)\n        4. Under meeting join & lobby set Anonymous users can join a meeting to Off.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams\n        2. Run the following command to set the recommended state:\n            Set-CsTeamsMeetingPolicy -Identity Global -AllowAnonymousUsersToJoinMeeting $false"},{"label":"rationale","data":"For meetings that could contain sensitive information, it is best to allow the meeting\n        organizer to vet anyone not directly sent an invite before admitting them to the meeting.\n        This will also prevent the anonymous user from using the meeting link to have meetings\n        at unscheduled times.\n        Note: Those companies that don't normally operate at a Level 2 environment, but do\n        deal with sensitive information, may want to consider this policy setting."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/MicrosoftTeams/configure-meetings-sensitive-protection"}],"tags":{"severity":"medium","cis_controls":[{"8":["untracked"]},{"7":["untracked"]}],"default_value":"On (True)","nist":["CM-6"]},"code":"control 'microsoft-365-foundations-8.5.1' do\n  title \"Ensure anonymous users can't join a meeting\"\n  desc \"This policy setting can prevent anyone other than invited attendees (people directly invited by the organizer, or to whom an invitation was forwarded) from bypassing the lobby and entering the meeting.\n        For more information on how to setup a sensitive meeting, please visit Configure Teams meetings with protection for sensitive data - Microsoft Teams: https://learn.microsoft.com/en-us/MicrosoftTeams/configure-meetings-sensitive-protection\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting join & lobby verify that Anonymous users can join a meeting is set to Off.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to verify the recommended state:\n            Get-CsTeamsMeetingPolicy -Identity Global | fl AllowAnonymousUsersToJoinMeeting\n        3. Ensure the returned value is False.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default)\n        4. Under meeting join & lobby set Anonymous users can join a meeting to Off.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams\n        2. Run the following command to set the recommended state:\n            Set-CsTeamsMeetingPolicy -Identity Global -AllowAnonymousUsersToJoinMeeting $false\"\n\n  desc 'rationale',\n       \"For meetings that could contain sensitive information, it is best to allow the meeting\n        organizer to vet anyone not directly sent an invite before admitting them to the meeting.\n        This will also prevent the anonymous user from using the meeting link to have meetings\n        at unscheduled times.\n        Note: Those companies that don't normally operate at a Level 2 environment, but do\n        deal with sensitive information, may want to consider this policy setting.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['untracked'] }, { '7' => ['untracked'] }]\n  tag default_value: 'On (True)'\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-us/MicrosoftTeams/configure-meetings-sensitive-protection'\n\n  ensure_anonymous_users_cant_join_script = %{\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2('#{input('certificate_path')}','#{input('certificate_password')}')\n    import-module MicrosoftTeams\n    Connect-MicrosoftTeams -Certificate $cert -ApplicationId $client_id -TenantId $tenantid > $null\n    Write-Output (Get-CsTeamsMeetingPolicy -Identity Global).AllowAnonymousUsersToJoinMeeting\n  }\n  powershell_output = powershell(ensure_anonymous_users_cant_join_script)\n  describe 'Ensure that AllowAnonymousUsersToJoinMeeting state' do\n    subject { powershell_output.stdout.strip }\n    it 'is set to False' do\n      expect(subject).to eq('False')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-8.5.1.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure that AllowAnonymousUsersToJoinMeeting state is set to False","run_time":3.931,"start_time":"2024-09-24T15:51:57-04:00","message":"\nexpected: \"False\"\n     got: \"True\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that AllowAnonymousUsersToJoinMeeting state"}]},{"id":"microsoft-365-foundations-8.5.2","title":"Ensure anonymous users and dial-in callers can't start a meeting","desc":"This policy setting controls if an anonymous participant can start a Microsoft Teams meeting without someone in attendance. Anonymous users and dial-in callers must wait in the lobby until the meeting is started by someone in the organization or an external user from a trusted organization.\n        Anonymous participants are classified as:\n            • Participants who are not logged in to Teams with a work or school account.\n            • Participants from non-trusted organizations (as configured in external access).\n            • Participants from organizations where there is not mutual trust.\n        Note: This setting only applies when Who can bypass the lobby is set to Everyone. If the anonymous users can join a meeting organization-level setting or meeting policy is Off, this setting only applies to dial-in callers.","descriptions":[{"label":"default","data":"This policy setting controls if an anonymous participant can start a Microsoft Teams meeting without someone in attendance. Anonymous users and dial-in callers must wait in the lobby until the meeting is started by someone in the organization or an external user from a trusted organization.\n        Anonymous participants are classified as:\n            • Participants who are not logged in to Teams with a work or school account.\n            • Participants from non-trusted organizations (as configured in external access).\n            • Participants from organizations where there is not mutual trust.\n        Note: This setting only applies when Who can bypass the lobby is set to Everyone. If the anonymous users can join a meeting organization-level setting or meeting policy is Off, this setting only applies to dial-in callers."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting join & lobby verify that Anonymous users and dial-in callers can start a meeting is set to Off.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to verify the recommended state:\n            Get-CsTeamsMeetingPolicy -Identity Global | fl AllowAnonymousUsersToStartMeeting\n        3. Ensure the returned value is False."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting join & lobby set Anonymous users and dial-in callers can start a meeting to Off.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to set the recommended state:\n            Set-CsTeamsMeetingPolicy -Identity Global -AllowAnonymousUsersToStartMeeting $false"},{"label":"rationale","data":"Not allowing anonymous participants to automatically join a meeting reduces the risk of\n        meeting spamming."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoftteams/anonymous-users-in-meetings"},{"ref":"https://learn.microsoft.com/en-US/microsoftteams/who-can-bypass-meeting-lobby?WT.mc_id=TeamsAdminCenterCSH#overview-of-lobby-settings-and-policies"}],"tags":{"severity":"medium","cis_controls":[{"8":["untracked"]},{"7":["untracked"]}],"default_value":"Off (False)","nist":["CM-6"]},"code":"control 'microsoft-365-foundations-8.5.2' do\n  title \"Ensure anonymous users and dial-in callers can't start a meeting\"\n  desc \"This policy setting controls if an anonymous participant can start a Microsoft Teams meeting without someone in attendance. Anonymous users and dial-in callers must wait in the lobby until the meeting is started by someone in the organization or an external user from a trusted organization.\n        Anonymous participants are classified as:\n            • Participants who are not logged in to Teams with a work or school account.\n            • Participants from non-trusted organizations (as configured in external access).\n            • Participants from organizations where there is not mutual trust.\n        Note: This setting only applies when Who can bypass the lobby is set to Everyone. If the anonymous users can join a meeting organization-level setting or meeting policy is Off, this setting only applies to dial-in callers.\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting join & lobby verify that Anonymous users and dial-in callers can start a meeting is set to Off.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to verify the recommended state:\n            Get-CsTeamsMeetingPolicy -Identity Global | fl AllowAnonymousUsersToStartMeeting\n        3. Ensure the returned value is False.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting join & lobby set Anonymous users and dial-in callers can start a meeting to Off.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to set the recommended state:\n            Set-CsTeamsMeetingPolicy -Identity Global -AllowAnonymousUsersToStartMeeting $false\"\n\n  desc 'rationale',\n       'Not allowing anonymous participants to automatically join a meeting reduces the risk of\n        meeting spamming.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['untracked'] }, { '7' => ['untracked'] }]\n  tag default_value: 'Off (False)'\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-us/microsoftteams/anonymous-users-in-meetings'\n  ref 'https://learn.microsoft.com/en-US/microsoftteams/who-can-bypass-meeting-lobby?WT.mc_id=TeamsAdminCenterCSH#overview-of-lobby-settings-and-policies'\n\n  ensure_anonymous_users_cant_start_script = %{\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2('#{input('certificate_path')}','#{input('certificate_password')}')\n    import-module MicrosoftTeams\n    Connect-MicrosoftTeams -Certificate $cert -ApplicationId $client_id -TenantId $tenantid > $null\n    Write-Output (Get-CsTeamsMeetingPolicy -Identity Global).AllowAnonymousUsersToStartMeeting\n  }\n\n  powershell_output = powershell(ensure_anonymous_users_cant_start_script)\n  describe 'Ensure that AllowAnonymousUsersToStartMeeting state' do\n    subject { powershell_output.stdout.strip }\n    it 'is set to False' do\n      expect(subject).to eq('False')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-8.5.2.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure that AllowAnonymousUsersToStartMeeting state is set to False","run_time":3.069558,"start_time":"2024-09-24T15:52:00-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that AllowAnonymousUsersToStartMeeting state"}]},{"id":"microsoft-365-foundations-8.5.3","title":"Ensure only people in my org can bypass the lobby","desc":"This policy setting controls who can join a meeting directly and who must wait in the lobby until they're admitted by an organizer, co-organizer, or presenter of the meeting.","descriptions":[{"label":"default","data":"This policy setting controls who can join a meeting directly and who must wait in the lobby until they're admitted by an organizer, co-organizer, or presenter of the meeting."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting join & lobby verify Who can bypass the lobby is set to People in my org.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to verify the recommended state:\n            Get-CsTeamsMeetingPolicy -Identity Global | fl AutoAdmittedUsers\n        3. Ensure the returned value is EveryoneInCompanyExcludingGuests"},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting join & lobby set Who can bypass the lobby to People in my org.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to set the recommended state:\n            Set-CsTeamsMeetingPolicy -Identity Global -AutoAdmittedUsers \"EveryoneInCompanyExcludingGuests\""},{"label":"rationale","data":"For meetings that could contain sensitive information, it is best to allow the meeting\n        organizer to vet anyone not directly sent an invite before admitting them to the meeting.\n        This will also prevent the anonymous user from using the meeting link to have meetings\n        at unscheduled times."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-US/microsoftteams/who-can-bypass-meeting-lobby?WT.mc_id=TeamsAdminCenterCSH"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/skype/set-csteamsmeetingpolicy?view=skype-ps"}],"tags":{"severity":"medium","cis_controls":[{"8":["6.8"]}],"default_value":"People in my org and guests (EveryoneInCompany)","nist":["AC-2","AC-5","AC-6","AC-6(1)","AC-6(7)","AU-9(4)"]},"code":"control 'microsoft-365-foundations-8.5.3' do\n  title 'Ensure only people in my org can bypass the lobby'\n  desc \"This policy setting controls who can join a meeting directly and who must wait in the lobby until they're admitted by an organizer, co-organizer, or presenter of the meeting.\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting join & lobby verify Who can bypass the lobby is set to People in my org.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to verify the recommended state:\n            Get-CsTeamsMeetingPolicy -Identity Global | fl AutoAdmittedUsers\n        3. Ensure the returned value is EveryoneInCompanyExcludingGuests\"\n\n  desc 'fix',\n       'To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting join & lobby set Who can bypass the lobby to People in my org.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to set the recommended state:\n            Set-CsTeamsMeetingPolicy -Identity Global -AutoAdmittedUsers \"EveryoneInCompanyExcludingGuests\"'\n\n  desc 'rationale',\n       'For meetings that could contain sensitive information, it is best to allow the meeting\n        organizer to vet anyone not directly sent an invite before admitting them to the meeting.\n        This will also prevent the anonymous user from using the meeting link to have meetings\n        at unscheduled times.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['6.8'] }]\n  tag default_value: 'People in my org and guests (EveryoneInCompany)'\n  tag nist: ['AC-2', 'AC-5', 'AC-6', 'AC-6(1)', 'AC-6(7)', 'AU-9(4)']\n\n  ref 'https://learn.microsoft.com/en-US/microsoftteams/who-can-bypass-meeting-lobby?WT.mc_id=TeamsAdminCenterCSH'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/skype/set-csteamsmeetingpolicy?view=skype-ps'\n\n  ensure_people_in_org_bypass_lobby_script = %{\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2('#{input('certificate_path')}','#{input('certificate_password')}')\n    import-module MicrosoftTeams\n    Connect-MicrosoftTeams -Certificate $cert -ApplicationId $client_id -TenantId $tenantid > $null\n    Write-Output (Get-CsTeamsMeetingPolicy -Identity Global).AutoAdmittedUsers\n  }\n\n  powershell_output = powershell(ensure_people_in_org_bypass_lobby_script)\n  describe 'Ensure that the AutoAdmittedUsers state' do\n    subject { powershell_output.stdout.strip }\n    it 'is set to EveryoneInCompanyExcludingGuests' do\n      expect(subject).to eq('EveryoneInCompanyExcludingGuests')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-8.5.3.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure that the AutoAdmittedUsers state is set to EveryoneInCompanyExcludingGuests","run_time":3.357598,"start_time":"2024-09-24T15:52:04-04:00","message":"\nexpected: \"EveryoneInCompanyExcludingGuests\"\n     got: \"EveryoneInCompany\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the AutoAdmittedUsers state"}]},{"id":"microsoft-365-foundations-8.5.4","title":"Ensure users dialing in can't bypass the lobby","desc":"This policy setting controls if users who dial in by phone can join the meeting directly or must wait in the lobby. Admittance to the meeting from the lobby is authorized by the meeting organizer, co-organizer, or presenter of the meeting.","descriptions":[{"label":"default","data":"This policy setting controls if users who dial in by phone can join the meeting directly or must wait in the lobby. Admittance to the meeting from the lobby is authorized by the meeting organizer, co-organizer, or presenter of the meeting."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting join & lobby verify that People dialing in can bypass the lobby is set to Off.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to verify the recommended state:\n            Get-CsTeamsMeetingPolicy -Identity Global | fl AllowPSTNUsersToBypassLobby\n        3. Ensure the value is False."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting join & lobby set People dialing in can bypass the lobby to Off.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to set the recommended state:\n            Set-CsTeamsMeetingPolicy -Identity Global -AllowPSTNUsersToBypassLobby $false"},{"label":"rationale","data":"For meetings that could contain sensitive information, it is best to allow the meeting\n        organizer to vet anyone not directly from the organization."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-US/microsoftteams/who-can-bypass-meeting-lobby?WT.mc_id=TeamsAdminCenterCSH#choose-who-can-bypass-the-lobby-in-meetings-hosted-by-your-organization"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/skype/set-csteamsmeetingpolicy?view=skype-ps"}],"tags":{"severity":"medium","cis_controls":[{"8":["untracked"]},{"7":["untracked"]}],"default_value":"Off (False)","nist":["CM-6"]},"code":"control 'microsoft-365-foundations-8.5.4' do\n  title \"Ensure users dialing in can't bypass the lobby\"\n  desc 'This policy setting controls if users who dial in by phone can join the meeting directly or must wait in the lobby. Admittance to the meeting from the lobby is authorized by the meeting organizer, co-organizer, or presenter of the meeting.'\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting join & lobby verify that People dialing in can bypass the lobby is set to Off.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to verify the recommended state:\n            Get-CsTeamsMeetingPolicy -Identity Global | fl AllowPSTNUsersToBypassLobby\n        3. Ensure the value is False.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting join & lobby set People dialing in can bypass the lobby to Off.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to set the recommended state:\n            Set-CsTeamsMeetingPolicy -Identity Global -AllowPSTNUsersToBypassLobby $false\"\n\n  desc 'rationale',\n       'For meetings that could contain sensitive information, it is best to allow the meeting\n        organizer to vet anyone not directly from the organization.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['untracked'] }, { '7' => ['untracked'] }]\n  tag default_value: 'Off (False)'\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-US/microsoftteams/who-can-bypass-meeting-lobby?WT.mc_id=TeamsAdminCenterCSH#choose-who-can-bypass-the-lobby-in-meetings-hosted-by-your-organization'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/skype/set-csteamsmeetingpolicy?view=skype-ps'\n\n  ensure_people_dialing_in_cant_bypass_lobby_script = %{\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2('#{input('certificate_path')}','#{input('certificate_password')}')\n    import-module MicrosoftTeams\n    Connect-MicrosoftTeams -Certificate $cert -ApplicationId $client_id -TenantId $tenantid > $null\n    Write-Output (Get-CsTeamsMeetingPolicy -Identity Global).AllowPSTNUsersToBypassLobby\n  }\n\n  powershell_output = powershell(ensure_people_dialing_in_cant_bypass_lobby_script)\n  describe 'Ensure that the AllowPSTNUsersToBypassLobby state' do\n    subject { powershell_output.stdout.strip }\n    it 'is set to False' do\n      expect(subject).to eq('False')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-8.5.4.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure that the AllowPSTNUsersToBypassLobby state is set to False","run_time":3.534282,"start_time":"2024-09-24T15:52:07-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the AllowPSTNUsersToBypassLobby state"}]},{"id":"microsoft-365-foundations-8.5.5","title":"Ensure meeting chat does not allow anonymous users","desc":"This policy setting controls who has access to read and write chat messages during a meeting.","descriptions":[{"label":"default","data":"This policy setting controls who has access to read and write chat messages during a meeting."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting engagement verify that Meeting chat is set to On for everyone but anonymous users.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to verify the recommended state:\n            Get-CsTeamsMeetingPolicy -Identity Global | fl MeetingChatEnabledType\n        3. Ensure the returned value is EnabledExceptAnonymous."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting engagement set Meeting chat to On for everyone but anonymous users.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to set the recommended state:\n            Set-CsTeamsMeetingPolicy -Identity Global -MeetingChatEnabledType \"EnabledExceptAnonymous\""},{"label":"rationale","data":"Ensuring that only authorized individuals can read and write chat messages during a\n        meeting reduces the risk that a malicious user can inadvertently show content that is not\n        appropriate or view sensitive information."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/powershell/module/skype/set-csteamsmeetingpolicy?view=skype-ps#-meetingchatenabledtype"}],"tags":{"severity":"medium","cis_controls":[{"8":["untracked"]},{"7":["untracked"]}],"default_value":"On for everyone (Enabled)","nist":["CM-6"]},"code":"control 'microsoft-365-foundations-8.5.5' do\n  title 'Ensure meeting chat does not allow anonymous users'\n  desc 'This policy setting controls who has access to read and write chat messages during a meeting.'\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting engagement verify that Meeting chat is set to On for everyone but anonymous users.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to verify the recommended state:\n            Get-CsTeamsMeetingPolicy -Identity Global | fl MeetingChatEnabledType\n        3. Ensure the returned value is EnabledExceptAnonymous.\"\n\n  desc 'fix',\n       'To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting engagement set Meeting chat to On for everyone but anonymous users.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to set the recommended state:\n            Set-CsTeamsMeetingPolicy -Identity Global -MeetingChatEnabledType \"EnabledExceptAnonymous\"'\n\n  desc 'rationale',\n       'Ensuring that only authorized individuals can read and write chat messages during a\n        meeting reduces the risk that a malicious user can inadvertently show content that is not\n        appropriate or view sensitive information.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['untracked'] }, { '7' => ['untracked'] }]\n  tag default_value: 'On for everyone (Enabled)'\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-us/powershell/module/skype/set-csteamsmeetingpolicy?view=skype-ps#-meetingchatenabledtype'\n\n  ensure_meeting_chat_not_allow_anon_users = %{\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2('#{input('certificate_path')}','#{input('certificate_password')}')\n    import-module MicrosoftTeams\n    Connect-MicrosoftTeams -Certificate $cert -ApplicationId $client_id -TenantId $tenantid > $null\n    Write-Output (Get-CsTeamsMeetingPolicy -Identity Global).MeetingChatEnabledType\n  }\n\n  powershell_output = powershell(ensure_meeting_chat_not_allow_anon_users)\n  describe 'Ensure that the MeetingChatEnabledType state' do\n    subject { powershell_output.stdout.strip }\n    it 'is set to EnabledExceptAnonymous' do\n      expect(subject).to eq('EnabledExceptAnonymous')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-8.5.5.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure that the MeetingChatEnabledType state is set to EnabledExceptAnonymous","run_time":3.201367,"start_time":"2024-09-24T15:52:10-04:00","message":"\nexpected: \"EnabledExceptAnonymous\"\n     got: \"Enabled\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the MeetingChatEnabledType state"}]},{"id":"microsoft-365-foundations-8.5.6","title":"Ensure only organizers and co-organizers can present","desc":"This policy setting controls who can present in a Teams meeting.\n        Note: Organizers and co-organizers can change this setting when the meeting is set up.","descriptions":[{"label":"default","data":"This policy setting controls who can present in a Teams meeting.\n        Note: Organizers and co-organizers can change this setting when the meeting is set up."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under content sharing verify Who can present is set to Only organizers and co-organizers.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to verify the recommended state:\n            Get-CsTeamsMeetingPolicy -Identity Global | fl DesignatedPresenterRoleMode\n        3. Ensure the returned value is OrganizerOnlyUserOverride."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under content sharing set Who can present to Only organizers and co-organizers.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to set the recommended state:\n            Set-CsTeamsMeetingPolicy -Identity Global -DesignatedPresenterRoleMode \"OrganizerOnlyUserOverride\""},{"label":"rationale","data":"Ensuring that only authorized individuals are able to present reduces the risk that a\n        malicious user can inadvertently show content that is not appropriate."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-US/microsoftteams/meeting-who-present-request-control"},{"ref":"https://learn.microsoft.com/en-us/microsoftteams/meeting-who-present-request-control#manage-who-can-present"},{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/step-by-step-guides/reducing-attack-surface-in-microsoft-teams?view=o365-worldwide#configure-meeting-settings-restrict-presenters"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/skype/set-csteamsmeetingpolicy?view=skype-ps"}],"tags":{"severity":"medium","cis_controls":[{"8":["untracked"]},{"7":["untracked"]}],"default_value":"Everyone (EveryoneUserOverride)","nist":["CM-6"]},"code":"control 'microsoft-365-foundations-8.5.6' do\n  title 'Ensure only organizers and co-organizers can present'\n  desc \"This policy setting controls who can present in a Teams meeting.\n        Note: Organizers and co-organizers can change this setting when the meeting is set up.\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under content sharing verify Who can present is set to Only organizers and co-organizers.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to verify the recommended state:\n            Get-CsTeamsMeetingPolicy -Identity Global | fl DesignatedPresenterRoleMode\n        3. Ensure the returned value is OrganizerOnlyUserOverride.\"\n\n  desc 'fix',\n       'To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under content sharing set Who can present to Only organizers and co-organizers.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to set the recommended state:\n            Set-CsTeamsMeetingPolicy -Identity Global -DesignatedPresenterRoleMode \"OrganizerOnlyUserOverride\"'\n\n  desc 'rationale',\n       'Ensuring that only authorized individuals are able to present reduces the risk that a\n        malicious user can inadvertently show content that is not appropriate.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['untracked'] }, { '7' => ['untracked'] }]\n  tag default_value: 'Everyone (EveryoneUserOverride)'\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-US/microsoftteams/meeting-who-present-request-control'\n  ref 'https://learn.microsoft.com/en-us/microsoftteams/meeting-who-present-request-control#manage-who-can-present'\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/step-by-step-guides/reducing-attack-surface-in-microsoft-teams?view=o365-worldwide#configure-meeting-settings-restrict-presenters'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/skype/set-csteamsmeetingpolicy?view=skype-ps'\n\n  ensure_organizers_only_can_present_script = %{\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2('#{input('certificate_path')}','#{input('certificate_password')}')\n    import-module MicrosoftTeams\n    Connect-MicrosoftTeams -Certificate $cert -ApplicationId $client_id -TenantId $tenantid > $null\n    Write-Output (Get-CsTeamsMeetingPolicy -Identity Global).DesignatedPresenterRoleMode\n  }\n\n  powershell_output = powershell(ensure_organizers_only_can_present_script)\n  describe 'Ensure that the DesignatedPresenterRoleMode state' do\n    subject { powershell_output.stdout.strip }\n    it 'is set to OrganizerOnlyUserOverride' do\n      expect(subject).to eq('OrganizerOnlyUserOverride')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-8.5.6.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure that the DesignatedPresenterRoleMode state is set to OrganizerOnlyUserOverride","run_time":3.918376,"start_time":"2024-09-24T15:52:14-04:00","message":"\nexpected: \"OrganizerOnlyUserOverride\"\n     got: \"EveryoneUserOverride\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the DesignatedPresenterRoleMode state"}]},{"id":"microsoft-365-foundations-8.5.7","title":"Ensure external participants can't give or request control","desc":"This policy setting allows control of who can present in meetings and who can request control of the presentation while a meeting is underway.","descriptions":[{"label":"default","data":"This policy setting allows control of who can present in meetings and who can request control of the presentation while a meeting is underway."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under content sharing verify that External participants can give or request control is Off.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to verify the recommended state:\n            Get-CsTeamsMeetingPolicy -Identity Global | fl AllowExternalParticipantGiveRequestControl\n        3. Ensure the returned value is False."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under content sharing set External participants can give or request control to Off.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to set the recommended state:\n            Set-CsTeamsMeetingPolicy -Identity Global -AllowExternalParticipantGiveRequestControl $false"},{"label":"rationale","data":"Ensuring that only authorized individuals and not external participants are able to\n        present and request control reduces the risk that a malicious user can inadvertently\n        show content that is not appropriate.\n        External participants are categorized as follows: external users, guests, and anonymous\n        users."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoftteams/meeting-who-present-request-control"},{"ref":"https://learn.microsoft.com/en-us/powershell/module/skype/set-csteamsmeetingpolicy?view=skype-ps"}],"tags":{"severity":"medium","cis_controls":[{"8":["untracked"]},{"7":["untracked"]}],"default_value":"Off (False)","nist":["CM-6"]},"code":"control 'microsoft-365-foundations-8.5.7' do\n  title \"Ensure external participants can't give or request control\"\n  desc 'This policy setting allows control of who can present in meetings and who can request control of the presentation while a meeting is underway.'\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under content sharing verify that External participants can give or request control is Off.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to verify the recommended state:\n            Get-CsTeamsMeetingPolicy -Identity Global | fl AllowExternalParticipantGiveRequestControl\n        3. Ensure the returned value is False.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under content sharing set External participants can give or request control to Off.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to set the recommended state:\n            Set-CsTeamsMeetingPolicy -Identity Global -AllowExternalParticipantGiveRequestControl $false\"\n\n  desc 'rationale',\n       'Ensuring that only authorized individuals and not external participants are able to\n        present and request control reduces the risk that a malicious user can inadvertently\n        show content that is not appropriate.\n        External participants are categorized as follows: external users, guests, and anonymous\n        users.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['untracked'] }, { '7' => ['untracked'] }]\n  tag default_value: 'Off (False)'\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-us/microsoftteams/meeting-who-present-request-control'\n  ref 'https://learn.microsoft.com/en-us/powershell/module/skype/set-csteamsmeetingpolicy?view=skype-ps'\n\n  ensure_organizers_only_can_present_script = %{\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2('#{input('certificate_path')}','#{input('certificate_password')}')\n    import-module MicrosoftTeams\n    Connect-MicrosoftTeams -Certificate $cert -ApplicationId $client_id -TenantId $tenantid > $null\n    Write-Output (Get-CsTeamsMeetingPolicy -Identity Global).AllowExternalParticipantGiveRequestControl\n  }\n\n  powershell_output = powershell(ensure_organizers_only_can_present_script)\n  describe 'Ensure that the AllowExternalParticipantGiveRequestControl state' do\n    subject { powershell_output.stdout.strip }\n    it 'is set to False' do\n      expect(subject).to eq('False')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-8.5.7.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure that the AllowExternalParticipantGiveRequestControl state is set to False","run_time":4.935312,"start_time":"2024-09-24T15:52:18-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the AllowExternalParticipantGiveRequestControl state"}]},{"id":"microsoft-365-foundations-8.5.8","title":"Ensure external meeting chat is off","desc":"This meeting policy setting controls whether users can read or write messages in external meeting chats with untrusted organizations. If an external organization is on the list of trusted organizations this setting will be ignored.","descriptions":[{"label":"default","data":"This meeting policy setting controls whether users can read or write messages in external meeting chats with untrusted organizations. If an external organization is on the list of trusted organizations this setting will be ignored."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting engagement verify that External meeting chat is set to Off.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to verify the recommended state:\n            Get-CsTeamsMeetingPolicy -Identity Global | fl AllowExternalNonTrustedMeetingChat\n        3. Ensure the returned value is False."},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting engagement set External meeting chat to Off.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to set the recommended state:\n            Set-CsTeamsMeetingPolicy -Identity Global -AllowExternalNonTrustedMeetingChat $false"},{"label":"rationale","data":"Restricting access to chat in meetings hosted by external organizations limits the\n        opportunity for an exploit like GIFShell or DarkGate malware from being delivered to\n        users."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-US/microsoftteams/settings-policies-reference?WT.mc_id=TeamsAdminCenterCSH#meeting-engagement"}],"tags":{"severity":"medium","cis_controls":[{"8":["16.10"]}],"default_value":"On(True)","nist":["PL-8","SA-8"]},"code":"control 'microsoft-365-foundations-8.5.8' do\n  title 'Ensure external meeting chat is off'\n  desc 'This meeting policy setting controls whether users can read or write messages in external meeting chats with untrusted organizations. If an external organization is on the list of trusted organizations this setting will be ignored.'\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting engagement verify that External meeting chat is set to Off.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to verify the recommended state:\n            Get-CsTeamsMeetingPolicy -Identity Global | fl AllowExternalNonTrustedMeetingChat\n        3. Ensure the returned value is False.\"\n\n  desc 'fix',\n       \"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Meetings select Meeting policies.\n        3. Click Global (Org-wide default).\n        4. Under meeting engagement set External meeting chat to Off.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Run the following command to set the recommended state:\n            Set-CsTeamsMeetingPolicy -Identity Global -AllowExternalNonTrustedMeetingChat $false\"\n\n  desc 'rationale',\n       'Restricting access to chat in meetings hosted by external organizations limits the\n        opportunity for an exploit like GIFShell or DarkGate malware from being delivered to\n        users.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['16.10'] }]\n  tag default_value: 'On(True)'\n  tag nist: ['PL-8', 'SA-8']\n\n  ref 'https://learn.microsoft.com/en-US/microsoftteams/settings-policies-reference?WT.mc_id=TeamsAdminCenterCSH#meeting-engagement'\n\n  ensure_external_meeting_chat_off_script = %{\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2('#{input('certificate_path')}','#{input('certificate_password')}')\n    import-module MicrosoftTeams\n    Connect-MicrosoftTeams -Certificate $cert -ApplicationId $client_id -TenantId $tenantid > $null\n    Write-Output (Get-CsTeamsMeetingPolicy -Identity Global).AllowExternalNonTrustedMeetingChat\n  }\n\n  powershell_output = powershell(ensure_external_meeting_chat_off_script)\n  describe 'Ensure that the AllowExternalNonTrustedMeetingChat state' do\n    subject { powershell_output.stdout.strip }\n    it 'is set to False' do\n      expect(subject).to eq('False')\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-8.5.8.rb"},"waiver_data":{},"results":[{"status":"failed","code_desc":"Ensure that the AllowExternalNonTrustedMeetingChat state is set to False","run_time":4.544347,"start_time":"2024-09-24T15:52:22-04:00","message":"\nexpected: \"False\"\n     got: \"True\"\n\n(compared using ==)\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the AllowExternalNonTrustedMeetingChat state"}]},{"id":"microsoft-365-foundations-8.6.1","title":"Ensure users can report security concerns in Teams","desc":"User reporting settings allow a user to report a message as malicious for further analysis. This recommendation is composed of 3 different settings and all be configured to pass:\n        • In the Teams admin center: On by default and controls whether users are able to report messages from Teams. When this setting is turned off, users can't report messages within Teams, so the corresponding setting in the Microsoft 365 Defender portal is irrelevant.\n        • In the Microsoft 365 Defender portal: On by default for new tenants. Existing tenants need to enable it. If user reporting of messages is turned on in the Teams admin center, it also needs to be turned on the Defender portal for user reported messages to show up correctly on the User reported tab on the Submissions page.\n        • Defender - Report message destinations: This applies to more than just Microsoft Teams and allows for an organization to keep their reports contained. Due to how the parameters are configured on the backend it is included in this assessment as a requirement.","descriptions":[{"label":"default","data":"User reporting settings allow a user to report a message as malicious for further analysis. This recommendation is composed of 3 different settings and all be configured to pass:\n        • In the Teams admin center: On by default and controls whether users are able to report messages from Teams. When this setting is turned off, users can't report messages within Teams, so the corresponding setting in the Microsoft 365 Defender portal is irrelevant.\n        • In the Microsoft 365 Defender portal: On by default for new tenants. Existing tenants need to enable it. If user reporting of messages is turned on in the Teams admin center, it also needs to be turned on the Defender portal for user reported messages to show up correctly on the User reported tab on the Submissions page.\n        • Defender - Report message destinations: This applies to more than just Microsoft Teams and allows for an organization to keep their reports contained. Due to how the parameters are configured on the backend it is included in this assessment as a requirement."},{"label":"check","data":"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Messaging select Messaging policies.\n        3. Click Global (Org-wide default).\n        4. Ensure Report a security concern is On.\n        5. Next, navigate to Microsoft 365 Defender https://security.microsoft.com/\n        6. Click on Settings > Email & collaboration > User reported settings.\n        7. Scroll to Microsoft Teams.\n        8. Ensure Monitor reported messages in Microsoft Teams is checked.\n        9. Ensure Send reported messages to: is set to My reporting mailbox only with report email addresses defined for authorized staff.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Connect to Exchange Online PowerShell using Connect-ExchangeOnline.\n        3. Run the following cmdlet for to assess Teams:\n            Get-CsTeamsMessagingPolicy -Identity Global | fl AllowSecurityEndUserReporting\n        4. Ensure the value returned is True.\n        5. Run this cmdlet to assess Defender:\n            Get-ReportSubmissionPolicy | fl Report*\n        6. Ensure the output matches the following values with organization specific email addresses:\n            ReportJunkToCustomizedAddress : True\n            ReportNotJunkToCustomizedAddress : True\n            ReportPhishToCustomizedAddress : True\n            ReportJunkAddresses : {SOC@contoso.com}\n            ReportNotJunkAddresses : {SOC@contoso.com}\n            ReportPhishAddresses : {SOC@contoso.com}\n            ReportChatMessageEnabled : False\n            ReportChatMessageToCustomizedAddressEnabled : True"},{"label":"fix","data":"To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Messaging select Messaging policies.\n        3. Click Global (Org-wide default).\n        4. Set Report a security concern to On.\n        5. Next, navigate to Microsoft 365 Defender https://security.microsoft.com/\n        6. Click on Settings > Email & collaboration > User reported settings.\n        7. Scroll to Microsoft Teams.\n        8. Check Monitor reported messages in Microsoft Teams and Save.\n        9. Set Send reported messages to: to My reporting mailbox only with reports configured to be sent to authorized staff.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Connect to Exchange Online PowerShell using Connect-ExchangeOnline.\n        3. Run the following cmdlet:\n            Set-CsTeamsMessagingPolicy -Identity Global -AllowSecurityEndUserReporting $true\n        4. To configure the Defender reporting policies, edit and run this script:\n            $usersub = \"userreportedmessages@fabrikam.com\" # Change this.\n            $params = @{ Identity = \"DefaultReportSubmissionPolicy\" EnableReportToMicrosoft = $false ReportChatMessageEnabled = $false ReportChatMessageToCustomizedAddressEnabled = $true ReportJunkToCustomizedAddress = $true ReportNotJunkToCustomizedAddress = $true ReportPhishToCustomizedAddress = $true ReportJunkAddresses = $usersub ReportNotJunkAddresses = $usersub ReportPhishAddresses = $usersub }\n            Set-ReportSubmissionPolicy @params\n            New-ReportSubmissionRule -Name DefaultReportSubmissionRule -ReportSubmissionPolicy DefaultReportSubmissionPolicy -SentTo $usersub"},{"label":"rationale","data":"Users will be able to more quickly and systematically alert administrators of suspicious\n        malicious messages within Teams. The content of these messages may be sensitive in\n        nature and therefore should be kept within the organization and not shared with\n        Microsoft without first consulting company policy.\n        Note:\n            • The reported message remains visible to the user in the Teams client.\n            • Users can report the same message multiple times.\n            • The message sender isn't notified that messages were reported."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/submissions-teams?view=o365-worldwide"}],"tags":{"severity":"medium","cis_controls":[{"8":["untracked"]},{"7":["untracked"]}],"default_value":"On (True)\n                    Report message destination: Microsoft Only","nist":["CM-6"]},"code":"control 'microsoft-365-foundations-8.6.1' do\n  title 'Ensure users can report security concerns in Teams'\n  desc \"User reporting settings allow a user to report a message as malicious for further analysis. This recommendation is composed of 3 different settings and all be configured to pass:\n        • In the Teams admin center: On by default and controls whether users are able to report messages from Teams. When this setting is turned off, users can't report messages within Teams, so the corresponding setting in the Microsoft 365 Defender portal is irrelevant.\n        • In the Microsoft 365 Defender portal: On by default for new tenants. Existing tenants need to enable it. If user reporting of messages is turned on in the Teams admin center, it also needs to be turned on the Defender portal for user reported messages to show up correctly on the User reported tab on the Submissions page.\n        • Defender - Report message destinations: This applies to more than just Microsoft Teams and allows for an organization to keep their reports contained. Due to how the parameters are configured on the backend it is included in this assessment as a requirement.\"\n\n  desc 'check',\n       \"To audit using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Messaging select Messaging policies.\n        3. Click Global (Org-wide default).\n        4. Ensure Report a security concern is On.\n        5. Next, navigate to Microsoft 365 Defender https://security.microsoft.com/\n        6. Click on Settings > Email & collaboration > User reported settings.\n        7. Scroll to Microsoft Teams.\n        8. Ensure Monitor reported messages in Microsoft Teams is checked.\n        9. Ensure Send reported messages to: is set to My reporting mailbox only with report email addresses defined for authorized staff.\n    To audit using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Connect to Exchange Online PowerShell using Connect-ExchangeOnline.\n        3. Run the following cmdlet for to assess Teams:\n            Get-CsTeamsMessagingPolicy -Identity Global | fl AllowSecurityEndUserReporting\n        4. Ensure the value returned is True.\n        5. Run this cmdlet to assess Defender:\n            Get-ReportSubmissionPolicy | fl Report*\n        6. Ensure the output matches the following values with organization specific email addresses:\n            ReportJunkToCustomizedAddress : True\n            ReportNotJunkToCustomizedAddress : True\n            ReportPhishToCustomizedAddress : True\n            ReportJunkAddresses : {SOC@contoso.com}\n            ReportNotJunkAddresses : {SOC@contoso.com}\n            ReportPhishAddresses : {SOC@contoso.com}\n            ReportChatMessageEnabled : False\n            ReportChatMessageToCustomizedAddressEnabled : True\"\n\n  desc 'fix',\n       'To remediate using the UI:\n        1. Navigate to Microsoft Teams admin center https://admin.teams.microsoft.com.\n        2. Click to expand Messaging select Messaging policies.\n        3. Click Global (Org-wide default).\n        4. Set Report a security concern to On.\n        5. Next, navigate to Microsoft 365 Defender https://security.microsoft.com/\n        6. Click on Settings > Email & collaboration > User reported settings.\n        7. Scroll to Microsoft Teams.\n        8. Check Monitor reported messages in Microsoft Teams and Save.\n        9. Set Send reported messages to: to My reporting mailbox only with reports configured to be sent to authorized staff.\n    To remediate using PowerShell:\n        1. Connect to Teams PowerShell using Connect-MicrosoftTeams.\n        2. Connect to Exchange Online PowerShell using Connect-ExchangeOnline.\n        3. Run the following cmdlet:\n            Set-CsTeamsMessagingPolicy -Identity Global -AllowSecurityEndUserReporting $true\n        4. To configure the Defender reporting policies, edit and run this script:\n            $usersub = \"userreportedmessages@fabrikam.com\" # Change this.\n            $params = @{ Identity = \"DefaultReportSubmissionPolicy\" EnableReportToMicrosoft = $false ReportChatMessageEnabled = $false ReportChatMessageToCustomizedAddressEnabled = $true ReportJunkToCustomizedAddress = $true ReportNotJunkToCustomizedAddress = $true ReportPhishToCustomizedAddress = $true ReportJunkAddresses = $usersub ReportNotJunkAddresses = $usersub ReportPhishAddresses = $usersub }\n            Set-ReportSubmissionPolicy @params\n            New-ReportSubmissionRule -Name DefaultReportSubmissionRule -ReportSubmissionPolicy DefaultReportSubmissionPolicy -SentTo $usersub'\n\n  desc 'rationale',\n       \"Users will be able to more quickly and systematically alert administrators of suspicious\n        malicious messages within Teams. The content of these messages may be sensitive in\n        nature and therefore should be kept within the organization and not shared with\n        Microsoft without first consulting company policy.\n        Note:\n            • The reported message remains visible to the user in the Teams client.\n            • Users can report the same message multiple times.\n            • The message sender isn't notified that messages were reported.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['untracked'] }, { '7' => ['untracked'] }]\n  tag default_value: 'On (True)\n                    Report message destination: Microsoft Only'\n  tag nist: ['CM-6']\n\n  ref 'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/submissions-teams?view=o365-worldwide'\n\n  microsoft_teams_script = %{\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2('#{input('certificate_path')}','#{input('certificate_password')}')\n    import-module MicrosoftTeams\n    Connect-MicrosoftTeams -Certificate $cert -ApplicationId $client_id -TenantId $tenantid > $null\n    (Get-CsTeamsMessagingPolicy -Identity Global).AllowSecurityEndUserReporting\n }\n  powershell_output_teams = powershell(microsoft_teams_script).stdout.strip\n  describe 'Ensure the AllowSecurityEndUserReporting state from Get-CsTeamsMessagingPolicy' do\n    subject { powershell_output_teams }\n    it 'is set to True' do\n      expect(subject).to eq('True')\n    end\n  end\n\n  microsoft_defender_script = %{\n    $client_id = '#{input('client_id')}'\n    $tenantid = '#{input('tenant_id')}'\n    $certificate_password = '#{input('certificate_password')}'\n    $certificate_path = '#{input('certificate_path')}'\n    $organization = '#{input('organization')}'\n    import-module exchangeonlinemanagement\n    Connect-ExchangeOnline -CertificateFilePath $certificate_path -CertificatePassword (ConvertTo-SecureString -String $certificate_password -AsPlainText -Force)  -AppID $client_id -Organization $organization -ShowBanner:$false\n    $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2('#{input('certificate_path')}','#{input('certificate_password')}')\n    import-module MicrosoftTeams\n    Connect-MicrosoftTeams -Certificate $cert -ApplicationId $client_id -TenantId $tenantid > $null\n    Get-ReportSubmissionPolicy | Select-Object -Property ReportJunkToCustomizedAddress, ReportNotJunkToCustomizedAddress, ReportPhishToCustomizedAddress, ReportJunkAddresses, ReportNotJunkAddresses, ReportPhishAddresses, ReportChatMessageEnabled, ReportChatMessageToCustomizedAddressEnabled | ConvertTo-Json\n  }\n\n  reporting_email_addresses = input('reporting_email_addresses_for_malicious_messages')\n  powershell_output = powershell(microsoft_defender_script).stdout.strip\n  submission_policy_data = JSON.parse(powershell_output)\n  describe 'Ensure that the following states:' do\n    subject { powershell_output }\n    it 'ReportJunkToCustomizedAddress should be True' do\n      expect(submission_policy_data['ReportJunkToCustomizedAddress']).to eq(true)\n    end\n\n    it 'ReportNotJunkToCustomizedAddress should be True' do\n      expect(submission_policy_data['ReportNotJunkToCustomizedAddress']).to eq(true)\n    end\n\n    it 'ReportPhishToCustomizedAddress should be True' do\n      expect(submission_policy_data['ReportPhishToCustomizedAddress']).to eq(true)\n    end\n\n    it \"ReportJunkAddresses should be #{reporting_email_addresses}\" do\n      expect(submission_policy_data['ReportJunkAddresses']).to match_array(reporting_email_addresses)\n    end\n\n    it \"ReportNotJunkAddresses should be #{reporting_email_addresses}\" do\n      expect(submission_policy_data['ReportNotJunkAddresses']).to match_array(reporting_email_addresses)\n    end\n\n    it \"ReportPhishAddresses should be #{reporting_email_addresses}\" do\n      expect(submission_policy_data['ReportPhishAddresses']).to match_array(reporting_email_addresses)\n    end\n\n    it 'ReportChatMessageEnabled should be False' do\n      expect(submission_policy_data['ReportChatMessageEnabled']).to eq(false)\n    end\n\n    it 'ReportChatMessageToCustomizedAddressEnabled should be True' do\n      expect(submission_policy_data['ReportChatMessageToCustomizedAddressEnabled']).to eq(true)\n    end\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-8.6.1.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Ensure the AllowSecurityEndUserReporting state from Get-CsTeamsMessagingPolicy is set to True","run_time":8.5e-05,"start_time":"2024-09-24T15:52:27-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure the AllowSecurityEndUserReporting state from Get-CsTeamsMessagingPolicy"},{"status":"passed","code_desc":"Ensure that the following states: ReportJunkToCustomizedAddress should be True","run_time":4.5e-05,"start_time":"2024-09-24T15:52:27-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the following states:"},{"status":"passed","code_desc":"Ensure that the following states: ReportNotJunkToCustomizedAddress should be True","run_time":3.2e-05,"start_time":"2024-09-24T15:52:27-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the following states:"},{"status":"passed","code_desc":"Ensure that the following states: ReportPhishToCustomizedAddress should be True","run_time":3.1e-05,"start_time":"2024-09-24T15:52:27-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the following states:"},{"status":"failed","code_desc":"Ensure that the following states: ReportJunkAddresses should be [\"a\"]","run_time":0.002704,"start_time":"2024-09-24T15:52:27-04:00","message":"expected collection contained:  [\"a\"]\nactual collection contained:    [\"mcannava@mitredev.onmicrosoft.com\"]\nthe missing elements were:      [\"a\"]\nthe extra elements were:        [\"mcannava@mitredev.onmicrosoft.com\"]\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the following states:"},{"status":"failed","code_desc":"Ensure that the following states: ReportNotJunkAddresses should be [\"a\"]","run_time":0.000104,"start_time":"2024-09-24T15:52:27-04:00","message":"expected collection contained:  [\"a\"]\nactual collection contained:    [\"mcannava@mitredev.onmicrosoft.com\"]\nthe missing elements were:      [\"a\"]\nthe extra elements were:        [\"mcannava@mitredev.onmicrosoft.com\"]\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the following states:"},{"status":"failed","code_desc":"Ensure that the following states: ReportPhishAddresses should be [\"a\"]","run_time":6.3e-05,"start_time":"2024-09-24T15:52:27-04:00","message":"expected collection contained:  [\"a\"]\nactual collection contained:    [\"mcannava@mitredev.onmicrosoft.com\"]\nthe missing elements were:      [\"a\"]\nthe extra elements were:        [\"mcannava@mitredev.onmicrosoft.com\"]\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the following states:"},{"status":"failed","code_desc":"Ensure that the following states: ReportChatMessageEnabled should be False","run_time":0.001529,"start_time":"2024-09-24T15:52:27-04:00","message":"\nexpected: false\n     got: true\n\n(compared using ==)\n\nDiff:\n@@ -1 +1 @@\n-false\n+true\n","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the following states:"},{"status":"passed","code_desc":"Ensure that the following states: ReportChatMessageToCustomizedAddressEnabled should be True","run_time":3.3e-05,"start_time":"2024-09-24T15:52:27-04:00","resource_class":"Object","resource_params":"[]","resource_id":"Ensure that the following states:"}]},{"id":"microsoft-365-foundations-9.1.1","title":"Ensure guest user access is restricted","desc":"This setting allows business-to-business (B2B) guests access to Microsoft Fabric, and contents that they have permissions to. With the setting turned off, B2B guest users receive an error when trying to access Power BI.\n        The recommended state is Enabled for a subset of the organization or Disabled.","descriptions":[{"label":"default","data":"This setting allows business-to-business (B2B) guests access to Microsoft Fabric, and contents that they have permissions to. With the setting turned off, B2B guest users receive an error when trying to access Power BI.\n        The recommended state is Enabled for a subset of the organization or Disabled."},{"label":"check","data":"Ensure guest user access is restricted:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Ensure that Guest users can access Microsoft Fabric adheres to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled."},{"label":"fix","data":"Restrict guest user access:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Set Guest users can access Microsoft Fabric to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled."},{"label":"rationale","data":"Establishing and enforcing a dedicated security group prevents unauthorized access to\n        Microsoft Fabric for guests collaborating in Azure that are new or assigned guest status\n        from other applications. This upholds the principle of least privilege and uses role-based\n        access control (RBAC). These security groups can also be used for tasks like\n        conditional access, enhancing risk management and user accountability across the\n        organization."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/power-bi/admin/service-admin-portal-export-sharing"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.3"]},{"8":["6.8"]}],"default_value":"Enabled for Entire Organization","nist":["AC-3","AC-5","AC-6","MP-2","AC-2","AC-6(1)","AC-6(7)","AU-9(4)"]},"code":"control 'microsoft-365-foundations-9.1.1' do\n  title 'Ensure guest user access is restricted'\n  desc \"This setting allows business-to-business (B2B) guests access to Microsoft Fabric, and contents that they have permissions to. With the setting turned off, B2B guest users receive an error when trying to access Power BI.\n        The recommended state is Enabled for a subset of the organization or Disabled.\"\n\n  desc 'check',\n       \"Ensure guest user access is restricted:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Ensure that Guest users can access Microsoft Fabric adheres to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled.\"\n\n  desc 'fix',\n       \"Restrict guest user access:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Set Guest users can access Microsoft Fabric to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled.\"\n\n  desc 'rationale',\n       'Establishing and enforcing a dedicated security group prevents unauthorized access to\n        Microsoft Fabric for guests collaborating in Azure that are new or assigned guest status\n        from other applications. This upholds the principle of least privilege and uses role-based\n        access control (RBAC). These security groups can also be used for tasks like\n        conditional access, enhancing risk management and user accountability across the\n        organization.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['3.3'] }, { '8' => ['6.8'] }]\n  tag default_value: 'Enabled for Entire Organization'\n  tag nist: ['AC-3', 'AC-5', 'AC-6', 'MP-2', 'AC-2', 'AC-6(1)', 'AC-6(7)', 'AU-9(4)']\n\n  ref 'https://learn.microsoft.com/en-us/power-bi/admin/service-admin-portal-export-sharing'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-9.1.1.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":1.0e-05,"start_time":"2024-09-24T15:52:27-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-9.1.2","title":"Ensure external user invitations are restricted","desc":"This setting helps organizations choose whether new external users can be invited to the organization through Power BI sharing, permissions, and subscription experiences. This setting only controls the ability to invite through Power BI.\n        The recommended state is Enabled for a subset of the organization or Disabled.\n        Note: To invite external users to the organization, the user must also have the Microsoft Entra Guest Inviter role","descriptions":[{"label":"default","data":"This setting helps organizations choose whether new external users can be invited to the organization through Power BI sharing, permissions, and subscription experiences. This setting only controls the ability to invite through Power BI.\n        The recommended state is Enabled for a subset of the organization or Disabled.\n        Note: To invite external users to the organization, the user must also have the Microsoft Entra Guest Inviter role"},{"label":"check","data":"Ensure external user invitations are restricted:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Ensure that Users can invite guest users to collaborate through item sharing and permissions adheres to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled."},{"label":"fix","data":"Restrict external user invitations:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Set Users can invite guest users to collaborate through item sharing and permissions to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled."},{"label":"rationale","data":"Establishing and enforcing a dedicated security group prevents unauthorized access to\n        Microsoft Fabric for guests collaborating in Azure that are new or assigned guest status\n        from other applications. This upholds the principle of least privilege and uses role-based\n        access control (RBAC). These security groups can also be used for tasks like\n        conditional access, enhancing risk management and user accountability across the\n        organization."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/power-bi/admin/service-admin-portal-export-sharing"},{"ref":"https://learn.microsoft.com/en-us/power-bi/enterprise/service-admin-azure-ad-b2b#invite-guest-users"}],"tags":{"severity":"medium","cis_controls":[{"8":["6.8"]}],"default_value":"Enabled for the entire organization","nist":["AC-5","AC-6","AC-6(1)","AC-6(7)","AU-9(4)"]},"code":"control 'microsoft-365-foundations-9.1.2' do\n  title 'Ensure external user invitations are restricted'\n  desc \"This setting helps organizations choose whether new external users can be invited to the organization through Power BI sharing, permissions, and subscription experiences. This setting only controls the ability to invite through Power BI.\n        The recommended state is Enabled for a subset of the organization or Disabled.\n        Note: To invite external users to the organization, the user must also have the Microsoft Entra Guest Inviter role\"\n\n  desc 'check',\n       \"Ensure external user invitations are restricted:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Ensure that Users can invite guest users to collaborate through item sharing and permissions adheres to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled.\"\n\n  desc 'fix',\n       \"Restrict external user invitations:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Set Users can invite guest users to collaborate through item sharing and permissions to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled.\"\n\n  desc 'rationale',\n       'Establishing and enforcing a dedicated security group prevents unauthorized access to\n        Microsoft Fabric for guests collaborating in Azure that are new or assigned guest status\n        from other applications. This upholds the principle of least privilege and uses role-based\n        access control (RBAC). These security groups can also be used for tasks like\n        conditional access, enhancing risk management and user accountability across the\n        organization.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['6.8'] }]\n  tag default_value: 'Enabled for the entire organization'\n  tag nist: ['AC-5', 'AC-6', 'AC-6(1)', 'AC-6(7)', 'AU-9(4)']\n\n  ref 'https://learn.microsoft.com/en-us/power-bi/admin/service-admin-portal-export-sharing'\n  ref 'https://learn.microsoft.com/en-us/power-bi/enterprise/service-admin-azure-ad-b2b#invite-guest-users'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-9.1.2.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":5.0e-06,"start_time":"2024-09-24T15:52:27-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-9.1.3","title":"Ensure guest access to content is restricted","desc":"This setting allows Microsoft Entra B2B guest users to have full access to the browsing experience using the left-hand navigation pane in the organization. Guest users who have been assigned workspace roles or specific item permissions will continue to have those roles and/or permissions, even if this setting is disabled.\n        The recommended state is Enabled for a subset of the organization or Disabled.","descriptions":[{"label":"default","data":"This setting allows Microsoft Entra B2B guest users to have full access to the browsing experience using the left-hand navigation pane in the organization. Guest users who have been assigned workspace roles or specific item permissions will continue to have those roles and/or permissions, even if this setting is disabled.\n        The recommended state is Enabled for a subset of the organization or Disabled."},{"label":"check","data":"Ensure guest user content access is restricted:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Ensure that Guest users can browse and access Fabric content adheres to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled."},{"label":"fix","data":"Restrict guest user content access:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Set Guest users can browse and access Fabric content to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled."},{"label":"rationale","data":"Establishing and enforcing a dedicated security group prevents unauthorized access to\n        Microsoft Fabric for guests collaborating in Entra that are new or assigned guest status\n        from other applications. This upholds the principle of least privilege and uses role-based\n        access control (RBAC). These security groups can also be used for tasks like\n        conditional access, enhancing risk management and user accountability across the\n        organization."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/power-bi/admin/service-admin-portal-export-sharing"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.3"]},{"7":["14.6"]}],"default_value":"Disabled","nist":["AC-3","AC-5","AC-6","MP-2","AT-2"]},"code":"control 'microsoft-365-foundations-9.1.3' do\n  title 'Ensure guest access to content is restricted'\n  desc \"This setting allows Microsoft Entra B2B guest users to have full access to the browsing experience using the left-hand navigation pane in the organization. Guest users who have been assigned workspace roles or specific item permissions will continue to have those roles and/or permissions, even if this setting is disabled.\n        The recommended state is Enabled for a subset of the organization or Disabled.\"\n\n  desc 'check',\n       \"Ensure guest user content access is restricted:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Ensure that Guest users can browse and access Fabric content adheres to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled.\"\n\n  desc 'fix',\n       \"Restrict guest user content access:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Set Guest users can browse and access Fabric content to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled.\"\n\n  desc 'rationale',\n       'Establishing and enforcing a dedicated security group prevents unauthorized access to\n        Microsoft Fabric for guests collaborating in Entra that are new or assigned guest status\n        from other applications. This upholds the principle of least privilege and uses role-based\n        access control (RBAC). These security groups can also be used for tasks like\n        conditional access, enhancing risk management and user accountability across the\n        organization.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['3.3'] }, { '7' => ['14.6'] }]\n  tag default_value: 'Disabled'\n  tag nist: ['AC-3', 'AC-5', 'AC-6', 'MP-2', 'AT-2']\n\n  ref 'https://learn.microsoft.com/en-us/power-bi/admin/service-admin-portal-export-sharing'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-9.1.3.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":4.0e-06,"start_time":"2024-09-24T15:52:27-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-9.1.4","title":"Ensure 'Publish to web' is restricted","desc":"Power BI enables users to share reports and materials directly on the internet from both the application's desktop version and its web user interface. This functionality generates a publicly reachable web link that doesn't necessitate authentication or the need to be an AAD user in order to access and view it.\n        The recommended state is Enabled for a subset of the organization or Disabled.","descriptions":[{"label":"default","data":"Power BI enables users to share reports and materials directly on the internet from both the application's desktop version and its web user interface. This functionality generates a publicly reachable web link that doesn't necessitate authentication or the need to be an AAD user in order to access and view it.\n        The recommended state is Enabled for a subset of the organization or Disabled."},{"label":"check","data":"Ensure Publish to web is restricted:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Ensure that Publish to web adheres to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Choose how embed codes work set to Only allow existing codes AND Specific security groups selected and defined\n        Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled."},{"label":"fix","data":"Restrict Publish to web:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Set Publish to web to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Choose how embed codes work set to Only allow existing codes AND Specific security groups selected and defined\n        Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled."},{"label":"rationale","data":"When using Publish to Web anyone on the Internet can view a published report or\n        visual. Viewing requires no authentication. It includes viewing detail-level data that your\n        reports aggregate. By disabling the feature, restricting access to certain users and\n        allowing existing embed codes organizations can mitigate the exposure of confidential\n        or proprietary information."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/power-bi/collaborate-share/service-publish-to-web"},{"ref":"https://learn.microsoft.com/en-us/power-bi/admin/service-admin-portal-export-sharing#publish-to-web"}],"tags":{"severity":"medium","cis_controls":[{"8":["16.10"]}],"default_value":"Enabled for the entire organization\n                      Only allow existing codes","nist":["PL-8","SA-8"]},"code":"control 'microsoft-365-foundations-9.1.4' do\n  title \"Ensure 'Publish to web' is restricted\"\n  desc \"Power BI enables users to share reports and materials directly on the internet from both the application's desktop version and its web user interface. This functionality generates a publicly reachable web link that doesn't necessitate authentication or the need to be an AAD user in order to access and view it.\n        The recommended state is Enabled for a subset of the organization or Disabled.\"\n\n  desc 'check',\n       \"Ensure Publish to web is restricted:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Ensure that Publish to web adheres to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Choose how embed codes work set to Only allow existing codes AND Specific security groups selected and defined\n        Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled.\"\n\n  desc 'fix',\n       \"Restrict Publish to web:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Set Publish to web to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Choose how embed codes work set to Only allow existing codes AND Specific security groups selected and defined\n        Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled.\"\n\n  desc 'rationale',\n       'When using Publish to Web anyone on the Internet can view a published report or\n        visual. Viewing requires no authentication. It includes viewing detail-level data that your\n        reports aggregate. By disabling the feature, restricting access to certain users and\n        allowing existing embed codes organizations can mitigate the exposure of confidential\n        or proprietary information.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['16.10'] }]\n  tag default_value: 'Enabled for the entire organization\n                      Only allow existing codes'\n  tag nist: ['PL-8', 'SA-8']\n\n  ref 'https://learn.microsoft.com/en-us/power-bi/collaborate-share/service-publish-to-web'\n  ref 'https://learn.microsoft.com/en-us/power-bi/admin/service-admin-portal-export-sharing#publish-to-web'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-9.1.4.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":6.0e-06,"start_time":"2024-09-24T15:52:27-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-9.1.5","title":"Ensure 'Interact with and share R and Python' visuals is 'Disabled'","desc":"Power BI allows the integration of R and Python scripts directly into visuals. This feature allows data visualizations by incorporating custom calculations, statistical analyses, machine learning models, and more using R or Python scripts. Custom visuals can be created by embedding them directly into Power BI reports. Users can then interact with these visuals and see the results of the custom code within the Power BI interface.","descriptions":[{"label":"default","data":"Power BI allows the integration of R and Python scripts directly into visuals. This feature allows data visualizations by incorporating custom calculations, statistical analyses, machine learning models, and more using R or Python scripts. Custom visuals can be created by embedding them directly into Power BI reports. Users can then interact with these visuals and see the results of the custom code within the Power BI interface."},{"label":"check","data":"Ensure the recommended state is configured:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to R and Python visuals settings.\n        4. Ensure that Interact with and share R and Python visuals is Disabled"},{"label":"fix","data":"Configure the recommended state:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to R and Python visuals settings.\n        4. Set Interact with and share R and Python visuals to Disabled"},{"label":"rationale","data":"Disabling this feature can reduce the attack surface by preventing potential malicious\n        code execution leading to data breaches, or unauthorized access. The potential for\n        sensitive or confidential data being leaked to unintended users is also increased with\n        the use of scripts."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/power-bi/admin/service-admin-portal-r-python-visuals"},{"ref":"https://learn.microsoft.com/en-us/power-bi/visuals/service-r-visuals"},{"ref":"https://www.r-project.org/"}],"tags":{"severity":"medium","cis_controls":[{"8":["4.8"]}],"default_value":"Enabled","nist":["CM-6","CM-7"]},"code":"control 'microsoft-365-foundations-9.1.5' do\n  title \"Ensure 'Interact with and share R and Python' visuals is 'Disabled'\"\n  desc 'Power BI allows the integration of R and Python scripts directly into visuals. This feature allows data visualizations by incorporating custom calculations, statistical analyses, machine learning models, and more using R or Python scripts. Custom visuals can be created by embedding them directly into Power BI reports. Users can then interact with these visuals and see the results of the custom code within the Power BI interface.'\n\n  desc 'check',\n       \"Ensure the recommended state is configured:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to R and Python visuals settings.\n        4. Ensure that Interact with and share R and Python visuals is Disabled\"\n\n  desc 'fix',\n       \"Configure the recommended state:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to R and Python visuals settings.\n        4. Set Interact with and share R and Python visuals to Disabled\"\n\n  desc 'rationale',\n       'Disabling this feature can reduce the attack surface by preventing potential malicious\n        code execution leading to data breaches, or unauthorized access. The potential for\n        sensitive or confidential data being leaked to unintended users is also increased with\n        the use of scripts.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['4.8'] }]\n  tag default_value: 'Enabled'\n  tag nist: ['CM-6', 'CM-7']\n\n  ref 'https://learn.microsoft.com/en-us/power-bi/admin/service-admin-portal-r-python-visuals'\n  ref 'https://learn.microsoft.com/en-us/power-bi/visuals/service-r-visuals'\n  ref 'https://www.r-project.org/'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-9.1.5.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":5.0e-06,"start_time":"2024-09-24T15:52:27-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-9.1.6","title":"Ensure 'Allow users to apply sensitivity labels for content' is 'Enabled'","desc":"Information protection tenant settings help to protect sensitive information in the Power BI tenant. Allowing and applying sensitivity labels to content ensures that information is only seen and accessed by the appropriate users.\n        The recommended state is Enabled or Enabled for a subset of the organization.\n        Note: Sensitivity labels and protection are only applied to files exported to Excel, PowerPoint, or PDF files, that are controlled by \"Export to Excel\" and \"Export reports as PowerPoint presentation or PDF documents\" settings. All other export and sharing options do not support the application of sensitivity labels and protection.\n        Note 2: There are some prerequisite steps that need to be completed in order to fully utilize labeling. See here.","descriptions":[{"label":"default","data":"Information protection tenant settings help to protect sensitive information in the Power BI tenant. Allowing and applying sensitivity labels to content ensures that information is only seen and accessed by the appropriate users.\n        The recommended state is Enabled or Enabled for a subset of the organization.\n        Note: Sensitivity labels and protection are only applied to files exported to Excel, PowerPoint, or PDF files, that are controlled by \"Export to Excel\" and \"Export reports as PowerPoint presentation or PDF documents\" settings. All other export and sharing options do not support the application of sensitivity labels and protection.\n        Note 2: There are some prerequisite steps that need to be completed in order to fully utilize labeling. See here."},{"label":"check","data":"Ensure sensitivity labels are Enabled:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Information protection.\n        4. Ensure that Allow users to apply sensitivity labels for content adheres to one of these states:\n            o State 1: Enabled\n            o State 2: Enabled with Specific security groups selected and defined."},{"label":"fix","data":"Enable sensitivity labels:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Information protection.\n        4. Set Allow users to apply sensitivity labels for content to one of these states:\n            o State 1: Enabled\n            o State 2: Enabled with Specific security groups selected and defined."},{"label":"rationale","data":"Establishing data classifications and affixing labels to data at creation enables\n        organizations to discern the data's criticality, sensitivity, and value. This initial\n        identification enables the implementation of appropriate protective measures, utilizing\n        technologies like Data Loss Prevention (DLP) to avert inadvertent exposure and\n        enforcing access controls to safeguard against unauthorized access.\n        This practice can also promote user awareness and responsibility in regard to the\n        nature of the data they interact with. Which in turn can foster awareness in other areas\n        of data management across the organization."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/power-bi/enterprise/service-security-enable-data-sensitivity-labels"},{"ref":"https://learn.microsoft.com/en-us/power-bi/enterprise/service-security-dlp-policies-for-power-bi-overview"},{"ref":"https://learn.microsoft.com/en-us/power-bi/enterprise/service-security-enable-data-sensitivity-labels#licensing-and-requirements"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.2"]},{"8":["3.7"]}],"default_value":"Disabled","nist":["CM-12","PM-5(1)","RA-2"]},"code":"control 'microsoft-365-foundations-9.1.6' do\n  title \"Ensure 'Allow users to apply sensitivity labels for content' is 'Enabled'\"\n  desc 'Information protection tenant settings help to protect sensitive information in the Power BI tenant. Allowing and applying sensitivity labels to content ensures that information is only seen and accessed by the appropriate users.\n        The recommended state is Enabled or Enabled for a subset of the organization.\n        Note: Sensitivity labels and protection are only applied to files exported to Excel, PowerPoint, or PDF files, that are controlled by \"Export to Excel\" and \"Export reports as PowerPoint presentation or PDF documents\" settings. All other export and sharing options do not support the application of sensitivity labels and protection.\n        Note 2: There are some prerequisite steps that need to be completed in order to fully utilize labeling. See here.'\n\n  desc 'check',\n       \"Ensure sensitivity labels are Enabled:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Information protection.\n        4. Ensure that Allow users to apply sensitivity labels for content adheres to one of these states:\n            o State 1: Enabled\n            o State 2: Enabled with Specific security groups selected and defined.\"\n\n  desc 'fix',\n       \"Enable sensitivity labels:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Information protection.\n        4. Set Allow users to apply sensitivity labels for content to one of these states:\n            o State 1: Enabled\n            o State 2: Enabled with Specific security groups selected and defined.\"\n\n  desc 'rationale',\n       \"Establishing data classifications and affixing labels to data at creation enables\n        organizations to discern the data's criticality, sensitivity, and value. This initial\n        identification enables the implementation of appropriate protective measures, utilizing\n        technologies like Data Loss Prevention (DLP) to avert inadvertent exposure and\n        enforcing access controls to safeguard against unauthorized access.\n        This practice can also promote user awareness and responsibility in regard to the\n        nature of the data they interact with. Which in turn can foster awareness in other areas\n        of data management across the organization.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['3.2'] }, { '8' => ['3.7'] }]\n  tag default_value: 'Disabled'\n  tag nist: ['CM-12', 'PM-5(1)', 'RA-2']\n\n  ref 'https://learn.microsoft.com/en-us/power-bi/enterprise/service-security-enable-data-sensitivity-labels'\n  ref 'https://learn.microsoft.com/en-us/power-bi/enterprise/service-security-dlp-policies-for-power-bi-overview'\n  ref 'https://learn.microsoft.com/en-us/power-bi/enterprise/service-security-enable-data-sensitivity-labels#licensing-and-requirements'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-9.1.6.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":5.0e-06,"start_time":"2024-09-24T15:52:27-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-9.1.7","title":"Ensure shareable links are restricted","desc":"Creating a shareable link allows a user to create a link to a report or dashboard, then add that link to an email or another messaging application.\n        There are 3 options that can be selected when creating a shareable link:\n            • People in your organization\n            • People with existing access\n            • Specific people\n        This setting solely deals with restrictions to People in the organization. External users by default are not included in any of these categories, and therefore cannot use any of these links regardless of the state of this setting.\n        The recommended state is Enabled for a subset of the organization or Disabled.","descriptions":[{"label":"default","data":"Creating a shareable link allows a user to create a link to a report or dashboard, then add that link to an email or another messaging application.\n        There are 3 options that can be selected when creating a shareable link:\n            • People in your organization\n            • People with existing access\n            • Specific people\n        This setting solely deals with restrictions to People in the organization. External users by default are not included in any of these categories, and therefore cannot use any of these links regardless of the state of this setting.\n        The recommended state is Enabled for a subset of the organization or Disabled."},{"label":"check","data":"Ensure shareable links are restricted:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Ensure that Allow shareable links to grant access to everyone in your organization adheres to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled."},{"label":"fix","data":"Restrict shareable links:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Set Allow shareable links to grant access to everyone in your organization to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled."},{"label":"rationale","data":"While external users are unable to utilize shareable links, disabling or restricting this\n        feature ensures that a user cannot generate a link accessible by individuals within the\n        same organization who lack the necessary clearance to the shared data. For example,\n        a member of Human Resources intends to share sensitive information with a particular\n        employee or another colleague within their department. The owner would be prompted\n        to specify either People with existing access or Specific people when generating\n        the link requiring the person clicking the link to pass a first layer access control list. This\n        measure along with proper file and folder permissions can help prevent unintended\n        access and potential information leakage."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/power-bi/collaborate-share/service-share-dashboards?wt.mc_id=powerbi_inproduct_sharedialog#link-settings"},{"ref":"https://learn.microsoft.com/en-us/power-bi/admin/service-admin-portal-export-sharing"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.3"]}],"default_value":"Enabled for Entire Organization","nist":["AC-3","AC-5","AC-6","MP-2"]},"code":"control 'microsoft-365-foundations-9.1.7' do\n  title 'Ensure shareable links are restricted'\n  desc \"Creating a shareable link allows a user to create a link to a report or dashboard, then add that link to an email or another messaging application.\n        There are 3 options that can be selected when creating a shareable link:\n            • People in your organization\n            • People with existing access\n            • Specific people\n        This setting solely deals with restrictions to People in the organization. External users by default are not included in any of these categories, and therefore cannot use any of these links regardless of the state of this setting.\n        The recommended state is Enabled for a subset of the organization or Disabled.\"\n\n  desc 'check',\n       \"Ensure shareable links are restricted:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Ensure that Allow shareable links to grant access to everyone in your organization adheres to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled.\"\n\n  desc 'fix',\n       \"Restrict shareable links:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Set Allow shareable links to grant access to everyone in your organization to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled.\"\n\n  desc 'rationale',\n       'While external users are unable to utilize shareable links, disabling or restricting this\n        feature ensures that a user cannot generate a link accessible by individuals within the\n        same organization who lack the necessary clearance to the shared data. For example,\n        a member of Human Resources intends to share sensitive information with a particular\n        employee or another colleague within their department. The owner would be prompted\n        to specify either People with existing access or Specific people when generating\n        the link requiring the person clicking the link to pass a first layer access control list. This\n        measure along with proper file and folder permissions can help prevent unintended\n        access and potential information leakage.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['3.3'] }]\n  tag default_value: 'Enabled for Entire Organization'\n  tag nist: ['AC-3', 'AC-5', 'AC-6', 'MP-2']\n\n  ref 'https://learn.microsoft.com/en-us/power-bi/collaborate-share/service-share-dashboards?wt.mc_id=powerbi_inproduct_sharedialog#link-settings'\n  ref 'https://learn.microsoft.com/en-us/power-bi/admin/service-admin-portal-export-sharing'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-9.1.7.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":9.0e-06,"start_time":"2024-09-24T15:52:27-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-9.1.8","title":"Ensure enabling of external data sharing is restricted","desc":"Power BI admins can specify which users or user groups can share datasets externally with guests from a different tenant through the in-place mechanism. Disabling this setting prevents any user from sharing datasets externally by restricting the ability of users to turn on external sharing for datasets they own or manage.\n        The recommended state is Enabled for a subset of the organization or Disabled.","descriptions":[{"label":"default","data":"Power BI admins can specify which users or user groups can share datasets externally with guests from a different tenant through the in-place mechanism. Disabling this setting prevents any user from sharing datasets externally by restricting the ability of users to turn on external sharing for datasets they own or manage.\n        The recommended state is Enabled for a subset of the organization or Disabled."},{"label":"check","data":"Ensure external data sharing is restricted:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Ensure that Allow specific users to turn on external data sharing adheres to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled."},{"label":"fix","data":"Restrict external data sharing:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Set Allow specific users to turn on external data sharing to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled."},{"label":"rationale","data":"Establishing and enforcing a dedicated security group prevents unauthorized access to\n        Microsoft Fabric for guests collaborating in Azure that are new or from other\n        applications. This upholds the principle of least privilege and uses role-based access\n        control (RBAC). These security groups can also be used for tasks like conditional\n        access, enhancing risk management and user accountability across the organization."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/power-bi/admin/service-admin-portal-export-sharing"}],"tags":{"severity":"medium","cis_controls":[{"8":["3.3"]},{"8":["6.8"]}],"default_value":"Enabled for the entire organization","nist":["AC-3","AC-5","AC-6","MP-2","AC-2","AC-6(1)","AC-6(7)","AU-9(4)"]},"code":"control 'microsoft-365-foundations-9.1.8' do\n  title 'Ensure enabling of external data sharing is restricted'\n  desc \"Power BI admins can specify which users or user groups can share datasets externally with guests from a different tenant through the in-place mechanism. Disabling this setting prevents any user from sharing datasets externally by restricting the ability of users to turn on external sharing for datasets they own or manage.\n        The recommended state is Enabled for a subset of the organization or Disabled.\"\n\n  desc 'check',\n       \"Ensure external data sharing is restricted:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Ensure that Allow specific users to turn on external data sharing adheres to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled.\"\n\n  desc 'fix',\n       \"Restrict external data sharing:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Export and Sharing settings.\n        4. Set Allow specific users to turn on external data sharing to one of these states:\n            o State 1: Disabled\n            o State 2: Enabled with Specific security groups selected and defined.\n    Important: If the organization doesn't actively use this feature it is recommended to keep it Disabled.\"\n\n  desc 'rationale',\n       'Establishing and enforcing a dedicated security group prevents unauthorized access to\n        Microsoft Fabric for guests collaborating in Azure that are new or from other\n        applications. This upholds the principle of least privilege and uses role-based access\n        control (RBAC). These security groups can also be used for tasks like conditional\n        access, enhancing risk management and user accountability across the organization.'\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['3.3'] }, { '8' => ['6.8'] }]\n  tag default_value: 'Enabled for the entire organization'\n  tag nist: ['AC-3', 'AC-5', 'AC-6', 'MP-2', 'AC-2', 'AC-6(1)', 'AC-6(7)', 'AU-9(4)']\n\n  ref 'https://learn.microsoft.com/en-us/power-bi/admin/service-admin-portal-export-sharing'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-9.1.8.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":4.0e-06,"start_time":"2024-09-24T15:52:27-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]},{"id":"microsoft-365-foundations-9.1.9","title":"Ensure 'Block ResourceKey Authentication' is 'Enabled'","desc":"This setting blocks the use of resource key based authentication. The Block ResourceKey Authentication setting applies to streaming and PUSH datasets. If blocked users will not be allowed send data to streaming and PUSH datasets using the API with a resource key.\n        The recommended state is Enabled.","descriptions":[{"label":"default","data":"This setting blocks the use of resource key based authentication. The Block ResourceKey Authentication setting applies to streaming and PUSH datasets. If blocked users will not be allowed send data to streaming and PUSH datasets using the API with a resource key.\n        The recommended state is Enabled."},{"label":"check","data":"Ensure ResourceKey Authentication is Enabled:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Developer settings.\n        4. Ensure that Block ResourceKey Authentication is Enabled"},{"label":"fix","data":"Ensure ResourceKey Authentication is Enabled:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Developer settings.\n        4. Set Block ResourceKey Authentication to Enabled"},{"label":"rationale","data":"Resource keys are a form of authentication that allows users to access Power BI\n        resources (such as reports, dashboards, and datasets) without requiring individual user\n        accounts. While convenient, this method bypasses the organization's centralized\n        identity and access management controls. Enabling ensures that access to Power BI\n        resources is tied to the organization's authentication mechanisms, providing a more\n        secure and controlled environment."}],"impact":0.5,"refs":[{"ref":"https://learn.microsoft.com/en-us/power-bi/admin/service-admin-portal-developer"},{"ref":"https://learn.microsoft.com/en-us/power-bi/connect-data/service-real-time-streaming"}],"tags":{"severity":"medium","cis_controls":[{"8":["4.8"]}],"default_value":"Disabled for the entire organization","nist":["CM-6","CM-7"]},"code":"control 'microsoft-365-foundations-9.1.9' do\n  title \"Ensure 'Block ResourceKey Authentication' is 'Enabled'\"\n  desc \"This setting blocks the use of resource key based authentication. The Block ResourceKey Authentication setting applies to streaming and PUSH datasets. If blocked users will not be allowed send data to streaming and PUSH datasets using the API with a resource key.\n        The recommended state is Enabled.\"\n\n  desc 'check',\n       \"Ensure ResourceKey Authentication is Enabled:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Developer settings.\n        4. Ensure that Block ResourceKey Authentication is Enabled\"\n\n  desc 'fix',\n       \"Ensure ResourceKey Authentication is Enabled:\n        1. Navigate to Microsoft Fabric https://app.powerbi.com/admin-portal\n        2. Select Tenant settings.\n        3. Scroll to Developer settings.\n        4. Set Block ResourceKey Authentication to Enabled\"\n\n  desc 'rationale',\n       \"Resource keys are a form of authentication that allows users to access Power BI\n        resources (such as reports, dashboards, and datasets) without requiring individual user\n        accounts. While convenient, this method bypasses the organization's centralized\n        identity and access management controls. Enabling ensures that access to Power BI\n        resources is tied to the organization's authentication mechanisms, providing a more\n        secure and controlled environment.\"\n\n  impact 0.5\n  tag severity: 'medium'\n  tag cis_controls: [{ '8' => ['4.8'] }]\n  tag default_value: 'Disabled for the entire organization'\n  tag nist: ['CM-6', 'CM-7']\n\n  ref 'https://learn.microsoft.com/en-us/power-bi/admin/service-admin-portal-developer'\n  ref 'https://learn.microsoft.com/en-us/power-bi/connect-data/service-real-time-streaming'\n\n  describe 'manual' do\n    skip 'The test for this control needs to be done manually'\n  end\nend\n","source_location":{"line":1,"ref":"./controls/microsoft-365-foundations-9.1.9.rb"},"waiver_data":{},"results":[{"status":"skipped","code_desc":"manual","run_time":3.0e-06,"start_time":"2024-09-24T15:52:27-04:00","resource":"","skip_message":"The test for this control needs to be done manually","resource_class":"Object","resource_params":"[]","resource_id":"manual"}]}],"status":"loaded","status_message":""}],"statistics":{"duration":1451.291834},"version":"6.8.1"}